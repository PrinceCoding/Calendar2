<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>C</text></svg>">
  <link rel="manifest" href="pwa/manifest.json">
  <meta name="theme-color" content="#007AFF">
  <meta name="apple-mobile-web-app-title" content="CANVAS">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23007AFF' rx='40'/><text x='90' y='130' font-size='110' text-anchor='middle' fill='white' font-family='system-ui' font-weight='600'>C</text></svg>">
  <title>CANVAS</title>

  <!-- =========================
        MODERN UI/UX LIBRARIES
        ========================= -->
  <!-- Tailwind CSS - Modern utility-first CSS framework -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.5s ease-out',
            'scale-in': 'scaleIn 0.3s ease-out',
            'bounce-soft': 'bounceSoft 0.6s ease-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            scaleIn: {
              '0%': { transform: 'scale(0.95)', opacity: '0' },
              '100%': { transform: 'scale(1)', opacity: '1' },
            },
            bounceSoft: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
          },
          backdropBlur: {
            'xs': '2px',
          }
        }
      }
    }
  </script>
  
  <!-- Konsta UI - Mobile-first UI components with Tailwind -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/konsta@latest/css/konsta.min.css">
  
  <!-- Lucide Icons - Beautiful & consistent icon set -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <!-- Animate.css - Ready-to-use CSS animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  
  <!-- GSAP - Professional-grade animation library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  
  <!-- AOS - Animate On Scroll library -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <!-- =========================
        STYLES (CSS)
        ========================= -->
  <!-- Modern Enhancements -->
  <link rel="stylesheet" href="css/modern-enhancements.css?v=3">
  
  <!-- Core Styles -->
  <link rel="stylesheet" href="css/themes.css?v=2">
  <link rel="stylesheet" href="css/base.css?v=2">
  <link rel="stylesheet" href="css/dragging.css?v=2">
  <link rel="stylesheet" href="css/mobile-konsta.css?v=1">
</head>
<body class="antialiased k-ios safe-areas">

<!-- Auto-detect mobile platform -->
<script>
  // Detect Android for Material Design styling
  if (/android/i.test(navigator.userAgent)) {
    document.body.classList.remove('k-ios');
    document.body.classList.add('k-material-theme', 'k-material');
  }
  // iOS is default (k-ios already added)
</script>

<!-- Modern Header with Tailwind -->
<header class="fixed top-0 left-0 right-0 h-14 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border-b border-gray-200 dark:border-gray-800 z-50 shadow-sm">
  <div class="h-full px-4 flex items-center justify-between gap-4">
    
    <!-- Left: App Launcher -->
    <button id="appLauncherBtn" 
            class="flex items-center justify-center w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105"
            title="Apps">
      <i data-lucide="grid-3x3" class="w-5 h-5"></i>
    </button>
    
    <!-- Center: Dynamic Islands -->
    <div class="flex items-center gap-2 flex-wrap justify-center flex-1">
      <!-- Canvas Switcher -->
      <div class="relative group">
        <button id="canvasSwitcher" 
                class="flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 shadow-md hover:shadow-lg">
          <i data-lucide="folder" class="w-4 h-4"></i>
          <span id="canvasNameDisplay" class="font-medium text-sm">Canvas 1</span>
          <i data-lucide="chevron-down" class="w-4 h-4 transition-transform group-hover:rotate-180 duration-300"></i>
        </button>
        <div id="canvasDropdown" class="absolute top-full mt-2 left-0 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 min-w-[200px] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300"></div>
      </div>
      
      <!-- Date/Time Island -->
      <div id="dynamicIslandDateTime" 
           class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/30 dark:to-purple-900/30 rounded-full shadow-md">
        <i data-lucide="clock" class="w-4 h-4"></i>
        <span id="dtText" class="text-sm font-medium"></span>
      </div>
      
      <!-- Pomodoro Island -->
      <div id="dynamicIslandPomodoro" 
           class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-red-50 to-orange-50 dark:from-red-900/30 dark:to-orange-900/30 rounded-full shadow-md">
        <i data-lucide="timer" class="w-4 h-4"></i>
        <span id="pomoTime" class="text-sm font-medium">60:00</span>
        <button id="pomoStart" class="p-1 hover:bg-white/50 dark:hover:bg-black/20 rounded transition-all">
          <i data-lucide="play" class="w-3 h-3"></i>
        </button>
        <button id="pomoReset" class="p-1 hover:bg-white/50 dark:hover:bg-black/20 rounded transition-all">
          <i data-lucide="rotate-ccw" class="w-3 h-3"></i>
        </button>
      </div>
      
      <div id="dynamicIslandAdditional" class="hidden"></div>
    </div>

    <!-- Right: Theme & Settings -->
    <div class="flex items-center gap-2">
      <button id="themeBtn" 
              class="flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 shadow-md hover:shadow-lg">
        <i data-lucide="sun" class="w-4 h-4"></i>
        <span class="text-sm font-medium hidden sm:inline">macOS</span>
      </button>
      <button id="settingsBtn" 
              class="flex items-center justify-center w-9 h-9 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 shadow-md hover:shadow-lg">
        <i data-lucide="settings" class="w-5 h-5"></i>
      </button>
    </div>
  </div>
</header>

<!-- Canvas Workspace with Modern Grid -->
<div id="canvasWorkspace" class="fixed top-14 left-0 right-0 bottom-0 overflow-auto bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800">
  
  <!-- Canvas Helper Hint with Modern Design -->
  <div id="canvasHint" 
       class="fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 bg-white/90 dark:bg-gray-800/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-300 z-50 animate__animated animate__fadeInUp"
       data-aos="fade-up">
    <div class="flex items-center gap-3">
      <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-500"></i>
      <div>
        <strong class="font-semibold">Quick Tips:</strong> 
        Hold <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs font-mono">Space</kbd> + drag to pan • 
        Drag widgets anywhere • 
        Use Canvas Manager to switch workspaces • 
        Click <strong>▦</strong> for apps
      </div>
    </div>
  </div>

  <!-- Modern Floating Analog Clock -->
  <div id="analogClock" 
       class="absolute top-20 left-20 w-80 bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 p-6"
       data-aos="zoom-in">
    <div class="absolute top-3 right-3 flex gap-2">
      <button id="clockSettingsBtn" 
              class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
        <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
      </button>
      <button id="closeClockBtn" 
              class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>
    
    <div class="clock-face relative w-64 h-64 mx-auto mt-8">
      <div class="absolute inset-0 rounded-full bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 shadow-inner"></div>
      <div class="hour-marks absolute inset-0">
        <span></span><span></span><span></span><span></span><span></span><span></span>
        <span></span><span></span><span></span><span></span><span></span><span></span>
      </div>
      <div class="hand hour absolute" id="hourHand"></div>
      <div class="hand minute absolute" id="minuteHand"></div>
      <div class="hand second absolute" id="secondHand"></div>
      <div class="clock-center absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 shadow-lg"></div>
      <div class="clock-date absolute bottom-16 left-1/2 -translate-x-1/2 text-center">
        <div id="clockDay" class="text-sm font-semibold text-gray-600 dark:text-gray-300"></div>
        <div id="clockNum" class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent"></div>
      </div>
    </div>
  </div>

  <!-- Modern Floating Pomodoro Widget -->
  <div id="floatingPomo" 
       class="absolute top-20 right-20 w-96 bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden"
       data-aos="zoom-in"
       data-aos-delay="100">
    <div class="absolute top-3 right-3 flex gap-2 z-10">
      <button id="pomoSettingsBtn" 
              class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
        <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
      </button>
      <button id="closePomoBtn" 
              class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>
    <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize opacity-0 hover:opacity-100 transition-opacity"></div>
    
    <div class="p-6">
      <h3 class="text-2xl font-bold mb-6 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Pomodoro Timer</h3>
      
      <div class="relative flex items-center justify-center mb-6">
        <svg class="pomo-progress-ring w-48 h-48 -rotate-90" viewBox="0 0 180 180">
          <defs>
            <linearGradient id="pomoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#8B5CF6;stop-opacity:1" />
              <stop offset="50%" style="stop-color:#EC4899;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#3B82F6;stop-opacity:1" />
            </linearGradient>
          </defs>
          <circle class="stroke-gray-200 dark:stroke-gray-700" cx="90" cy="90" r="75" stroke-width="8" fill="none" />
          <circle class="pomo-progress-bar" cx="90" cy="90" r="75" id="pomoProgressCircle" stroke="url(#pomoGradient)" stroke-width="8" fill="none" stroke-linecap="round" />
        </svg>
        <div class="absolute inset-0 flex flex-col items-center justify-center">
          <div id="pomoMode" class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-2">Focus</div>
          <div id="floatingPomoTime" class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">60:00</div>
          <div class="flex items-center gap-3 mt-4">
            <button id="floatingPomoStart" 
                    class="p-3 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-110">
              <i data-lucide="play" class="w-6 h-6"></i>
            </button>
            <button id="floatingPomoReset" 
                    class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300">
              <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div class="flex gap-2 bg-gray-100 dark:bg-gray-700 rounded-xl p-1">
        <button class="pomo-mode-btn flex-1 py-2 px-3 rounded-lg font-medium text-sm transition-all duration-300 active bg-white dark:bg-gray-800 shadow-md" 
                id="pomoFocusBtn" data-mode="focus">
          <i data-lucide="brain" class="w-4 h-4 inline mr-1"></i>Focus
        </button>
        <button class="pomo-mode-btn flex-1 py-2 px-3 rounded-lg font-medium text-sm transition-all duration-300 hover:bg-white/50 dark:hover:bg-gray-800/50" 
                id="pomoBreakBtn" data-mode="break">
          <i data-lucide="coffee" class="w-4 h-4 inline mr-1"></i>Break
        </button>
        <button class="pomo-mode-btn flex-1 py-2 px-3 rounded-lg font-medium text-sm transition-all duration-300 hover:bg-white/50 dark:hover:bg-gray-800/50" 
                id="pomoLongBreakBtn" data-mode="longbreak">
          <i data-lucide="sunset" class="w-4 h-4 inline mr-1"></i>Long
        </button>
      </div>
    </div>
  </div>

  <!-- Modern Floating Ambient Sounds Widget -->
  <div id="floatingAmbient" 
       class="absolute top-20 left-1/2 -translate-x-1/2 w-[500px] max-w-[90vw] bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700"
       data-aos="fade-down"
       data-aos-delay="200">
    <div class="absolute top-3 right-3 flex gap-2 z-10">
      <button id="ambientSettingsBtn" 
              class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
        <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
      </button>
      <button id="closeAmbientBtn" 
              class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>
    <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize opacity-0 hover:opacity-100 transition-opacity"></div>
    
    <div class="p-6">
      <div class="flex items-center gap-3 mb-6">
        <div class="p-3 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600">
          <i data-lucide="music" class="w-6 h-6 text-white"></i>
        </div>
        <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Ambient Sounds</h2>
      </div>
      
      <div class="flex gap-2 mb-4">
        <button id="stopAllSoundsBtn" 
                class="px-4 py-2 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/30 transition-all duration-300 font-medium">
          <i data-lucide="stop-circle" class="w-4 h-4 inline mr-2"></i>Stop All
        </button>
        <button id="randomMixBtn" 
                class="px-4 py-2 rounded-lg bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-all duration-300 font-medium">
          <i data-lucide="shuffle" class="w-4 h-4 inline mr-2"></i>Random Mix
        </button>
      </div>
      
      <div id="ambientSoundsGrid" class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <!-- Sound cards will be generated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Modern Floating Todo List -->
  <div id="floatingTodo" 
       class="absolute bottom-20 right-20 w-96 max-h-[600px] bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden"
       data-aos="fade-up"
       data-aos-delay="300">
    <div class="absolute top-3 right-3 flex gap-2 z-10">
      <button id="todoSettingsBtn" 
              class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
        <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
      </button>
      <button id="closeTodoBtn" 
              class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>
    <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-nwse-resize opacity-0 hover:opacity-100 transition-opacity"></div>
    
    <div class="p-6 flex-shrink-0">
      <div class="flex items-center gap-3 mb-6">
        <div class="p-3 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600">
          <i data-lucide="check-square" class="w-6 h-6 text-white"></i>
        </div>
        <h2 class="text-2xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">To-Do List</h2>
      </div>
      
      <div class="flex gap-2">
        <input type="text" 
               id="todoInput" 
               class="flex-1 px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-green-500 focus:bg-white dark:focus:bg-gray-800 transition-all duration-300 outline-none" 
               placeholder="Add a new task..." />
        <button id="todoAddBtn" 
                class="px-6 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
          <i data-lucide="plus" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
    
    <div id="todoList" class="flex-1 overflow-y-auto px-6 pb-6 space-y-2">
      <!-- Todo items will be added here -->
    </div>
  </div>

<!-- Modern Floating Countdown Widget -->
<div id="floatingCountdown" 
     class="absolute bottom-20 left-20 w-[450px] max-h-[600px] bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden"
     data-aos="fade-up"
     data-aos-delay="400">
  <div class="absolute top-3 right-3 flex gap-2 z-10">
    <button id="countdownSettingsBtn" 
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
      <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
    </button>
    <button id="closeCountdownBtn" 
            class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
      <i data-lucide="x" class="w-4 h-4"></i>
    </button>
  </div>
  <div class="resize-handle"></div>
  
  <div class="p-6 flex-shrink-0">
    <div class="flex items-center gap-3 mb-6">
      <div class="p-3 rounded-xl bg-gradient-to-br from-orange-500 to-red-600">
        <i data-lucide="calendar-clock" class="w-6 h-6 text-white"></i>
      </div>
      <h2 class="text-2xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent">Countdowns</h2>
    </div>
    
    <div class="space-y-3">
      <input type="text" 
             id="countdownTitleInput" 
             class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-orange-500 focus:bg-white dark:focus:bg-gray-800 transition-all duration-300 outline-none" 
             placeholder="Event name..." />
      <input type="date" 
             id="countdownDateInput" 
             class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-orange-500 focus:bg-white dark:focus:bg-gray-800 transition-all duration-300 outline-none" />
      <button id="countdownAddBtn" 
              class="w-full px-6 py-3 rounded-xl bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
        <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>Add Countdown
      </button>
    </div>
  </div>
  
  <div id="countdownList" class="flex-1 overflow-y-auto px-6 pb-6 space-y-3">
    <!-- Countdown items will be added here -->
  </div>
</div>

<!-- Modern Floating Calculator Widget -->
<div id="floatingCalculator" 
     class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden"
     data-aos="zoom-in"
     data-aos-delay="500">
  <div class="absolute top-3 right-3 flex gap-2 z-10">
    <button id="calculatorSettingsBtn" 
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
      <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
    </button>
    <button id="closeCalculatorBtn" 
            class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
      <i data-lucide="x" class="w-4 h-4"></i>
    </button>
  </div>
  <div class="resize-handle"></div>
  
  <div class="p-6">
    <div class="flex items-center gap-3 mb-6">
      <div class="p-3 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600">
        <i data-lucide="calculator" class="w-6 h-6 text-white"></i>
      </div>
      <h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Calculator</h2>
    </div>
    
    <div id="calcDisplay" class="w-full h-20 px-6 py-4 mb-4 rounded-2xl bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 text-right text-3xl font-bold text-gray-800 dark:text-white shadow-inner flex items-center justify-end">0</div>
  
  <!-- Scientific buttons (hidden by default) -->
  <div class="calc-scientific-buttons" style="display:none;">
    <button class="calc-btn sci" data-calc="Math.sin">sin</button>
    <button class="calc-btn sci" data-calc="Math.cos">cos</button>
    <button class="calc-btn sci" data-calc="Math.tan">tan</button>
    <button class="calc-btn sci" data-calc="Math.log">log</button>
    
    <button class="calc-btn sci" data-calc="Math.sqrt">√</button>
    <button class="calc-btn sci" data-calc="^2">x²</button>
    <button class="calc-btn sci" data-calc="^">xʸ</button>
    <button class="calc-btn sci" data-calc="Math.PI">π</button>
    
    <button class="calc-btn sci" data-calc="Math.E">e</button>
    <button class="calc-btn sci" data-calc="1/">1/x</button>
    <button class="calc-btn sci" data-calc="%">%</button>
    <button class="calc-btn sci" data-calc="!">n!</button>
  </div>
    
    <div class="grid grid-cols-4 gap-2">
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 font-bold text-lg transition-all duration-200 transform active:scale-95" data-calc="C">C</button>
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="(">(</button>
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc=")">)</button>
      <button class="calc-btn operator col-span-1 p-4 rounded-xl bg-indigo-100 dark:bg-indigo-900/30 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 font-bold text-lg transition-all duration-200 transform active:scale-95" data-calc="/">÷</button>
      
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="7">7</button>
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="8">8</button>
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="9">9</button>
      <button class="calc-btn operator col-span-1 p-4 rounded-xl bg-indigo-100 dark:bg-indigo-900/30 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 font-bold text-lg transition-all duration-200 transform active:scale-95" data-calc="*">×</button>
      
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="4">4</button>
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="5">5</button>
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="6">6</button>
      <button class="calc-btn operator col-span-1 p-4 rounded-xl bg-indigo-100 dark:bg-indigo-900/30 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 font-bold text-lg transition-all duration-200 transform active:scale-95" data-calc="-">−</button>
      
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="1">1</button>
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="2">2</button>
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="3">3</button>
      <button class="calc-btn operator col-span-1 p-4 rounded-xl bg-indigo-100 dark:bg-indigo-900/30 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400 font-bold text-lg transition-all duration-200 transform active:scale-95" data-calc="+">+</button>
      
      <button class="calc-btn col-span-2 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc="0">0</button>
      <button class="calc-btn col-span-1 p-4 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 font-semibold text-lg transition-all duration-200 transform active:scale-95" data-calc=".">.</button>
      <button class="calc-btn equals col-span-1 p-4 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold text-xl shadow-lg hover:shadow-xl transition-all duration-200 transform active:scale-95" data-calc="=">=</button>
    </div>
  </div>
</div>

<!-- Modern Floating Events Widget -->
<div id="floatingEvents" 
     class="absolute top-20 left-1/3 w-[500px] max-h-[700px] bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden"
     data-aos="fade-down"
     data-aos-delay="350">
  <div class="absolute top-3 right-3 flex gap-2 z-10">
    <button id="eventsSettingsBtn" 
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
      <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
    </button>
    <button id="closeEventsBtn" 
            class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
      <i data-lucide="x" class="w-4 h-4"></i>
    </button>
  </div>
  <div class="resize-handle"></div>
  
  <div class="p-6 flex-shrink-0">
    <div class="flex items-center gap-3 mb-6">
      <div class="p-3 rounded-xl bg-gradient-to-br from-pink-500 to-rose-600">
        <i data-lucide="calendar-days" class="w-6 h-6 text-white"></i>
      </div>
      <h2 class="text-2xl font-bold bg-gradient-to-r from-pink-600 to-rose-600 bg-clip-text text-transparent">Events</h2>
      <span id="selectedDateBadge" class="ml-auto px-3 py-1 rounded-full bg-pink-100 dark:bg-pink-900/30 text-pink-600 dark:text-pink-400 text-sm font-medium cursor-pointer hover:bg-pink-200 dark:hover:bg-pink-900/50 transition-all" title="Click to show all events"></span>
    </div>
    
    <div class="space-y-3 mb-4">
      <input type="date" 
             id="eventDateInput" 
             class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-pink-500 focus:bg-white dark:focus:bg-gray-800 transition-all duration-300 outline-none" />
      <input type="text" 
             id="eventTextInput" 
             class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-pink-500 focus:bg-white dark:focus:bg-gray-800 transition-all duration-300 outline-none" 
             placeholder="Event description..." />
      <div class="flex gap-2">
        <button id="eventAddBtn" 
                class="flex-1 px-6 py-3 rounded-xl bg-gradient-to-r from-pink-500 to-rose-600 hover:from-pink-600 hover:to-rose-700 text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
          <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>Add Event
        </button>
        <button id="showAllEventsBtn" 
                class="px-4 py-3 rounded-xl bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 font-medium transition-all duration-300">
          <i data-lucide="list" class="w-5 h-5 inline"></i>
        </button>
      </div>
    </div>
  </div>
  
  <div id="eventsList" class="flex-1 overflow-y-auto px-6 pb-6 space-y-2">
    <!-- Events will be added here -->
  </div>
</div>

<!-- Modern Floating Calendar Widget -->
<div id="floatingCalendar" 
     class="absolute top-40 left-40 w-[900px] max-w-[90vw] max-h-[85vh] bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden"
     data-aos="zoom-in-up"
     data-aos-delay="250">
  <div class="absolute top-3 right-3 flex gap-2 z-10">
    <button id="calendarSettingsBtn" 
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
      <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
    </button>
    <button id="closeCalendarBtn" 
            class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
      <i data-lucide="x" class="w-4 h-4"></i>
    </button>
  </div>
  <div class="resize-handle"></div>
  
  <div class="p-6 flex-shrink-0 border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="p-3 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600">
          <i data-lucide="calendar" class="w-6 h-6 text-white"></i>
        </div>
        <h1 id="year" class="text-3xl font-bold bg-gradient-to-r from-cyan-600 to-blue-600 bg-clip-text text-transparent">Calendar 2026</h1>
      </div>
      
      <div class="flex items-center gap-2">
        <button id="todayBtn" 
                class="px-4 py-2 rounded-lg bg-cyan-100 dark:bg-cyan-900/30 text-cyan-600 dark:text-cyan-400 hover:bg-cyan-200 dark:hover:bg-cyan-900/50 font-medium transition-all duration-300">
          <i data-lucide="pin" class="w-4 h-4 inline mr-2"></i>Today
        </button>
        <button id="monthToggleBtn" 
                class="px-4 py-2 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-900/50 font-medium transition-all duration-300">
          <i data-lucide="layout-grid" class="w-4 h-4 inline mr-2"></i>Year View
        </button>
        <button id="prev" 
                class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300">
          <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>
        <button id="next" 
                class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300">
          <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
  </div>
  
  <div id="calendar" class="flex-1 overflow-y-auto p-6">
    <!-- Calendar grid will be generated here -->
  </div>
</div>

<!-- Modern Floating Notes Widget -->
<div id="floatingNotes" 
     class="absolute top-60 right-60 w-[600px] h-[500px] bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden"
     data-aos="flip-left"
     data-aos-delay="300">
  <div class="absolute top-3 right-3 flex gap-2 z-10">
    <button id="notesSettingsBtn" 
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
      <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
    </button>
    <button id="closeNotesBtn" 
            class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
      <i data-lucide="x" class="w-4 h-4"></i>
    </button>
  </div>
  <div class="resize-handle"></div>
  
  <div class="p-6 flex-shrink-0 border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="p-3 rounded-xl bg-gradient-to-br from-amber-500 to-yellow-600">
          <i data-lucide="sticky-note" class="w-6 h-6 text-white"></i>
        </div>
        <h2 class="text-2xl font-bold bg-gradient-to-r from-amber-600 to-yellow-600 bg-clip-text text-transparent">Notes</h2>
        <div id="syncStatus" class="ml-2 px-3 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-xs font-medium text-gray-500 dark:text-gray-400">
          <i data-lucide="cloud-off" class="w-3 h-3 inline mr-1"></i>Not signed in
        </div>
      </div>
      
      <div class="notes-tools flex gap-1">
        <button data-cmd="bold" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200" title="Bold">
          <i data-lucide="bold" class="w-4 h-4"></i>
        </button>
        <button data-cmd="italic" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200" title="Italic">
          <i data-lucide="italic" class="w-4 h-4"></i>
        </button>
        <button data-cmd="underline" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200" title="Underline">
          <i data-lucide="underline" class="w-4 h-4"></i>
        </button>
        <button data-cmd="insertUnorderedList" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200" title="List">
          <i data-lucide="list" class="w-4 h-4"></i>
        </button>
      </div>
    </div>
  </div>
  
  <div id="notesEditor" 
       class="flex-1 overflow-y-auto px-6 py-4 focus:outline-none text-base leading-relaxed" 
       contenteditable="true" 
       placeholder="Start typing your notes...">
  </div>
</div>

<!-- Modern Web Browser Widget -->
<div id="floatingWebBrowser" 
     class="absolute bottom-40 left-1/3 w-[800px] h-[600px] bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden"
     data-aos="fade-up"
     data-aos-delay="450">
  <div class="absolute top-3 right-3 flex gap-2 z-10">
    <button id="webBrowserSettingsBtn" 
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
      <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
    </button>
    <button id="closeWebBrowserBtn" 
            class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
      <i data-lucide="x" class="w-4 h-4"></i>
    </button>
  </div>
  <div class="resize-handle"></div>
  
  <div class="p-4 flex-shrink-0 border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center gap-3 mb-4">
      <div class="p-3 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600">
        <i data-lucide="globe" class="w-6 h-6 text-white"></i>
      </div>
      <h2 class="text-2xl font-bold bg-gradient-to-r from-violet-600 to-purple-600 bg-clip-text text-transparent">Web Browser</h2>
    </div>
    
    <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 rounded-xl p-2">
      <button id="browserBackBtn" 
              class="p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-all duration-200 disabled:opacity-30 disabled:cursor-not-allowed" 
              title="Back" disabled>
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
      </button>
      <button id="browserForwardBtn" 
              class="p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-all duration-200 disabled:opacity-30 disabled:cursor-not-allowed" 
              title="Forward" disabled>
        <i data-lucide="arrow-right" class="w-4 h-4"></i>
      </button>
      <button id="browserRefreshBtn" 
              class="p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-all duration-200" 
              title="Refresh">
        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
      </button>
      <button id="browserHomeBtn" 
              class="p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-all duration-200" 
              title="Home">
        <i data-lucide="home" class="w-4 h-4"></i>
      </button>
      <input type="text" 
             id="browserUrlInput" 
             placeholder="Enter URL or search..." 
             class="flex-1 px-4 py-2 rounded-lg bg-white dark:bg-gray-600 border-2 border-transparent focus:border-violet-500 transition-all duration-300 outline-none">
      <button id="browserGoBtn" 
              class="px-4 py-2 rounded-lg bg-gradient-to-r from-violet-500 to-purple-600 hover:from-violet-600 hover:to-purple-700 text-white font-semibold transition-all duration-300" 
              title="Go">
        <i data-lucide="arrow-right" class="w-4 h-4"></i>
      </button>
      <button id="browserNewTabBtn" 
              class="p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-all duration-200" 
              title="New Instance">
        <i data-lucide="external-link" class="w-4 h-4"></i>
      </button>
      <button id="browserBookmarkBtn" 
              class="p-2 rounded-lg hover:bg-white dark:hover:bg-gray-600 transition-all duration-200" 
              title="Bookmark">
        <i data-lucide="star" class="w-4 h-4"></i>
      </button>
    </div>
  </div>
  
  <div id="browserBookmarks" class="hidden px-4 py-2 bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700 flex gap-2 flex-wrap">
    <!-- Bookmarks will be added here -->
  </div>
  
  <div class="flex-1 relative bg-gray-50 dark:bg-gray-900">
    <iframe id="browserIframe" 
            class="w-full h-full border-0" 
            sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-top-navigation allow-modals allow-downloads" 
            allowfullscreen></iframe>
    <div id="browserErrorOverlay" class="absolute inset-0 hidden items-center justify-center bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm">
      <div class="text-center p-8 max-w-md">
        <div class="mb-4">
          <i data-lucide="alert-circle" class="w-16 h-16 mx-auto text-red-500"></i>
        </div>
        <h3 class="text-xl font-bold mb-2">Can't Display This Page</h3>
        <p id="browserErrorMessage" class="text-gray-600 dark:text-gray-400 mb-6">This website cannot be displayed in an iframe due to security restrictions.</p>
        <div class="flex gap-3 justify-center">
          <button id="browserOpenNewTabError" 
                  class="px-6 py-3 rounded-xl bg-gradient-to-r from-violet-500 to-purple-600 hover:from-violet-600 hover:to-purple-700 text-white font-semibold shadow-lg hover:shadow-xl transition-all duration-300">
            <i data-lucide="external-link" class="w-4 h-4 inline mr-2"></i>Open Externally
          </button>
          <button id="browserTryAgain" 
                  class="px-6 py-3 rounded-xl bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 font-semibold transition-all duration-300">
            Try Again
          </button>
        </div>
        <small class="block mt-4 text-gray-500 dark:text-gray-400">
          Many sites like Google, Facebook, and YouTube block iframe embedding for security.<br>
          <strong>Try the Popular Sites section below for guaranteed compatibility!</strong>
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Modern Canvas Manager Widget -->
<div id="canvasManager" 
     class="absolute top-1/3 right-1/4 w-[550px] max-h-[600px] bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden"
     data-aos="flip-right"
     data-aos-delay="500">
  <div class="absolute top-3 right-3 flex gap-2 z-10">
    <button id="canvasManagerSettingsBtn" 
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300 group">
      <i data-lucide="settings" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-300"></i>
    </button>
    <button id="closeCanvasManagerBtn" 
            class="p-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 transition-all duration-300">
      <i data-lucide="x" class="w-4 h-4"></i>
    </button>
  </div>
  <div class="resize-handle"></div>
  
  <div class="p-6">
    <div class="flex items-center gap-3 mb-6">
      <div class="p-3 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600">
        <i data-lucide="layout-dashboard" class="w-6 h-6 text-white"></i>
      </div>
      <h2 class="text-2xl font-bold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent">Canvas Manager</h2>
    </div>
    
    <div id="canvasTabsContainer" class="grid grid-cols-2 gap-3">
      <!-- Canvas tabs will be rendered here by JavaScript -->
    </div>
  </div>
</div>

</div><!-- End Canvas Workspace -->

<!-- Modern App Drawer Overlay -->
<div id="appDrawer" class="fixed inset-0 z-[9999] hidden">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="document.getElementById('appDrawer').classList.add('hidden')"></div>
  <div class="absolute top-16 left-1/2 -translate-x-1/2 w-[600px] max-w-[90vw] max-h-[80vh] bg-white/95 dark:bg-gray-800/95 backdrop-blur-xl rounded-3xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden animate__animated animate__fadeInDown">
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-3">
        <div class="p-3 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600">
          <i data-lucide="grid-3x3" class="w-6 h-6 text-white"></i>
        </div>
        <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Apps</h2>
      </div>
    </div>
    
    <div class="p-6 overflow-y-auto max-h-[calc(80vh-100px)]">
      <div class="grid grid-cols-1 gap-2">\n        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="calendar">
          <div class="p-3 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="calendar" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">Calendar</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Full year view</div>
          </div>
          <div class="app-toggle" id="toggleCalendarApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="clock">
          <div class="p-3 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="clock" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">Analog Clock</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Live time display</div>
          </div>
          <div class="app-toggle" id="toggleClockApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="pomodoro">
          <div class="p-3 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="timer" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">Pomodoro Timer</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Focus timer</div>
          </div>
          <div class="app-toggle" id="togglePomoApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="todo">
          <div class="p-3 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="check-square" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">To-Do List</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Task management</div>
          </div>
          <div class="app-toggle" id="toggleTodoApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="countdown">
          <div class="p-3 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="calendar-clock" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">Countdown</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Track events</div>
          </div>
          <div class="app-toggle" id="toggleCountdownApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="events">
          <div class="p-3 rounded-xl bg-gradient-to-br from-pink-500 to-rose-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="calendar-days" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">Events</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Track events</div>
          </div>
          <div class="app-toggle" id="toggleEventsApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="calculator">
          <div class="p-3 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="calculator" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">Calculator</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Quick calculations</div>
          </div>
          <div class="app-toggle" id="toggleCalculatorApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="notes">
          <div class="p-3 rounded-xl bg-gradient-to-br from-amber-500 to-yellow-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="sticky-note" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">Notes</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Quick notes</div>
          </div>
          <div class="app-toggle" id="toggleNotesApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="webBrowser">
          <div class="p-3 rounded-xl bg-gradient-to-br from-violet-500 to-purple-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="globe" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">Web Browser</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Browse the web</div>
          </div>
          <div class="app-toggle" id="toggleWebBrowserApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="canvasManager">
          <div class="p-3 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="layout-dashboard" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">Canvas Manager</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Manage canvases</div>
          </div>
          <div class="app-toggle" id="toggleCanvasManagerApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="ambientSounds">
          <div class="p-3 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="music" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">Ambient Sounds</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Focus & relax</div>
          </div>
          <div class="app-toggle" id="toggleAmbientApp"></div>
        </div>
        
        <div class="app-item group flex items-center gap-4 p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-300 cursor-pointer" data-app="appStore">
          <div class="p-3 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 group-hover:scale-110 transition-transform duration-300">
            <i data-lucide="shopping-bag" class="w-6 h-6 text-white"></i>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-gray-900 dark:text-white">App Store</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">Browse & install apps</div>
          </div>
          <div class="app-toggle" id="toggleAppStoreApp"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     SETTINGS PAGE (OVERLAY)
     ========================= -->
<div id="settingsPage" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.25);backdrop-filter:blur(4px);">
    <div id="settingsContainer" style="max-width:420px;margin:4rem auto;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-float); max-height: 90vh; overflow-y: auto;">
    
    <!-- Main Settings View -->
    <div id="mainSettingsView">
      <h2 style="margin-top:0">Settings</h2>

      <!-- Appearance -->
      <div class="month" style="margin-bottom:1rem;">
        <h3>Appearance</h3>
        <p style="font-size:0.8rem;color:var(--muted)">Theme</p>
        <div id="settingsThemes" style="display:flex;gap:0.4rem;flex-wrap:wrap;"></div>

        <p style="font-size:0.8rem;color:var(--muted);margin-top:0.6rem">Font Size</p>
        <button class="font-btn" data-size="90">A−</button>
        <button class="font-btn" data-size="100">A</button>
        <button class="font-btn" data-size="110">A+</button>
      </div>

      <!-- Account -->
      <div class="month" style="margin-bottom:1rem;">
        <h3>Account</h3>
        
        <!-- Logged Out View -->
        <div id="loggedOutUI">
          <input type="email" id="emailInput" class="auth-input" placeholder="Email address">
          <input type="password" id="passwordInput" class="auth-input" placeholder="Password">
          
          <div style="display:flex; gap: 8px; margin-bottom: 12px;">
            <button id="loginBtn" class="today-btn" style="position:static; flex:1; justify-content:center;">Login</button>
            <button id="signupBtn" class="theme-btn" style="position:static; flex:1; justify-content:center;">Sign Up</button>
          </div>
          
          <button id="resetPasswordBtn" style="font-size: 0.7rem; color: var(--primary); text-decoration: underline; background: none; border: none; padding: 0; cursor: pointer;">Forgot Password?</button>
        </div>

        <!-- Logged In View -->
        <div id="loggedInUI" style="display:none;">
          <p id="userEmailDisplay" style="font-size: 0.8rem; margin-bottom: 12px;"></p>
          <button id="logoutBtn" class="today-btn" style="position:static; background: linear-gradient(180deg, #ff3b30, #d70015); width: 100%; justify-content: center;">Sign Out</button>
        </div>

        <p style="font-size:0.75rem;color:var(--muted); margin-top: 12px;">Sync notes across devices</p>
      </div>

      <!-- Dynamic Island -->
      <div class="month" style="margin-bottom:1rem;">
        <h3>Dynamic Island</h3>
        <p style="font-size:0.8rem;color:var(--muted);margin-bottom:0.8rem;">Choose which apps to display in the header</p>
        
        <label class="settings-label">
          <span>Show Pomodoro Timer</span>
          <input type="checkbox" id="dynamicIslandShowPomodoro" checked>
        </label>
        
        <label class="settings-label">
          <span>Show Canvas Switcher</span>
          <input type="checkbox" id="dynamicIslandShowCanvas" checked>
        </label>
        
        <label class="settings-label">
          <span>Show Date/Time</span>
          <input type="checkbox" id="dynamicIslandShowDateTime" checked>
        </label>
        
        <label class="settings-label" style="margin-top:0.8rem;">
          <span>Additional Widget</span>
          <select id="dynamicIslandAdditionalWidget" class="settings-select">
            <option value="none">None</option>
            <option value="clock">🕒 Clock</option>
            <option value="countdown">⏰ Countdown</option>
            <option value="todo">✅ Todo</option>
            <option value="events">📅 Events</option>
          </select>
        </label>
      </div>

      <!-- About -->
      <div class="month" style="margin-bottom:1rem;">
        <h3>About</h3>
        <p style="font-size:0.75rem;color:var(--muted)">CANVAS - Multi-workspace productivity platform</p>
      </div>

      <!-- Apps Section (iOS Style) -->
      <div class="month">
        <h3>Apps</h3>
        <div class="settings-app-list">
          <div class="settings-app-item" id="showAppsListBtn">
            <span class="settings-app-icon">📱</span>
            <span class="settings-app-name">Apps</span>
            <span class="settings-app-chevron">›</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Apps List View -->
    <div id="appsListView" style="display:none;">
      <button id="backToSettingsFromApps" class="settings-back-btn">‹ Settings</button>
      
      <h2 style="margin-top:0">Apps</h2>
      <div class="settings-app-list" id="appsListContainer">
        <div class="settings-app-item" data-app="clock">
          <span class="settings-app-icon">🕒</span>
          <span class="settings-app-name">Clock</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="pomodoro">
          <span class="settings-app-icon">🍅</span>
          <span class="settings-app-name">Pomodoro</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="todo">
          <span class="settings-app-icon">✅</span>
          <span class="settings-app-name">Todo</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="countdown">
          <span class="settings-app-icon">⏰</span>
          <span class="settings-app-name">Countdown</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="calculator">
          <span class="settings-app-icon">🔢</span>
          <span class="settings-app-name">Calculator</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="events">
          <span class="settings-app-icon">📅</span>
          <span class="settings-app-name">Events</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="calendar">
          <span class="settings-app-icon">📆</span>
          <span class="settings-app-name">Calendar</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="notes">
          <span class="settings-app-icon">📝</span>
          <span class="settings-app-name">Notes</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="webBrowser">
          <span class="settings-app-icon">🌐</span>
          <span class="settings-app-name">Web Browser</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="canvas">
          <span class="settings-app-icon">📑</span>
          <span class="settings-app-name">Canvas Manager</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="ambient">
          <span class="settings-app-icon">🎵</span>
          <span class="settings-app-name">Ambient Sounds</span>
          <span class="settings-app-chevron">›</span>
        </div>
        <div class="settings-app-item" data-app="appStore">
          <span class="settings-app-icon">🛍️</span>
          <span class="settings-app-name">App Store</span>
          <span class="settings-app-chevron">›</span>
        </div>
      </div>
    </div>

    <!-- App Settings Views -->
    <div id="appSettingsView" style="display:none;">
      <button id="backToSettings" class="settings-back-btn">‹ Settings</button>
      
      <!-- Clock Settings -->
      <div id="clockAppSettings" class="app-settings-detail" style="display:none;">
        <h2>🕒 Clock</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Show Seconds Hand</span>
            <input type="checkbox" id="clockShowSeconds" checked>
          </label>
          <label class="settings-label">
            <span>24-Hour Format</span>
            <input type="checkbox" id="clockShow24Hour">
          </label>
          <label class="settings-label">
            <span>Clock Size</span>
            <select id="clockSize" class="settings-select">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Clock Face Color</span>
            <select id="clockColor" class="settings-select">
              <option value="default" selected>Default</option>
              <option value="blue">Blue</option>
              <option value="green">Green</option>
              <option value="red">Red</option>
              <option value="gold">Gold</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Show Date</span>
            <input type="checkbox" id="clockShowDate" checked>
          </label>
        </div>
      </div>

      <!-- Pomodoro Settings -->
      <div id="pomodoroAppSettings" class="app-settings-detail" style="display:none;">
        <h2>🍅 Pomodoro</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Focus Duration (minutes)</span>
            <input type="number" id="pomoFocusDuration" min="1" max="120" value="25" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Short Break (minutes)</span>
            <input type="number" id="pomoBreakDuration" min="1" max="60" value="5" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Long Break (minutes)</span>
            <input type="number" id="pomoLongBreak" min="1" max="60" value="15" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Sessions before long break</span>
            <input type="number" id="pomoSessionsBeforeLongBreak" min="1" max="10" value="4" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Auto-start next session</span>
            <input type="checkbox" id="pomoAutoStart">
          </label>
          <label class="settings-label">
            <span>Play sound on completion</span>
            <input type="checkbox" id="pomoSound" checked>
          </label>
          <label class="settings-label">
            <span>Desktop notifications</span>
            <input type="checkbox" id="pomoNotifications" checked>
          </label>
        </div>
      </div>

      <!-- Todo Settings -->
      <div id="todoAppSettings" class="app-settings-detail" style="display:none;">
        <h2>✅ Todo</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Show completed tasks</span>
            <input type="checkbox" id="todoShowCompleted" checked>
          </label>
          <label class="settings-label">
            <span>Auto-sort by priority</span>
            <input type="checkbox" id="todoAutoSort">
          </label>
          <label class="settings-label">
            <span>Show priority colors</span>
            <input type="checkbox" id="todoShowPriorityColors" checked>
          </label>
          <label class="settings-label">
            <span>Confirm before delete</span>
            <input type="checkbox" id="todoConfirmDelete" checked>
          </label>
          <label class="settings-label">
            <span>Default Priority</span>
            <select id="todoDefaultPriority" class="settings-select">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Task limit per day</span>
            <input type="number" id="todoMaxTasks" min="5" max="100" value="50" class="settings-input">
          </label>
          <button id="todoClearCompleted" class="settings-action-btn">Clear Completed</button>
        </div>
      </div>

      <!-- Calculator Settings -->
      <div id="calculatorAppSettings" class="app-settings-detail" style="display:none;">
        <h2>🔢 Calculator</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Scientific Mode</span>
            <input type="checkbox" id="calcScientificMode">
          </label>
          <label class="settings-label">
            <span>Decimal Places</span>
            <input type="number" id="calcDecimalPlaces" min="0" max="10" value="2" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Use thousands separator</span>
            <input type="checkbox" id="calcThousandsSeparator" checked>
          </label>
          <label class="settings-label">
            <span>Button click sound</span>
            <input type="checkbox" id="calcButtonSound">
          </label>
          <label class="settings-label">
            <span>History size</span>
            <input type="number" id="calcHistorySize" min="5" max="100" value="20" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Theme</span>
            <select id="calcTheme" class="settings-select">
              <option value="default" selected>Default</option>
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="colorful">Colorful</option>
            </select>
          </label>
          <button id="calcClearHistory" class="settings-action-btn">Clear History</button>
        </div>
      </div>

      <!-- Events Settings -->
      <div id="eventsAppSettings" class="app-settings-detail" style="display:none;">
        <h2>📅 Events</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Show past events</span>
            <input type="checkbox" id="eventsShowPast" checked>
          </label>
          <label class="settings-label">
            <span>Enable notifications</span>
            <input type="checkbox" id="eventsNotifications">
          </label>
          <label class="settings-label">
            <span>Reminder time (minutes before)</span>
            <select id="eventsReminderTime" class="settings-select">
              <option value="0">At event time</option>
              <option value="5">5 minutes</option>
              <option value="15" selected>15 minutes</option>
              <option value="30">30 minutes</option>
              <option value="60">1 hour</option>
              <option value="1440">1 day</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Compact view</span>
            <input type="checkbox" id="eventsCompactView">
          </label>
          <label class="settings-label">
            <span>Default View</span>
            <select id="eventsDefaultView" class="settings-select">
              <option value="all" selected>All Events</option>
              <option value="today">Today Only</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Sort By</span>
            <select id="eventsSortOrder" class="settings-select">
              <option value="date" selected>Date</option>
              <option value="created">Created</option>
              <option value="title">Title</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Countdown Settings -->
      <div id="countdownAppSettings" class="app-settings-detail" style="display:none;">
        <h2>⏰ Countdown</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Show past countdowns</span>
            <input type="checkbox" id="countdownShowPast">
          </label>
          <label class="settings-label">
            <span>Enable notifications</span>
            <input type="checkbox" id="countdownNotifications" checked>
          </label>
          <label class="settings-label">
            <span>Notify when countdown reaches zero</span>
            <input type="checkbox" id="countdownNotifyZero" checked>
          </label>
          <label class="settings-label">
            <span>Default time format</span>
            <select id="countdownTimeFormat" class="settings-select">
              <option value="short" selected>Short (2d 5h 30m)</option>
              <option value="long">Long (2 days, 5 hours, 30 minutes)</option>
              <option value="compact">Compact (2:05:30:15)</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Sort by</span>
            <select id="countdownSortOrder" class="settings-select">
              <option value="date" selected>Date (soonest first)</option>
              <option value="created">Created</option>
              <option value="name">Name</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Show emoji icons</span>
            <input type="checkbox" id="countdownShowEmoji" checked>
          </label>
          <label class="settings-label">
            <span>Auto-delete expired countdowns</span>
            <input type="checkbox" id="countdownAutoDelete">
          </label>
          <button id="countdownClearAll" class="settings-action-btn">Clear All Countdowns</button>
        </div>
      </div>

      <!-- Calendar Settings -->
      <div id="calendarAppSettings" class="app-settings-detail" style="display:none;">
        <h2>📆 Calendar</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Start Week On</span>
            <select id="calendarWeekStart" class="settings-select">
              <option value="0" selected>Sunday</option>
              <option value="1">Monday</option>
              <option value="6">Saturday</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Show week numbers</span>
            <input type="checkbox" id="calendarShowWeekNumbers">
          </label>
          <label class="settings-label">
            <span>Highlight weekends</span>
            <input type="checkbox" id="calendarHighlightWeekends" checked>
          </label>
          <label class="settings-label">
            <span>Show today indicator</span>
            <input type="checkbox" id="calendarShowToday" checked>
          </label>
          <label class="settings-label">
            <span>Show holidays</span>
            <input type="checkbox" id="calendarShowHolidays" checked>
          </label>
          <label class="settings-label">
            <span>Compact month view</span>
            <input type="checkbox" id="calendarCompactView">
          </label>
          <label class="settings-label">
            <span>Default View</span>
            <select id="calendarDefaultView" class="settings-select">
              <option value="month" selected>Month</option>
              <option value="year">Year</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Notes Settings -->
      <div id="notesAppSettings" class="app-settings-detail" style="display:none;">
        <h2>📝 Notes</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Font Size</span>
            <select id="notesFontSize" class="settings-select">
              <option value="12px">Small</option>
              <option value="14px" selected>Medium</option>
              <option value="16px">Large</option>
              <option value="18px">Extra Large</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Font Family</span>
            <select id="notesFontFamily" class="settings-select">
              <option value="system-ui" selected>System</option>
              <option value="monospace">Monospace</option>
              <option value="serif">Serif</option>
              <option value="'Comic Sans MS', cursive">Comic Sans</option>
              <option value="'Georgia', serif">Georgia</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Line Height</span>
            <select id="notesLineHeight" class="settings-select">
              <option value="1.2">Compact</option>
              <option value="1.5">Normal</option>
              <option value="1.8" selected>Comfortable</option>
              <option value="2.0">Spacious</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Word wrap</span>
            <input type="checkbox" id="notesWordWrap" checked>
          </label>
          <label class="settings-label">
            <span>Auto-save</span>
            <input type="checkbox" id="notesAutoSave" checked>
          </label>
          <label class="settings-label">
            <span>Spell check</span>
            <input type="checkbox" id="notesSpellCheck" checked>
          </label>
          <label class="settings-label">
            <span>Auto-save interval (seconds)</span>
            <input type="number" id="notesAutoSaveInterval" min="5" max="300" value="30" class="settings-input">
          </label>
        </div>
      </div>

      <!-- Web Browser Settings -->
      <div id="webBrowserAppSettings" class="app-settings-detail" style="display:none;">
        <h2>🌐 Web Browser</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Home page URL</span>
            <input type="text" id="browserHomePage" placeholder="https://wikipedia.org" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Default zoom level</span>
            <select id="browserZoom" class="settings-select">
              <option value="0.75">75%</option>
              <option value="0.9">90%</option>
              <option value="1" selected>100%</option>
              <option value="1.1">110%</option>
              <option value="1.25">125%</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Search engine</span>
            <select id="browserSearchEngine" class="settings-select">
              <option value="google" selected>Google</option>
              <option value="bing">Bing</option>
              <option value="duckduckgo">DuckDuckGo</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Allow JavaScript</span>
            <input type="checkbox" id="browserAllowJS" checked>
          </label>
          <label class="settings-label">
            <span>Allow forms</span>
            <input type="checkbox" id="browserAllowForms" checked>
          </label>
          <label class="settings-label">
            <span>Allow popups</span>
            <input type="checkbox" id="browserAllowPopups" checked>
          </label>
          <label class="settings-label">
            <span>Show bookmarks bar</span>
            <input type="checkbox" id="browserShowBookmarks" checked>
          </label>
          <button id="browserClearHistory" class="settings-button" style="margin-top:1rem;">Clear History</button>
          <button id="browserClearBookmarks" class="settings-button" style="margin-top:0.5rem;">Clear All Bookmarks</button>
        </div>
      </div>

      <!-- Canvas Manager Settings -->
      <div id="canvasAppSettings" class="app-settings-detail" style="display:none;">
        <h2>📑 Canvas Manager</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Max Canvases</span>
            <input type="number" id="canvasMaxCount" min="1" max="20" value="10" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Default brush size</span>
            <input type="number" id="canvasBrushSize" min="1" max="50" value="2" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Show grid</span>
            <input type="checkbox" id="canvasShowGrid">
          </label>
          <label class="settings-label">
            <span>Grid size (pixels)</span>
            <input type="number" id="canvasGridSize" min="10" max="100" value="20" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Auto-save canvas state</span>
            <input type="checkbox" id="canvasAutoSave" checked>
          </label>
          <label class="settings-label">
            <span>Auto-save interval (seconds)</span>
            <input type="number" id="canvasAutoSaveInterval" min="10" max="300" value="60" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Show hints</span>
            <input type="checkbox" id="canvasShowHints" checked>
          </label>
          <button id="canvasExportAll" class="settings-action-btn">Export All Canvases</button>
          <button id="canvasImportData" class="settings-action-btn">Import Canvases</button>
        </div>
      </div>

      <!-- Ambient Sounds Settings -->
      <div id="ambientAppSettings" class="app-settings-detail" style="display:none;">
        <h2>🎵 Ambient Sounds</h2>
        <div class="settings-group">
          <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.85rem;">
            Create custom ambient soundscapes by mixing different sounds together.
          </p>
          
          <label class="settings-label">
            <span>Master Volume</span>
            <input type="range" id="ambientMasterVolume" min="0" max="100" value="50" class="settings-slider">
            <span id="ambientMasterVolumeValue">50%</span>
          </label>
          
          <label class="settings-label">
            <span>Fade Duration (seconds)</span>
            <input type="number" id="ambientFadeDuration" min="0" max="5" step="0.5" value="0.5" class="settings-input">
          </label>
          
          <label class="settings-label">
            <span>Auto-play last mix on open</span>
            <input type="checkbox" id="ambientAutoPlay">
          </label>
          
          <label class="settings-label">
            <span>Show volume controls</span>
            <input type="checkbox" id="ambientShowVolume" checked>
          </label>
          
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
              <strong>Available Sounds:</strong>
            </p>
            <p style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6;">
              🌧️ Rain • ⛈️ Thunder • 💨 Wind • 🌲 Forest<br>
              🌊 Ocean • 🔥 Fire • ☕ Café • 📻 White Noise
            </p>
          </div>
          
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <p style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6;">
              <strong>Tips:</strong><br>
              • Click sound cards to play/stop<br>
              • Adjust individual volume sliders<br>
              • Use "Stop All" to silence everything<br>
              • Try "Random Mix" for instant ambiance
            </p>
          </div>
        </div>
      </div>

      <!-- App Store Settings -->
      <div id="appStoreAppSettings" class="app-settings-detail" style="display:none;">
        <h2>🛍️ App Store</h2>
        <div class="settings-group">
          <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.85rem;">
            Manage your app installations and store preferences.
          </p>
          
          <label class="settings-label">
            <span>Show featured apps badge</span>
            <input type="checkbox" id="appStoreShowFeatured" checked>
          </label>
          
          <label class="settings-label">
            <span>Show popular apps badge</span>
            <input type="checkbox" id="appStoreShowPopular" checked>
          </label>
          
          <label class="settings-label">
            <span>Default filter</span>
            <select id="appStoreDefaultFilter" class="settings-select">
              <option value="all" selected>All Apps</option>
              <option value="featured">Featured</option>
              <option value="popular">Popular</option>
              <option value="Productivity">Productivity</option>
              <option value="Utilities">Utilities</option>
              <option value="Lifestyle">Lifestyle</option>
              <option value="Internet">Internet</option>
            </select>
          </label>
          
          <label class="settings-label">
            <span>Show app ratings</span>
            <input type="checkbox" id="appStoreShowRatings" checked>
          </label>
          
          <label class="settings-label">
            <span>Show app reviews count</span>
            <input type="checkbox" id="appStoreShowReviews" checked>
          </label>
          
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
              <strong>Cloud Sync:</strong>
            </p>
            <p style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6;">
              Your installed apps are automatically synced across all devices when signed in.
            </p>
          </div>
          
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
              <strong>Available Categories:</strong>
            </p>
            <p style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6;">
              📊 Productivity • 🔧 Utilities • 🎨 Lifestyle • 🌐 Internet
            </p>
          </div>
        </div>
      </div>
    </div>

    <button id="closeSettings" class="theme-btn" style="position:absolute;top:0.8rem;right:0.8rem;">✕</button>
  </div>
</div>

<!-- Floating Notes Widget -->
<div id="floatingNotes" class="floating-notes">
  <button id="closeNotesBtn" class="close-widget-btn" title="Close Notes">✕</button>
  <div class="resize-handle"></div>
  <div class="notes-header">
    <div style="display:flex;align-items:center;gap:0.6rem;">
      <h2 style="margin:0">Notes</h2>
      <div id="syncStatus" style="font-size:0.75rem;color:var(--muted)">Not signed in</div>
    </div>
    <div class="notes-tools">
      <button data-cmd="bold"><b>B</b></button>
      <button data-cmd="italic"><i>I</i></button>
      <button data-cmd="underline"><u>U</u></button>
      <button data-cmd="insertUnorderedList">• List</button>
    </div>
  </div>
  <div id="notesEditor" class="notes-editor" contenteditable="true"></div>
</div>

</div><!-- End Canvas Workspace -->

<script>
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPage = document.getElementById('settingsPage');
  const closeSettings = document.getElementById('closeSettings');
  const notesEditor = document.getElementById('notesEditor');
  const toolButtons = document.querySelectorAll('.notes-tools button');

  function updateTime() {
    const d = new Date();
    const dtText = document.getElementById('dtText');
    if(dtText) {
      dtText.textContent = d.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' }) + ' • ' + d.toLocaleTimeString();
    }
  }

  toolButtons.forEach(b => b.onclick = () => {
    document.execCommand(b.dataset.cmd);
    updateToolStates();
  });

  function updateToolStates() {
    toolButtons.forEach(btn => {
      const cmd = btn.dataset.cmd;
      try {
        const isActive = document.queryCommandState(cmd);
        btn.classList.toggle('active', isActive);
      } catch (e) {}
    });
  }

  document.addEventListener('selectionchange', () => {
    if (document.activeElement === notesEditor) {
      updateToolStates();
    }
  });

  // Notes content is loaded and saved via Firebase (see bottom of file)
  // No localStorage usage for notes content to avoid conflicts

  // Font size controls
  const fontButtons = document.querySelectorAll('.font-btn');
  fontButtons.forEach(btn => {
    btn.onclick = () => {
      const size = btn.dataset.size;
      document.documentElement.style.fontSize = size + '%';
      localStorage.setItem('fontSize', size);
    };
  });

  const savedFontSize = localStorage.getItem('fontSize');
  if (savedFontSize) {
    document.documentElement.style.fontSize = savedFontSize + '%';
  }

  settingsBtn.onclick = () => { settingsPage.style.display = 'block'; };
  closeSettings.onclick = (e) => { e.stopPropagation(); settingsPage.style.display = 'none'; };

  settingsPage.addEventListener('click', (e) => {
    if (e.target === settingsPage) {
      settingsPage.style.display = 'none';
    }
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && settingsPage.style.display === 'block') {
      settingsPage.style.display = 'none';
    }
  });

  updateTime();
  setInterval(updateTime, 1000);

  const DEVICE_ID_KEY = 'device_id';
  let defaultPomoMinutes = 60; // Default value, will be updated from Firebase
  let defaultBreakMinutes = 5; // Default break duration
  let defaultLongBreakMinutes = 15; // Default long break duration
  let isBreakMode = false; // Track if in break or focus mode
  let isLongBreak = false; // Track if long break
  let secs = defaultPomoMinutes * 60;
  let timer = null; // local display tick interval
  let anchorStartMs = null; // when (ms) the session started (server/local)
  let anchorRemaining = null; // secs remaining at start
  let isApplyingRemote = false;
  let deviceId = localStorage.getItem(DEVICE_ID_KEY);
  if (!deviceId) {
    deviceId = Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(DEVICE_ID_KEY, deviceId);
  }
  // Make deviceId globally accessible
  window.deviceId = deviceId;

  const pomoDurationInput = document.getElementById('pomoFocusDuration');
  if (pomoDurationInput) {
    pomoDurationInput.value = defaultPomoMinutes;
  }

  function updatePomoDisplay() {
    const minStr = String(Math.floor(secs/60)).padStart(2,'0');
    const secStr = String(secs%60).padStart(2,'0');
    const timeText = `${minStr}:${secStr}`;
    const pt = document.getElementById('pomoTime');
    const fpt = document.getElementById('floatingPomoTime');
    const pomoMode = document.getElementById('pomoMode');
    const progressCircle = document.getElementById('pomoProgressCircle');
    
    if(pt) pt.textContent = timeText;
    if(fpt) fpt.textContent = timeText;
    if(pomoMode) pomoMode.textContent = isLongBreak ? 'Long Break' : (isBreakMode ? 'Break' : 'Focus');
    
    // Update progress circle
    let totalSecs;
    if (isLongBreak) {
      totalSecs = defaultLongBreakMinutes * 60;
    } else {
      totalSecs = isBreakMode ? (defaultBreakMinutes * 60) : (defaultPomoMinutes * 60);
    }
    const progress = (secs / totalSecs) * 100;
    const circumference = 2 * Math.PI * 75; // radius is 75
    const offset = circumference - (progress / 100) * circumference;
    
    if(progressCircle) {
      progressCircle.style.strokeDashoffset = offset;
    }
  }

  function saveLocalSecs() {
    // No longer saving to localStorage - using Firebase only
  }

  function setStartButtons(running) {
    const ps = document.getElementById('pomoStart');
    const fps = document.getElementById('floatingPomoStart');
    if (ps) ps.textContent = running ? '⏸' : '▶';
    if (fps) fps.textContent = running ? '⏸' : '▶';
  }

  async function syncToCloud(runningFlag, extra = {}) {
    try {
      if (!window.auth || !window.auth.currentUser) {
        console.log('[POMO] ⏸ Not syncing - user not authenticated');
        return;
      }
      if (!window.db || !window.doc || !window.setDoc || !window.serverTimestamp) {
        console.log('[POMO] ⏸ Not syncing - Firebase not ready');
        return;
      }
      const ref = window.doc(window.db, 'user_pomodoro', window.auth.currentUser.uid);
      await window.setDoc(ref, Object.assign({
        duration: defaultPomoMinutes,
        running: !!runningFlag,
        by: deviceId,
        updatedAt: window.serverTimestamp()
      }, extra), { merge: true });
      console.log('[POMO] ✅ Synced to cloud:', { running: runningFlag, ...extra });
    } catch (err) {
      console.error('[POMO] ❌ Cloud sync failed:', err);
    }
  }

  function clearLocalTimer() {
    if (timer) { clearInterval(timer); timer = null; }
  }

  function startLocalDisplayFromAnchor(remainAtStart, startedAtMs) {
    clearLocalTimer();
    anchorRemaining = remainAtStart;
    anchorStartMs = startedAtMs;
    setStartButtons(true);
    const tick = () => {
      const elapsed = Math.floor((Date.now() - anchorStartMs) / 1000);
      const left = Math.max(0, Math.round(anchorRemaining - elapsed));
      secs = left;
      updatePomoDisplay();
      saveLocalSecs();
      if (left <= 0) {
        clearLocalTimer();
        setStartButtons(false);
      }
    };
    tick();
    timer = setInterval(tick, 1000);
  }

  function togglePomo() {
    console.log('[POMO] Toggle clicked, timer active:', !!timer);
    // Pause if currently running
    if (timer) {
      clearLocalTimer();
      setStartButtons(false);
      saveLocalSecs();
      console.log('[POMO] ⏸ Paused at', secs, 'seconds');
      // Persist pause with remaining seconds
      syncToCloud(false, { remaining: secs, startedAt: null, isBreak: isBreakMode, isLongBreak: isLongBreak });
      return;
    }
    // Start a new session from current remaining seconds
    const remainAtStart = secs;
    const startedNow = Date.now();
    startLocalDisplayFromAnchor(remainAtStart, startedNow);
    console.log('[POMO] ▶ Started with', remainAtStart, 'seconds remaining');
    // Persist start (no per-second writes) - save actual timestamp for cross-device sync
    syncToCloud(true, { remaining: remainAtStart, startedAt: startedNow, isBreak: isBreakMode, isLongBreak: isLongBreak });
  }

  function resetPomo() {
    console.log('[POMO] ⟳ Reset to', defaultPomoMinutes, 'minutes');
    clearLocalTimer();
    if (isLongBreak) {
      secs = defaultLongBreakMinutes * 60;
    } else {
      secs = isBreakMode ? (defaultBreakMinutes * 60) : (defaultPomoMinutes * 60);
    }
    updatePomoDisplay();
    setStartButtons(false);
    saveLocalSecs();
    syncToCloud(false, { remaining: secs, startedAt: null, isBreak: isBreakMode, isLongBreak: isLongBreak });
  }

  function toggleBreakMode(newMode) {
    if (newMode === 'focus') {
      isBreakMode = false;
      isLongBreak = false;
      secs = defaultPomoMinutes * 60;
    } else if (newMode === 'break') {
      isBreakMode = true;
      isLongBreak = false;
      secs = defaultBreakMinutes * 60;
    } else if (newMode === 'longbreak') {
      isBreakMode = true;
      isLongBreak = true;
      secs = defaultLongBreakMinutes * 60;
    } else {
      // Toggle mode
      isBreakMode = !isBreakMode;
      isLongBreak = false;
      secs = isBreakMode ? (defaultBreakMinutes * 60) : (defaultPomoMinutes * 60);
    }
    
    console.log('[POMO] Switching to', isLongBreak ? 'long break' : (isBreakMode ? 'break' : 'focus'), 'mode');
    clearLocalTimer();
    updatePomoDisplay();
    setStartButtons(false);
    
    // Update toggle buttons
    const focusBtn = document.getElementById('pomoFocusBtn');
    const breakBtn = document.getElementById('pomoBreakBtn');
    const longBreakBtn = document.getElementById('pomoLongBreakBtn');
    if (focusBtn && breakBtn && longBreakBtn) {
      focusBtn.classList.remove('active');
      breakBtn.classList.remove('active');
      longBreakBtn.classList.remove('active');
      
      if (isLongBreak) {
        longBreakBtn.classList.add('active');
      } else if (isBreakMode) {
        breakBtn.classList.add('active');
      } else {
        focusBtn.classList.add('active');
      }
    }
    
    syncToCloud(false, { remaining: secs, startedAt: null, isBreak: isBreakMode, isLongBreak: isLongBreak });
  }

  // Expose reset function globally for widget settings
  window.resetPomoTimer = function(newDuration) {
    if (newDuration) {
      defaultPomoMinutes = newDuration;
    }
    resetPomo();
    // Update input if it exists
    const pomoInput = document.getElementById('pomoFocusDuration');
    if (pomoInput) {
      pomoInput.value = defaultPomoMinutes;
    }
  };

  if (pomoDurationInput) {
    pomoDurationInput.onchange = () => {
      const val = Math.max(1, Number(pomoDurationInput.value) || 60);
      console.log('[POMO] Duration changed to', val, 'minutes');
      defaultPomoMinutes = val;
      secs = val * 60;
      updatePomoDisplay();
      clearLocalTimer();
      setStartButtons(false);
      saveLocalSecs();
      syncToCloud(false, { remaining: secs, startedAt: null });
    };
  }
  
  const pomoStartBtn = document.getElementById('pomoStart');
  const floatingPomoStartBtn = document.getElementById('floatingPomoStart');
  const pomoResetBtn = document.getElementById('pomoReset');
  const floatingPomoResetBtn = document.getElementById('floatingPomoReset');
  const pomoFocusBtn = document.getElementById('pomoFocusBtn');
  const pomoBreakBtn = document.getElementById('pomoBreakBtn');
  const pomoLongBreakBtn = document.getElementById('pomoLongBreakBtn');
  
  // Mode toggle buttons
  if (pomoFocusBtn) {
    pomoFocusBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleBreakMode('focus');
    });
  }
  if (pomoBreakBtn) {
    pomoBreakBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleBreakMode('break');
    });
  }
  if (pomoLongBreakBtn) {
    pomoLongBreakBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleBreakMode('longbreak');
    });
  }
  
  console.log('[POMO] Initializing buttons:');
  console.log('  pomoStart:', pomoStartBtn, pomoStartBtn ? 'FOUND ✅' : 'MISSING ❌');
  console.log('  floatingPomoStart:', floatingPomoStartBtn, floatingPomoStartBtn ? 'FOUND ✅' : 'MISSING ❌');
  console.log('  pomoReset:', pomoResetBtn, pomoResetBtn ? 'FOUND ✅' : 'MISSING ❌');
  console.log('  floatingPomoReset:', floatingPomoResetBtn, floatingPomoResetBtn ? 'FOUND ✅' : 'MISSING ❌');
  
  if (pomoStartBtn) {
    pomoStartBtn.onclick = (e) => {
      console.log('[POMO] Header start button clicked');
      e.stopPropagation();
      togglePomo();
    };
    pomoStartBtn.style.pointerEvents = 'auto';
    console.log('[POMO] Header start button initialized');
  }
  if (floatingPomoStartBtn) {
    floatingPomoStartBtn.onclick = (e) => {
      console.log('[POMO] Floating start button clicked');
      e.stopPropagation();
      togglePomo();
    };
    floatingPomoStartBtn.style.pointerEvents = 'auto';
    console.log('[POMO] Floating start button initialized');
  }
  if (pomoResetBtn) {
    pomoResetBtn.onclick = (e) => {
      console.log('[POMO] Header reset button clicked');
      e.stopPropagation();
      resetPomo();
    };
    pomoResetBtn.style.pointerEvents = 'auto';
    console.log('[POMO] Header reset button initialized');
  }
  if (floatingPomoResetBtn) {
    floatingPomoResetBtn.onclick = (e) => {
      console.log('[POMO] Floating reset button clicked');
      e.stopPropagation();
      resetPomo();
    };
    floatingPomoResetBtn.style.pointerEvents = 'auto';
    console.log('[POMO] Floating reset button initialized');
  }

  // Initialize pomodoro display
  updatePomoDisplay();

  // Expose handler for Firebase snapshot updates
  window.applyRemoteState = (data) => {
    try {
      if (!data) return;
      
      console.log('[POMO] Applying remote state:', data);

      // Update duration if changed remotely
      if (typeof data.duration === 'number' && data.duration > 0 && data.duration !== defaultPomoMinutes) {
        defaultPomoMinutes = data.duration;
        if (pomoDurationInput) pomoDurationInput.value = defaultPomoMinutes;
      }

      // Update break mode
      if (typeof data.isBreak === 'boolean') {
        isBreakMode = data.isBreak;
      }
      if (typeof data.isLongBreak === 'boolean') {
        isLongBreak = data.isLongBreak;
      }
      
      // Update toggle buttons
      const focusBtn = document.getElementById('pomoFocusBtn');
      const breakBtn = document.getElementById('pomoBreakBtn');
      const longBreakBtn = document.getElementById('pomoLongBreakBtn');
      if (focusBtn && breakBtn && longBreakBtn) {
        focusBtn.classList.remove('active');
        breakBtn.classList.remove('active');
        longBreakBtn.classList.remove('active');
        
        if (isLongBreak) {
          longBreakBtn.classList.add('active');
        } else if (isBreakMode) {
          breakBtn.classList.add('active');
        } else {
          focusBtn.classList.add('active');
        }
      }

      const running = !!data.running;
      const remaining = (typeof data.remaining === 'number' && data.remaining >= 0)
        ? data.remaining
        : (typeof data.secs === 'number' ? data.secs : defaultPomoMinutes * 60);

      if (running && data.startedAt) {
        // Handle both Firestore Timestamp objects and numeric timestamps
        const startedAtMs = (typeof data.startedAt.toMillis === 'function')
          ? data.startedAt.toMillis()
          : (typeof data.startedAt === 'number' ? data.startedAt : Date.now());
        console.log('[POMO] Restoring running timer from', startedAtMs, 'with', remaining, 'seconds');
        startLocalDisplayFromAnchor(remaining, startedAtMs);
      } else if (running) {
        // Fallback if startedAt missing: just start from remaining now
        console.log('[POMO] Fallback: Starting timer with', remaining, 'seconds');
        startLocalDisplayFromAnchor(remaining, Date.now());
      } else {
        clearLocalTimer();
        secs = remaining;
        updatePomoDisplay();
        setStartButtons(false);
      }
    } catch (e) {
      console.error('[POMO] applyRemoteState error:', e);
    }
  };

  // Calendar navigation now handled by calendar.js app

  const themes = [
    { name: '🍎 macOS', class: '' },
    { name: '🌙 Dark', class: 'dark' },
    { name: '🌊 Ocean', class: 'theme-ocean' },
    { name: '🌲 Forest', class: 'theme-forest' },
    { name: '🌅 Solar', class: 'theme-solar' },
    { name: '💎 Glass', class: 'theme-glass' }
  ];
  
  // Load saved theme or default to 0
  let themeIndex = parseInt(localStorage.getItem('selectedThemeIndex')) || 0;
  
  // Apply saved theme on page load
  const savedTheme = themes[themeIndex];
  if (savedTheme) {
    document.body.classList.remove('dark','theme-ocean','theme-forest','theme-solar','theme-glass');
    if (savedTheme.class) document.body.classList.add(savedTheme.class);
    themeBtn.textContent = savedTheme.name;
  }
  
  themeBtn.onclick = () => {
    document.body.classList.remove('dark','theme-ocean','theme-forest','theme-solar','theme-glass');
    themeIndex = (themeIndex + 1) % themes.length;
    const t = themes[themeIndex];
    if (t.class) document.body.classList.add(t.class);
    themeBtn.textContent = t.name;
    
    // Save theme selection to localStorage
    localStorage.setItem('selectedThemeIndex', themeIndex.toString());
    console.log('Theme saved:', t.name);
  };

  // =========================
  // APP LAUNCHER & DRAWER
  // =========================
  const appLauncherBtn = document.getElementById('appLauncherBtn');
  const appDrawer = document.getElementById('appDrawer');
  const toggleCalendarApp = document.getElementById('toggleCalendarApp');
  const toggleClockApp = document.getElementById('toggleClockApp');
  const togglePomoApp = document.getElementById('togglePomoApp');
  const toggleTodoApp = document.getElementById('toggleTodoApp');
  const toggleCountdownApp = document.getElementById('toggleCountdownApp');
  const toggleEventsApp = document.getElementById('toggleEventsApp');
  const toggleNotesApp = document.getElementById('toggleNotesApp');
  const toggleWebBrowserApp = document.getElementById('toggleWebBrowserApp');
  const toggleCanvasManagerApp = document.getElementById('toggleCanvasManagerApp');
  const toggleAmbientApp = document.getElementById('toggleAmbientApp');
  const toggleAppStoreApp = document.getElementById('toggleAppStoreApp');

  // Open/close app drawer
  if (appLauncherBtn) {
    appLauncherBtn.onclick = () => {
      if (appDrawer.style.display === 'block') {
        appDrawer.style.display = 'none';
      } else {
        appDrawer.style.display = 'block';
        
        // Sync toggle button states when opening
        if (window.syncAppStoreToggleStates) {
          setTimeout(window.syncAppStoreToggleStates, 50);
        }
      }
    };
  }

  if (appDrawer) {
    appDrawer.onclick = (e) => {
      if (e.target === appDrawer) {
        appDrawer.style.display = 'none';
      }
    };
  }

  // Close drawer on Escape
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && appDrawer.style.display === 'block') {
      appDrawer.style.display = 'none';
    }
  });

  // =========================
  // WIDGET VISIBILITY + DRAG
  // =========================
  const clock = document.getElementById('analogClock');
  const closeClockBtn = document.getElementById('closeClockBtn');
  const floatingPomo = document.getElementById('floatingPomo');
  const closePomoBtn = document.getElementById('closePomoBtn');
  const floatingTodo = document.getElementById('floatingTodo');
  const closeTodoBtn = document.getElementById('closeTodoBtn');
  const floatingCountdown = document.getElementById('floatingCountdown');
  const closeCountdownBtn = document.getElementById('closeCountdownBtn');
  const floatingEvents = document.getElementById('floatingEvents');
  const closeEventsBtn = document.getElementById('closeEventsBtn');
  const floatingCalendar = document.getElementById('floatingCalendar');
  const closeCalendarBtn = document.getElementById('closeCalendarBtn');
  const floatingNotes = document.getElementById('floatingNotes');
  const closeNotesBtn = document.getElementById('closeNotesBtn');
  const floatingWebBrowser = document.getElementById('floatingWebBrowser');
  const closeWebBrowserBtn = document.getElementById('closeWebBrowserBtn');
  const canvasManager = document.getElementById('canvasManager');
  const closeCanvasManagerBtn = document.getElementById('closeCanvasManagerBtn');
  const floatingAmbient = document.getElementById('floatingAmbient');
  const closeAmbientBtn = document.getElementById('closeAmbientBtn');

  const CLOCK_VIS_KEY = 'show_analog_clock';
  const POMO_VIS_KEY = 'show_floating_pomo';
  const TODO_VIS_KEY = 'show_floating_todo';
  const COUNTDOWN_VIS_KEY = 'show_floating_countdown';
  const EVENTS_VIS_KEY = 'show_floating_events';
  const CALENDAR_VIS_KEY = 'show_floating_calendar';
  const NOTES_VIS_KEY = 'show_floating_notes';
  const WEB_BROWSER_VIS_KEY = 'show_web_browser';
  const CANVAS_TABS_VIS_KEY = 'show_canvas_tabs';
  const AMBIENT_VIS_KEY = 'show_ambient_sounds';

  // Calendar visibility now handled by calendar.js app
  // Kept here for backward compatibility
  function updateCalendarVisibility(visible) {
    if (window.updateCalendarVisibility) {
      window.updateCalendarVisibility(visible);
    }
  }

  function updateClockVisibility(visible) {
    if (!clock) return;
    clock.style.display = visible ? 'block' : 'none';
    if (visible) bringToFront(clock);
    if (toggleClockApp) toggleClockApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }

  function updatePomoVisibility(visible) {
    if (!floatingPomo) return;
    floatingPomo.style.display = visible ? 'block' : 'none';
    if (visible) bringToFront(floatingPomo);
    if (togglePomoApp) togglePomoApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }

  function updateTodoVisibility(visible) {
    if (!floatingTodo) return;
    floatingTodo.style.display = visible ? 'flex' : 'none';
    if (visible) bringToFront(floatingTodo);
    if (toggleTodoApp) toggleTodoApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }

  function updateCountdownVisibility(visible) {
    if (!floatingCountdown) return;
    floatingCountdown.style.display = visible ? 'flex' : 'none';
    if (visible) bringToFront(floatingCountdown);
    if (toggleCountdownApp) toggleCountdownApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }

  function updateEventsVisibility(visible) {
    if (!floatingEvents) return;
    floatingEvents.style.display = visible ? 'flex' : 'none';
    if (visible) bringToFront(floatingEvents);
    if (toggleEventsApp) toggleEventsApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateEventsVisibility = updateEventsVisibility;

  function updateNotesVisibility(visible) {
    if (!floatingNotes) return;
    floatingNotes.style.display = visible ? 'flex' : 'none';
    if (visible) bringToFront(floatingNotes);
    if (toggleNotesApp) toggleNotesApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateNotesVisibility = updateNotesVisibility;

  function updateWebBrowserVisibility(visible) {
    if (!floatingWebBrowser) return;
    floatingWebBrowser.style.display = visible ? 'flex' : 'none';
    if (visible) bringToFront(floatingWebBrowser);
    if (toggleWebBrowserApp) toggleWebBrowserApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateWebBrowserVisibility = updateWebBrowserVisibility;

  function updateCanvasManagerVisibility(visible) {
    if (!canvasManager) return;
    canvasManager.style.display = visible ? 'flex' : 'none';
    if (visible) bringToFront(canvasManager);
    if (toggleCanvasManagerApp) toggleCanvasManagerApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateCanvasManagerVisibility = updateCanvasManagerVisibility;

  function updateAmbientVisibility(visible) {
    if (!floatingAmbient) return;
    floatingAmbient.style.display = visible ? 'flex' : 'none';
    if (visible) bringToFront(floatingAmbient);
    if (toggleAmbientApp) toggleAmbientApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateAmbientVisibility = updateAmbientVisibility;

  function updateAppStoreVisibility(visible) {
    const appStore = window.appStoreWidget || document.getElementById('appStore');
    if (!appStore) return;
    appStore.style.display = visible ? 'flex' : 'none';
    if (toggleAppStoreApp) toggleAppStoreApp.classList.toggle('active', !!visible);
    if (visible) bringToFront(appStore);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateAppStoreVisibility = updateAppStoreVisibility;

  // Widget visibility initialization is now handled by canvas manager

  // App toggle click handlers
  if (toggleCalendarApp) {
    toggleCalendarApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingCalendar && floatingCalendar.style.display !== 'none';
      updateCalendarVisibility(!isVisible);
    };
  }

  if (toggleClockApp) {
    toggleClockApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = clock && clock.style.display !== 'none';
      updateClockVisibility(!isVisible);
    };
  }
  if (togglePomoApp) {
    togglePomoApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingPomo && floatingPomo.style.display !== 'none';
      updatePomoVisibility(!isVisible);
    };
  }
  if (toggleTodoApp) {
    toggleTodoApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingTodo && floatingTodo.style.display !== 'none';
      updateTodoVisibility(!isVisible);
    };
  }
  if (toggleCountdownApp) {
    toggleCountdownApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingCountdown && floatingCountdown.style.display !== 'none';
      updateCountdownVisibility(!isVisible);
    };
  }
  if (toggleEventsApp) {
    toggleEventsApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingEvents && floatingEvents.style.display !== 'none';
      updateEventsVisibility(!isVisible);
    };
  }
  if (toggleNotesApp) {
    toggleNotesApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingNotes && floatingNotes.style.display !== 'none';
      updateNotesVisibility(!isVisible);
    };
  }
  if (toggleWebBrowserApp) {
    toggleWebBrowserApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingWebBrowser && floatingWebBrowser.style.display !== 'none';
      updateWebBrowserVisibility(!isVisible);
    };
  }
  if (toggleCanvasManagerApp) {
    toggleCanvasManagerApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = canvasManager && canvasManager.style.display !== 'none';
      updateCanvasManagerVisibility(!isVisible);
    };
  }
  if (toggleAmbientApp) {
    toggleAmbientApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingAmbient && floatingAmbient.style.display !== 'none';
      updateAmbientVisibility(!isVisible);
    };
  }
  if (toggleAppStoreApp) {
    toggleAppStoreApp.onclick = (e) => {
      e.stopPropagation();
      const appStore = window.appStoreWidget || document.getElementById('appStore');
      const isVisible = appStore && appStore.style.display !== 'none';
      updateAppStoreVisibility(!isVisible);
    };
  }

  // Close button handlers
  if (closeCalendarBtn) closeCalendarBtn.onclick = (e) => { e.stopPropagation(); updateCalendarVisibility(false); };
  if (closeClockBtn) closeClockBtn.onclick = (e) => { e.stopPropagation(); updateClockVisibility(false); };
  if (closePomoBtn) closePomoBtn.onclick = (e) => { e.stopPropagation(); updatePomoVisibility(false); };
  if (closeTodoBtn) closeTodoBtn.onclick = (e) => { e.stopPropagation(); updateTodoVisibility(false); };
  if (closeCountdownBtn) closeCountdownBtn.onclick = (e) => { e.stopPropagation(); updateCountdownVisibility(false); };
  if (closeEventsBtn) closeEventsBtn.onclick = (e) => { e.stopPropagation(); updateEventsVisibility(false); };
  if (closeNotesBtn) closeNotesBtn.onclick = (e) => { e.stopPropagation(); updateNotesVisibility(false); };
  if (closeWebBrowserBtn) closeWebBrowserBtn.onclick = (e) => { e.stopPropagation(); updateWebBrowserVisibility(false); };
  if (closeCanvasManagerBtn) closeCanvasManagerBtn.onclick = (e) => { e.stopPropagation(); updateCanvasManagerVisibility(false); };
  if (closeAmbientBtn) closeAmbientBtn.onclick = (e) => { e.stopPropagation(); updateAmbientVisibility(false); };

  // =========================
  // CALCULATOR WIDGET
  // =========================
  const floatingCalculator = document.getElementById('floatingCalculator');
  const calcDisplay = document.getElementById('calcDisplay');
  const calcButtons = document.querySelectorAll('.calc-btn');
  const closeCalculatorBtn = document.getElementById('closeCalculatorBtn');
  const toggleCalculatorApp = document.getElementById('toggleCalculatorApp');
  const CALCULATOR_VIS_KEY = 'show_calculator';

  let calcExpression = '';
  let calcResult = '0';

  function updateCalculatorVisibility(visible) {
    if (!floatingCalculator) return;
    floatingCalculator.style.display = visible ? 'flex' : 'none';
    if (visible) bringToFront(floatingCalculator);
    localStorage.setItem(CALCULATOR_VIS_KEY, String(visible));
    if (toggleCalculatorApp) toggleCalculatorApp.classList.toggle('active', !!visible);
  }

  function updateCalcDisplay(value) {
    if (calcDisplay) calcDisplay.textContent = value;
  }

  function handleCalculatorInput(input) {
    if (input === 'C') {
      calcExpression = '';
      calcResult = '0';
      updateCalcDisplay('0');
    } else if (input === '=') {
      try {
        // Replace display symbols with JS operators
        const expr = calcExpression.replace(/×/g, '*').replace(/÷/g, '/').replace(/−/g, '-');
        const result = eval(expr);
        calcResult = result.toString();
        updateCalcDisplay(calcResult);
        calcExpression = calcResult;
      } catch (e) {
        updateCalcDisplay('Error');
        calcExpression = '';
        calcResult = '0';
      }
    } else {
      if (calcExpression === '0' || calcExpression === calcResult) {
        calcExpression = input;
      } else {
        calcExpression += input;
      }
      updateCalcDisplay(calcExpression);
    }
  }

  calcButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const value = btn.dataset.calc;
      if (value) handleCalculatorInput(value);
    });
  });

  // Keyboard support
  document.addEventListener('keydown', (e) => {
    // Don't intercept keys if user is typing in an input field or contenteditable
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
      return;
    }
    
    if (floatingCalculator.style.display !== 'flex') return;
    const key = e.key;
    if (/[0-9\+\-\*\/\.\(\)]/.test(key)) {
      e.preventDefault();
      handleCalculatorInput(key);
    } else if (key === 'Enter') {
      e.preventDefault();
      handleCalculatorInput('=');
    } else if (key === 'Escape' || key === 'Backspace') {
      e.preventDefault();
      handleCalculatorInput('C');
    }
  });

  if (toggleCalculatorApp) {
    toggleCalculatorApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingCalculator && floatingCalculator.style.display !== 'none';
      updateCalculatorVisibility(!isVisible);
    };
  }

  if (closeCalculatorBtn) {
    closeCalculatorBtn.onclick = (e) => {
      e.stopPropagation();
      updateCalculatorVisibility(false);
    };
  }

  // Init calculator visibility
  (function initCalculatorVisibility() {
    if (toggleCalculatorApp) {
      const savedCalc = localStorage.getItem(CALCULATOR_VIS_KEY);
      const showCalc = savedCalc === null ? false : savedCalc !== 'false';
      toggleCalculatorApp.classList.toggle('active', showCalc);
      if (showCalc) floatingCalculator.style.display = 'flex';
    }
  })();

  // =========================
  // CANVAS WIDGET POSITIONING
  // =========================
  let highestZIndex = 1000;
  
  // Bring widget to front when clicked
  function bringToFront(el) {
    if (!el) return;
    highestZIndex++;
    el.style.zIndex = highestZIndex;
  }
  
  function constrainWidgetToViewport(el) {
    if (!el) return;
    // In canvas mode, widgets can be placed anywhere
    // Only ensure they don't go negative or above canvas
    const minTop = 44; // Canvas starts at 44px (header height)
    let left = parseFloat(el.style.left) || 0;
    let top = parseFloat(el.style.top) || 0;
    
    if (left < 0) left = 0;
    if (top < minTop) top = minTop;
    
    el.style.left = left + 'px';
    el.style.top = top + 'px';
  }
  
  function saveWidgetPosition(el, id) {
    // Save to current canvas
    if (window.saveCurrentCanvas) {
      window.saveCurrentCanvas();
    }
  }
  
  function restoreWidgetPosition(el, id) {
    // Positions are loaded via loadCanvasPositions
    // This function is kept for compatibility
  }
  
  function adjustAllWidgetsToViewport() {
    const widgets = [
      { el: clock, id: 'analogClock' },
      { el: floatingPomo, id: 'floatingPomo' },
      { el: floatingTodo, id: 'floatingTodo' },
      { el: floatingEvents, id: 'floatingEvents' },
      { el: floatingCalculator, id: 'floatingCalculator' },
      { el: floatingCalendar, id: 'floatingCalendar' },
      { el: floatingNotes, id: 'floatingNotes' },
      { el: floatingWebBrowser, id: 'floatingWebBrowser' }
    ];
    
    widgets.forEach(({ el, id }) => {
      if (el && el.style.left && el.style.top) {
        constrainWidgetToViewport(el);
        saveWidgetPosition(el, id);
      }
    });
  }

  // Draggable (mouse + touch) - only from header
  function makeDraggable(el, handleSelector = null, widgetId = null) {
    if (!el) return;
    let isDragging = false;
    let startX, startY, startLeft, startTop;

    const getPoint = (evt) => {
      if (evt.touches && evt.touches.length) return { x: evt.touches[0].clientX, y: evt.touches[0].clientY };
      return { x: evt.clientX, y: evt.clientY };
    };

    const startDrag = (e) => {
      // If handleSelector is provided, only allow drag from that element
      if (handleSelector) {
        const handle = el.querySelector(handleSelector);
        if (!handle || !handle.contains(e.target)) return;
      }
      
      // prevent dragging when pressing inner buttons or input fields
      if (e.target && (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
      
      // Bring to front when starting to drag
      bringToFront(el);
      
      isDragging = true;
      const p = getPoint(e);
      startX = p.x; startY = p.y;
      startLeft = el.offsetLeft; startTop = el.offsetTop;
      el.style.right = 'auto';
      el.style.bottom = 'auto';
      
      // Add dragging class for visual feedback
      el.classList.add('is-dragging');
      document.body.classList.add('dragging-active');
      
      // Prevent scrolling on touch devices only when actually dragging from valid area
      if (e.type === 'touchstart') {
        e.preventDefault();
      }
    };

    const moveDrag = (e) => {
      if (!isDragging) return;
      // Prevent scrolling while dragging on touch devices
      if (e.type === 'touchmove') {
        e.preventDefault();
      }
      const p = getPoint(e);
      el.style.left = startLeft + (p.x - startX) + 'px';
      el.style.top = startTop + (p.y - startY) + 'px';
    };

    const endDrag = () => {
      if (!isDragging) return;
      isDragging = false;
      
      // Remove dragging class
      el.classList.remove('is-dragging');
      document.body.classList.remove('dragging-active');
      
      constrainWidgetToViewport(el);
      if (widgetId) saveWidgetPosition(el, widgetId);
    };

    el.addEventListener('mousedown', startDrag);
    el.addEventListener('touchstart', startDrag, { passive: false });
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('touchmove', moveDrag, { passive: false });
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);
  }

  // Make widgets resizable
  function makeResizable(el, widgetId = null) {
    if (!el) return;
    const handle = el.querySelector('.resize-handle');
    if (!handle) return;

    let isResizing = false;
    let startX, startY, startWidth, startHeight;

    const getPoint = (evt) => {
      if (evt.touches && evt.touches.length) return { x: evt.touches[0].clientX, y: evt.touches[0].clientY };
      return { x: evt.clientX, y: evt.clientY };
    };

    const startResize = (e) => {
      e.stopPropagation();
      e.preventDefault();
      isResizing = true;
      const p = getPoint(e);
      startX = p.x;
      startY = p.y;
      startWidth = el.offsetWidth;
      startHeight = el.offsetHeight;
      document.body.style.cursor = 'nwse-resize';
      document.body.style.userSelect = 'none';
    };

    const moveResize = (e) => {
      if (!isResizing) return;
      e.preventDefault();
      const p = getPoint(e);
      const newWidth = Math.max(250, startWidth + (p.x - startX));
      const newHeight = Math.max(200, startHeight + (p.y - startY));
      el.style.width = newWidth + 'px';
      el.style.height = newHeight + 'px';
    };

    const endResize = () => {
      if (!isResizing) return;
      isResizing = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
      if (widgetId) saveWidgetPosition(el, widgetId);
    };

    handle.addEventListener('mousedown', startResize);
    handle.addEventListener('touchstart', startResize, { passive: false });
    window.addEventListener('mousemove', moveResize);
    window.addEventListener('touchmove', moveResize, { passive: false });
    window.addEventListener('mouseup', endResize);
    window.addEventListener('touchend', endResize);
  }

  // Expose globally for app store
  window.makeDraggable = makeDraggable;
  window.makeResizable = makeResizable;

  // Restore saved positions - commented out, canvas manager handles this
  // restoreWidgetPosition(clock, 'analogClock');
  // restoreWidgetPosition(floatingPomo, 'floatingPomo');
  // restoreWidgetPosition(floatingTodo, 'floatingTodo');
  // restoreWidgetPosition(floatingEvents, 'floatingEvents');
  // restoreWidgetPosition(floatingCalculator, 'floatingCalculator');
  // restoreWidgetPosition(floatingCalendar, 'floatingCalendar');
  // restoreWidgetPosition(floatingNotes, 'floatingNotes');

  // Setup draggable and resizable functionality
  makeDraggable(clock, null, 'analogClock');
  makeDraggable(floatingPomo, '.pomo-header', 'floatingPomo');
  makeDraggable(floatingTodo, '.todo-header', 'floatingTodo');
  makeDraggable(floatingCountdown, '.countdown-header', 'floatingCountdown');
  makeDraggable(floatingEvents, '.events-header', 'floatingEvents');
  makeDraggable(floatingCalculator, '.calc-header', 'floatingCalculator');
  makeDraggable(floatingCalendar, '.calendar-header', 'floatingCalendar');
  makeDraggable(floatingNotes, '.notes-header', 'floatingNotes');
  makeDraggable(floatingWebBrowser, '.browser-header', 'floatingWebBrowser');
  makeDraggable(canvasManager, '.canvas-manager-header', 'canvasManager');
  makeDraggable(floatingAmbient, '.ambient-header', 'floatingAmbient');

  // Make widgets resizable
  makeResizable(floatingPomo, 'floatingPomo');
  makeResizable(floatingTodo, 'floatingTodo');
  makeResizable(floatingCountdown, 'floatingCountdown');
  makeResizable(floatingEvents, 'floatingEvents');
  makeResizable(floatingCalculator, 'floatingCalculator');
  makeResizable(floatingCalendar, 'floatingCalendar');
  makeResizable(floatingNotes, 'floatingNotes');
  makeResizable(floatingWebBrowser, 'floatingWebBrowser');
  makeResizable(canvasManager, 'canvasManager');
  makeResizable(floatingAmbient, 'floatingAmbient');

  // Add click handlers to bring widgets to front
  // Note: appStore will be added dynamically when created
  const allWidgets = [clock, floatingPomo, floatingTodo, floatingCountdown, floatingEvents, floatingCalculator, floatingCalendar, floatingNotes, floatingWebBrowser, canvasManager, floatingAmbient];
  
  // Function to add app store to widgets array
  window.addAppStoreToWidgets = function() {
    const appStore = window.appStoreWidget;
    if (appStore && !allWidgets.includes(appStore)) {
      allWidgets.push(appStore);
      window.addWidgetInteractionHandlers(appStore);
      console.log('[WIDGETS] App Store added to allWidgets with interaction handlers');
    }
  };

  // Global function to add interaction handlers to any widget
  window.addWidgetInteractionHandlers = function(widget) {
    if (!widget) return;
    
    // Bring to front on any interaction
    widget.addEventListener('mousedown', (e) => {
      bringToFront(widget);
    });
    widget.addEventListener('click', (e) => {
      bringToFront(widget);
    });
    widget.addEventListener('focus', (e) => {
      bringToFront(widget);
    }, true); // Use capture to catch focus on children
    
    widget.addEventListener('touchstart', (e) => {
      bringToFront(widget);
      widget.classList.add('widget-touched');
      if (touchTimers.has(widget)) {
        clearTimeout(touchTimers.get(widget));
      }
      const timer = setTimeout(() => {
        widget.classList.remove('widget-touched');
        touchTimers.delete(widget);
      }, 3000);
      touchTimers.set(widget, timer);
    });
  };
  
  // Touch handling for close button visibility
  const touchTimers = new Map();
  
  allWidgets.forEach(widget => {
    if (widget) {
      window.addWidgetInteractionHandlers(widget);
    }
  });

  // Handle viewport resize and orientation change
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(adjustAllWidgetsToViewport, 200);
  });
  
  window.addEventListener('orientationchange', () => {
    setTimeout(adjustAllWidgetsToViewport, 300);
  });

  // =========================
  // CANVAS PANNING (Space + Drag)
  // =========================
  const canvasWorkspace = document.getElementById('canvasWorkspace');
  const canvasHint = document.getElementById('canvasHint');
  let isPanning = false;
  let panStartX = 0;
  let panStartY = 0;
  let scrollStartX = 0;
  let scrollStartY = 0;
  let spacePressed = false;

  // Auto-hide hint after 5 seconds
  if (canvasHint) {
    setTimeout(() => {
      canvasHint.classList.add('hidden');
    }, 5000);
  }

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && !e.repeat && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && !e.target.isContentEditable) {
      e.preventDefault();
      spacePressed = true;
      canvasWorkspace.style.cursor = 'grab';
    }
  });

  window.addEventListener('keyup', (e) => {
    if (e.code === 'Space') {
      spacePressed = false;
      canvasWorkspace.style.cursor = '';
      if (isPanning) {
        isPanning = false;
        canvasWorkspace.classList.remove('panning');
      }
    }
  });

  canvasWorkspace.addEventListener('mousedown', (e) => {
    // Pan with Space+LMB or Middle Mouse Button
    if ((spacePressed && e.button === 0) || e.button === 1) {
      e.preventDefault();
      isPanning = true;
      canvasWorkspace.classList.add('panning');
      panStartX = e.clientX;
      panStartY = e.clientY;
      scrollStartX = canvasWorkspace.scrollLeft;
      scrollStartY = canvasWorkspace.scrollTop;
    }
  });

  window.addEventListener('mousemove', (e) => {
    if (isPanning) {
      const deltaX = panStartX - e.clientX;
      const deltaY = panStartY - e.clientY;
      canvasWorkspace.scrollLeft = scrollStartX + deltaX;
      canvasWorkspace.scrollTop = scrollStartY + deltaY;
    }
  });

  window.addEventListener('mouseup', () => {
    if (isPanning) {
      isPanning = false;
      canvasWorkspace.classList.remove('panning');
    }
  });

  // =========================
  // ANALOG CLOCK TICK LOGIC
  // =========================
  const hourHand = document.getElementById('hourHand');
  const minuteHand = document.getElementById('minuteHand');
  const secondHand = document.getElementById('secondHand');
  const clockDay = document.getElementById('clockDay');
  const clockNum = document.getElementById('clockNum');

  function updateAnalogClock() {
    const now = new Date();
    const sec = now.getSeconds();
    const min = now.getMinutes();
    const hr = now.getHours() % 12;

    if (hourHand) hourHand.style.transform = `translateX(-50%) rotate(${hr * 30 + min * 0.5}deg)`;
    if (minuteHand) minuteHand.style.transform = `translateX(-50%) rotate(${min * 6}deg)`;
    if (secondHand) secondHand.style.transform = `translateX(-50%) rotate(${sec * 6}deg)`;

    if (clockDay) clockDay.textContent = now.toLocaleDateString(undefined, { weekday: 'short' });
    if (clockNum) clockNum.textContent = now.getDate();
  }

  // Align ticks to the next second boundary for accuracy
  (function startClockTicks() {
    updateAnalogClock();
    const now = new Date();
    const msToNextSecond = 1000 - now.getMilliseconds();
    setTimeout(() => {
      updateAnalogClock();
      setInterval(updateAnalogClock, 1000);
    }, msToNextSecond);
  })();

  // =========================
  // TODO LIST LOGIC - REBUILT FROM SCRATCH
  // =========================
  
  // Initialize todo state
  let todos = [];
  let todosLoaded = false;
  
  // Get DOM elements
  const todoInput = document.getElementById('todoInput');
  const todoAddBtn = document.getElementById('todoAddBtn');
  const todoList = document.getElementById('todoList');

  // Render todos to DOM
  function renderTodos() {
    if (!todoList) {
      console.error('[TODO] todoList element not found');
      return;
    }
    
    console.log('[TODO] Rendering', todos.length, 'todos');
    todoList.innerHTML = '';
    
    // Show loading state if waiting for Firebase
    if (!todosLoaded && window.auth && window.auth.currentUser) {
      todoList.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--muted);font-size:0.9rem;">⏳ Loading from cloud...</div>';
      return;
    }
    
    // Show empty state if no todos
    if (todos.length === 0) {
      todoList.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--muted);font-size:0.85rem;">No tasks yet. Add one above!</div>';
      return;
    }
    
    // Render each todo
    todos.forEach((todo, index) => {
      const item = document.createElement('div');
      item.className = 'todo-item';
      item.dataset.index = index;
      
      // Checkbox
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'todo-checkbox';
      checkbox.checked = todo.completed || false;
      checkbox.addEventListener('change', () => toggleTodo(index));
      
      // Text
      const text = document.createElement('span');
      text.className = 'todo-text' + (todo.completed ? ' completed' : '');
      text.textContent = todo.text;
      
      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'todo-delete';
      deleteBtn.textContent = '✕';
      deleteBtn.addEventListener('click', () => deleteTodo(index));
      
      item.appendChild(checkbox);
      item.appendChild(text);
      item.appendChild(deleteBtn);
      todoList.appendChild(item);
    });
  }

  // Add new todo
  function addTodo() {
    if (!todoInput) return;
    
    const text = todoInput.value.trim();
    if (!text) {
      console.log('[TODO] Empty input, ignoring');
      return;
    }
    
    // Check if user is authenticated
    if (!window.auth || !window.auth.currentUser) {
      alert('Please log in to save todos');
      return;
    }
    
    console.log('[TODO] Adding new todo:', text);
    
    const newTodo = {
      text: text,
      completed: false,
      id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      createdAt: Date.now()
    };
    
    todos.push(newTodo);
    todoInput.value = '';
    
    console.log('[TODO] Total todos:', todos.length);
    renderTodos();
    saveTodosToFirebase();
  }

  // Toggle todo completion
  function toggleTodo(index) {
    if (index < 0 || index >= todos.length) return;
    
    console.log('[TODO] Toggling todo at index', index);
    todos[index].completed = !todos[index].completed;
    
    renderTodos();
    saveTodosToFirebase();
  }

  // Delete todo
  function deleteTodo(index) {
    if (index < 0 || index >= todos.length) return;
    
    console.log('[TODO] Deleting todo at index', index);
    todos.splice(index, 1);
    
    renderTodos();
    saveTodosToFirebase();
  }

  // Save todos to Firebase
  async function saveTodosToFirebase() {
    try {
      // Verify authentication
      if (!window.auth || !window.auth.currentUser) {
        console.warn('[TODO] Not authenticated, cannot save');
        return;
      }
      
      if (!window.db || !window.doc || !window.setDoc || !window.serverTimestamp) {
        console.error('[TODO] Firebase not initialized');
        return;
      }
      
      const userId = window.auth.currentUser.uid;
      const deviceId = window.deviceId || 'unknown';
      
      console.log('[TODO] Saving', todos.length, 'todos to Firebase for user:', userId);
      
      const todoRef = window.doc(window.db, 'user_todos', userId);
      await window.setDoc(todoRef, {
        items: todos,
        by: deviceId,
        updatedAt: window.serverTimestamp()
      });
      
      console.log('[TODO] ✅ Successfully saved to Firebase');
    } catch (error) {
      console.error('[TODO] ❌ Failed to save to Firebase:', error);
      console.error('[TODO] Error code:', error.code);
      console.error('[TODO] Error message:', error.message);
    }
  }

  // Load todos from Firebase (called by Firebase listener)
  function loadTodosFromFirebase(data) {
    try {
      console.log('[TODO] Loading data from Firebase:', data);
      
      if (!data) {
        console.log('[TODO] No data received from Firebase, using empty array');
        todos = [];
        todosLoaded = true;
        renderTodos();
        return;
      }
      
      if (Array.isArray(data.items)) {
        todos = data.items;
        console.log('[TODO] ✅ Loaded', todos.length, 'todos from Firebase');
      } else {
        console.warn('[TODO] data.items is not an array, using empty array');
        todos = [];
      }
      
      todosLoaded = true;
      renderTodos();
    } catch (error) {
      console.error('[TODO] ❌ Error loading from Firebase:', error);
      todos = [];
      todosLoaded = true;
      renderTodos();
    }
  }

  // Expose function for Firebase listener
  window.applyRemoteTodos = loadTodosFromFirebase;

  // Expose function for clearing completed todos (used by settings)
  window.clearCompletedTodos = function() {
    const remaining = todos.filter(t => !t.completed);
    todos = remaining;
    renderTodos();
    saveTodosToFirebase();
  };

  // Set up event listeners
  if (todoAddBtn) {
    todoAddBtn.addEventListener('click', addTodo);
    console.log('[TODO] Add button listener attached');
  }

  if (todoInput) {
    todoInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addTodo();
      }
    });
    console.log('[TODO] Input keypress listener attached');
  }

  // Initial render
  console.log('[TODO] Initial render');
  renderTodos();

  // =========================
  // EVENTS LOGIC
  // =========================
  const eventDateInput = document.getElementById('eventDateInput');
  const eventTextInput = document.getElementById('eventTextInput');
  const eventAddBtn = document.getElementById('eventAddBtn');
  const eventsList = document.getElementById('eventsList');
  const selectedDateBadge = document.getElementById('selectedDateBadge');
  const showAllEventsBtn = document.getElementById('showAllEventsBtn');

  // Set today as default date
  if (eventDateInput) {
    const today = new Date();
    eventDateInput.value = today.toISOString().split('T')[0];
  }

  // Click date badge or button to show all events
  if (selectedDateBadge) {
    selectedDateBadge.onclick = () => {
      selectedCalendarDate = null;
      renderEvents(null);
    };
  }
  if (showAllEventsBtn) {
    showAllEventsBtn.onclick = () => {
      selectedCalendarDate = null;
      renderEvents(null);
    };
</div><!-- End Canvas Workspace -->

<!-- Dynamic App Loader - Only loads installed apps -->
<script src="js/app-loader.js"></script>

<!-- Main Application Logic -->
<script src="js/main.js"></script>

<!-- Firebase Module -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
  import {
    getAuth, setPersistence, browserLocalPersistence, signOut, onAuthStateChanged,
    signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail,
    signInWithCustomToken
  } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

  // Firebase config
  const firebaseConfig = {
    apiKey: 'AIzaSyA05Vxw3kSZ8xAHUBppMh5p7VwBZ-47kmM',
    authDomain: 'calendar-599ac.firebaseapp.com',
    projectId: 'calendar-599ac',
    storageBucket: 'calendar-599ac.firebasestorage.app',
    messagingSenderId: '89812638572',
    appId: '1:89812638572:web:f02d7309367576a619b149'
  };

  // Initialize
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Expose for non-module script usage
  window.auth = auth;
  window.db = db;
  window.doc = doc;
  window.getDoc = getDoc;
  window.setDoc = setDoc;
  window.serverTimestamp = serverTimestamp;
  window.onSnapshot = onSnapshot;

  // UI elements
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const resetPasswordBtn = document.getElementById('resetPasswordBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const loggedOutUI = document.getElementById('loggedOutUI');
  const loggedInUI = document.getElementById('loggedInUI');
  const userEmailDisplay = document.getElementById('userEmailDisplay');
  const syncStatus = document.getElementById('syncStatus');
  const notesEditor = document.getElementById('notesEditor');

  const NOTES_KEY_CLOUD = 'calendar_notes_rich';

  const setSyncStatus = (text) => { if (syncStatus) syncStatus.textContent = text; };

  // Auth actions
  const handleAuthError = (err) => {
    console.error(err);
    let msg = 'Authentication failed';
    if (err.code === 'auth/wrong-password') msg = 'Wrong password';
    if (err.code === 'auth/user-not-found') msg = 'User not found';
    if (err.code === 'auth/email-already-in-use') msg = 'Email already registered';
    if (err.code === 'auth/invalid-email') msg = 'Invalid email address';
    if (err.code === 'auth/weak-password') msg = 'Password is too weak';
    setSyncStatus('Error: ' + msg);
  };

  if (loginBtn) loginBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) return setSyncStatus('Enter email & password');
    try {
      setSyncStatus('Logging in...');
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      // Store user info in Firestore
      const user = userCredential.user;
      if (user) {
        const userRef = doc(db, 'users', user.uid);
        await setDoc(userRef, {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || '',
          photoURL: user.photoURL || '',
          lastLogin: serverTimestamp(),
        }, { merge: true });
      }
      setSyncStatus('Logged in! ✓');
      setTimeout(() => {
        settingsPage.style.display = 'none';
      }, 800);
    } catch (err) { handleAuthError(err); }
  };

  if (signupBtn) signupBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) return setSyncStatus('Enter email & password');
    try {
      setSyncStatus('Creating account...');
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      // Store user info in Firestore
      const user = userCredential.user;
      if (user) {
        const userRef = doc(db, 'users', user.uid);
        await setDoc(userRef, {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || '',
          photoURL: user.photoURL || '',
          createdAt: serverTimestamp(),
        }, { merge: true });
      }
      
      // Success - close settings automatically
      setSyncStatus('Account created! ✓');
      const settingsPage = document.getElementById('settingsPage');
      if (settingsPage) {
        setTimeout(() => {
          settingsPage.style.display = 'none';
        }, 800);
      }
    } catch (err) { handleAuthError(err); }
  };

  if (resetPasswordBtn) resetPasswordBtn.onclick = async () => {
    const email = emailInput.value.trim();
    if (!email) return setSyncStatus('Enter your email first');
    try {
      setSyncStatus('Sending reset link...');
      await sendPasswordResetEmail(auth, email);
      setSyncStatus('Check your inbox for reset link');
    } catch (err) { handleAuthError(err); }
  };

  if (logoutBtn) logoutBtn.onclick = async () => {
    // Clear all app data from memory
    todos = [];
    if (window.updateCalendarEvents) window.updateCalendarEvents([]);
    if (window.setEventsLoaded) window.setEventsLoaded(false);
    todosLoaded = false;
    
    // Clear all cached data from localStorage
    console.log('[LOGOUT] Clearing all cached data...');
    localStorage.removeItem('todos_local_cache');
    localStorage.removeItem('events_local_cache');
    localStorage.removeItem('calendar_notes_rich');
    
    // Clear UI
    if (todoList) todoList.innerHTML = '';
    if (eventsList) eventsList.innerHTML = '';
    if (notesEditor) notesEditor.innerHTML = '';
    
    console.log('[LOGOUT] All data cleared, signing out...');
    await signOut(auth);
  };

  // Persist auth
  (async function initAuth() {
    try {
      await setPersistence(auth, browserLocalPersistence);
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      }
    } catch (err) {
      console.error('Init Auth error', err);
    }
  })();

  // Realtime sync
  let unsubscribeNote = null;
  let unsubscribePomo = null;
  let unsubscribeEvents = null;
  let unsubscribeTodo = null;
  let unsubscribeCountdown = null;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // Store/update user info in Firestore on login
      try {
        const userRef = doc(db, 'users', user.uid);
        await setDoc(userRef, {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || '',
          photoURL: user.photoURL || '',
          lastLogin: serverTimestamp(),
        }, { merge: true });
      } catch (err) {
        console.error('Error writing user info to Firestore:', err);
      }
      if (loggedOutUI) loggedOutUI.style.display = 'none';
      if (loggedInUI) loggedInUI.style.display = 'block';
      if (userEmailDisplay) userEmailDisplay.textContent = `Logged in as: ${user.email}`;
      setSyncStatus('Signed in — syncing');

      // Notes listener
      const noteRef = doc(db, 'user_notes', user.uid);
      if (unsubscribeNote) unsubscribeNote();
      unsubscribeNote = onSnapshot(noteRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (document.activeElement !== notesEditor && notesEditor) {
            notesEditor.innerHTML = data.content || '';
          }
          setSyncStatus('Cloud Synced');
        } else {
          // No existing notes - start with empty
          setDoc(noteRef, { content: '', updatedAt: serverTimestamp() })
            .then(() => setSyncStatus('Synced (Started Cloud)'))
            .catch(() => setSyncStatus('Sync Error'));
        }
      }, (err) => {
        console.error('Firestore Error:', err);
        setSyncStatus('Sync Error: Permission Denied');
      });

      // Pomodoro listener
      const pomoRef = doc(db, 'user_pomodoro', user.uid);
      if (unsubscribePomo) unsubscribePomo();
      unsubscribePomo = onSnapshot(pomoRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (window.applyRemoteState) {
            window.applyRemoteState(data);
          }
        } else {
          // No cloud data yet, initialize with default values
          setDoc(pomoRef, {
            remaining: 60 * 60,
            duration: 60,
            running: false,
            startedAt: null,
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial pomo set error:', err));
        }
      }, (err) => {
        console.error('Pomodoro listener error:', err);
      });

      // Todo listener
      const todoRef = doc(db, 'user_todos', user.uid);
      if (unsubscribeTodo) unsubscribeTodo();
      console.log('[TODO] Setting up Firebase listener for user:', user.uid);
      unsubscribeTodo = onSnapshot(todoRef, (snap) => {
        console.log('[TODO] Snapshot received, exists:', snap.exists());
        if (snap.exists()) {
          const data = snap.data();
          console.log('[TODO] Snapshot data:', data);
          if (window.applyRemoteTodos) {
            window.applyRemoteTodos(data);
          }
        } else {
          console.log('[TODO] No todos document found, creating empty one');
          setDoc(todoRef, {
            items: [],
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial todo set error:', err));
        }
      }, (err) => {
        console.error('[TODO] Listener error:', err);
        console.error('[TODO] Error code:', err.code);
        console.error('[TODO] Error message:', err.message);
      });

      // Events listener
      const eventsRef = doc(db, 'user_events', user.uid);
      if (unsubscribeEvents) unsubscribeEvents();
      console.log('[EVENTS] Setting up Firebase listener for user:', user.uid);
      unsubscribeEvents = onSnapshot(eventsRef, (snap) => {
        console.log('[EVENTS] Snapshot received, exists:', snap.exists());
        if (snap.exists()) {
          const data = snap.data();
          console.log('[EVENTS] Snapshot data:', data);
          if (window.applyRemoteEvents) {
            window.applyRemoteEvents(data);
          }
        } else {
          console.log('[EVENTS] No events document found, creating empty one');
          setDoc(eventsRef, {
            items: [],
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial events set error:', err));
        }
      }, (err) => {
        console.error('[EVENTS] Listener error:', err);
        console.error('[EVENTS] Error code:', err.code);
        console.error('[EVENTS] Error message:', err.message);
      });

      // Countdown listener - Cloud Sync
      const countdownRef = doc(db, 'user_countdowns', user.uid);
      if (unsubscribeCountdown) unsubscribeCountdown();
      console.log('[COUNTDOWN] ☁️ Setting up cloud sync for user:', user.uid);
      unsubscribeCountdown = onSnapshot(countdownRef, (snap) => {
        console.log('[COUNTDOWN] Cloud snapshot received, exists:', snap.exists());
        if (snap.exists()) {
          const data = snap.data();
          console.log('[COUNTDOWN] Cloud data:', data);
          if (window.applyRemoteCountdowns) {
            window.applyRemoteCountdowns(data);
          }
        } else {
          console.log('[COUNTDOWN] No cloud data found, initializing...');
          setDoc(countdownRef, {
            items: [],
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[COUNTDOWN] ❌ Cloud init error:', err));
        }
      }, (err) => {
        console.error('[COUNTDOWN] ❌ Cloud sync error:', err);
        console.error('[COUNTDOWN] Error code:', err.code);
        console.error('[COUNTDOWN] Error message:', err.message);
      });

    } else {
      if (loggedOutUI) loggedOutUI.style.display = 'block';
      if (loggedInUI) loggedInUI.style.display = 'none';
      setSyncStatus('Not signed in - Login to access your data');
      
      // Unsubscribe from all listeners
      if (unsubscribeNote) { unsubscribeNote(); unsubscribeNote = null; }
      if (unsubscribePomo) { unsubscribePomo(); unsubscribePomo = null; }
      if (unsubscribeTodo) { unsubscribeTodo(); unsubscribeTodo = null; }
      if (unsubscribeEvents) { unsubscribeEvents(); unsubscribeEvents = null; }
      
      // Clear all data when logged out (cloud-first approach)
      todos = [];
      if (window.updateCalendarEvents) window.updateCalendarEvents([]);
      if (window.setEventsLoaded) window.setEventsLoaded(false);
      todosLoaded = false;
      if (notesEditor) notesEditor.innerHTML = '';
      if (todoList) todoList.innerHTML = '';
      if (eventsList) eventsList.innerHTML = '';
    }
  });

  // Debounced cloud save for notes
  let saveTimer = null;
  if (notesEditor) {
    notesEditor.addEventListener('input', () => {
      const html = notesEditor.innerHTML;
      // Only save to cloud if authenticated - no local storage
      if (auth.currentUser) {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(async () => {
          try {
            const noteRef = doc(db, 'user_notes', auth.currentUser.uid);
            await setDoc(noteRef, { content: html, updatedAt: serverTimestamp() }, { merge: true });
            setSyncStatus('All changes saved');
          } catch (err) {
            setSyncStatus('Cloud save failed');
          }
        }, 800);
      }
    });
  }

  window.addEventListener('offline', () => setSyncStatus('Offline — saved locally'));
  window.addEventListener('online', () => setSyncStatus('Online'));

  // =========================
  // DYNAMIC ISLAND SETTINGS
  // =========================
  const dynamicIslandShowPomodoro = document.getElementById('dynamicIslandShowPomodoro');
  const dynamicIslandShowCanvas = document.getElementById('dynamicIslandShowCanvas');
  const dynamicIslandShowDateTime = document.getElementById('dynamicIslandShowDateTime');
  const dynamicIslandAdditionalWidget = document.getElementById('dynamicIslandAdditionalWidget');
  
  const pomodoroIsland = document.getElementById('dynamicIslandPomodoro');
  const canvasSwitcherIsland = document.getElementById('canvasSwitcher');
  const dateTimeIsland = document.getElementById('dynamicIslandDateTime');
  const additionalIsland = document.getElementById('dynamicIslandAdditional');

  // Load saved dynamic island settings
  function loadDynamicIslandSettings() {
    const showPomo = localStorage.getItem('dynamicIsland_showPomodoro') !== 'false';
    const showCanvas = localStorage.getItem('dynamicIsland_showCanvas') !== 'false';
    const showDateTime = localStorage.getItem('dynamicIsland_showDateTime') !== 'false';
    const additionalWidget = localStorage.getItem('dynamicIsland_additionalWidget') || 'none';

    if (dynamicIslandShowPomodoro) dynamicIslandShowPomodoro.checked = showPomo;
    if (dynamicIslandShowCanvas) dynamicIslandShowCanvas.checked = showCanvas;
    if (dynamicIslandShowDateTime) dynamicIslandShowDateTime.checked = showDateTime;
    if (dynamicIslandAdditionalWidget) dynamicIslandAdditionalWidget.value = additionalWidget;

    applyDynamicIslandVisibility(showPomo, showCanvas, showDateTime, additionalWidget);
  }

  function applyDynamicIslandVisibility(showPomo, showCanvas, showDateTime, additionalWidget) {
    if (pomodoroIsland) pomodoroIsland.style.display = showPomo ? '' : 'none';
    if (canvasSwitcherIsland) canvasSwitcherIsland.style.display = showCanvas ? '' : 'none';
    if (dateTimeIsland) dateTimeIsland.style.display = showDateTime ? '' : 'none';
    
    // Handle additional widget
    if (additionalIsland) {
      if (additionalWidget === 'none') {
        additionalIsland.style.display = 'none';
        additionalIsland.innerHTML = '';
      } else {
        additionalIsland.style.display = '';
        updateAdditionalIslandContent(additionalWidget);
      }
    }
  }

  function updateAdditionalIslandContent(widgetType) {
    if (!additionalIsland) return;
    
    switch(widgetType) {
      case 'clock':
        additionalIsland.innerHTML = '🕒 <span id="dynamicClock"></span>';
        updateDynamicClock();
        if (!window.dynamicClockInterval) {
          window.dynamicClockInterval = setInterval(updateDynamicClock, 1000);
        }
        break;
      case 'countdown':
        additionalIsland.innerHTML = '⏰ <span id="dynamicCountdown">Next event</span>';
        updateDynamicCountdown();
        break;
      case 'todo':
        additionalIsland.innerHTML = '✅ <span id="dynamicTodo">0 tasks</span>';
        updateDynamicTodo();
        break;
      case 'events':
        additionalIsland.innerHTML = '📅 <span id="dynamicEvents">0 events</span>';
        updateDynamicEvents();
        break;
      default:
        additionalIsland.innerHTML = '';
        if (window.dynamicClockInterval) {
          clearInterval(window.dynamicClockInterval);
          window.dynamicClockInterval = null;
        }
    }
  }

  function updateDynamicClock() {
    const clockSpan = document.getElementById('dynamicClock');
    if (clockSpan) {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      clockSpan.textContent = `${hours}:${minutes}`;
    }
  }

  function updateDynamicCountdown() {
    const countdownSpan = document.getElementById('dynamicCountdown');
    if (countdownSpan) {
      // This can be enhanced to show actual countdown data
      countdownSpan.textContent = 'No events';
    }
  }

  function updateDynamicTodo() {
    const todoSpan = document.getElementById('dynamicTodo');
    if (todoSpan) {
      // This can be enhanced to show actual todo count
      const todoList = document.getElementById('todoList');
      const count = todoList ? todoList.children.length : 0;
      todoSpan.textContent = `${count} tasks`;
    }
  }

  function updateDynamicEvents() {
    const eventsSpan = document.getElementById('dynamicEvents');
    if (eventsSpan) {
      // This can be enhanced to show actual events count
      eventsSpan.textContent = 'No events';
    }
  }

  // Event listeners for dynamic island settings
  if (dynamicIslandShowPomodoro) {
    dynamicIslandShowPomodoro.addEventListener('change', (e) => {
      localStorage.setItem('dynamicIsland_showPomodoro', e.target.checked);
      if (pomodoroIsland) pomodoroIsland.style.display = e.target.checked ? '' : 'none';
    });
  }

  if (dynamicIslandShowCanvas) {
    dynamicIslandShowCanvas.addEventListener('change', (e) => {
      localStorage.setItem('dynamicIsland_showCanvas', e.target.checked);
      if (canvasSwitcherIsland) canvasSwitcherIsland.style.display = e.target.checked ? '' : 'none';
    });
  }

  if (dynamicIslandShowDateTime) {
    dynamicIslandShowDateTime.addEventListener('change', (e) => {
      localStorage.setItem('dynamicIsland_showDateTime', e.target.checked);
      if (dateTimeIsland) dateTimeIsland.style.display = e.target.checked ? '' : 'none';
    });
  }

  if (dynamicIslandAdditionalWidget) {
    dynamicIslandAdditionalWidget.addEventListener('change', (e) => {
      const widgetType = e.target.value;
      localStorage.setItem('dynamicIsland_additionalWidget', widgetType);
      applyDynamicIslandVisibility(
        dynamicIslandShowPomodoro?.checked,
        dynamicIslandShowCanvas?.checked,
        dynamicIslandShowDateTime?.checked,
        widgetType
      );
    });
  }

  // Initialize dynamic island settings
  loadDynamicIslandSettings();

  // Expose update functions for other scripts
  window.updateDynamicTodo = updateDynamicTodo;
  window.updateDynamicEvents = updateDynamicEvents;
  window.updateDynamicCountdown = updateDynamicCountdown;
</script>

<!-- Initialize Modern UI Libraries -->
<script>
  // Initialize Lucide Icons
  document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    
    // Initialize AOS (Animate On Scroll)
    AOS.init({
      duration: 800,
      easing: 'ease-out-cubic',
      once: true,
      offset: 50,
      delay: 100
    });
    
    // GSAP Enhancements
    // Animate header on load
    gsap.from('header', {
      y: -100,
      opacity: 0,
      duration: 0.8,
      ease: 'power3.out'
    });
    
    // Animate dynamic islands
    gsap.from('.dynamic-island, [id*="dynamic"]', {
      scale: 0.8,
      opacity: 0,
      duration: 0.6,
      stagger: 0.1,
      ease: 'back.out(1.7)',
      delay: 0.5
    });
    
    // Add hover animations to buttons
    const buttons = document.querySelectorAll('button:not(.no-hover)');
    buttons.forEach(btn => {
      btn.addEventListener('mouseenter', () => {
        gsap.to(btn, {
          scale: 1.05,
          duration: 0.2,
          ease: 'power2.out'
        });
      });
      btn.addEventListener('mouseleave', () => {
        gsap.to(btn, {
          scale: 1,
          duration: 0.2,
          ease: 'power2.out'
        });
      });
    });
    
    // Smooth scroll for canvas workspace
    const canvasWorkspace = document.getElementById('canvasWorkspace');
    if (canvasWorkspace) {
      canvasWorkspace.style.scrollBehavior = 'smooth';
    }
    
    // Add entrance animations to widgets
    const widgets = document.querySelectorAll('[id*="floating"]');
    widgets.forEach((widget, index) => {
      gsap.from(widget, {
        scale: 0.5,
        opacity: 0,
        duration: 0.6,
        delay: 1 + (index * 0.1),
        ease: 'back.out(1.7)',
        onComplete: () => {
          widget.style.transform = ''; // Reset for drag functionality
        }
      });
    });
    
    // Refresh icons after dynamic content loads
    setTimeout(() => {
      lucide.createIcons();
    }, 1000);
    
    // Re-initialize icons when content changes
    const observer = new MutationObserver(() => {
      lucide.createIcons();
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  });
</script>

<!-- Widget/App Scripts -->
<script src="apps/calendar/calendar.js"></script>
<script src="apps/events/events.js"></script>
<script src="apps/clock/clock.js"></script>
<script src="apps/pomodoro/pomodoro.js"></script>
<script src="apps/todo/todo.js"></script>
<script src="apps/countdown/countdown.js"></script>
<script src="apps/calculator/calculator.js"></script>
<script src="apps/notes/notes.js"></script>
<script src="apps/web-browser/web-browser.js"></script>
<script src="apps/canvas-manager/canvas-manager.js"></script>
<script src="apps/settings/settings.js"></script>
<script src="apps/ambient-sounds/ambient-sounds.js"></script>
<script src="apps/app-store/app-store.js"></script>

<script>
  // Initialize canvas manager after all scripts are loaded
  if (window.initializeCanvasManager) {
    window.initializeCanvasManager();
  }

  // =========================
  // PWA SERVICE WORKER
  // =========================
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./pwa/sw.js')
        .then((registration) => {
          console.log('[PWA] Service Worker registered:', registration.scope);
          
          // Check for updates periodically
          setInterval(() => {
            registration.update();
          }, 60000); // Check every minute
          
          // Handle service worker updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New service worker available, prompt user to refresh
                if (confirm('New version available! Reload to update?')) {
                  newWorker.postMessage({ type: 'SKIP_WAITING' });
                  window.location.reload();
                }
              }
            });
          });
        })
        .catch((error) => {
          console.log('[PWA] Service Worker registration failed:', error);
        });
    });

    // Reload page when new service worker takes control
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  }

  // =========================
  // PWA INSTALL PROMPT
  // =========================
  let deferredPrompt;
  
  window.addEventListener('beforeinstallprompt', (e) => {
    // Prevent the mini-infobar from appearing on mobile
    e.preventDefault();
    // Stash the event so it can be triggered later
    deferredPrompt = e;
    
    // Show install button/banner (you can create a custom UI here)
    console.log('[PWA] Install prompt available');
    
    // Optional: Show a custom install banner
    showInstallPromotion();
  });

  function showInstallPromotion() {
    // Create a simple install prompt
    const installBanner = document.createElement('div');
    installBanner.id = 'installBanner';
    installBanner.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 0.9rem;
      animation: slideUp 0.3s ease;
    `;
    
    installBanner.innerHTML = `
      <span>📱 Install CANVAS app</span>
      <button id="installBtn" style="background: white; color: var(--primary); border: none; padding: 6px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">Install</button>
      <button id="dismissInstall" style="background: transparent; color: white; border: 1px solid white; padding: 6px 12px; border-radius: 6px; cursor: pointer;">✕</button>
    `;
    
    document.body.appendChild(installBanner);
    
    // Install button handler
    document.getElementById('installBtn').addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`[PWA] User response: ${outcome}`);
        deferredPrompt = null;
        installBanner.remove();
      }
    });
    
    // Dismiss button handler
    document.getElementById('dismissInstall').addEventListener('click', () => {
      installBanner.remove();
    });
  }

  // Track when app is installed
  window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installed successfully');
    deferredPrompt = null;
    const banner = document.getElementById('installBanner');
    if (banner) banner.remove();
  });

  // Detect if running as installed PWA
  window.addEventListener('load', () => {
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
      console.log('[PWA] Running as installed app');
      document.body.classList.add('pwa-installed');
    }
  });
</script>

<style>
  @keyframes slideUp {
    from {
      transform: translateX(-50%) translateY(100px);
      opacity: 0;
    }
    to {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  }
</style>

</body>
</html>
