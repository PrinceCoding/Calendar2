<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Year Calendar with Notes</title>

  <!-- =========================
        STYLES (CSS)
        ========================= -->
  <style>
    /* =========================
        macOS SYSTEM THEME
        ========================= */
    :root {
      --bg: #f5f5f7;
      --card: rgba(255,255,255,0.75);
      --text: #1d1d1f;
      --muted: #6e6e73;
      --primary: #007aff;
      --today: #34c759;
      --border: rgba(0,0,0,0.08);
      --shadow-soft: 0 1px 2px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 24px rgba(0,0,0,0.12);
    }

    body.dark {
      --bg: #0f1115;
      --card: rgba(28,28,30,0.75);
      --text: #f5f5f7;
      --muted: #9a9aa0;
      --primary: #0a84ff;
      --today: #30d158;
      --border: rgba(255,255,255,0.12);
    }

    /* Ocean theme */
    body.theme-ocean {
      --bg: #ecfeff;
      --card: rgba(255,255,255,0.8);
      --text: #164e63;
      --muted: #155e75;
      --primary: #06b6d4;
      --today: #22d3ee;
      --border: rgba(22,78,99,0.15);
    }

    /* Forest theme */
    body.theme-forest {
      --bg: #f0fdf4;
      --card: rgba(255,255,255,0.8);
      --text: #14532d;
      --muted: #166534;
      --primary: #16a34a;
      --today: #22c55e;
      --border: rgba(20,83,45,0.15);
    }

    /* Solar theme */
    body.theme-solar {
      --bg: #fff7ed;
      --card: rgba(255,255,255,0.85);
      --text: #7c2d12;
      --muted: #a16207;
      --primary: #f97316;
      --today: #fb923c;
      --border: rgba(124,45,18,0.15);
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    button {
      border: none;
      background: none;
      font-family: inherit;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      pointer-events: none;
    }

    /* =========================
        HEADER
        ========================= */
    header {
      position: relative;
      padding: 0.9rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .date-time {
      height: 32px;
      padding: 0 0.9rem;
      border-radius: 10px;
      font-size: 0.78rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: var(--card);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft), var(--shadow-float);
      white-space: nowrap;
    }

    .pomo-btn {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: rgba(0,0,0,0.08);
      color: var(--text);
      font-size: 0.65rem;
      display: grid;
      place-items: center;
    }

    .today-btn,
    .theme-btn {
      height: 32px;
      padding: 0 0.9rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .today-btn {
      position: absolute;
      top: 0.9rem;
      left: 9rem;
      background: linear-gradient(180deg, #34c759, #28b84e);
      color: #fff;
    }

    .theme-btn {
      position: absolute;
      top: 0.9rem;
      right: 1rem;
      background: var(--card);
      color: var(--text);
    }

    h1 {
      margin: 0.6rem 0 0.2rem;
      font-size: 1.7rem;
      font-weight: 600;
    }

    .nav {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
    }

    .nav-btn {
      height: 28px;
      width: 28px;
      border-radius: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      color: var(--text);
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    body.dark .nav-btn {
      background: rgba(44,44,46,0.85);
      color: #f5f5f7;
      border: 1px solid rgba(255,255,255,0.18);
    }

    /* =========================
        CALENDAR
        ========================= */
    .calendar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.8rem;
      padding: 0.8rem 1rem 1rem;
    }

    .month {
      background: var(--card);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.75rem;
      box-shadow: var(--shadow-soft), var(--shadow-float);
    }

    .month h2 {
      margin: 0.2rem 0 0.6rem;
      text-align: center;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
    }

    .weekdays,
    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      gap: 0.25rem;
    }

    .weekdays div {
      font-size: 0.6rem;
      color: var(--muted);
    }

    .days div {
      font-size: 0.75rem;
      padding: 0.35rem 0;
      border-radius: 8px;
      transition: background 0.15s ease;
    }

    .days div:hover {
      background: rgba(0,0,0,0.06);
    }

    .today {
      background: var(--today);
      color: #fff;
      font-weight: 600;
    }

    /* =========================
        NOTES
        ========================= */
    .notes {
      margin: 0.6rem 1rem 1rem;
      background: var(--card);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.75rem;
      box-shadow: var(--shadow-soft), var(--shadow-float);
    }

    .notes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .notes h2 {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .notes-tools button {
      height: 26px;
      padding: 0 0.5rem;
      border-radius: 7px;
      background: var(--card);
      border: 1px solid var(--border);
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text);
      box-shadow: var(--shadow-soft);
    }

    .notes-tools button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    body.dark .notes-tools button {
      background: rgba(44,44,46,0.85);
      color: #f5f5f7;
      border: 1px solid rgba(255,255,255,0.18);
    }

    .notes-editor {
      width: 100%;
      min-height: 120px;
      padding: 0.6rem;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      background: rgba(255,255,255,0.5);
      color: var(--text);
      outline: none;
    }

    body.dark .notes-editor {
      background: rgba(0,0,0,0.25);
    }

    footer {
      text-align: center;
      font-size: 0.65rem;
      color: var(--muted);
      padding-bottom: 0.6rem;
    }

    /* Auth Input Styles */
    .auth-input {
      width: 100%;
      height: 34px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.4);
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
    }
    .auth-input:focus {
      border-color: var(--primary);
    }
    body.dark .auth-input {
      background: rgba(0,0,0,0.2);
    }

  /* =========================
   iPHONE / MOBILE ADJUSTMENTS
   ========================= */
@media (max-width: 480px) {
  header {
    padding: 0.7rem 0.6rem 0.8rem;
  }

  .date-time {
    font-size: 0.7rem;
    padding: 0 0.6rem;
    height: 30px;
  }

  .today-btn,
  .theme-btn {
    position: static;
    height: 28px;
    font-size: 0.7rem;
    padding: 0 0.6rem;
  }

  header > div:first-child {
    flex-wrap: wrap;
    justify-content: center;
  }

  .nav {
    margin-top: 0.4rem;
  }

  h1 {
    font-size: 1.3rem;
  }

  .calendar {
    grid-template-columns: 1fr;
    padding: 0.6rem;
  }

  .month {
    padding: 0.6rem;
  }

  .month h2 {
    font-size: 0.9rem;
  }

  .weekdays div {
    font-size: 0.55rem;
  }

  .days div {
    font-size: 0.7rem;
    padding: 0.3rem 0;
  }

  .notes {
    margin: 0.6rem;
  }

  .notes-editor {
    min-height: 140px;
    font-size: 0.8rem;
  }
}

    /* =========================
        LAYOUT 2 (CALENDAR + NOTES SIDE BY SIDE)
        ========================= */
    body.layout-2 main {
      display: grid;
      grid-template-columns: 2.2fr 8px 1fr;
      gap: 0;
      padding: 0 1rem 1rem;
      align-items: stretch;
    }

    body.layout-2 .calendar {
      padding: 0;
    }

    body.layout-2 .notes {
      margin: 0;
      height: fit-content;
      position: sticky;
      top: 1rem;
    }

    /* Resize handle */
    .resize-handle {
      cursor: col-resize;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.12), transparent);
    }

    body.dark .resize-handle {
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.25), transparent);
    }

    /* =========================
        LAYOUT 2 ‚Äì MOBILE FIX (PHONE)
        ========================= */
    @media (max-width: 768px) {
      body.layout-2 main {
        display: block; /* stop grid */
        padding: 0.6rem;
      }

      body.layout-2 .calendar {
        padding: 0;
      }

      body.layout-2 .notes {
        position: relative;
        margin: 0.8rem 0 0;
        max-height: none;
      }

      .resize-handle {
        display: none;
      }
    }

/* =========================
        FLOATING ANALOG CLOCK
        ========================= */
    .analog-clock {
      position: fixed;
      bottom: 1.2rem;
      right: 1.2rem;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft), var(--shadow-float);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      cursor: grab;
      z-index: 999;
    }
    .analog-clock:active { cursor: grabbing; }
    .clock-face { position: relative; width: 100%; height: 100%; }
    .hour-marks {
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      pointer-events: none;
    }
    .hour-marks span {
      position: absolute;
      top: 0;
      left: 50%;
      width: 2px;
      height: 6px;
      background: var(--muted);
      transform-origin: center calc(60px - 6px);
    }
    .hour-marks span:nth-child(1) { transform: rotate(0deg); }
    .hour-marks span:nth-child(2) { transform: rotate(30deg); }
    .hour-marks span:nth-child(3) { transform: rotate(60deg); }
    .hour-marks span:nth-child(4) { transform: rotate(90deg); }
    .hour-marks span:nth-child(5) { transform: rotate(120deg); }
    .hour-marks span:nth-child(6) { transform: rotate(150deg); }
    .hour-marks span:nth-child(7) { transform: rotate(180deg); }
    .hour-marks span:nth-child(8) { transform: rotate(210deg); }
    .hour-marks span:nth-child(9) { transform: rotate(240deg); }
    .hour-marks span:nth-child(10){ transform: rotate(270deg); }
    .hour-marks span:nth-child(11){ transform: rotate(300deg); }
    .hour-marks span:nth-child(12){ transform: rotate(330deg); }
    .hand {
      position: absolute;
      left: 50%;
      bottom: 50%;
      transform-origin: bottom center;
      background: var(--text);
      border-radius: 2px;
    }
    .hand.hour { width: 4px; height: 32px; }
    .hand.minute { width: 3px; height: 44px; }
    .hand.second { width: 2px; height: 50px; background: var(--primary); }
    .clock-center {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--text);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .clock-date {
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.55rem;
      font-weight: 600;
      color: var(--text);
      background: rgba(0,0,0,0.04);
      border: 1px solid var(--border);
      letter-spacing: 0.3px;
      pointer-events: none;
      line-height: 1.05;
    }
    body.dark .clock-date {
      background: rgba(255,255,255,0.08);
    }
    .clock-date div {
      display: block;
    }

    /* =========================
        FLOATING POMODORO
        ========================= */
    .floating-pomo {
      position: fixed;
      bottom: 10rem;
      right: 1.2rem;
      padding: 0.6rem 1rem;
      border-radius: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft), var(--shadow-float);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      cursor: grab;
      z-index: 998;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
    }
    .floating-pomo:active { cursor: grabbing; }
    .pomo-content { display: flex; align-items: center; gap: 0.6rem; font-weight: 600; font-size: 0.9rem; }
    .pomo-controls { display: flex; gap: 0.3rem; }

    /* =========================
        FLOATING TODO LIST
        ========================= */
    .floating-todo {
      position: fixed;
      bottom: 1.2rem;
      left: 1.2rem;
      width: 280px;
      max-height: 400px;
      padding: 0.8rem;
      border-radius: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft), var(--shadow-float);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      cursor: grab;
      z-index: 997;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    .floating-todo:active { cursor: grabbing; }
    .todo-header {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.6rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
      cursor: grab;
      -webkit-user-select: none;
      user-select: none;
    }
    .todo-header:active {
      cursor: grabbing;
    }
    .todo-input-container {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.6rem;
      touch-action: auto;
      pointer-events: auto;
    }
    .todo-input {
      flex: 1;
      height: 28px;
      padding: 0 0.5rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.75rem;
      background: rgba(255,255,255,0.5);
      color: var(--text);
      outline: none;
      touch-action: auto;
      -webkit-user-select: text;
      user-select: text;
    }
    body.dark .todo-input {
      background: rgba(0,0,0,0.25);
    }
    .todo-add-btn {
      height: 28px;
      width: 28px;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .todo-list {
      overflow-y: auto;
      max-height: 280px;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .todo-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.5rem;
      border-radius: 8px;
      background: rgba(0,0,0,0.04);
      font-size: 0.75rem;
      transition: background 0.15s;
    }
    body.dark .todo-item {
      background: rgba(255,255,255,0.08);
    }
    .todo-item:hover {
      background: rgba(0,0,0,0.08);
    }
    body.dark .todo-item:hover {
      background: rgba(255,255,255,0.12);
    }
    .todo-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .todo-text {
      flex: 1;
      word-break: break-word;
    }
    .todo-text.completed {
      text-decoration: line-through;
      opacity: 0.5;
    }
    .todo-delete {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: rgba(255,59,48,0.1);
      color: #ff3b30;
      font-size: 0.65rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .todo-item:hover .todo-delete {
      opacity: 1;
    }
    .todo-delete:hover {
      background: #ff3b30;
      color: white;
    }

    /* =========================
        FLOATING CALCULATOR WIDGET
        ========================= */
    .floating-calculator {
      position: fixed;
      bottom: 1.2rem;
      right: 5rem;
      width: 280px;
      padding: 0.8rem;
      border-radius: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft), var(--shadow-float);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      cursor: grab;
      z-index: 997;
      display: none;
      flex-direction: column;
      user-select: none;
    }
    .floating-calculator:active { cursor: grabbing; }
    .calc-header {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.6rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
      cursor: grab;
      -webkit-user-select: none;
      user-select: none;
    }
    .calc-header:active { cursor: grabbing; }
    .calc-display {
      width: 100%;
      height: 60px;
      padding: 0.8rem;
      margin-bottom: 0.6rem;
      border-radius: 10px;
      background: rgba(0,0,0,0.05);
      border: 1px solid var(--border);
      font-size: 1.5rem;
      font-weight: 500;
      text-align: right;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text);
    }
    body.dark .calc-display {
      background: rgba(255,255,255,0.05);
    }
    .calc-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
    }
    .calc-btn {
      height: 48px;
      border-radius: 10px;
      background: rgba(0,0,0,0.04);
      border: 1px solid var(--border);
      font-size: 1rem;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    body.dark .calc-btn {
      background: rgba(255,255,255,0.06);
    }
    .calc-btn:hover {
      background: rgba(0,0,0,0.08);
      transform: scale(1.02);
    }
    body.dark .calc-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    .calc-btn:active {
      transform: scale(0.98);
    }
    .calc-btn.operator {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .calc-btn.operator:hover {
      opacity: 0.9;
      background: var(--primary);
    }
    .calc-btn.equals {
      grid-column: span 2;
      background: var(--today);
      color: white;
      border-color: var(--today);
    }
    .calc-btn.equals:hover {
      opacity: 0.9;
      background: var(--today);
    }
    .calc-btn.clear {
      background: rgba(255,59,48,0.1);
      color: #ff3b30;
      border-color: rgba(255,59,48,0.3);
    }
    .calc-btn.clear:hover {
      background: rgba(255,59,48,0.2);
    }

    /* =========================
        FLOATING EVENTS WIDGET
        ========================= */
    .floating-events {
      position: fixed;
      bottom: 1.2rem;
      left: 20rem;
      width: 320px;
      max-height: 450px;
      padding: 0.8rem;
      border-radius: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft), var(--shadow-float);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      cursor: grab;
      z-index: 996;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    .floating-events:active { cursor: grabbing; }
    .events-header {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.6rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
      -webkit-user-select: none;
      user-select: none;
    }
    .events-header:active {
      cursor: grabbing;
    }
    .events-input-container {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-bottom: 0.6rem;
      touch-action: auto;
      pointer-events: auto;
    }
    .events-input-row {
      display: flex;
      gap: 0.4rem;
    }
    .event-date-input {
      width: 110px;
      height: 28px;
      padding: 0 0.5rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.75rem;
      background: rgba(255,255,255,0.5);
      color: var(--text);
      outline: none;
      touch-action: auto;
      -webkit-user-select: text;
      user-select: text;
    }
    body.dark .event-date-input {
      background: rgba(0,0,0,0.25);
    }
    .event-text-input {
      flex: 1;
      height: 28px;
      padding: 0 0.5rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.75rem;
      background: rgba(255,255,255,0.5);
      color: var(--text);
      outline: none;
      touch-action: auto;
      -webkit-user-select: text;
      user-select: text;
    }
    body.dark .event-text-input {
      background: rgba(0,0,0,0.25);
    }
    .event-add-btn {
      height: 28px;
      padding: 0 0.8rem;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      font-size: 0.75rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .events-list {
      overflow-y: auto;
      max-height: 320px;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .event-item {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      padding: 0.5rem;
      border-radius: 8px;
      background: rgba(0,0,0,0.04);
      font-size: 0.75rem;
      transition: background 0.15s;
      position: relative;
    }
    body.dark .event-item {
      background: rgba(255,255,255,0.08);
    }
    .event-item:hover {
      background: rgba(0,0,0,0.08);
    }
    body.dark .event-item:hover {
      background: rgba(255,255,255,0.12);
    }
    .event-date-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 6px;
      background: var(--primary);
      color: white;
      font-size: 0.65rem;
      font-weight: 600;
      width: fit-content;
    }
    .event-text {
      word-break: break-word;
      line-height: 1.4;
    }
    .event-delete {
      position: absolute;
      top: 0.3rem;
      right: 0.3rem;
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: rgba(255,59,48,0.1);
      color: #ff3b30;
      font-size: 0.65rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .event-item:hover .event-delete {
      opacity: 1;
    }
    .event-delete:hover {
      background: #ff3b30;
      color: white;
    }
    .event-dot {
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--primary);
      pointer-events: none;
    }
    .days div {
      position: relative;
    }
    .selected-date-badge {
      font-size: 0.7rem;
      color: var(--muted);
      font-weight: 500;
    }
    .show-all-btn {
      display: none;
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      background: var(--primary);
      color: white;
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .show-all-btn:hover {
      opacity: 0.8;
    }

    /* =========================
        CLOSE BUTTON FOR WIDGETS
        ========================= */
    .close-widget-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ff3b30;
      color: white;
      font-size: 10px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .analog-clock:hover .close-widget-btn,
    .floating-pomo:hover .close-widget-btn,
    .floating-todo:hover .close-widget-btn,
    .floating-events:hover .close-widget-btn,
    .floating-calculator:hover .close-widget-btn {
      opacity: 1;
    }
    .close-widget-btn:hover {
      background: #d70015;
      transform: scale(1.1);
    }

    /* =========================
        APP LAUNCHER
        ========================= */
    .app-launcher-btn {
      position: fixed;
      top: 1.2rem;
      left: 1.2rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), #0051d5);
      color: white;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-float), 0 4px 12px rgba(0,122,255,0.3);
      cursor: pointer;
      z-index: 1001;
      transition: transform 0.2s, box-shadow 0.2s;
      border: none;
    }
    .app-launcher-btn:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-float), 0 6px 16px rgba(0,122,255,0.4);
    }
    .app-launcher-btn:active {
      transform: scale(0.95);
    }
    .app-drawer {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .app-drawer-content {
      position: absolute;
      top: 5rem;
      left: 1.2rem;
      width: 280px;
      max-height: 400px;
      background: var(--card);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow-float), 0 12px 32px rgba(0,0,0,0.2);
      padding: 0.8rem;
      animation: slideUp 0.2s ease;
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .app-drawer-header {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
      padding-bottom: 0.6rem;
      border-bottom: 1px solid var(--border);
    }
    .app-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .app-item {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.6rem 0.8rem;
      border-radius: 10px;
      background: rgba(0,0,0,0.04);
      transition: background 0.15s;
      cursor: pointer;
    }
    body.dark .app-item {
      background: rgba(255,255,255,0.06);
    }
    .app-item:hover {
      background: rgba(0,0,0,0.08);
    }
    body.dark .app-item:hover {
      background: rgba(255,255,255,0.1);
    }
    .app-icon {
      font-size: 1.5rem;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary), #0051d5);
      flex-shrink: 0;
    }
    .app-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .app-name {
      font-size: 0.8rem;
      font-weight: 600;
    }
    .app-desc {
      font-size: 0.65rem;
      color: var(--muted);
    }
    .app-toggle {
      width: 44px;
      height: 24px;
      border-radius: 12px;
      background: rgba(0,0,0,0.1);
      position: relative;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    body.dark .app-toggle {
      background: rgba(255,255,255,0.1);
    }
    .app-toggle.active {
      background: var(--primary);
    }
    .app-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      transition: transform 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .app-toggle.active::after {
      transform: translateX(20px);
    }

    /* =========================
        GROUP STUDY FEATURE
        ========================= */
    .study-toggle-btn {
      position: absolute;
      top: 3.5rem;
      right: 1rem;
      height: 42px;
      padding: 0 1.5rem;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px) saturate(180%);
      transition: all 0.2s;
    }
    .study-toggle-btn.active {
      background: linear-gradient(180deg, #007aff, #0066dd);
      color: #fff;
      border-color: #0066dd;
    }

    .study-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    .study-modal-content {
      background: var(--card);
      backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
      box-shadow: var(--shadow-float);
    }
    .study-modal-header {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .study-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }
    .study-tab {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      font-weight: 500;
      background: none;
      color: var(--muted);
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      cursor: pointer;
    }
    .study-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .study-tab-content {
      display: none;
    }
    .study-tab-content.active {
      display: block;
    }
    .session-code-box {
      background: rgba(0,0,0,0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      margin: 1rem 0;
    }
    .session-code-text {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.15rem;
      color: var(--primary);
      font-family: 'Courier New', monospace;
    }
    .code-input-box {
      width: 100%;
      padding: 0.7rem;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      letter-spacing: 0.1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-family: 'Courier New', monospace;
      text-transform: uppercase;
    }
    .study-btn {
      width: 100%;
      padding: 0.7rem;
      margin-top: 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      border-radius: 8px;
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .study-btn.secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      margin-top: 0.5rem;
    }
    .study-info {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
      margin-top: 0.5rem;
    }

    .chat-widget {
      position: fixed;
      bottom: 1.2rem;
      right: 1.2rem;
      width: 320px;
      height: 450px;
      background: var(--card);
      backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow-float);
      display: none;
      flex-direction: column;
      z-index: 9999;
    }
    .chat-header {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-session-code {
      font-size: 0.7rem;
      color: var(--muted);
    }
    .chat-messages-container {
      flex: 1;
      padding: 0.8rem;
      overflow-y: auto;
    }
    .chat-footer {
      padding: 0.6rem 0.8rem;
      border-top: 1px solid var(--border);
      font-size: 0.7rem;
      color: var(--muted);
    }
    .chat-input-area {
      padding: 0.8rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
    }
    .chat-input-field {
      flex: 1;
      padding: 0.6rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 0.8rem;
    }
    .chat-send-button {
      width: 38px;
      height: 38px;
      border-radius: 8px;
      background: var(--primary);
      color: #fff;
      font-size: 1rem;
      border: none;
      cursor: pointer;
    }
    body.dark .session-code-box {
      background: rgba(255,255,255,0.08);
    }
</style>
</head>
<body>

<header>
  <button id="studyToggleBtn" class="study-toggle-btn">üë§ Solo Study</button>
  
  <div style="display:inline-flex;align-items:center;gap:0.4rem;">
    <div class="date-time"><span id="dtText"></span></div>
    <div class="date-time">üçÖ <span id="pomoTime">60:00</span>
      <button id="pomoStart" class="pomo-btn">‚ñ∂</button>
      <button id="pomoReset" class="pomo-btn">‚ü≥</button>
    </div>
  </div>

  <button id="todayBtn" class="today-btn">üìç Today</button>
  <button id="themeBtn" class="theme-btn">üçé macOS</button>
  <button id="layoutBtn" class="theme-btn" style="right:5.5rem;">üóÇ Layout 1</button>
  <button id="settingsBtn" class="theme-btn" style="right:15.5rem;">‚öôÔ∏è Settings</button>
  <button id="monthToggleBtn" class="theme-btn" style="right:10.5rem;">üìÖ Month</button>

  <div class="nav">
    <button id="prev" class="nav-btn">‚óÄ</button>
    <h1 id="year"></h1>
    <button id="next" class="nav-btn">‚ñ∂</button>
  </div>
</header>

<!-- Study Session Modal -->
<div id="studyModal" class="study-modal">
  <div class="study-modal-content">
    <div class="study-modal-header">üë• Group Study</div>
    
    <div class="study-tabs">
      <button class="study-tab active" data-tab="create">Create</button>
      <button class="study-tab" data-tab="join">Join</button>
    </div>

    <!-- Create Tab -->
    <div class="study-tab-content active" data-content="create">
      <p style="font-size:0.8rem;color:var(--muted);margin:0 0 1rem;">Share this code with others:</p>
      <div class="session-code-box">
        <div style="font-size:0.7rem;color:var(--muted);margin-bottom:0.4rem;">Session Code</div>
        <div class="session-code-text" id="generatedCode">------</div>
      </div>
      <button id="createSessionBtn" class="study-btn">üöÄ Create Session</button>
      <button id="copySessionCodeBtn" class="study-btn secondary" style="display:none;">üìã Copy Code</button>
      <div class="study-info" id="createInfo"></div>
    </div>

    <!-- Join Tab -->
    <div class="study-tab-content" data-content="join">
      <p style="font-size:0.8rem;color:var(--muted);margin:0 0 1rem;">Enter the session code:</p>
      <input type="text" id="joinCodeInput" class="code-input-box" placeholder="Enter Code" maxlength="6" />
      <button id="joinSessionBtn" class="study-btn">‚úì Join Session</button>
      <div class="study-info" id="joinInfo"></div>
    </div>

    <button id="closeStudyModal" class="study-btn secondary">Close</button>
  </div>
</div>

<!-- Chat Widget -->
<div id="chatWidget" class="chat-widget">
  <div class="chat-header">
    <div>
      <div>üí¨ Group Chat</div>
      <div class="chat-session-code" id="chatSessionCode">Session: ------</div>
    </div>
    <button id="closeChatBtn" style="width:24px;height:24px;border:none;background:rgba(0,0,0,0.1);border-radius:50%;cursor:pointer;">‚úï</button>
  </div>
  <div id="matrixChatMessages" class="chat-messages-container">
    <div style="text-align:center;color:var(--muted);font-size:0.75rem;margin-top:2rem;">
      Welcome! üéâ<br>Start chatting with your study partners.
    </div>
  </div>
  <div class="chat-footer">
    üë• <span id="participantCount">1</span> ‚Ä¢ <span id="participantNames">Just you</span>
  </div>
  <div class="chat-input-area">
    <input type="text" id="chatMessageInput" class="chat-input-field" placeholder="Type a message..." />
    <button id="sendChatBtn" class="chat-send-button">‚û§</button>
  </div>
</div>

<!-- Floating Analog Clock -->
<div id="analogClock" class="analog-clock">
  <button id="closeClockBtn" class="close-widget-btn" title="Close Clock">‚úï</button>
  <div class="clock-face">
    <div class="hour-marks">
      <span></span><span></span><span></span><span></span><span></span><span></span>
      <span></span><span></span><span></span><span></span><span></span><span></span>
    </div>
    <div class="hand hour" id="hourHand"></div>
    <div class="hand minute" id="minuteHand"></div>
    <div class="hand second" id="secondHand"></div>
    <div class="clock-center"></div>
    <div class="clock-date"><div id="clockDay"></div><div id="clockNum"></div></div>
  </div>
</div>

<!-- Floating Pomodoro -->
<div id="floatingPomo" class="floating-pomo">
  <button id="closePomoBtn" class="close-widget-btn" title="Close Pomodoro">‚úï</button>
  <div class="pomo-content">
    <span class="pomo-emoji">üçÖ</span>
    <span id="floatingPomoTime">60:00</span>
    <div class="pomo-controls">
      <button id="floatingPomoStart" class="pomo-btn">‚ñ∂</button>
      <button id="floatingPomoReset" class="pomo-btn">‚ü≥</button>
    </div>
  </div>
</div>

<!-- Floating Todo List -->
<div id="floatingTodo" class="floating-todo">
  <button id="closeTodoBtn" class="close-widget-btn" title="Close Todo">‚úï</button>
  <div class="todo-header">üìù To-Do List</div>
  <div class="todo-input-container">
    <input type="text" id="todoInput" class="todo-input" placeholder="Add a task..." />
    <button id="todoAddBtn" class="todo-add-btn">+</button>
  </div>
  <div id="todoList" class="todo-list"></div>
</div>

<!-- Floating Calculator Widget -->
<div id="floatingCalculator" class="floating-calculator">
  <button id="closeCalculatorBtn" class="close-widget-btn" title="Close Calculator">‚úï</button>
  <div class="calc-header">üî¢ Calculator</div>
  <div id="calcDisplay" class="calc-display">0</div>
  <div class="calc-buttons">
    <button class="calc-btn clear" data-calc="C">C</button>
    <button class="calc-btn" data-calc="(">(</button>
    <button class="calc-btn" data-calc=")">)</button>
    <button class="calc-btn operator" data-calc="/">√∑</button>
    
    <button class="calc-btn" data-calc="7">7</button>
    <button class="calc-btn" data-calc="8">8</button>
    <button class="calc-btn" data-calc="9">9</button>
    <button class="calc-btn operator" data-calc="*">√ó</button>
    
    <button class="calc-btn" data-calc="4">4</button>
    <button class="calc-btn" data-calc="5">5</button>
    <button class="calc-btn" data-calc="6">6</button>
    <button class="calc-btn operator" data-calc="-">‚àí</button>
    
    <button class="calc-btn" data-calc="1">1</button>
    <button class="calc-btn" data-calc="2">2</button>
    <button class="calc-btn" data-calc="3">3</button>
    <button class="calc-btn operator" data-calc="+">+</button>
    
    <button class="calc-btn" data-calc="0">0</button>
    <button class="calc-btn" data-calc=".">.</button>
    <button class="calc-btn equals" data-calc="=">=</button>
  </div>
</div>

<!-- Floating Events Widget -->
<div id="floatingEvents" class="floating-events">
  <button id="closeEventsBtn" class="close-widget-btn" title="Close Events">‚úï</button>
  <div class="events-header">
    <span>üìÖ Events</span>
    <span id="selectedDateBadge" class="selected-date-badge" style="cursor:pointer" title="Click to show all events"></span>
    <button id="showAllEventsBtn" class="show-all-btn">Show All</button>
  </div>
  <div class="events-input-container">
    <div class="events-input-row">
      <input type="date" id="eventDateInput" class="event-date-input" />
      <input type="text" id="eventTextInput" class="event-text-input" placeholder="Event description..." />
    </div>
    <button id="eventAddBtn" class="event-add-btn">+ Add Event</button>
  </div>
  <div id="eventsList" class="events-list"></div>
</div>

<!-- App Launcher Button -->
<button id="appLauncherBtn" class="app-launcher-btn" title="Apps">‚ñ¶</button>

<!-- App Drawer Overlay -->
<div id="appDrawer" class="app-drawer">
  <div class="app-drawer-content">
    <div class="app-drawer-header">üöÄ Apps</div>
    <div class="app-list">
      <div class="app-item" data-app="clock">
        <div class="app-icon">üïê</div>
        <div class="app-info">
          <div class="app-name">Analog Clock</div>
          <div class="app-desc">Live time display</div>
        </div>
        <div class="app-toggle" id="toggleClockApp"></div>
      </div>
      <div class="app-item" data-app="pomodoro">
        <div class="app-icon">üçÖ</div>
        <div class="app-info">
          <div class="app-name">Pomodoro Timer</div>
          <div class="app-desc">Focus timer</div>
        </div>
        <div class="app-toggle" id="togglePomoApp"></div>
      </div>
      <div class="app-item" data-app="todo">
        <div class="app-icon">‚úÖ</div>
        <div class="app-info">
          <div class="app-name">To-Do List</div>
          <div class="app-desc">Task management</div>
        </div>
        <div class="app-toggle" id="toggleTodoApp"></div>
      </div>
      <div class="app-item" data-app="events">
        <div class="app-icon">üìÖ</div>
        <div class="app-info">
          <div class="app-name">Events Calendar</div>
          <div class="app-desc">Track events</div>
        </div>
        <div class="app-toggle" id="toggleEventsApp"></div>
      </div>
      <div class="app-item" data-app="calculator">
        <div class="app-icon">üî¢</div>
        <div class="app-info">
          <div class="app-name">Calculator</div>
          <div class="app-desc">Quick calculations</div>
        </div>
        <div class="app-toggle" id="toggleCalculatorApp"></div>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     SETTINGS PAGE (OVERLAY)
     ========================= -->
<div id="settingsPage" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.25);backdrop-filter:blur(4px);">
    <div style="max-width:420px;margin:4rem auto;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-float); max-height: 90vh; overflow-y: auto;">
    <h2 style="margin-top:0">Settings</h2>

    <!-- Appearance -->
    <div class="month" style="margin-bottom:1rem;">
      <h3>Appearance</h3>
      <p style="font-size:0.8rem;color:var(--muted)">Theme</p>
      <div id="settingsThemes" style="display:flex;gap:0.4rem;flex-wrap:wrap;"></div>

      <p style="font-size:0.8rem;color:var(--muted);margin-top:0.6rem">Font Size</p>
      <button class="font-btn" data-size="90">A‚àí</button>
      <button class="font-btn" data-size="100">A</button>
      <button class="font-btn" data-size="110">A+</button>
    </div>

    <!-- Pomodoro -->
    <div class="month" style="margin-bottom:1rem;">
      <h3>Pomodoro</h3>
      <p style="font-size:0.75rem;color:var(--muted)">Session length (minutes)</p>
      <input id="pomoDurationInput" type="number" min="1" style="width:80px;padding:4px 6px;border-radius:8px;border:1px solid var(--border);font-size:0.8rem;" />
    </div>

    <!-- Account -->
    <div class="month" style="margin-bottom:1rem;">
      <h3>Account</h3>
      
      <!-- Logged Out View -->
      <div id="loggedOutUI">
        <input type="email" id="emailInput" class="auth-input" placeholder="Email address">
        <input type="password" id="passwordInput" class="auth-input" placeholder="Password">
        
        <div style="display:flex; gap: 8px; margin-bottom: 12px;">
          <button id="loginBtn" class="today-btn" style="position:static; flex:1; justify-content:center;">Login</button>
          <button id="signupBtn" class="theme-btn" style="position:static; flex:1; justify-content:center;">Sign Up</button>
        </div>
        
        <button id="resetPasswordBtn" style="font-size: 0.7rem; color: var(--primary); text-decoration: underline; background: none; border: none; padding: 0; cursor: pointer;">Forgot Password?</button>
      </div>

      <!-- Logged In View -->
      <div id="loggedInUI" style="display:none;">
        <p id="userEmailDisplay" style="font-size: 0.8rem; margin-bottom: 12px;"></p>
        <button id="logoutBtn" class="today-btn" style="position:static; background: linear-gradient(180deg, #ff3b30, #d70015); width: 100%; justify-content: center;">Sign Out</button>
      </div>

      <p style="font-size:0.75rem;color:var(--muted); margin-top: 12px;">Sync notes across devices</p>
    </div>

    <!-- About -->
    <div class="month">
      <h3>About</h3>
      <p style="font-size:0.75rem;color:var(--muted)">Year Calendar with Notes</p>
    </div>

    <button id="closeSettings" class="theme-btn" style="position:absolute;top:0.8rem;right:0.8rem;">‚úï</button>
  </div>
</div>

<main id="mainLayout">

<div id="calendar" class="calendar"></div>

  <div id="resizeHandle" class="resize-handle"></div>

<section class="notes">
  <div class="notes-header">
    <div style="display:flex;align-items:center;gap:0.6rem;">
      <h2 style="margin:0">Notes</h2>
      <div id="syncStatus" style="font-size:0.75rem;color:var(--muted)">Not signed in</div>
    </div>
    <div class="notes-tools">
      <button data-cmd="bold"><b>B</b></button>
      <button data-cmd="italic"><i>I</i></button>
      <button data-cmd="underline"><u>U</u></button>
      <button data-cmd="insertUnorderedList">‚Ä¢ List</button>
    </div>
  </div>
  <div id="notesEditor" class="notes-editor" contenteditable="true"></div>
</section>

<footer>Highlighted date = Today</footer>

</main>

<script>
  const calEl = document.getElementById('calendar');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPage = document.getElementById('settingsPage');
  const closeSettings = document.getElementById('closeSettings');
  const yearEl = document.getElementById('year');
  const notesEditor = document.getElementById('notesEditor');
  const toolButtons = document.querySelectorAll('.notes-tools button');

  const now = new Date();
  const CURRENT_YEAR = now.getFullYear();
  const TODAY_DATE = now.getDate();
  const TODAY_MONTH = now.getMonth();
  let shownYear = CURRENT_YEAR;

  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  let monthViewIndex = null;
  const monthToggleBtn = document.getElementById('monthToggleBtn');
  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  // Events data (initialized early for calendar rendering)
  let events = [];
  let selectedCalendarDate = null;

  function renderCalendar(year) {
    calEl.innerHTML = '';
    yearEl.textContent = `Calendar ${year}`;

    MONTHS.forEach((m, i) => {
      if (monthViewIndex !== null && monthViewIndex !== i) return;
      const box = document.createElement('div');
      box.className = 'month';
      box.innerHTML = `<h2 data-month="${i}" style="cursor:pointer">${m}</h2>`;

      const w = document.createElement('div');
      w.className = 'weekdays';
      DAYS.forEach(d => w.innerHTML += `<div>${d}</div>`);

      const g = document.createElement('div');
      g.className = 'days';
      const first = new Date(year, i, 1).getDay();
      const total = new Date(year, i + 1, 0).getDate();

      for (let j = 0; j < first; j++) g.innerHTML += '<div></div>';
      for (let d = 1; d <= total; d++) {
        const t = d === TODAY_DATE && i === TODAY_MONTH && year === CURRENT_YEAR;
        const dateStr = `${year}-${String(i + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const hasEvent = events.some(e => e.date === dateStr);
        const dotHtml = hasEvent ? '<span class="event-dot"></span>' : '';
        g.innerHTML += `<div class="${t ? 'today' : ''}" data-date="${dateStr}" style="cursor:pointer">${d}${dotHtml}</div>`;
      }

      box.append(w, g);
      calEl.appendChild(box);
    });

    // Add click handlers to dates for event viewing
    calEl.querySelectorAll('.days div[data-date]').forEach(dayEl => {
      dayEl.onclick = (e) => {
        const dateStr = e.currentTarget.dataset.date;
        if (!dateStr) return;
        selectedCalendarDate = dateStr;
        const eventDateInput = document.getElementById('eventDateInput');
        if (eventDateInput) eventDateInput.value = dateStr;
        if (window.renderEvents) window.renderEvents(dateStr);
        
        // Show events widget if hidden
        const eventsWidget = document.getElementById('floatingEvents');
        if (eventsWidget && eventsWidget.style.display === 'none') {
          if (window.updateEventsVisibility) window.updateEventsVisibility(true);
        }
      };
    });
  }

  function updateTime() {
    const d = new Date();
    const dtText = document.getElementById('dtText');
    if(dtText) {
      dtText.textContent = d.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' }) + ' ‚Ä¢ ' + d.toLocaleTimeString();
    }
  }

  toolButtons.forEach(b => b.onclick = () => {
    document.execCommand(b.dataset.cmd);
    updateToolStates();
  });

  function updateToolStates() {
    toolButtons.forEach(btn => {
      const cmd = btn.dataset.cmd;
      try {
        const isActive = document.queryCommandState(cmd);
        btn.classList.toggle('active', isActive);
      } catch (e) {}
    });
  }

  document.addEventListener('selectionchange', () => {
    if (document.activeElement === notesEditor) {
      updateToolStates();
    }
  });

  const NOTES_KEY = 'calendar_notes_rich';
  notesEditor.innerHTML = localStorage.getItem(NOTES_KEY) || '';
  notesEditor.oninput = () => localStorage.setItem(NOTES_KEY, notesEditor.innerHTML);

  renderCalendar(shownYear);

  // Font size controls
  const fontButtons = document.querySelectorAll('.font-btn');
  fontButtons.forEach(btn => {
    btn.onclick = () => {
      const size = btn.dataset.size;
      document.documentElement.style.fontSize = size + '%';
      localStorage.setItem('fontSize', size);
    };
  });

  const savedFontSize = localStorage.getItem('fontSize');
  if (savedFontSize) {
    document.documentElement.style.fontSize = savedFontSize + '%';
  }

  settingsBtn.onclick = () => { settingsPage.style.display = 'block'; };
  closeSettings.onclick = (e) => { e.stopPropagation(); settingsPage.style.display = 'none'; };

  settingsPage.addEventListener('click', (e) => {
    if (e.target === settingsPage) {
      settingsPage.style.display = 'none';
    }
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && settingsPage.style.display === 'block') {
      settingsPage.style.display = 'none';
    }
  });

  monthToggleBtn.onclick = () => {
    if (monthViewIndex === null) {
      monthViewIndex = TODAY_MONTH;
      monthToggleBtn.textContent = 'üóì Year';
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
    } else {
      monthViewIndex = null;
      monthToggleBtn.textContent = 'üìÖ Month';
      yearEl.textContent = `Calendar ${shownYear}`;
    }
    renderCalendar(shownYear);
  };

  calEl.addEventListener('click', (e) => {
    const h = e.target.closest('h2[data-month]');
    if (!h) return;
    monthViewIndex = Number(h.dataset.month);
    monthToggleBtn.textContent = 'üóì Year';
    yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
    renderCalendar(shownYear);
  });
  updateTime();
  setInterval(updateTime, 1000);

  const POMO_KEY = 'pomo_duration_minutes';
  const POMO_SECS_LOCAL_KEY = 'pomo_secs_local';
  const DEVICE_ID_KEY = 'device_id';
  let defaultPomoMinutes = Number(localStorage.getItem(POMO_KEY)) || 60;
  let secsStored = Number(localStorage.getItem(POMO_SECS_LOCAL_KEY));
  let secs = (!isNaN(secsStored) && secsStored > 0) ? secsStored : (defaultPomoMinutes * 60);
  let timer = null; // local display tick interval
  let anchorStartMs = null; // when (ms) the session started (server/local)
  let anchorRemaining = null; // secs remaining at start
  let isApplyingRemote = false;
  let deviceId = localStorage.getItem(DEVICE_ID_KEY);
  if (!deviceId) {
    deviceId = Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(DEVICE_ID_KEY, deviceId);
  }

  const pomoDurationInput = document.getElementById('pomoDurationInput');
  pomoDurationInput.value = defaultPomoMinutes;

  function updatePomoDisplay() {
    const minStr = String(Math.floor(secs/60)).padStart(2,'0');
    const secStr = String(secs%60).padStart(2,'0');
    const timeText = `${minStr}:${secStr}`;
    const pt = document.getElementById('pomoTime');
    const fpt = document.getElementById('floatingPomoTime');
    if(pt) pt.textContent = timeText;
    if(fpt) fpt.textContent = timeText;
  }

  function saveLocalSecs() {
    localStorage.setItem(POMO_SECS_LOCAL_KEY, String(secs));
  }

  function setStartButtons(running) {
    const ps = document.getElementById('pomoStart');
    const fps = document.getElementById('floatingPomoStart');
    if (ps) ps.textContent = running ? '‚è∏' : '‚ñ∂';
    if (fps) fps.textContent = running ? '‚è∏' : '‚ñ∂';
  }

  async function syncToCloud(runningFlag, extra = {}) {
    try {
      if (!window.auth || !auth.currentUser || !window.db || !window.doc || !window.setDoc || !window.serverTimestamp) return;
      const ref = doc(db, 'user_pomodoro', auth.currentUser.uid);
      await setDoc(ref, Object.assign({
        duration: defaultPomoMinutes,
        running: !!runningFlag,
        by: deviceId,
        updatedAt: serverTimestamp()
      }, extra), { merge: true });
    } catch (err) {
      console.error('[POMO] Cloud sync failed:', err);
    }
  }

  function clearLocalTimer() {
    if (timer) { clearInterval(timer); timer = null; }
  }

  function startLocalDisplayFromAnchor(remainAtStart, startedAtMs) {
    clearLocalTimer();
    anchorRemaining = remainAtStart;
    anchorStartMs = startedAtMs;
    setStartButtons(true);
    const tick = () => {
      const elapsed = Math.floor((Date.now() - anchorStartMs) / 1000);
      const left = Math.max(0, Math.round(anchorRemaining - elapsed));
      secs = left;
      updatePomoDisplay();
      saveLocalSecs();
      if (left <= 0) {
        clearLocalTimer();
        setStartButtons(false);
      }
    };
    tick();
    timer = setInterval(tick, 1000);
  }

  function togglePomo() {
    // Pause if currently running
    if (timer) {
      clearLocalTimer();
      setStartButtons(false);
      saveLocalSecs();
      // Persist pause with remaining seconds
      syncToCloud(false, { remaining: secs, startedAt: null });
      return;
    }
    // Start a new session from current remaining seconds
    const remainAtStart = secs;
    const startedNow = Date.now();
    startLocalDisplayFromAnchor(remainAtStart, startedNow);
    // Persist start (no per-second writes)
    syncToCloud(true, { remaining: remainAtStart, startedAt: serverTimestamp() });
  }

  function resetPomo() {
    clearLocalTimer();
    secs = defaultPomoMinutes * 60;
    updatePomoDisplay();
    setStartButtons(false);
    saveLocalSecs();
    syncToCloud(false, { remaining: secs, startedAt: null });
  }

  pomoDurationInput.onchange = () => {
    const val = Math.max(1, Number(pomoDurationInput.value) || 60);
    defaultPomoMinutes = val;
    localStorage.setItem(POMO_KEY, val);
    secs = val * 60;
    updatePomoDisplay();
    clearLocalTimer();
    setStartButtons(false);
    saveLocalSecs();
    syncToCloud(false, { remaining: secs, startedAt: null });
  };
  
  document.getElementById('pomoStart').onclick = togglePomo;
  document.getElementById('floatingPomoStart').onclick = togglePomo;

  document.getElementById('pomoReset').onclick = resetPomo;
  document.getElementById('floatingPomoReset').onclick = resetPomo;

  // Expose handler for Firebase snapshot updates
  window.applyRemoteState = (data) => {
    try {
      if (!data) return;
      if (data.by && data.by === deviceId) return; // ignore self-originating updates

      // Update duration if changed remotely
      if (typeof data.duration === 'number' && data.duration > 0 && data.duration !== defaultPomoMinutes) {
        defaultPomoMinutes = data.duration;
        localStorage.setItem(POMO_KEY, String(defaultPomoMinutes));
        if (pomoDurationInput) pomoDurationInput.value = defaultPomoMinutes;
      }

      const running = !!data.running;
      const remaining = (typeof data.remaining === 'number' && data.remaining >= 0)
        ? data.remaining
        : (typeof data.secs === 'number' ? data.secs : defaultPomoMinutes * 60);

      if (running && data.startedAt && typeof data.startedAt.toMillis === 'function') {
        const startedAtMs = data.startedAt.toMillis();
        startLocalDisplayFromAnchor(remaining, startedAtMs);
      } else if (running) {
        // Fallback if startedAt missing: just start from remaining now
        startLocalDisplayFromAnchor(remaining, Date.now());
      } else {
        clearLocalTimer();
        secs = remaining;
        updatePomoDisplay();
        setStartButtons(false);
      }
    } catch (e) {
      console.error('[POMO] applyRemoteState error:', e);
    }
  };

  document.getElementById('prev').onclick = () => {
    if (monthViewIndex !== null) {
      monthViewIndex = (monthViewIndex + 11) % 12;
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
      renderCalendar(shownYear);
    } else {
      renderCalendar(--shownYear);
    }
  };
  document.getElementById('next').onclick = () => {
    if (monthViewIndex !== null) {
      monthViewIndex = (monthViewIndex + 1) % 12;
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
      renderCalendar(shownYear);
    } else {
      renderCalendar(++shownYear);
    }
  };
  todayBtn.onclick = () => {
    if (monthViewIndex === null) {
      shownYear = CURRENT_YEAR;
      renderCalendar(shownYear);
      return;
    }
    shownYear = CURRENT_YEAR;
    monthViewIndex = TODAY_MONTH;
    monthToggleBtn.textContent = 'üóì Year';
    yearEl.textContent = `${MONTHS[TODAY_MONTH]} ${shownYear}`;
    renderCalendar(shownYear);
  };

  const themes = [
    { name: 'üçé macOS', class: '' },
    { name: 'üåô Dark', class: 'dark' },
    { name: 'üåä Ocean', class: 'theme-ocean' },
    { name: 'üå≤ Forest', class: 'theme-forest' },
    { name: 'üåÖ Solar', class: 'theme-solar' }
  ];
  let themeIndex = 0;
  themeBtn.onclick = () => {
    document.body.classList.remove('dark','theme-ocean','theme-forest','theme-solar');
    themeIndex = (themeIndex + 1) % themes.length;
    const t = themes[themeIndex];
    if (t.class) document.body.classList.add(t.class);
    themeBtn.textContent = t.name;
  };

  const layoutBtn = document.getElementById('layoutBtn');
  let currentLayout = 1;
  layoutBtn.onclick = () => {
    const main = document.getElementById('mainLayout');
    if (currentLayout === 1) {
      currentLayout = 2;
      document.body.classList.add('layout-2');
      layoutBtn.textContent = 'üóÇ Layout 2';
      const saved = localStorage.getItem('layout2_split_sizes');
      if (saved) main.style.gridTemplateColumns = saved;
    } else {
      currentLayout = 1;
      document.body.classList.remove('layout-2');
      layoutBtn.textContent = 'üóÇ Layout 1';
      main.style.gridTemplateColumns = '';
    }
  };

  const handle = document.getElementById('resizeHandle');
  let isResizing = false;
  handle.addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'col-resize'; });
  window.addEventListener('mousemove', (e) => {
    if (!isResizing || !document.body.classList.contains('layout-2')) return;
    const main = document.getElementById('mainLayout');
    const rect = main.getBoundingClientRect();
    const leftWidth = e.clientX - rect.left;
    const total = rect.width;
    const leftFr = Math.max(1, Math.min(4, (leftWidth / total) * 3));
    main.style.gridTemplateColumns = `${leftFr}fr 8px ${4 - leftFr}fr`;
  });
  window.addEventListener('mouseup', () => {
    if (!isResizing) return;
    isResizing = false;
    document.body.style.cursor = '';
    const main = document.getElementById('mainLayout');
    if (document.body.classList.contains('layout-2')) {
      localStorage.setItem('layout2_split_sizes', main.style.gridTemplateColumns);
    }
  });

  // =========================
  // APP LAUNCHER & DRAWER
  // =========================
  const appLauncherBtn = document.getElementById('appLauncherBtn');
  const appDrawer = document.getElementById('appDrawer');
  const toggleClockApp = document.getElementById('toggleClockApp');
  const togglePomoApp = document.getElementById('togglePomoApp');
  const toggleTodoApp = document.getElementById('toggleTodoApp');
  const toggleEventsApp = document.getElementById('toggleEventsApp');

  // Open/close app drawer
  if (appLauncherBtn) {
    appLauncherBtn.onclick = () => {
      if (appDrawer.style.display === 'block') {
        appDrawer.style.display = 'none';
      } else {
        appDrawer.style.display = 'block';
      }
    };
  }

  if (appDrawer) {
    appDrawer.onclick = (e) => {
      if (e.target === appDrawer) {
        appDrawer.style.display = 'none';
      }
    };
  }

  // Close drawer on Escape
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && appDrawer.style.display === 'block') {
      appDrawer.style.display = 'none';
    }
  });

  // =========================
  // WIDGET VISIBILITY + DRAG
  // =========================
  const clock = document.getElementById('analogClock');
  const closeClockBtn = document.getElementById('closeClockBtn');
  const floatingPomo = document.getElementById('floatingPomo');
  const closePomoBtn = document.getElementById('closePomoBtn');
  const floatingTodo = document.getElementById('floatingTodo');
  const closeTodoBtn = document.getElementById('closeTodoBtn');
  const floatingEvents = document.getElementById('floatingEvents');
  const closeEventsBtn = document.getElementById('closeEventsBtn');

  const CLOCK_VIS_KEY = 'show_analog_clock';
  const POMO_VIS_KEY = 'show_floating_pomo';
  const TODO_VIS_KEY = 'show_floating_todo';
  const EVENTS_VIS_KEY = 'show_floating_events';

  function updateClockVisibility(visible) {
    if (!clock) return;
    clock.style.display = visible ? 'block' : 'none';
    localStorage.setItem(CLOCK_VIS_KEY, String(visible));
    if (toggleClockApp) toggleClockApp.classList.toggle('active', !!visible);
  }

  function updatePomoVisibility(visible) {
    if (!floatingPomo) return;
    floatingPomo.style.display = visible ? 'flex' : 'none';
    localStorage.setItem(POMO_VIS_KEY, String(visible));
    if (togglePomoApp) togglePomoApp.classList.toggle('active', !!visible);
  }

  function updateTodoVisibility(visible) {
    if (!floatingTodo) return;
    floatingTodo.style.display = visible ? 'flex' : 'none';
    localStorage.setItem(TODO_VIS_KEY, String(visible));
    if (toggleTodoApp) toggleTodoApp.classList.toggle('active', !!visible);
  }

  function updateEventsVisibility(visible) {
    if (!floatingEvents) return;
    floatingEvents.style.display = visible ? 'flex' : 'none';
    localStorage.setItem(EVENTS_VIS_KEY, String(visible));
    if (toggleEventsApp) toggleEventsApp.classList.toggle('active', !!visible);
  }
  window.updateEventsVisibility = updateEventsVisibility;

  // Init states from localStorage
  (function initWidgetVisibility() {
    const savedClock = localStorage.getItem(CLOCK_VIS_KEY);
    const showClock = savedClock === null ? true : savedClock !== 'false';
    updateClockVisibility(showClock);

    const savedPomoVis = localStorage.getItem(POMO_VIS_KEY);
    const showPomo = savedPomoVis === null ? true : savedPomoVis !== 'false';
    updatePomoVisibility(showPomo);

    const savedTodoVis = localStorage.getItem(TODO_VIS_KEY);
    const showTodo = savedTodoVis === null ? true : savedTodoVis !== 'false';
    updateTodoVisibility(showTodo);

    const savedEventsVis = localStorage.getItem(EVENTS_VIS_KEY);
    const showEvents = savedEventsVis === null ? true : savedEventsVis !== 'false';
    updateEventsVisibility(showEvents);
  })();

  // App toggle click handlers
  if (toggleClockApp) {
    toggleClockApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = localStorage.getItem(CLOCK_VIS_KEY) !== 'false';
      updateClockVisibility(!isVisible);
    };
  }
  if (togglePomoApp) {
    togglePomoApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = localStorage.getItem(POMO_VIS_KEY) !== 'false';
      updatePomoVisibility(!isVisible);
    };
  }
  if (toggleTodoApp) {
    toggleTodoApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = localStorage.getItem(TODO_VIS_KEY) !== 'false';
      updateTodoVisibility(!isVisible);
    };
  }
  if (toggleEventsApp) {
    toggleEventsApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = localStorage.getItem(EVENTS_VIS_KEY) !== 'false';
      updateEventsVisibility(!isVisible);
    };
  }

  // Close buttons
  if (closeClockBtn) closeClockBtn.onclick = (e) => { e.stopPropagation(); updateClockVisibility(false); };
  if (closePomoBtn) closePomoBtn.onclick = (e) => { e.stopPropagation(); updatePomoVisibility(false); };
  if (closeTodoBtn) closeTodoBtn.onclick = (e) => { e.stopPropagation(); updateTodoVisibility(false); };
  if (closeEventsBtn) closeEventsBtn.onclick = (e) => { e.stopPropagation(); updateEventsVisibility(false); };

  // =========================
  // CALCULATOR WIDGET
  // =========================
  const floatingCalculator = document.getElementById('floatingCalculator');
  const calcDisplay = document.getElementById('calcDisplay');
  const calcButtons = document.querySelectorAll('.calc-btn');
  const closeCalculatorBtn = document.getElementById('closeCalculatorBtn');
  const toggleCalculatorApp = document.getElementById('toggleCalculatorApp');
  const CALCULATOR_VIS_KEY = 'show_calculator';

  let calcExpression = '';
  let calcResult = '0';

  function updateCalculatorVisibility(visible) {
    if (!floatingCalculator) return;
    floatingCalculator.style.display = visible ? 'flex' : 'none';
    localStorage.setItem(CALCULATOR_VIS_KEY, String(visible));
    if (toggleCalculatorApp) toggleCalculatorApp.classList.toggle('active', !!visible);
  }

  function updateCalcDisplay(value) {
    if (calcDisplay) calcDisplay.textContent = value;
  }

  function handleCalculatorInput(input) {
    if (input === 'C') {
      calcExpression = '';
      calcResult = '0';
      updateCalcDisplay('0');
    } else if (input === '=') {
      try {
        // Replace display symbols with JS operators
        const expr = calcExpression.replace(/√ó/g, '*').replace(/√∑/g, '/').replace(/‚àí/g, '-');
        const result = eval(expr);
        calcResult = result.toString();
        updateCalcDisplay(calcResult);
        calcExpression = calcResult;
      } catch (e) {
        updateCalcDisplay('Error');
        calcExpression = '';
        calcResult = '0';
      }
    } else {
      if (calcExpression === '0' || calcExpression === calcResult) {
        calcExpression = input;
      } else {
        calcExpression += input;
      }
      updateCalcDisplay(calcExpression);
    }
  }

  calcButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const value = btn.dataset.calc;
      if (value) handleCalculatorInput(value);
    });
  });

  // Keyboard support
  document.addEventListener('keydown', (e) => {
    if (floatingCalculator.style.display !== 'flex') return;
    const key = e.key;
    if (/[0-9\+\-\*\/\.\(\)]/.test(key)) {
      e.preventDefault();
      handleCalculatorInput(key);
    } else if (key === 'Enter') {
      e.preventDefault();
      handleCalculatorInput('=');
    } else if (key === 'Escape' || key === 'Backspace') {
      e.preventDefault();
      handleCalculatorInput('C');
    }
  });

  if (toggleCalculatorApp) {
    toggleCalculatorApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = localStorage.getItem(CALCULATOR_VIS_KEY) !== 'false';
      updateCalculatorVisibility(!isVisible);
    };
  }

  if (closeCalculatorBtn) {
    closeCalculatorBtn.onclick = (e) => {
      e.stopPropagation();
      updateCalculatorVisibility(false);
    };
  }

  // Init calculator visibility
  (function initCalculatorVisibility() {
    if (toggleCalculatorApp) {
      const savedCalc = localStorage.getItem(CALCULATOR_VIS_KEY);
      const showCalc = savedCalc === null ? false : savedCalc !== 'false';
      toggleCalculatorApp.classList.toggle('active', showCalc);
      if (showCalc) floatingCalculator.style.display = 'flex';
    }
  })();

  // =========================
  // RESPONSIVE WIDGET POSITIONING
  // =========================
  const WIDGET_POSITIONS_KEY = 'widget_positions_responsive';
  
  function constrainWidgetToViewport(el) {
    if (!el) return;
    const rect = el.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    
    let left = parseFloat(el.style.left) || rect.left;
    let top = parseFloat(el.style.top) || rect.top;
    
    // Ensure widget is at least partially visible
    const minVisible = 50; // At least 50px must be visible
    
    if (left + minVisible > vw) left = vw - minVisible;
    if (left + rect.width < minVisible) left = minVisible - rect.width;
    if (top + minVisible > vh) top = vh - minVisible;
    if (top < 0) top = 0;
    
    el.style.left = left + 'px';
    el.style.top = top + 'px';
  }
  
  function saveWidgetPosition(el, id) {
    if (!el) return;
    const positions = JSON.parse(localStorage.getItem(WIDGET_POSITIONS_KEY) || '{}');
    positions[id] = {
      left: el.style.left,
      top: el.style.top,
      width: window.innerWidth,
      height: window.innerHeight
    };
    localStorage.setItem(WIDGET_POSITIONS_KEY, JSON.stringify(positions));
  }
  
  function restoreWidgetPosition(el, id) {
    if (!el) return;
    const positions = JSON.parse(localStorage.getItem(WIDGET_POSITIONS_KEY) || '{}');
    const saved = positions[id];
    
    if (saved && saved.left && saved.top) {
      // Scale position if viewport size changed
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const savedVw = saved.width || vw;
      const savedVh = saved.height || vh;
      
      const scaleX = vw / savedVw;
      const scaleY = vh / savedVh;
      
      const newLeft = parseFloat(saved.left) * scaleX;
      const newTop = parseFloat(saved.top) * scaleY;
      
      el.style.left = newLeft + 'px';
      el.style.top = newTop + 'px';
      el.style.right = 'auto';
      el.style.bottom = 'auto';
      
      // Ensure it's still visible after scaling
      constrainWidgetToViewport(el);
    }
  }
  
  function adjustAllWidgetsToViewport() {
    const widgets = [
      { el: clock, id: 'analogClock' },
      { el: floatingPomo, id: 'floatingPomo' },
      { el: floatingTodo, id: 'floatingTodo' },
      { el: floatingEvents, id: 'floatingEvents' },
      { el: floatingCalculator, id: 'floatingCalculator' }
    ];
    
    widgets.forEach(({ el, id }) => {
      if (el && el.style.left && el.style.top) {
        constrainWidgetToViewport(el);
        saveWidgetPosition(el, id);
      }
    });
  }

  // Draggable (mouse + touch) - only from header
  function makeDraggable(el, handleSelector = null, widgetId = null) {
    if (!el) return;
    let isDragging = false;
    let startX, startY, startLeft, startTop;

    const getPoint = (evt) => {
      if (evt.touches && evt.touches.length) return { x: evt.touches[0].clientX, y: evt.touches[0].clientY };
      return { x: evt.clientX, y: evt.clientY };
    };

    const startDrag = (e) => {
      // If handleSelector is provided, only allow drag from that element
      if (handleSelector) {
        const handle = el.querySelector(handleSelector);
        if (!handle || !handle.contains(e.target)) return;
      }
      
      // prevent dragging when pressing inner buttons or input fields
      if (e.target && (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
      
      isDragging = true;
      const p = getPoint(e);
      startX = p.x; startY = p.y;
      startLeft = el.offsetLeft; startTop = el.offsetTop;
      el.style.right = 'auto';
      el.style.bottom = 'auto';
      // Prevent scrolling on touch devices only when actually dragging from valid area
      if (e.type === 'touchstart') {
        e.preventDefault();
      }
    };

    const moveDrag = (e) => {
      if (!isDragging) return;
      // Prevent scrolling while dragging on touch devices
      if (e.type === 'touchmove') {
        e.preventDefault();
      }
      const p = getPoint(e);
      el.style.left = startLeft + (p.x - startX) + 'px';
      el.style.top = startTop + (p.y - startY) + 'px';
    };

    const endDrag = () => {
      if (!isDragging) return;
      isDragging = false;
      constrainWidgetToViewport(el);
      if (widgetId) saveWidgetPosition(el, widgetId);
    };

    el.addEventListener('mousedown', startDrag);
    el.addEventListener('touchstart', startDrag, { passive: false });
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('touchmove', moveDrag, { passive: false });
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);
  }

  // Restore saved positions
  restoreWidgetPosition(clock, 'analogClock');
  restoreWidgetPosition(floatingPomo, 'floatingPomo');
  restoreWidgetPosition(floatingTodo, 'floatingTodo');
  restoreWidgetPosition(floatingEvents, 'floatingEvents');
  restoreWidgetPosition(floatingCalculator, 'floatingCalculator');

  makeDraggable(clock, null, 'analogClock');
  makeDraggable(floatingPomo, null, 'floatingPomo');
  makeDraggable(floatingTodo, '.todo-header', 'floatingTodo');
  makeDraggable(floatingEvents, '.events-header', 'floatingEvents');
  makeDraggable(floatingCalculator, '.calc-header', 'floatingCalculator');

  // Handle viewport resize and orientation change
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(adjustAllWidgetsToViewport, 200);
  });
  
  window.addEventListener('orientationchange', () => {
    setTimeout(adjustAllWidgetsToViewport, 300);
  });

  // =========================
  // ANALOG CLOCK TICK LOGIC
  // =========================
  const hourHand = document.getElementById('hourHand');
  const minuteHand = document.getElementById('minuteHand');
  const secondHand = document.getElementById('secondHand');
  const clockDay = document.getElementById('clockDay');
  const clockNum = document.getElementById('clockNum');

  function updateAnalogClock() {
    const now = new Date();
    const sec = now.getSeconds();
    const min = now.getMinutes();
    const hr = now.getHours() % 12;

    if (hourHand) hourHand.style.transform = `translateX(-50%) rotate(${hr * 30 + min * 0.5}deg)`;
    if (minuteHand) minuteHand.style.transform = `translateX(-50%) rotate(${min * 6}deg)`;
    if (secondHand) secondHand.style.transform = `translateX(-50%) rotate(${sec * 6}deg)`;

    if (clockDay) clockDay.textContent = now.toLocaleDateString(undefined, { weekday: 'short' });
    if (clockNum) clockNum.textContent = now.getDate();
  }

  // Align ticks to the next second boundary for accuracy
  (function startClockTicks() {
    updateAnalogClock();
    const now = new Date();
    const msToNextSecond = 1000 - now.getMilliseconds();
    setTimeout(() => {
      updateAnalogClock();
      setInterval(updateAnalogClock, 1000);
    }, msToNextSecond);
  })();

  // =========================
  // TODO LIST LOGIC
  // =========================
  let todos = [];
  const todoInput = document.getElementById('todoInput');
  const todoAddBtn = document.getElementById('todoAddBtn');
  const todoList = document.getElementById('todoList');

  function renderTodos() {
    if (!todoList) return;
    todoList.innerHTML = '';
    todos.forEach((todo, index) => {
      const item = document.createElement('div');
      item.className = 'todo-item';
      item.innerHTML = `
        <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} data-index="${index}" />
        <span class="todo-text ${todo.completed ? 'completed' : ''}">${todo.text}</span>
        <button class="todo-delete" data-index="${index}">‚úï</button>
      `;
      todoList.appendChild(item);
    });

    // Event listeners
    todoList.querySelectorAll('.todo-checkbox').forEach(cb => {
      cb.onchange = (e) => {
        const idx = Number(e.target.dataset.index);
        todos[idx].completed = e.target.checked;
        renderTodos();
        syncTodosToCloud();
      };
    });
    todoList.querySelectorAll('.todo-delete').forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        const idx = Number(e.currentTarget.dataset.index);
        todos.splice(idx, 1);
        renderTodos();
        syncTodosToCloud();
      };
    });
  }

  function addTodo() {
    if (!todoInput) return;
    const text = todoInput.value.trim();
    if (!text) return;
    todos.push({ text, completed: false, id: Date.now() + Math.random() });
    todoInput.value = '';
    renderTodos();
    syncTodosToCloud();
  }

  async function syncTodosToCloud() {
    try {
      if (!window.auth || !auth.currentUser || !window.db || !window.doc || !window.setDoc || !window.serverTimestamp) return;
      const ref = doc(db, 'user_todos', auth.currentUser.uid);
      await setDoc(ref, {
        items: todos,
        by: deviceId,
        updatedAt: serverTimestamp()
      }, { merge: true });
    } catch (err) {
      console.error('[TODO] Cloud sync failed:', err);
    }
  }

  window.applyRemoteTodos = (data) => {
    try {
      if (!data) return;
      if (data.by && data.by === deviceId) return;
      if (Array.isArray(data.items)) {
        todos = data.items;
        renderTodos();
      }
    } catch (e) {
      console.error('[TODO] applyRemoteTodos error:', e);
    }
  };

  if (todoAddBtn) todoAddBtn.onclick = addTodo;
  if (todoInput) {
    todoInput.onkeypress = (e) => {
      if (e.key === 'Enter') addTodo();
    };
  }

  renderTodos();

  // =========================
  // EVENTS LOGIC
  // =========================
  const eventDateInput = document.getElementById('eventDateInput');
  const eventTextInput = document.getElementById('eventTextInput');
  const eventAddBtn = document.getElementById('eventAddBtn');
  const eventsList = document.getElementById('eventsList');
  const selectedDateBadge = document.getElementById('selectedDateBadge');
  const showAllEventsBtn = document.getElementById('showAllEventsBtn');

  // Set today as default date
  if (eventDateInput) {
    const today = new Date();
    eventDateInput.value = today.toISOString().split('T')[0];
  }

  // Click date badge or button to show all events
  if (selectedDateBadge) {
    selectedDateBadge.onclick = () => {
      selectedCalendarDate = null;
      renderEvents(null);
    };
  }
  if (showAllEventsBtn) {
    showAllEventsBtn.onclick = () => {
      selectedCalendarDate = null;
      renderEvents(null);
    };
  }

  function renderEvents(filterDate = null) {
    if (!eventsList) return;
    eventsList.innerHTML = '';
    
    // Filter events by date if specified
    const filteredEvents = filterDate 
      ? events.filter(e => e.date === filterDate)
      : events;

    // Sort events by date (newest first)
    filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));

    filteredEvents.forEach((event) => {
      const actualIndex = events.findIndex(e => e.id === event.id);
      const item = document.createElement('div');
      item.className = 'event-item';
      const dateObj = new Date(event.date + 'T00:00:00');
      const dateStr = dateObj.toLocaleDateString(undefined, { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
      item.innerHTML = `
        <div class="event-date-badge">${dateStr}</div>
        <div class="event-text">${event.text}</div>
        <button class="event-delete" data-index="${actualIndex}">‚úï</button>
      `;
      eventsList.appendChild(item);
    });

    // Event listeners
    eventsList.querySelectorAll('.event-delete').forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        const idx = Number(e.currentTarget.dataset.index);
        events.splice(idx, 1);
        renderEvents(selectedCalendarDate);
        renderCalendar(shownYear);
        syncEventsToCloud();
      };
    });

    // Update selected date badge and show all button
    if (selectedDateBadge) {
      if (filterDate) {
        const dateObj = new Date(filterDate + 'T00:00:00');
        selectedDateBadge.textContent = 'üìÜ ' + dateObj.toLocaleDateString(undefined, { 
          month: 'short', 
          day: 'numeric' 
        });
        selectedDateBadge.style.display = 'inline-block';
        if (showAllEventsBtn) showAllEventsBtn.style.display = 'inline-block';
      } else {
        selectedDateBadge.textContent = '';
        selectedDateBadge.style.display = 'none';
        if (showAllEventsBtn) showAllEventsBtn.style.display = 'none';
      }
    }
  }
  window.renderEvents = renderEvents;

  function addEvent() {
    if (!eventDateInput || !eventTextInput) return;
    const date = eventDateInput.value;
    const text = eventTextInput.value.trim();
    if (!date || !text) return;
    
    events.push({ 
      date, 
      text, 
      id: Date.now() + Math.random() 
    });
    
    eventTextInput.value = '';
    // Keep current filter (if any) after adding
    renderEvents(selectedCalendarDate);
    renderCalendar(shownYear);
    syncEventsToCloud();
  }

  async function syncEventsToCloud() {
    try {
      if (!window.auth || !auth.currentUser || !window.db || !window.doc || !window.setDoc || !window.serverTimestamp) return;
      const ref = doc(db, 'user_events', auth.currentUser.uid);
      await setDoc(ref, {
        items: events,
        by: deviceId,
        updatedAt: serverTimestamp()
      }, { merge: true });
    } catch (err) {
      console.error('[EVENTS] Cloud sync failed:', err);
    }
  }

  window.applyRemoteEvents = (data) => {
    try {
      if (!data) return;
      if (data.by && data.by === deviceId) return;
      if (Array.isArray(data.items)) {
        events = data.items;
        // Preserve current filter when receiving remote updates
        renderEvents(selectedCalendarDate);
        renderCalendar(shownYear);
      }
    } catch (e) {
      console.error('[EVENTS] applyRemoteEvents error:', e);
    }
  };

  if (eventAddBtn) eventAddBtn.onclick = addEvent;
  if (eventTextInput) {
    eventTextInput.onkeypress = (e) => {
      if (e.key === 'Enter') addEvent();
    };
  }

  // Show all events initially (no filter)
  renderEvents(null);
</script>

<!-- Firebase Module -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
  import {
    getAuth, setPersistence, browserLocalPersistence, signOut, onAuthStateChanged,
    signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail,
    signInWithCustomToken
  } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

  // Firebase config
  const firebaseConfig = {
    apiKey: 'AIzaSyA05Vxw3kSZ8xAHUBppMh5p7VwBZ-47kmM',
    authDomain: 'calendar-599ac.firebaseapp.com',
    projectId: 'calendar-599ac',
    storageBucket: 'calendar-599ac.firebasestorage.app',
    messagingSenderId: '89812638572',
    appId: '1:89812638572:web:f02d7309367576a619b149'
  };

  // Initialize
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Expose for non-module script usage
  window.auth = auth;
  window.db = db;
  window.doc = doc;
  window.setDoc = setDoc;
  window.serverTimestamp = serverTimestamp;

  // UI elements
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const resetPasswordBtn = document.getElementById('resetPasswordBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const loggedOutUI = document.getElementById('loggedOutUI');
  const loggedInUI = document.getElementById('loggedInUI');
  const userEmailDisplay = document.getElementById('userEmailDisplay');
  const syncStatus = document.getElementById('syncStatus');
  const notesEditor = document.getElementById('notesEditor');

  const NOTES_KEY_CLOUD = 'calendar_notes_rich';

  const setSyncStatus = (text) => { if (syncStatus) syncStatus.textContent = text; };

  // Auth actions
  const handleAuthError = (err) => {
    console.error(err);
    let msg = 'Authentication failed';
    if (err.code === 'auth/wrong-password') msg = 'Wrong password';
    if (err.code === 'auth/user-not-found') msg = 'User not found';
    if (err.code === 'auth/email-already-in-use') msg = 'Email already registered';
    if (err.code === 'auth/invalid-email') msg = 'Invalid email address';
    if (err.code === 'auth/weak-password') msg = 'Password is too weak';
    setSyncStatus('Error: ' + msg);
  };

  if (loginBtn) loginBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) return setSyncStatus('Enter email & password');
    try {
      setSyncStatus('Logging in...');
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) { handleAuthError(err); }
  };

  if (signupBtn) signupBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) return setSyncStatus('Enter email & password');
    try {
      setSyncStatus('Creating account...');
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) { handleAuthError(err); }
  };

  if (resetPasswordBtn) resetPasswordBtn.onclick = async () => {
    const email = emailInput.value.trim();
    if (!email) return setSyncStatus('Enter your email first');
    try {
      setSyncStatus('Sending reset link...');
      await sendPasswordResetEmail(auth, email);
      setSyncStatus('Check your inbox for reset link');
    } catch (err) { handleAuthError(err); }
  };

  if (logoutBtn) logoutBtn.onclick = () => signOut(auth);

  // Persist auth
  (async function initAuth() {
    try {
      await setPersistence(auth, browserLocalPersistence);
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      }
    } catch (err) {
      console.error('Init Auth error', err);
    }
  })();

  // Realtime sync
  let unsubscribeNote = null;
  let unsubscribePomo = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      if (loggedOutUI) loggedOutUI.style.display = 'none';
      if (loggedInUI) loggedInUI.style.display = 'block';
      if (userEmailDisplay) userEmailDisplay.textContent = `Logged in as: ${user.email}`;
      setSyncStatus('Signed in ‚Äî syncing');

      // Notes listener
      const noteRef = doc(db, 'user_notes', user.uid);
      if (unsubscribeNote) unsubscribeNote();
      unsubscribeNote = onSnapshot(noteRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (document.activeElement !== notesEditor && notesEditor) {
            notesEditor.innerHTML = data.content || '';
          }
          setSyncStatus('Cloud Synced');
        } else {
          const local = localStorage.getItem(NOTES_KEY_CLOUD) || '';
          setDoc(noteRef, { content: local, updatedAt: serverTimestamp() })
            .then(() => setSyncStatus('Synced (Started Cloud)'))
            .catch(() => setSyncStatus('Sync Error'));
        }
      }, (err) => {
        console.error('Firestore Error:', err);
        setSyncStatus('Sync Error: Permission Denied');
      });

      // Pomodoro listener
      const pomoRef = doc(db, 'user_pomodoro', user.uid);
      if (unsubscribePomo) unsubscribePomo();
      unsubscribePomo = onSnapshot(pomoRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (window.applyRemoteState) {
            window.applyRemoteState(data);
          }
        } else {
          const localDuration = Number(localStorage.getItem('pomo_duration_minutes')) || 60;
          const localSecs = Number(localStorage.getItem('pomo_secs_local')) || (localDuration * 60);
          setDoc(pomoRef, {
            remaining: localSecs,
            duration: localDuration,
            running: false,
            startedAt: null,
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial pomo set error:', err));
        }
      }, (err) => {
        console.error('Pomodoro listener error:', err);
      });

      // Todo listener
      const todoRef = doc(db, 'user_todos', user.uid);
      let unsubscribeTodo = null;
      if (unsubscribeTodo) unsubscribeTodo();
      unsubscribeTodo = onSnapshot(todoRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (window.applyRemoteTodos) {
            window.applyRemoteTodos(data);
          }
        } else {
          setDoc(todoRef, {
            items: [],
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial todo set error:', err));
        }
      }, (err) => {
        console.error('Todo listener error:', err);
      });

      // Events listener
      const eventsRef = doc(db, 'user_events', user.uid);
      let unsubscribeEvents = null;
      if (unsubscribeEvents) unsubscribeEvents();
      unsubscribeEvents = onSnapshot(eventsRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (window.applyRemoteEvents) {
            window.applyRemoteEvents(data);
          }
        } else {
          setDoc(eventsRef, {
            items: [],
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial events set error:', err));
        }
      }, (err) => {
        console.error('Events listener error:', err);
      });

    } else {
      if (loggedOutUI) loggedOutUI.style.display = 'block';
      if (loggedInUI) loggedInUI.style.display = 'none';
      setSyncStatus('Not signed in (Local mode)');
      if (unsubscribeNote) { unsubscribeNote(); unsubscribeNote = null; }
      if (unsubscribePomo) { unsubscribePomo(); unsubscribePomo = null; }
      if (notesEditor) notesEditor.innerHTML = localStorage.getItem(NOTES_KEY_CLOUD) || '';
    }
  });

  // Debounced cloud save for notes
  let saveTimer = null;
  if (notesEditor) {
    notesEditor.addEventListener('input', () => {
      const html = notesEditor.innerHTML;
      localStorage.setItem(NOTES_KEY_CLOUD, html);
      if (auth.currentUser) {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(async () => {
          try {
            const noteRef = doc(db, 'user_notes', auth.currentUser.uid);
            await setDoc(noteRef, { content: html, updatedAt: serverTimestamp() }, { merge: true });
            setSyncStatus('All changes saved');
          } catch (err) {
            setSyncStatus('Cloud save failed');
          }
        }, 800);
      }
    });
  }

  window.addEventListener('offline', () => setSyncStatus('Offline ‚Äî saved locally'));
  window.addEventListener('online', () => setSyncStatus('Online'));
  
  // =========================
  // GROUP STUDY UI HANDLERS
  // =========================
  
  const studyToggleBtn = document.getElementById('studyToggleBtn');
  const studyModal = document.getElementById('studyModal');
  const createSessionBtn = document.getElementById('createSessionBtn');
  const joinSessionBtn = document.getElementById('joinSessionBtn');
  const copySessionCodeBtn = document.getElementById('copySessionCodeBtn');
  const closeStudyModal = document.getElementById('closeStudyModal');
  const chatWidget = document.getElementById('chatWidget');
  const closeChatBtn = document.getElementById('closeChatBtn');
  const sendChatBtn = document.getElementById('sendChatBtn');
  const chatMessageInput = document.getElementById('chatMessageInput');
  
  let currentStudyMode = 'solo';
  let currentSessionCode = null;
  let peer = null;
  let connections = [];
  
  // Get user display name (email or name)
  function getUserDisplayName() {
    // Try to get from localStorage first
    let displayName = localStorage.getItem('studyDisplayName');
    
    if (!displayName) {
      // Try to get from Firebase auth if logged in
      if (auth && auth.currentUser && auth.currentUser.email) {
        displayName = auth.currentUser.email;
        localStorage.setItem('studyDisplayName', displayName);
      } else {
        // Prompt user to enter their email/name
        displayName = prompt('Enter your email or name for chat:', '');
        if (displayName && displayName.trim()) {
          displayName = displayName.trim();
          localStorage.setItem('studyDisplayName', displayName);
        } else {
          displayName = 'Anonymous' + Math.floor(Math.random() * 1000);
        }
      }
    }
    
    return displayName;
  }
  
  let myUserId = getUserDisplayName();
  
  // Generate random session code
  function generateSessionCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }
  
  // Initialize PeerJS
  function initPeer(sessionCode, isHost) {
    const peerId = `study-${sessionCode.toLowerCase()}-${isHost ? 'host' : myUserId}`;
    
    peer = new Peer(peerId, {
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      }
    });
    
    peer.on('open', (id) => {
      console.log('Connected with ID:', id);
      addChatSystemMessage('‚úì Connected to chat');
      
      // If not host, connect to host
      if (!isHost) {
        const hostId = `study-${sessionCode.toLowerCase()}-host`;
        setTimeout(() => {
          const conn = peer.connect(hostId);
          setupConnection(conn);
        }, 1000);
      }
    });
    
    peer.on('connection', (conn) => {
      console.log('New peer connected');
      setupConnection(conn);
      addChatSystemMessage('Someone joined the session');
    });
    
    peer.on('error', (err) => {
      console.error('Peer error:', err);
      addChatSystemMessage('‚ö†Ô∏è Running in offline mode');
    });
  }
  
  function setupConnection(conn) {
    connections.push(conn);
    
    conn.on('open', () => {
      console.log('Connection established');
      updateParticipantCount();
    });
    
    conn.on('data', (data) => {
      if (data.type === 'message') {
        displayReceivedMessage(data.userId, data.text);
      }
    });
    
    conn.on('close', () => {
      connections = connections.filter(c => c !== conn);
      updateParticipantCount();
      addChatSystemMessage('Someone left the session');
    });
  }
  
  function broadcastMessage(text) {
    const message = {
      type: 'message',
      userId: myUserId,
      text: text
    };
    
    connections.forEach(conn => {
      if (conn.open) {
        conn.send(message);
      }
    });
  }
  
  function displayReceivedMessage(userId, text) {
    const chatContainer = document.getElementById('matrixChatMessages');
    if (!chatContainer) return;
    
    const msgDiv = document.createElement('div');
    msgDiv.style.cssText = 'padding:0.5rem;margin:0.3rem 0;background:rgba(0,0,0,0.05);border-radius:8px;';
    msgDiv.innerHTML = `<strong style="color:var(--primary);">${userId}:</strong> ${escapeHtml(text)}`;
    chatContainer.appendChild(msgDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
  
  function addChatSystemMessage(text) {
    const chatContainer = document.getElementById('matrixChatMessages');
    if (!chatContainer) return;
    
    const msgDiv = document.createElement('div');
    msgDiv.style.cssText = 'text-align:center;color:var(--muted);font-size:0.75rem;padding:0.3rem;';
    msgDiv.textContent = text;
    chatContainer.appendChild(msgDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
  
  function updateParticipantCount() {
    const count = connections.filter(c => c.open).length + 1;
    const countEl = document.getElementById('participantCount');
    if (countEl) countEl.textContent = count;
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Toggle study mode
  studyToggleBtn.onclick = () => {
    if (currentStudyMode === 'solo') {
      studyModal.style.display = 'flex';
    } else {
      if (confirm('Leave group study session?')) {
        exitGroupMode();
      }
    }
  };
  
  // Study tabs
  document.querySelectorAll('.study-tab').forEach(tab => {
    tab.onclick = () => {
      const tabName = tab.dataset.tab;
      document.querySelectorAll('.study-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.study-tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.querySelector(`[data-content="${tabName}"]`).classList.add('active');
    };
  });
  
  // Create session
  createSessionBtn.onclick = () => {
    currentSessionCode = generateSessionCode();
    document.getElementById('generatedCode').textContent = currentSessionCode;
    copySessionCodeBtn.style.display = 'block';
    document.getElementById('createInfo').textContent = '‚úì Session created! Share the code.';
    document.getElementById('createInfo').style.color = 'var(--today)';
    
    enterGroupMode();
    studyModal.style.display = 'none';
    
    // Start as host
    initPeer(currentSessionCode, true);
  };
  
  // Copy code
  copySessionCodeBtn.onclick = () => {
    navigator.clipboard.writeText(currentSessionCode);
    copySessionCodeBtn.textContent = '‚úì Copied!';
    setTimeout(() => {
      copySessionCodeBtn.textContent = 'üìã Copy Code';
    }, 2000);
  };
  
  // Join session
  joinSessionBtn.onclick = () => {
    const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
    if (code.length !== 6) {
      document.getElementById('joinInfo').textContent = '‚ö†Ô∏è Enter a valid 6-character code';
      document.getElementById('joinInfo').style.color = 'var(--primary)';
      return;
    }
    
    currentSessionCode = code;
    document.getElementById('joinInfo').textContent = '‚úì Joining...';
    document.getElementById('joinInfo').style.color = 'var(--today)';
    
    enterGroupMode();
    studyModal.style.display = 'none';
    
    // Join as participant
    initPeer(currentSessionCode, false);
  };
  
  // Enter group mode
  function enterGroupMode() {
    currentStudyMode = 'group';
    studyToggleBtn.textContent = 'üë• Group Study';
    studyToggleBtn.classList.add('active');
    chatWidget.style.display = 'flex';
    document.getElementById('chatSessionCode').textContent = `Session: ${currentSessionCode}`;
  }
  
  // Exit group mode
  function exitGroupMode() {
    currentStudyMode = 'solo';
    
    // Clean up peer connections
    if (peer) {
      peer.destroy();
      peer = null;
    }
    connections = [];
    studyToggleBtn.textContent = 'üë§ Solo Study';
    studyToggleBtn.classList.remove('active');
    chatWidget.style.display = 'none';
    
    currentSessionCode = null;
    document.getElementById('matrixChatMessages').innerHTML = '<div style="text-align:center;color:var(--muted);font-size:0.75rem;margin-top:2rem;">Welcome! üéâ<br>Start chatting with your study partners.</div>';
  }
  
  // Send message
  function sendChatMessage() {
    const text = chatMessageInput.value.trim();
    if (!text) return;
    
    // Display locally
    const chatContainer = document.getElementById('matrixChatMessages');
    const msgDiv = document.createElement('div');
    msgDiv.style.cssText = 'padding:0.5rem;margin:0.3rem 0;background:var(--primary);color:#fff;border-radius:8px;text-align:right;';
    msgDiv.textContent = text;
    chatContainer.appendChild(msgDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Broadcast to peers
    broadcastMessage(text);
    
    chatMessageInput.value = '';
  }
  
  sendChatBtn.onclick = sendChatMessage;
  chatMessageInput.onkeypress = (e) => {
    if (e.key === 'Enter') sendChatMessage();
  };
  
  // Close modals
  closeStudyModal.onclick = () => {
    studyModal.style.display = 'none';
  };
  
  closeChatBtn.onclick = () => {
    if (confirm('Close chat? (You\'ll stay in group mode)')) {
      chatWidget.style.display = 'none';
    }
  };
  
  studyModal.onclick = (e) => {
    if (e.target === studyModal) {
      studyModal.style.display = 'none';
    }
  };
  
</script>

<!-- PeerJS for P2P Chat (100% FREE) -->
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>

</body>
</html>
