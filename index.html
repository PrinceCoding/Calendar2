<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>Year Calendar with Notes</title>

  <!-- =========================
        STYLES (CSS)
        ========================= -->
  <link rel="stylesheet" href="css/themes.css?v=2">
  <link rel="stylesheet" href="css/base.css?v=2">
  <link rel="stylesheet" href="css/header.css?v=2">
  <link rel="stylesheet" href="css/calendar.css?v=2">
  <link rel="stylesheet" href="css/notes.css?v=2">
  <link rel="stylesheet" href="css/web-browser.css?v=2">
  <link rel="stylesheet" href="css/clock.css?v=2">
  <link rel="stylesheet" href="css/pomodoro.css?v=2">
  <link rel="stylesheet" href="css/todo.css?v=2">
  <link rel="stylesheet" href="css/calculator.css?v=2">
  <link rel="stylesheet" href="css/events.css?v=2">
  <link rel="stylesheet" href="css/app-launcher.css?v=2">
  <link rel="stylesheet" href="css/canvas-tabs.css?v=2">
  <link rel="stylesheet" href="css/widgets.css?v=2">
  <link rel="stylesheet" href="css/dragging.css?v=2">
  <link rel="stylesheet" href="css/settings.css?v=2">
</head>
<body>

<header>
  <button id="appLauncherBtn" class="app-launcher-btn" title="Apps">â–¦</button>
  
  <div style="display:inline-flex;align-items:center;gap:0.4rem;flex-wrap:wrap;justify-content:center;">
    <div class="dynamic-island canvas-switcher" id="canvasSwitcher">
      ğŸ“‘ <span id="canvasNameDisplay">Canvas 1</span> <span class="dropdown-arrow">â–¾</span>
      <div class="canvas-dropdown" id="canvasDropdown"></div>
    </div>
    <div class="dynamic-island"><span id="dtText"></span></div>
    <div class="dynamic-island">ğŸ… <span id="pomoTime">60:00</span>
      <button id="pomoStart" class="pomo-btn">â–¶</button>
      <button id="pomoReset" class="pomo-btn">âŸ³</button>
    </div>
  </div>

  <button id="themeBtn" class="theme-btn">ğŸ macOS</button>
  <button id="settingsBtn" class="theme-btn">âš™ï¸</button>
</header>

<!-- Canvas Workspace -->
<div id="canvasWorkspace">

<!-- Canvas Helper Hint -->
<div class="canvas-hint" id="canvasHint">
  ğŸ’¡ <strong>Quick Tips:</strong> Hold <kbd>Space</kbd> + drag to pan â€¢ Drag widgets anywhere â€¢ Use Canvas Manager to switch workspaces â€¢ Click <strong>â–¦</strong> for apps
</div>

<!-- Floating Analog Clock -->
<div id="analogClock" class="analog-clock">
  <button id="closeClockBtn" class="close-widget-btn" title="Close Clock">âœ•</button>
  <button id="clockSettingsBtn" class="settings-btn" title="Clock Settings">âš™ï¸</button>
  <div class="clock-face">
    <div class="hour-marks">
      <span></span><span></span><span></span><span></span><span></span><span></span>
      <span></span><span></span><span></span><span></span><span></span><span></span>
    </div>
    <div class="hand hour" id="hourHand"></div>
    <div class="hand minute" id="minuteHand"></div>
    <div class="hand second" id="secondHand"></div>
    <div class="clock-center"></div>
    <div class="clock-date"><div id="clockDay"></div><div id="clockNum"></div></div>
  </div>
</div>

<!-- Floating Pomodoro -->
<div id="floatingPomo" class="floating-pomo">
  <button id="closePomoBtn" class="close-widget-btn" title="Close Pomodoro">âœ•</button>
  <button id="pomoSettingsBtn" class="settings-btn" title="Pomodoro Settings">âš™ï¸</button>
  <div class="pomo-content">
    <span class="pomo-emoji">ğŸ…</span>
    <span id="floatingPomoTime">60:00</span>
    <div class="pomo-controls">
      <button id="floatingPomoStart" class="pomo-btn">â–¶</button>
      <button id="floatingPomoReset" class="pomo-btn">âŸ³</button>
    </div>
  </div>
</div>

<!-- Floating Todo List -->
<div id="floatingTodo" class="floating-todo">
  <button id="closeTodoBtn" class="close-widget-btn" title="Close Todo">âœ•</button>
  <button id="todoSettingsBtn" class="settings-btn" title="Todo Settings">âš™ï¸</button>
  <div class="resize-handle"></div>
  <div class="todo-header">ğŸ“ To-Do List</div>
  <div class="todo-input-container">
    <input type="text" id="todoInput" class="todo-input" placeholder="Add a task..." />
    <button id="todoAddBtn" class="todo-add-btn">+</button>
  </div>
  <div id="todoList" class="todo-list"></div>
</div>

<!-- Floating Calculator Widget -->
<div id="floatingCalculator" class="floating-calculator">
  <button id="closeCalculatorBtn" class="close-widget-btn" title="Close Calculator">âœ•</button>
  <button id="calculatorSettingsBtn" class="settings-btn" title="Calculator Settings">âš™ï¸</button>
  <div class="resize-handle"></div>
  <div class="calc-header">ğŸ”¢ Calculator</div>
  <div id="calcDisplay" class="calc-display">0</div>
  
  <!-- Scientific buttons (hidden by default) -->
  <div class="calc-scientific-buttons" style="display:none;">
    <button class="calc-btn sci" data-calc="Math.sin">sin</button>
    <button class="calc-btn sci" data-calc="Math.cos">cos</button>
    <button class="calc-btn sci" data-calc="Math.tan">tan</button>
    <button class="calc-btn sci" data-calc="Math.log">log</button>
    
    <button class="calc-btn sci" data-calc="Math.sqrt">âˆš</button>
    <button class="calc-btn sci" data-calc="^2">xÂ²</button>
    <button class="calc-btn sci" data-calc="^">xÊ¸</button>
    <button class="calc-btn sci" data-calc="Math.PI">Ï€</button>
    
    <button class="calc-btn sci" data-calc="Math.E">e</button>
    <button class="calc-btn sci" data-calc="1/">1/x</button>
    <button class="calc-btn sci" data-calc="%">%</button>
    <button class="calc-btn sci" data-calc="!">n!</button>
  </div>
  
  <div class="calc-buttons">
    <button class="calc-btn clear" data-calc="C">C</button>
    <button class="calc-btn" data-calc="(">(</button>
    <button class="calc-btn" data-calc=")">)</button>
    <button class="calc-btn operator" data-calc="/">Ã·</button>
    
    <button class="calc-btn" data-calc="7">7</button>
    <button class="calc-btn" data-calc="8">8</button>
    <button class="calc-btn" data-calc="9">9</button>
    <button class="calc-btn operator" data-calc="*">Ã—</button>
    
    <button class="calc-btn" data-calc="4">4</button>
    <button class="calc-btn" data-calc="5">5</button>
    <button class="calc-btn" data-calc="6">6</button>
    <button class="calc-btn operator" data-calc="-">âˆ’</button>
    
    <button class="calc-btn" data-calc="1">1</button>
    <button class="calc-btn" data-calc="2">2</button>
    <button class="calc-btn" data-calc="3">3</button>
    <button class="calc-btn operator" data-calc="+">+</button>
    
    <button class="calc-btn" data-calc="0">0</button>
    <button class="calc-btn" data-calc=".">.</button>
    <button class="calc-btn equals" data-calc="=">=</button>
  </div>
</div>

<!-- Floating Events Widget -->
<div id="floatingEvents" class="floating-events">
  <button id="closeEventsBtn" class="close-widget-btn" title="Close Events">âœ•</button>
  <button id="eventsSettingsBtn" class="settings-btn" title="Events Settings">âš™ï¸</button>
  <div class="resize-handle"></div>
  <div class="events-header">
    <span>ğŸ“… Events</span>
    <span id="selectedDateBadge" class="selected-date-badge" style="cursor:pointer" title="Click to show all events"></span>
    <button id="showAllEventsBtn" class="show-all-btn">Show All</button>
  </div>
  <div class="events-input-container">
    <div class="events-input-row">
      <input type="date" id="eventDateInput" class="event-date-input" />
      <input type="text" id="eventTextInput" class="event-text-input" placeholder="Event description..." />
    </div>
    <button id="eventAddBtn" class="event-add-btn">+ Add Event</button>
  </div>
  <div id="eventsList" class="events-list"></div>
</div>

<!-- Floating Calendar Widget -->
<div id="floatingCalendar" class="floating-calendar">
  <button id="closeCalendarBtn" class="close-widget-btn" title="Close Calendar">âœ•</button>
  <button id="calendarSettingsBtn" class="settings-btn" title="Calendar Settings">âš™ï¸</button>
  <div class="resize-handle"></div>
  <div class="calendar-header">
    <h1 class="calendar-title" id="year">Calendar 2025</h1>
    <div class="calendar-controls">
      <button id="todayBtn" class="calendar-today-btn">ğŸ“ Today</button>
      <button id="monthToggleBtn" class="calendar-month-btn">ğŸ“… Year View</button>
      <button id="prev" class="calendar-nav-btn">â—€</button>
      <button id="next" class="calendar-nav-btn">â–¶</button>
    </div>
  </div>
  <div id="calendar" class="calendar"></div>
</div>

<!-- Floating Notes Widget -->
<div id="floatingNotes" class="floating-notes">
  <button id="closeNotesBtn" class="close-widget-btn" title="Close Notes">âœ•</button>
  <button id="notesSettingsBtn" class="settings-btn" title="Notes Settings">âš™ï¸</button>
  <div class="resize-handle"></div>
  <div class="notes-header">
    <div style="display:flex;align-items:center;gap:0.6rem;">
      <h2 style="margin:0">Notes</h2>
      <div id="syncStatus" style="font-size:0.75rem;color:var(--muted)">Not signed in</div>
    </div>
    <div class="notes-tools">
      <button data-cmd="bold"><b>B</b></button>
      <button data-cmd="italic"><i>I</i></button>
      <button data-cmd="underline"><u>U</u></button>
      <button data-cmd="insertUnorderedList">â€¢ List</button>
    </div>
  </div>
  <div id="notesEditor" class="notes-editor" contenteditable="true"></div>
</div>

<!-- Web Browser Widget -->
<div id="floatingWebBrowser" class="floating-web-browser">
  <button id="closeWebBrowserBtn" class="close-widget-btn" title="Close Browser">âœ•</button>
  <button id="webBrowserSettingsBtn" class="settings-btn" title="Browser Settings">âš™ï¸</button>
  <div class="resize-handle"></div>
  <div class="browser-header">ğŸŒ Web Browser</div>
  <div class="browser-toolbar">
    <button id="browserBackBtn" class="browser-nav-btn" title="Back" disabled>â†</button>
    <button id="browserForwardBtn" class="browser-nav-btn" title="Forward" disabled>â†’</button>
    <button id="browserRefreshBtn" class="browser-nav-btn" title="Refresh">â†»</button>
    <button id="browserHomeBtn" class="browser-nav-btn" title="Home">ğŸ </button>
    <input type="text" id="browserUrlInput" placeholder="Enter URL or search..." class="browser-url-input">
    <button id="browserGoBtn" class="browser-go-btn" title="Go">Go</button>
    <button id="browserNewTabBtn" class="browser-nav-btn" title="New Instance">â†—</button>
    <button id="browserBookmarkBtn" class="browser-bookmark-btn" title="Bookmark">â˜…</button>
  </div>
  <div class="browser-bookmarks" id="browserBookmarks" style="display:none;"></div>
  <div class="browser-content">
    <iframe id="browserIframe" class="browser-iframe" sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-top-navigation allow-modals allow-downloads" allowfullscreen></iframe>
    <div id="browserErrorOverlay" class="browser-error-overlay" style="display:none;">
      <div class="browser-error-content">
        <div class="browser-error-icon">ğŸš«</div>
        <h3>Can't Display This Page</h3>
        <p id="browserErrorMessage">This website cannot be displayed in an iframe due to security restrictions.</p>
        <div class="browser-error-actions">
          <button id="browserOpenNewTabError" class="browser-error-btn">Open Externally</button>
          <button id="browserTryAgain" class="browser-error-btn secondary">Try Again</button>
        </div>
        <small style="color:var(--muted);margin-top:1rem;display:block;">
          Many sites like Google, Facebook, and YouTube block iframe embedding for security.<br>
          <strong>Try the Popular Sites section below for guaranteed compatibility!</strong>
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Canvas Manager Widget -->
<div id="canvasManager" class="canvas-manager">
  <button id="closeCanvasManagerBtn" class="close-widget-btn" title="Close">âœ•</button>
  <button id="canvasManagerSettingsBtn" class="settings-btn" title="Canvas Settings">âš™ï¸</button>
  <div class="resize-handle"></div>
  <div class="canvas-manager-header">ğŸ“‘ Canvas Manager</div>
  <div id="canvasTabsContainer" class="canvas-tabs-container">
    <!-- Tabs will be rendered here by JavaScript -->
  </div>
</div>

</div><!-- End Canvas Workspace -->

<!-- App Drawer Overlay -->
<div id="appDrawer" class="app-drawer">
  <div class="app-drawer-content">
    <div class="app-drawer-header">ğŸš€ Apps</div>
    <div class="app-list">
      <div class="app-item" data-app="calendar">
        <div class="app-icon">ğŸ“†</div>
        <div class="app-info">
          <div class="app-name">Calendar</div>
          <div class="app-desc">Full year view</div>
        </div>
        <div class="app-toggle" id="toggleCalendarApp"></div>
      </div>
      <div class="app-item" data-app="clock">
        <div class="app-icon">ğŸ•</div>
        <div class="app-info">
          <div class="app-name">Analog Clock</div>
          <div class="app-desc">Live time display</div>
        </div>
        <div class="app-toggle" id="toggleClockApp"></div>
      </div>
      <div class="app-item" data-app="pomodoro">
        <div class="app-icon">ğŸ…</div>
        <div class="app-info">
          <div class="app-name">Pomodoro Timer</div>
          <div class="app-desc">Focus timer</div>
        </div>
        <div class="app-toggle" id="togglePomoApp"></div>
      </div>
      <div class="app-item" data-app="todo">
        <div class="app-icon">âœ…</div>
        <div class="app-info">
          <div class="app-name">To-Do List</div>
          <div class="app-desc">Task management</div>
        </div>
        <div class="app-toggle" id="toggleTodoApp"></div>
      </div>
      <div class="app-item" data-app="events">
        <div class="app-icon">ğŸ“…</div>
        <div class="app-info">
          <div class="app-name">Events</div>
          <div class="app-desc">Track events</div>
        </div>
        <div class="app-toggle" id="toggleEventsApp"></div>
      </div>
      <div class="app-item" data-app="calculator">
        <div class="app-icon">ğŸ”¢</div>
        <div class="app-info">
          <div class="app-name">Calculator</div>
          <div class="app-desc">Quick calculations</div>
        </div>
        <div class="app-toggle" id="toggleCalculatorApp"></div>
      </div>
      <div class="app-item" data-app="notes">
        <div class="app-icon">ğŸ“</div>
        <div class="app-info">
          <div class="app-name">Notes</div>
          <div class="app-desc">Quick notes</div>
        </div>
        <div class="app-toggle" id="toggleNotesApp"></div>
      </div>
      <div class="app-item" data-app="webBrowser">
        <div class="app-icon">ğŸŒ</div>
        <div class="app-info">
          <div class="app-name">Web Browser</div>
          <div class="app-desc">Browse the web</div>
        </div>
        <div class="app-toggle" id="toggleWebBrowserApp"></div>
      </div>
      <div class="app-item" data-app="canvasManager">
        <div class="app-icon">ğŸ“‘</div>
        <div class="app-info">
          <div class="app-name">Canvas Manager</div>
          <div class="app-desc">Manage canvases</div>
        </div>
        <div class="app-toggle" id="toggleCanvasManagerApp"></div>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     SETTINGS PAGE (OVERLAY)
     ========================= -->
<div id="settingsPage" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.25);backdrop-filter:blur(4px);">
    <div id="settingsContainer" style="max-width:420px;margin:4rem auto;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-float); max-height: 90vh; overflow-y: auto;">
    
    <!-- Main Settings View -->
    <div id="mainSettingsView">
      <h2 style="margin-top:0">Settings</h2>

      <!-- Appearance -->
      <div class="month" style="margin-bottom:1rem;">
        <h3>Appearance</h3>
        <p style="font-size:0.8rem;color:var(--muted)">Theme</p>
        <div id="settingsThemes" style="display:flex;gap:0.4rem;flex-wrap:wrap;"></div>

        <p style="font-size:0.8rem;color:var(--muted);margin-top:0.6rem">Font Size</p>
        <button class="font-btn" data-size="90">Aâˆ’</button>
        <button class="font-btn" data-size="100">A</button>
        <button class="font-btn" data-size="110">A+</button>
      </div>

      <!-- Account -->
      <div class="month" style="margin-bottom:1rem;">
        <h3>Account</h3>
        
        <!-- Logged Out View -->
        <div id="loggedOutUI">
          <input type="email" id="emailInput" class="auth-input" placeholder="Email address">
          <input type="password" id="passwordInput" class="auth-input" placeholder="Password">
          
          <div style="display:flex; gap: 8px; margin-bottom: 12px;">
            <button id="loginBtn" class="today-btn" style="position:static; flex:1; justify-content:center;">Login</button>
            <button id="signupBtn" class="theme-btn" style="position:static; flex:1; justify-content:center;">Sign Up</button>
          </div>
          
          <button id="resetPasswordBtn" style="font-size: 0.7rem; color: var(--primary); text-decoration: underline; background: none; border: none; padding: 0; cursor: pointer;">Forgot Password?</button>
        </div>

        <!-- Logged In View -->
        <div id="loggedInUI" style="display:none;">
          <p id="userEmailDisplay" style="font-size: 0.8rem; margin-bottom: 12px;"></p>
          <button id="logoutBtn" class="today-btn" style="position:static; background: linear-gradient(180deg, #ff3b30, #d70015); width: 100%; justify-content: center;">Sign Out</button>
        </div>

        <p style="font-size:0.75rem;color:var(--muted); margin-top: 12px;">Sync notes across devices</p>
      </div>

      <!-- About -->
      <div class="month" style="margin-bottom:1rem;">
        <h3>About</h3>
        <p style="font-size:0.75rem;color:var(--muted)">Year Calendar with Notes</p>
      </div>

      <!-- Apps Section (iOS Style) -->
      <div class="month">
        <h3>Apps</h3>
        <div class="settings-app-list">
          <div class="settings-app-item" data-app="clock">
            <span class="settings-app-icon">ğŸ•’</span>
            <span class="settings-app-name">Clock</span>
            <span class="settings-app-chevron">â€º</span>
          </div>
          <div class="settings-app-item" data-app="pomodoro">
            <span class="settings-app-icon">ğŸ…</span>
            <span class="settings-app-name">Pomodoro</span>
            <span class="settings-app-chevron">â€º</span>
          </div>
          <div class="settings-app-item" data-app="todo">
            <span class="settings-app-icon">âœ…</span>
            <span class="settings-app-name">Todo</span>
            <span class="settings-app-chevron">â€º</span>
          </div>
          <div class="settings-app-item" data-app="calculator">
            <span class="settings-app-icon">ğŸ”¢</span>
            <span class="settings-app-name">Calculator</span>
            <span class="settings-app-chevron">â€º</span>
          </div>
          <div class="settings-app-item" data-app="events">
            <span class="settings-app-icon">ğŸ“…</span>
            <span class="settings-app-name">Events</span>
            <span class="settings-app-chevron">â€º</span>
          </div>
          <div class="settings-app-item" data-app="calendar">
            <span class="settings-app-icon">ğŸ“†</span>
            <span class="settings-app-name">Calendar</span>
            <span class="settings-app-chevron">â€º</span>
          </div>
          <div class="settings-app-item" data-app="notes">
            <span class="settings-app-icon">ğŸ“</span>
            <span class="settings-app-name">Notes</span>
            <span class="settings-app-chevron">â€º</span>
          </div>
          <div class="settings-app-item" data-app="webBrowser">
            <span class="settings-app-icon">ğŸŒ</span>
            <span class="settings-app-name">Web Browser</span>
            <span class="settings-app-chevron">â€º</span>
          </div>
          <div class="settings-app-item" data-app="canvas">
            <span class="settings-app-icon">ğŸ“‘</span>
            <span class="settings-app-name">Canvas Manager</span>
            <span class="settings-app-chevron">â€º</span>
          </div>
        </div>
      </div>
    </div>

    <!-- App Settings Views -->
    <div id="appSettingsView" style="display:none;">
      <button id="backToSettings" class="settings-back-btn">â€¹ Settings</button>
      
      <!-- Clock Settings -->
      <div id="clockAppSettings" class="app-settings-detail" style="display:none;">
        <h2>ğŸ•’ Clock</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Show Seconds Hand</span>
            <input type="checkbox" id="clockShowSeconds" checked>
          </label>
          <label class="settings-label">
            <span>24-Hour Format</span>
            <input type="checkbox" id="clockShow24Hour">
          </label>
          <label class="settings-label">
            <span>Clock Size</span>
            <select id="clockSize" class="settings-select">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Clock Face Color</span>
            <select id="clockColor" class="settings-select">
              <option value="default" selected>Default</option>
              <option value="blue">Blue</option>
              <option value="green">Green</option>
              <option value="red">Red</option>
              <option value="gold">Gold</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Show Date</span>
            <input type="checkbox" id="clockShowDate" checked>
          </label>
        </div>
      </div>

      <!-- Pomodoro Settings -->
      <div id="pomodoroAppSettings" class="app-settings-detail" style="display:none;">
        <h2>ğŸ… Pomodoro</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Work Duration (minutes)</span>
            <input type="number" id="pomoWorkDuration" min="1" max="120" value="25" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Short Break (minutes)</span>
            <input type="number" id="pomoBreakDuration" min="1" max="60" value="5" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Long Break (minutes)</span>
            <input type="number" id="pomoLongBreak" min="1" max="60" value="15" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Sessions before long break</span>
            <input type="number" id="pomoSessionsBeforeLongBreak" min="1" max="10" value="4" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Auto-start next session</span>
            <input type="checkbox" id="pomoAutoStart">
          </label>
          <label class="settings-label">
            <span>Play sound on completion</span>
            <input type="checkbox" id="pomoSound" checked>
          </label>
          <label class="settings-label">
            <span>Desktop notifications</span>
            <input type="checkbox" id="pomoNotifications" checked>
          </label>
        </div>
      </div>

      <!-- Todo Settings -->
      <div id="todoAppSettings" class="app-settings-detail" style="display:none;">
        <h2>âœ… Todo</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Show completed tasks</span>
            <input type="checkbox" id="todoShowCompleted" checked>
          </label>
          <label class="settings-label">
            <span>Auto-sort by priority</span>
            <input type="checkbox" id="todoAutoSort">
          </label>
          <label class="settings-label">
            <span>Show priority colors</span>
            <input type="checkbox" id="todoShowPriorityColors" checked>
          </label>
          <label class="settings-label">
            <span>Confirm before delete</span>
            <input type="checkbox" id="todoConfirmDelete" checked>
          </label>
          <label class="settings-label">
            <span>Default Priority</span>
            <select id="todoDefaultPriority" class="settings-select">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Task limit per day</span>
            <input type="number" id="todoMaxTasks" min="5" max="100" value="50" class="settings-input">
          </label>
          <button id="todoClearCompleted" class="settings-action-btn">Clear Completed</button>
        </div>
      </div>

      <!-- Calculator Settings -->
      <div id="calculatorAppSettings" class="app-settings-detail" style="display:none;">
        <h2>ğŸ”¢ Calculator</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Scientific Mode</span>
            <input type="checkbox" id="calcScientificMode">
          </label>
          <label class="settings-label">
            <span>Decimal Places</span>
            <input type="number" id="calcDecimalPlaces" min="0" max="10" value="2" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Use thousands separator</span>
            <input type="checkbox" id="calcThousandsSeparator" checked>
          </label>
          <label class="settings-label">
            <span>Button click sound</span>
            <input type="checkbox" id="calcButtonSound">
          </label>
          <label class="settings-label">
            <span>History size</span>
            <input type="number" id="calcHistorySize" min="5" max="100" value="20" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Theme</span>
            <select id="calcTheme" class="settings-select">
              <option value="default" selected>Default</option>
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="colorful">Colorful</option>
            </select>
          </label>
          <button id="calcClearHistory" class="settings-action-btn">Clear History</button>
        </div>
      </div>

      <!-- Events Settings -->
      <div id="eventsAppSettings" class="app-settings-detail" style="display:none;">
        <h2>ğŸ“… Events</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Show past events</span>
            <input type="checkbox" id="eventsShowPast" checked>
          </label>
          <label class="settings-label">
            <span>Enable notifications</span>
            <input type="checkbox" id="eventsNotifications">
          </label>
          <label class="settings-label">
            <span>Reminder time (minutes before)</span>
            <select id="eventsReminderTime" class="settings-select">
              <option value="0">At event time</option>
              <option value="5">5 minutes</option>
              <option value="15" selected>15 minutes</option>
              <option value="30">30 minutes</option>
              <option value="60">1 hour</option>
              <option value="1440">1 day</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Compact view</span>
            <input type="checkbox" id="eventsCompactView">
          </label>
          <label class="settings-label">
            <span>Default View</span>
            <select id="eventsDefaultView" class="settings-select">
              <option value="all" selected>All Events</option>
              <option value="today">Today Only</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Sort By</span>
            <select id="eventsSortOrder" class="settings-select">
              <option value="date" selected>Date</option>
              <option value="created">Created</option>
              <option value="title">Title</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Calendar Settings -->
      <div id="calendarAppSettings" class="app-settings-detail" style="display:none;">
        <h2>ğŸ“† Calendar</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Start Week On</span>
            <select id="calendarWeekStart" class="settings-select">
              <option value="0" selected>Sunday</option>
              <option value="1">Monday</option>
              <option value="6">Saturday</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Show week numbers</span>
            <input type="checkbox" id="calendarShowWeekNumbers">
          </label>
          <label class="settings-label">
            <span>Highlight weekends</span>
            <input type="checkbox" id="calendarHighlightWeekends" checked>
          </label>
          <label class="settings-label">
            <span>Show today indicator</span>
            <input type="checkbox" id="calendarShowToday" checked>
          </label>
          <label class="settings-label">
            <span>Show holidays</span>
            <input type="checkbox" id="calendarShowHolidays" checked>
          </label>
          <label class="settings-label">
            <span>Compact month view</span>
            <input type="checkbox" id="calendarCompactView">
          </label>
          <label class="settings-label">
            <span>Default View</span>
            <select id="calendarDefaultView" class="settings-select">
              <option value="month" selected>Month</option>
              <option value="year">Year</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Notes Settings -->
      <div id="notesAppSettings" class="app-settings-detail" style="display:none;">
        <h2>ğŸ“ Notes</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Font Size</span>
            <select id="notesFontSize" class="settings-select">
              <option value="12px">Small</option>
              <option value="14px" selected>Medium</option>
              <option value="16px">Large</option>
              <option value="18px">Extra Large</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Font Family</span>
            <select id="notesFontFamily" class="settings-select">
              <option value="system-ui" selected>System</option>
              <option value="monospace">Monospace</option>
              <option value="serif">Serif</option>
              <option value="'Comic Sans MS', cursive">Comic Sans</option>
              <option value="'Georgia', serif">Georgia</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Line Height</span>
            <select id="notesLineHeight" class="settings-select">
              <option value="1.2">Compact</option>
              <option value="1.5">Normal</option>
              <option value="1.8" selected>Comfortable</option>
              <option value="2.0">Spacious</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Word wrap</span>
            <input type="checkbox" id="notesWordWrap" checked>
          </label>
          <label class="settings-label">
            <span>Auto-save</span>
            <input type="checkbox" id="notesAutoSave" checked>
          </label>
          <label class="settings-label">
            <span>Spell check</span>
            <input type="checkbox" id="notesSpellCheck" checked>
          </label>
          <label class="settings-label">
            <span>Auto-save interval (seconds)</span>
            <input type="number" id="notesAutoSaveInterval" min="5" max="300" value="30" class="settings-input">
          </label>
        </div>
      </div>

      <!-- Web Browser Settings -->
      <div id="webBrowserAppSettings" class="app-settings-detail" style="display:none;">
        <h2>ğŸŒ Web Browser</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Home page URL</span>
            <input type="text" id="browserHomePage" placeholder="https://wikipedia.org" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Default zoom level</span>
            <select id="browserZoom" class="settings-select">
              <option value="0.75">75%</option>
              <option value="0.9">90%</option>
              <option value="1" selected>100%</option>
              <option value="1.1">110%</option>
              <option value="1.25">125%</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Search engine</span>
            <select id="browserSearchEngine" class="settings-select">
              <option value="google" selected>Google</option>
              <option value="bing">Bing</option>
              <option value="duckduckgo">DuckDuckGo</option>
            </select>
          </label>
          <label class="settings-label">
            <span>Allow JavaScript</span>
            <input type="checkbox" id="browserAllowJS" checked>
          </label>
          <label class="settings-label">
            <span>Allow forms</span>
            <input type="checkbox" id="browserAllowForms" checked>
          </label>
          <label class="settings-label">
            <span>Allow popups</span>
            <input type="checkbox" id="browserAllowPopups" checked>
          </label>
          <label class="settings-label">
            <span>Show bookmarks bar</span>
            <input type="checkbox" id="browserShowBookmarks" checked>
          </label>
          <button id="browserClearHistory" class="settings-button" style="margin-top:1rem;">Clear History</button>
          <button id="browserClearBookmarks" class="settings-button" style="margin-top:0.5rem;">Clear All Bookmarks</button>
        </div>
      </div>

      <!-- Canvas Manager Settings -->
      <div id="canvasAppSettings" class="app-settings-detail" style="display:none;">
        <h2>ğŸ“‘ Canvas Manager</h2>
        <div class="settings-group">
          <label class="settings-label">
            <span>Max Canvases</span>
            <input type="number" id="canvasMaxCount" min="1" max="20" value="10" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Default brush size</span>
            <input type="number" id="canvasBrushSize" min="1" max="50" value="2" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Show grid</span>
            <input type="checkbox" id="canvasShowGrid">
          </label>
          <label class="settings-label">
            <span>Grid size (pixels)</span>
            <input type="number" id="canvasGridSize" min="10" max="100" value="20" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Auto-save canvas state</span>
            <input type="checkbox" id="canvasAutoSave" checked>
          </label>
          <label class="settings-label">
            <span>Auto-save interval (seconds)</span>
            <input type="number" id="canvasAutoSaveInterval" min="10" max="300" value="60" class="settings-input">
          </label>
          <label class="settings-label">
            <span>Show hints</span>
            <input type="checkbox" id="canvasShowHints" checked>
          </label>
          <button id="canvasExportAll" class="settings-action-btn">Export All Canvases</button>
          <button id="canvasImportData" class="settings-action-btn">Import Canvases</button>
        </div>
      </div>
    </div>

    <button id="closeSettings" class="theme-btn" style="position:absolute;top:0.8rem;right:0.8rem;">âœ•</button>
  </div>
</div>

<!-- Floating Notes Widget -->
<div id="floatingNotes" class="floating-notes">
  <button id="closeNotesBtn" class="close-widget-btn" title="Close Notes">âœ•</button>
  <div class="resize-handle"></div>
  <div class="notes-header">
    <div style="display:flex;align-items:center;gap:0.6rem;">
      <h2 style="margin:0">Notes</h2>
      <div id="syncStatus" style="font-size:0.75rem;color:var(--muted)">Not signed in</div>
    </div>
    <div class="notes-tools">
      <button data-cmd="bold"><b>B</b></button>
      <button data-cmd="italic"><i>I</i></button>
      <button data-cmd="underline"><u>U</u></button>
      <button data-cmd="insertUnorderedList">â€¢ List</button>
    </div>
  </div>
  <div id="notesEditor" class="notes-editor" contenteditable="true"></div>
</div>

</div><!-- End Canvas Workspace -->

<script>
  const calEl = document.getElementById('calendar');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPage = document.getElementById('settingsPage');
  const closeSettings = document.getElementById('closeSettings');
  const yearEl = document.getElementById('year');
  const notesEditor = document.getElementById('notesEditor');
  const toolButtons = document.querySelectorAll('.notes-tools button');

  const now = new Date();
  const CURRENT_YEAR = now.getFullYear();
  const TODAY_DATE = now.getDate();
  const TODAY_MONTH = now.getMonth();
  let shownYear = CURRENT_YEAR;

  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  let monthViewIndex = null;
  const monthToggleBtn = document.getElementById('monthToggleBtn');
  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  // Events data (initialized early for calendar rendering)
  // Start with empty - will be loaded from Firebase when authenticated
  let events = [];
  let eventsLoaded = false; // Track if Firebase data has been loaded
  let selectedCalendarDate = null;

  function renderCalendar(year) {
    calEl.innerHTML = '';
    yearEl.textContent = `Calendar ${year}`;

    // Get calendar settings
    const weekStart = parseInt(localStorage.getItem('calendarWeekStart') || '0');
    const showWeekNumbers = localStorage.getItem('calendarShowWeekNumbers') === 'true';
    const highlightWeekends = localStorage.getItem('calendarHighlightWeekends') !== 'false';
    const showToday = localStorage.getItem('calendarShowToday') !== 'false';

    // Reorder DAYS array based on week start
    let orderedDays = [...DAYS];
    if (weekStart > 0) {
      orderedDays = [...DAYS.slice(weekStart), ...DAYS.slice(0, weekStart)];
    }

    MONTHS.forEach((m, i) => {
      if (monthViewIndex !== null && monthViewIndex !== i) return;
      const box = document.createElement('div');
      box.className = 'month';
      box.innerHTML = `<h2 data-month="${i}" style="cursor:pointer">${m}</h2>`;

      const w = document.createElement('div');
      w.className = 'weekdays';
      
      // Add week number header if enabled
      if (showWeekNumbers) {
        w.innerHTML += '<div style="font-weight:bold;font-size:0.7rem;">Wk</div>';
      }
      
      orderedDays.forEach((d, idx) => {
        const isWeekend = highlightWeekends && ((idx + weekStart) % 7 === 0 || (idx + weekStart) % 7 === 6);
        const style = isWeekend ? 'color:var(--accent);font-weight:600;' : '';
        w.innerHTML += `<div style="${style}">${d}</div>`;
      });

      const g = document.createElement('div');
      g.className = 'days';
      g.style.gridTemplateColumns = showWeekNumbers ? 'repeat(8, 1fr)' : 'repeat(7, 1fr)';
      
      const first = new Date(year, i, 1).getDay();
      const total = new Date(year, i + 1, 0).getDate();
      
      // Adjust first day based on week start
      let adjustedFirst = (first - weekStart + 7) % 7;

      // Add week number for first week if enabled
      if (showWeekNumbers) {
        const firstDate = new Date(year, i, 1);
        const weekNum = getWeekNumber(firstDate);
        g.innerHTML += `<div style="font-size:0.7rem;color:var(--muted);display:flex;align-items:center;justify-content:center;">${weekNum}</div>`;
      }

      for (let j = 0; j < adjustedFirst; j++) g.innerHTML += '<div></div>';
      
      for (let d = 1; d <= total; d++) {
        // Add week number at start of each week
        if (showWeekNumbers && (adjustedFirst + d - 1) % 7 === 0 && d > 1) {
          const currentDate = new Date(year, i, d);
          const weekNum = getWeekNumber(currentDate);
          g.innerHTML += `<div style="font-size:0.7rem;color:var(--muted);display:flex;align-items:center;justify-content:center;">${weekNum}</div>`;
        }
        
        const isToday = d === TODAY_DATE && i === TODAY_MONTH && year === CURRENT_YEAR;
        const shouldShowToday = showToday && isToday;
        const dateStr = `${year}-${String(i + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const hasEvent = events.some(e => e.date === dateStr);
        const dotHtml = hasEvent ? '<span class="event-dot"></span>' : '';
        
        // Check if it's a weekend
        const dayOfWeek = new Date(year, i, d).getDay();
        const isWeekend = highlightWeekends && (dayOfWeek === 0 || dayOfWeek === 6);
        const weekendClass = isWeekend ? 'weekend-day' : '';
        
        g.innerHTML += `<div class="${shouldShowToday ? 'today' : ''} ${weekendClass}" data-date="${dateStr}" style="cursor:pointer">${d}${dotHtml}</div>`;
      }

      box.append(w, g);
      calEl.appendChild(box);
    });

    // Add click handlers to dates for event viewing
    calEl.querySelectorAll('.days div[data-date]').forEach(dayEl => {
      dayEl.onclick = (e) => {
        const dateStr = e.currentTarget.dataset.date;
        if (!dateStr) return;
        selectedCalendarDate = dateStr;
        const eventDateInput = document.getElementById('eventDateInput');
        if (eventDateInput) eventDateInput.value = dateStr;
        if (window.renderEvents) window.renderEvents(dateStr);
        
        // Show events widget if hidden
        const eventsWidget = document.getElementById('floatingEvents');
        if (eventsWidget && eventsWidget.style.display === 'none') {
          if (window.updateEventsVisibility) window.updateEventsVisibility(true);
        }
      };
    });
  }

  // Helper function to get week number
  function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  // Expose renderCalendar globally
  window.renderCalendar = renderCalendar;

  function updateTime() {
    const d = new Date();
    const dtText = document.getElementById('dtText');
    if(dtText) {
      dtText.textContent = d.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' }) + ' â€¢ ' + d.toLocaleTimeString();
    }
  }

  toolButtons.forEach(b => b.onclick = () => {
    document.execCommand(b.dataset.cmd);
    updateToolStates();
  });

  function updateToolStates() {
    toolButtons.forEach(btn => {
      const cmd = btn.dataset.cmd;
      try {
        const isActive = document.queryCommandState(cmd);
        btn.classList.toggle('active', isActive);
      } catch (e) {}
    });
  }

  document.addEventListener('selectionchange', () => {
    if (document.activeElement === notesEditor) {
      updateToolStates();
    }
  });

  // Notes content is loaded and saved via Firebase (see bottom of file)
  // No localStorage usage for notes content to avoid conflicts

  renderCalendar(shownYear);

  // Font size controls
  const fontButtons = document.querySelectorAll('.font-btn');
  fontButtons.forEach(btn => {
    btn.onclick = () => {
      const size = btn.dataset.size;
      document.documentElement.style.fontSize = size + '%';
      localStorage.setItem('fontSize', size);
    };
  });

  const savedFontSize = localStorage.getItem('fontSize');
  if (savedFontSize) {
    document.documentElement.style.fontSize = savedFontSize + '%';
  }

  settingsBtn.onclick = () => { settingsPage.style.display = 'block'; };
  closeSettings.onclick = (e) => { e.stopPropagation(); settingsPage.style.display = 'none'; };

  settingsPage.addEventListener('click', (e) => {
    if (e.target === settingsPage) {
      settingsPage.style.display = 'none';
    }
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && settingsPage.style.display === 'block') {
      settingsPage.style.display = 'none';
    }
  });

  monthToggleBtn.onclick = () => {
    if (monthViewIndex === null) {
      monthViewIndex = TODAY_MONTH;
      monthToggleBtn.textContent = 'ï¿½ Year View';
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
    } else {
      monthViewIndex = null;
      monthToggleBtn.textContent = 'ğŸ“… Month View';
      yearEl.textContent = `Calendar ${shownYear}`;
    }
    renderCalendar(shownYear);
  };

  calEl.addEventListener('click', (e) => {
    const h = e.target.closest('h2[data-month]');
    if (!h) return;
    monthViewIndex = Number(h.dataset.month);
    monthToggleBtn.textContent = 'ğŸ“… Year View';
    yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
    renderCalendar(shownYear);
  });
  updateTime();
  setInterval(updateTime, 1000);

  const DEVICE_ID_KEY = 'device_id';
  let defaultPomoMinutes = 60; // Default value, will be updated from Firebase
  let secs = defaultPomoMinutes * 60;
  let timer = null; // local display tick interval
  let anchorStartMs = null; // when (ms) the session started (server/local)
  let anchorRemaining = null; // secs remaining at start
  let isApplyingRemote = false;
  let deviceId = localStorage.getItem(DEVICE_ID_KEY);
  if (!deviceId) {
    deviceId = Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(DEVICE_ID_KEY, deviceId);
  }
  // Make deviceId globally accessible
  window.deviceId = deviceId;

  const pomoDurationInput = document.getElementById('pomoWorkDuration');
  if (pomoDurationInput) {
    pomoDurationInput.value = defaultPomoMinutes;
  }

  function updatePomoDisplay() {
    const minStr = String(Math.floor(secs/60)).padStart(2,'0');
    const secStr = String(secs%60).padStart(2,'0');
    const timeText = `${minStr}:${secStr}`;
    const pt = document.getElementById('pomoTime');
    const fpt = document.getElementById('floatingPomoTime');
    if(pt) pt.textContent = timeText;
    if(fpt) fpt.textContent = timeText;
  }

  function saveLocalSecs() {
    // No longer saving to localStorage - using Firebase only
  }

  function setStartButtons(running) {
    const ps = document.getElementById('pomoStart');
    const fps = document.getElementById('floatingPomoStart');
    if (ps) ps.textContent = running ? 'â¸' : 'â–¶';
    if (fps) fps.textContent = running ? 'â¸' : 'â–¶';
  }

  async function syncToCloud(runningFlag, extra = {}) {
    try {
      if (!window.auth || !window.auth.currentUser) {
        console.log('[POMO] â¸ Not syncing - user not authenticated');
        return;
      }
      if (!window.db || !window.doc || !window.setDoc || !window.serverTimestamp) {
        console.log('[POMO] â¸ Not syncing - Firebase not ready');
        return;
      }
      const ref = window.doc(window.db, 'user_pomodoro', window.auth.currentUser.uid);
      await window.setDoc(ref, Object.assign({
        duration: defaultPomoMinutes,
        running: !!runningFlag,
        by: deviceId,
        updatedAt: window.serverTimestamp()
      }, extra), { merge: true });
      console.log('[POMO] âœ… Synced to cloud:', { running: runningFlag, ...extra });
    } catch (err) {
      console.error('[POMO] âŒ Cloud sync failed:', err);
    }
  }

  function clearLocalTimer() {
    if (timer) { clearInterval(timer); timer = null; }
  }

  function startLocalDisplayFromAnchor(remainAtStart, startedAtMs) {
    clearLocalTimer();
    anchorRemaining = remainAtStart;
    anchorStartMs = startedAtMs;
    setStartButtons(true);
    const tick = () => {
      const elapsed = Math.floor((Date.now() - anchorStartMs) / 1000);
      const left = Math.max(0, Math.round(anchorRemaining - elapsed));
      secs = left;
      updatePomoDisplay();
      saveLocalSecs();
      if (left <= 0) {
        clearLocalTimer();
        setStartButtons(false);
      }
    };
    tick();
    timer = setInterval(tick, 1000);
  }

  function togglePomo() {
    console.log('[POMO] Toggle clicked, timer active:', !!timer);
    // Pause if currently running
    if (timer) {
      clearLocalTimer();
      setStartButtons(false);
      saveLocalSecs();
      console.log('[POMO] â¸ Paused at', secs, 'seconds');
      // Persist pause with remaining seconds
      syncToCloud(false, { remaining: secs, startedAt: null });
      return;
    }
    // Start a new session from current remaining seconds
    const remainAtStart = secs;
    const startedNow = Date.now();
    startLocalDisplayFromAnchor(remainAtStart, startedNow);
    console.log('[POMO] â–¶ Started with', remainAtStart, 'seconds remaining');
    // Persist start (no per-second writes) - save actual timestamp for cross-device sync
    syncToCloud(true, { remaining: remainAtStart, startedAt: startedNow });
  }

  function resetPomo() {
    console.log('[POMO] âŸ³ Reset to', defaultPomoMinutes, 'minutes');
    clearLocalTimer();
    secs = defaultPomoMinutes * 60;
    updatePomoDisplay();
    setStartButtons(false);
    saveLocalSecs();
    syncToCloud(false, { remaining: secs, startedAt: null });
  }

  // Expose reset function globally for widget settings
  window.resetPomoTimer = function(newDuration) {
    if (newDuration) {
      defaultPomoMinutes = newDuration;
    }
    resetPomo();
    // Update input if it exists
    const pomoInput = document.getElementById('pomoWorkDuration');
    if (pomoInput) {
      pomoInput.value = defaultPomoMinutes;
    }
  };

  if (pomoDurationInput) {
    pomoDurationInput.onchange = () => {
      const val = Math.max(1, Number(pomoDurationInput.value) || 60);
      console.log('[POMO] Duration changed to', val, 'minutes');
      defaultPomoMinutes = val;
      secs = val * 60;
      updatePomoDisplay();
      clearLocalTimer();
      setStartButtons(false);
      saveLocalSecs();
      syncToCloud(false, { remaining: secs, startedAt: null });
    };
  }
  
  const pomoStartBtn = document.getElementById('pomoStart');
  const floatingPomoStartBtn = document.getElementById('floatingPomoStart');
  const pomoResetBtn = document.getElementById('pomoReset');
  const floatingPomoResetBtn = document.getElementById('floatingPomoReset');
  
  console.log('[POMO] Initializing buttons:');
  console.log('  pomoStart:', pomoStartBtn, pomoStartBtn ? 'FOUND âœ…' : 'MISSING âŒ');
  console.log('  floatingPomoStart:', floatingPomoStartBtn, floatingPomoStartBtn ? 'FOUND âœ…' : 'MISSING âŒ');
  console.log('  pomoReset:', pomoResetBtn, pomoResetBtn ? 'FOUND âœ…' : 'MISSING âŒ');
  console.log('  floatingPomoReset:', floatingPomoResetBtn, floatingPomoResetBtn ? 'FOUND âœ…' : 'MISSING âŒ');
  
  if (pomoStartBtn) {
    pomoStartBtn.onclick = (e) => {
      console.log('[POMO] Header start button clicked');
      e.stopPropagation();
      togglePomo();
    };
    pomoStartBtn.style.pointerEvents = 'auto';
    console.log('[POMO] Header start button initialized');
  }
  if (floatingPomoStartBtn) {
    floatingPomoStartBtn.onclick = (e) => {
      console.log('[POMO] Floating start button clicked');
      e.stopPropagation();
      togglePomo();
    };
    floatingPomoStartBtn.style.pointerEvents = 'auto';
    console.log('[POMO] Floating start button initialized');
  }
  if (pomoResetBtn) {
    pomoResetBtn.onclick = (e) => {
      console.log('[POMO] Header reset button clicked');
      e.stopPropagation();
      resetPomo();
    };
    pomoResetBtn.style.pointerEvents = 'auto';
    console.log('[POMO] Header reset button initialized');
  }
  if (floatingPomoResetBtn) {
    floatingPomoResetBtn.onclick = (e) => {
      console.log('[POMO] Floating reset button clicked');
      e.stopPropagation();
      resetPomo();
    };
    floatingPomoResetBtn.style.pointerEvents = 'auto';
    console.log('[POMO] Floating reset button initialized');
  }

  // Initialize pomodoro display
  updatePomoDisplay();

  // Expose handler for Firebase snapshot updates
  window.applyRemoteState = (data) => {
    try {
      if (!data) return;
      
      console.log('[POMO] Applying remote state:', data);

      // Update duration if changed remotely
      if (typeof data.duration === 'number' && data.duration > 0 && data.duration !== defaultPomoMinutes) {
        defaultPomoMinutes = data.duration;
        if (pomoDurationInput) pomoDurationInput.value = defaultPomoMinutes;
      }

      const running = !!data.running;
      const remaining = (typeof data.remaining === 'number' && data.remaining >= 0)
        ? data.remaining
        : (typeof data.secs === 'number' ? data.secs : defaultPomoMinutes * 60);

      if (running && data.startedAt) {
        // Handle both Firestore Timestamp objects and numeric timestamps
        const startedAtMs = (typeof data.startedAt.toMillis === 'function')
          ? data.startedAt.toMillis()
          : (typeof data.startedAt === 'number' ? data.startedAt : Date.now());
        console.log('[POMO] Restoring running timer from', startedAtMs, 'with', remaining, 'seconds');
        startLocalDisplayFromAnchor(remaining, startedAtMs);
      } else if (running) {
        // Fallback if startedAt missing: just start from remaining now
        console.log('[POMO] Fallback: Starting timer with', remaining, 'seconds');
        startLocalDisplayFromAnchor(remaining, Date.now());
      } else {
        clearLocalTimer();
        secs = remaining;
        updatePomoDisplay();
        setStartButtons(false);
      }
    } catch (e) {
      console.error('[POMO] applyRemoteState error:', e);
    }
  };

  document.getElementById('prev').onclick = () => {
    if (monthViewIndex !== null) {
      monthViewIndex = (monthViewIndex + 11) % 12;
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
      renderCalendar(shownYear);
    } else {
      renderCalendar(--shownYear);
    }
  };
  document.getElementById('next').onclick = () => {
    if (monthViewIndex !== null) {
      monthViewIndex = (monthViewIndex + 1) % 12;
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
      renderCalendar(shownYear);
    } else {
      renderCalendar(++shownYear);
    }
  };
  todayBtn.onclick = () => {
    if (monthViewIndex === null) {
      shownYear = CURRENT_YEAR;
      renderCalendar(shownYear);
      return;
    }
    shownYear = CURRENT_YEAR;
    monthViewIndex = TODAY_MONTH;
    monthToggleBtn.textContent = 'ğŸ—“ Year';
    yearEl.textContent = `${MONTHS[TODAY_MONTH]} ${shownYear}`;
    renderCalendar(shownYear);
  };

  const themes = [
    { name: 'ğŸ macOS', class: '' },
    { name: 'ğŸŒ™ Dark', class: 'dark' },
    { name: 'ğŸŒŠ Ocean', class: 'theme-ocean' },
    { name: 'ğŸŒ² Forest', class: 'theme-forest' },
    { name: 'ğŸŒ… Solar', class: 'theme-solar' },
    { name: 'ğŸ’ Glass', class: 'theme-glass' }
  ];
  
  // Load saved theme or default to 0
  let themeIndex = parseInt(localStorage.getItem('selectedThemeIndex')) || 0;
  
  // Apply saved theme on page load
  const savedTheme = themes[themeIndex];
  if (savedTheme) {
    document.body.classList.remove('dark','theme-ocean','theme-forest','theme-solar','theme-glass');
    if (savedTheme.class) document.body.classList.add(savedTheme.class);
    themeBtn.textContent = savedTheme.name;
  }
  
  themeBtn.onclick = () => {
    document.body.classList.remove('dark','theme-ocean','theme-forest','theme-solar','theme-glass');
    themeIndex = (themeIndex + 1) % themes.length;
    const t = themes[themeIndex];
    if (t.class) document.body.classList.add(t.class);
    themeBtn.textContent = t.name;
    
    // Save theme selection to localStorage
    localStorage.setItem('selectedThemeIndex', themeIndex.toString());
    console.log('Theme saved:', t.name);
  };

  // =========================
  // APP LAUNCHER & DRAWER
  // =========================
  const appLauncherBtn = document.getElementById('appLauncherBtn');
  const appDrawer = document.getElementById('appDrawer');
  const toggleCalendarApp = document.getElementById('toggleCalendarApp');
  const toggleClockApp = document.getElementById('toggleClockApp');
  const togglePomoApp = document.getElementById('togglePomoApp');
  const toggleTodoApp = document.getElementById('toggleTodoApp');
  const toggleEventsApp = document.getElementById('toggleEventsApp');
  const toggleNotesApp = document.getElementById('toggleNotesApp');
  const toggleWebBrowserApp = document.getElementById('toggleWebBrowserApp');
  const toggleCanvasManagerApp = document.getElementById('toggleCanvasManagerApp');

  // Open/close app drawer
  if (appLauncherBtn) {
    appLauncherBtn.onclick = () => {
      if (appDrawer.style.display === 'block') {
        appDrawer.style.display = 'none';
      } else {
        appDrawer.style.display = 'block';
      }
    };
  }

  if (appDrawer) {
    appDrawer.onclick = (e) => {
      if (e.target === appDrawer) {
        appDrawer.style.display = 'none';
      }
    };
  }

  // Close drawer on Escape
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && appDrawer.style.display === 'block') {
      appDrawer.style.display = 'none';
    }
  });

  // =========================
  // WIDGET VISIBILITY + DRAG
  // =========================
  const clock = document.getElementById('analogClock');
  const closeClockBtn = document.getElementById('closeClockBtn');
  const floatingPomo = document.getElementById('floatingPomo');
  const closePomoBtn = document.getElementById('closePomoBtn');
  const floatingTodo = document.getElementById('floatingTodo');
  const closeTodoBtn = document.getElementById('closeTodoBtn');
  const floatingEvents = document.getElementById('floatingEvents');
  const closeEventsBtn = document.getElementById('closeEventsBtn');
  const floatingCalendar = document.getElementById('floatingCalendar');
  const closeCalendarBtn = document.getElementById('closeCalendarBtn');
  const floatingNotes = document.getElementById('floatingNotes');
  const closeNotesBtn = document.getElementById('closeNotesBtn');
  const floatingWebBrowser = document.getElementById('floatingWebBrowser');
  const closeWebBrowserBtn = document.getElementById('closeWebBrowserBtn');
  const canvasManager = document.getElementById('canvasManager');
  const closeCanvasManagerBtn = document.getElementById('closeCanvasManagerBtn');

  const CLOCK_VIS_KEY = 'show_analog_clock';
  const POMO_VIS_KEY = 'show_floating_pomo';
  const TODO_VIS_KEY = 'show_floating_todo';
  const EVENTS_VIS_KEY = 'show_floating_events';
  const CALENDAR_VIS_KEY = 'show_floating_calendar';
  const NOTES_VIS_KEY = 'show_floating_notes';
  const WEB_BROWSER_VIS_KEY = 'show_web_browser';
  const CANVAS_TABS_VIS_KEY = 'show_canvas_tabs';

  function updateCalendarVisibility(visible) {
    if (!floatingCalendar) return;
    floatingCalendar.style.display = visible ? 'flex' : 'none';
    if (toggleCalendarApp) toggleCalendarApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateCalendarVisibility = updateCalendarVisibility;

  function updateClockVisibility(visible) {
    if (!clock) return;
    clock.style.display = visible ? 'block' : 'none';
    if (toggleClockApp) toggleClockApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }

  function updatePomoVisibility(visible) {
    if (!floatingPomo) return;
    floatingPomo.style.display = visible ? 'block' : 'none';
    if (togglePomoApp) togglePomoApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }

  function updateTodoVisibility(visible) {
    if (!floatingTodo) return;
    floatingTodo.style.display = visible ? 'flex' : 'none';
    if (toggleTodoApp) toggleTodoApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }

  function updateEventsVisibility(visible) {
    if (!floatingEvents) return;
    floatingEvents.style.display = visible ? 'flex' : 'none';
    if (toggleEventsApp) toggleEventsApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateEventsVisibility = updateEventsVisibility;

  function updateNotesVisibility(visible) {
    if (!floatingNotes) return;
    floatingNotes.style.display = visible ? 'flex' : 'none';
    if (toggleNotesApp) toggleNotesApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateNotesVisibility = updateNotesVisibility;

  function updateWebBrowserVisibility(visible) {
    if (!floatingWebBrowser) return;
    floatingWebBrowser.style.display = visible ? 'flex' : 'none';
    if (toggleWebBrowserApp) toggleWebBrowserApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateWebBrowserVisibility = updateWebBrowserVisibility;

  function updateCanvasManagerVisibility(visible) {
    if (!canvasManager) return;
    canvasManager.style.display = visible ? 'flex' : 'none';
    if (toggleCanvasManagerApp) toggleCanvasManagerApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateCanvasManagerVisibility = updateCanvasManagerVisibility;

  // Widget visibility initialization is now handled by canvas manager

  // App toggle click handlers
  if (toggleCalendarApp) {
    toggleCalendarApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingCalendar && floatingCalendar.style.display !== 'none';
      updateCalendarVisibility(!isVisible);
    };
  }

  if (toggleClockApp) {
    toggleClockApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = clock && clock.style.display !== 'none';
      updateClockVisibility(!isVisible);
    };
  }
  if (togglePomoApp) {
    togglePomoApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingPomo && floatingPomo.style.display !== 'none';
      updatePomoVisibility(!isVisible);
    };
  }
  if (toggleTodoApp) {
    toggleTodoApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingTodo && floatingTodo.style.display !== 'none';
      updateTodoVisibility(!isVisible);
    };
  }
  if (toggleEventsApp) {
    toggleEventsApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingEvents && floatingEvents.style.display !== 'none';
      updateEventsVisibility(!isVisible);
    };
  }
  if (toggleNotesApp) {
    toggleNotesApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingNotes && floatingNotes.style.display !== 'none';
      updateNotesVisibility(!isVisible);
    };
  }
  if (toggleWebBrowserApp) {
    toggleWebBrowserApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingWebBrowser && floatingWebBrowser.style.display !== 'none';
      updateWebBrowserVisibility(!isVisible);
    };
  }
  if (toggleCanvasManagerApp) {
    toggleCanvasManagerApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = canvasManager && canvasManager.style.display !== 'none';
      updateCanvasManagerVisibility(!isVisible);
    };
  }

  // Close button handlers
  if (closeCalendarBtn) closeCalendarBtn.onclick = (e) => { e.stopPropagation(); updateCalendarVisibility(false); };
  if (closeClockBtn) closeClockBtn.onclick = (e) => { e.stopPropagation(); updateClockVisibility(false); };
  if (closePomoBtn) closePomoBtn.onclick = (e) => { e.stopPropagation(); updatePomoVisibility(false); };
  if (closeTodoBtn) closeTodoBtn.onclick = (e) => { e.stopPropagation(); updateTodoVisibility(false); };
  if (closeEventsBtn) closeEventsBtn.onclick = (e) => { e.stopPropagation(); updateEventsVisibility(false); };
  if (closeNotesBtn) closeNotesBtn.onclick = (e) => { e.stopPropagation(); updateNotesVisibility(false); };
  if (closeWebBrowserBtn) closeWebBrowserBtn.onclick = (e) => { e.stopPropagation(); updateWebBrowserVisibility(false); };
  if (closeCanvasManagerBtn) closeCanvasManagerBtn.onclick = (e) => { e.stopPropagation(); updateCanvasManagerVisibility(false); };

  // =========================
  // CALCULATOR WIDGET
  // =========================
  const floatingCalculator = document.getElementById('floatingCalculator');
  const calcDisplay = document.getElementById('calcDisplay');
  const calcButtons = document.querySelectorAll('.calc-btn');
  const closeCalculatorBtn = document.getElementById('closeCalculatorBtn');
  const toggleCalculatorApp = document.getElementById('toggleCalculatorApp');
  const CALCULATOR_VIS_KEY = 'show_calculator';

  let calcExpression = '';
  let calcResult = '0';

  function updateCalculatorVisibility(visible) {
    if (!floatingCalculator) return;
    floatingCalculator.style.display = visible ? 'flex' : 'none';
    localStorage.setItem(CALCULATOR_VIS_KEY, String(visible));
    if (toggleCalculatorApp) toggleCalculatorApp.classList.toggle('active', !!visible);
  }

  function updateCalcDisplay(value) {
    if (calcDisplay) calcDisplay.textContent = value;
  }

  function handleCalculatorInput(input) {
    if (input === 'C') {
      calcExpression = '';
      calcResult = '0';
      updateCalcDisplay('0');
    } else if (input === '=') {
      try {
        // Replace display symbols with JS operators
        const expr = calcExpression.replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/âˆ’/g, '-');
        const result = eval(expr);
        calcResult = result.toString();
        updateCalcDisplay(calcResult);
        calcExpression = calcResult;
      } catch (e) {
        updateCalcDisplay('Error');
        calcExpression = '';
        calcResult = '0';
      }
    } else {
      if (calcExpression === '0' || calcExpression === calcResult) {
        calcExpression = input;
      } else {
        calcExpression += input;
      }
      updateCalcDisplay(calcExpression);
    }
  }

  calcButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const value = btn.dataset.calc;
      if (value) handleCalculatorInput(value);
    });
  });

  // Keyboard support
  document.addEventListener('keydown', (e) => {
    // Don't intercept keys if user is typing in an input field or contenteditable
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
      return;
    }
    
    if (floatingCalculator.style.display !== 'flex') return;
    const key = e.key;
    if (/[0-9\+\-\*\/\.\(\)]/.test(key)) {
      e.preventDefault();
      handleCalculatorInput(key);
    } else if (key === 'Enter') {
      e.preventDefault();
      handleCalculatorInput('=');
    } else if (key === 'Escape' || key === 'Backspace') {
      e.preventDefault();
      handleCalculatorInput('C');
    }
  });

  if (toggleCalculatorApp) {
    toggleCalculatorApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingCalculator && floatingCalculator.style.display !== 'none';
      updateCalculatorVisibility(!isVisible);
    };
  }

  if (closeCalculatorBtn) {
    closeCalculatorBtn.onclick = (e) => {
      e.stopPropagation();
      updateCalculatorVisibility(false);
    };
  }

  // Init calculator visibility
  (function initCalculatorVisibility() {
    if (toggleCalculatorApp) {
      const savedCalc = localStorage.getItem(CALCULATOR_VIS_KEY);
      const showCalc = savedCalc === null ? false : savedCalc !== 'false';
      toggleCalculatorApp.classList.toggle('active', showCalc);
      if (showCalc) floatingCalculator.style.display = 'flex';
    }
  })();

  // =========================
  // CANVAS WIDGET POSITIONING
  // =========================
  let highestZIndex = 1000;
  
  // Bring widget to front when clicked
  function bringToFront(el) {
    if (!el) return;
    highestZIndex++;
    el.style.zIndex = highestZIndex;
  }
  
  function constrainWidgetToViewport(el) {
    if (!el) return;
    // In canvas mode, widgets can be placed anywhere
    // Only ensure they don't go negative or above canvas
    const minTop = 44; // Canvas starts at 44px (header height)
    let left = parseFloat(el.style.left) || 0;
    let top = parseFloat(el.style.top) || 0;
    
    if (left < 0) left = 0;
    if (top < minTop) top = minTop;
    
    el.style.left = left + 'px';
    el.style.top = top + 'px';
  }
  
  function saveWidgetPosition(el, id) {
    // Save to current canvas
    if (window.saveCurrentCanvas) {
      window.saveCurrentCanvas();
    }
  }
  
  function restoreWidgetPosition(el, id) {
    // Positions are loaded via loadCanvasPositions
    // This function is kept for compatibility
  }
  
  function adjustAllWidgetsToViewport() {
    const widgets = [
      { el: clock, id: 'analogClock' },
      { el: floatingPomo, id: 'floatingPomo' },
      { el: floatingTodo, id: 'floatingTodo' },
      { el: floatingEvents, id: 'floatingEvents' },
      { el: floatingCalculator, id: 'floatingCalculator' },
      { el: floatingCalendar, id: 'floatingCalendar' },
      { el: floatingNotes, id: 'floatingNotes' },
      { el: floatingWebBrowser, id: 'floatingWebBrowser' }
    ];
    
    widgets.forEach(({ el, id }) => {
      if (el && el.style.left && el.style.top) {
        constrainWidgetToViewport(el);
        saveWidgetPosition(el, id);
      }
    });
  }

  // Draggable (mouse + touch) - only from header
  function makeDraggable(el, handleSelector = null, widgetId = null) {
    if (!el) return;
    let isDragging = false;
    let startX, startY, startLeft, startTop;

    const getPoint = (evt) => {
      if (evt.touches && evt.touches.length) return { x: evt.touches[0].clientX, y: evt.touches[0].clientY };
      return { x: evt.clientX, y: evt.clientY };
    };

    const startDrag = (e) => {
      // If handleSelector is provided, only allow drag from that element
      if (handleSelector) {
        const handle = el.querySelector(handleSelector);
        if (!handle || !handle.contains(e.target)) return;
      }
      
      // prevent dragging when pressing inner buttons or input fields
      if (e.target && (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
      
      // Bring to front when starting to drag
      bringToFront(el);
      
      isDragging = true;
      const p = getPoint(e);
      startX = p.x; startY = p.y;
      startLeft = el.offsetLeft; startTop = el.offsetTop;
      el.style.right = 'auto';
      el.style.bottom = 'auto';
      
      // Add dragging class for visual feedback
      el.classList.add('is-dragging');
      document.body.classList.add('dragging-active');
      
      // Prevent scrolling on touch devices only when actually dragging from valid area
      if (e.type === 'touchstart') {
        e.preventDefault();
      }
    };

    const moveDrag = (e) => {
      if (!isDragging) return;
      // Prevent scrolling while dragging on touch devices
      if (e.type === 'touchmove') {
        e.preventDefault();
      }
      const p = getPoint(e);
      el.style.left = startLeft + (p.x - startX) + 'px';
      el.style.top = startTop + (p.y - startY) + 'px';
    };

    const endDrag = () => {
      if (!isDragging) return;
      isDragging = false;
      
      // Remove dragging class
      el.classList.remove('is-dragging');
      document.body.classList.remove('dragging-active');
      
      constrainWidgetToViewport(el);
      if (widgetId) saveWidgetPosition(el, widgetId);
    };

    el.addEventListener('mousedown', startDrag);
    el.addEventListener('touchstart', startDrag, { passive: false });
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('touchmove', moveDrag, { passive: false });
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);
  }

  // Make widgets resizable
  function makeResizable(el, widgetId = null) {
    if (!el) return;
    const handle = el.querySelector('.resize-handle');
    if (!handle) return;

    let isResizing = false;
    let startX, startY, startWidth, startHeight;

    const getPoint = (evt) => {
      if (evt.touches && evt.touches.length) return { x: evt.touches[0].clientX, y: evt.touches[0].clientY };
      return { x: evt.clientX, y: evt.clientY };
    };

    const startResize = (e) => {
      e.stopPropagation();
      e.preventDefault();
      isResizing = true;
      const p = getPoint(e);
      startX = p.x;
      startY = p.y;
      startWidth = el.offsetWidth;
      startHeight = el.offsetHeight;
      document.body.style.cursor = 'nwse-resize';
      document.body.style.userSelect = 'none';
    };

    const moveResize = (e) => {
      if (!isResizing) return;
      e.preventDefault();
      const p = getPoint(e);
      const newWidth = Math.max(250, startWidth + (p.x - startX));
      const newHeight = Math.max(200, startHeight + (p.y - startY));
      el.style.width = newWidth + 'px';
      el.style.height = newHeight + 'px';
    };

    const endResize = () => {
      if (!isResizing) return;
      isResizing = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
      if (widgetId) saveWidgetPosition(el, widgetId);
    };

    handle.addEventListener('mousedown', startResize);
    handle.addEventListener('touchstart', startResize, { passive: false });
    window.addEventListener('mousemove', moveResize);
    window.addEventListener('touchmove', moveResize, { passive: false });
    window.addEventListener('mouseup', endResize);
    window.addEventListener('touchend', endResize);
  }

  // Restore saved positions - commented out, canvas manager handles this
  // restoreWidgetPosition(clock, 'analogClock');
  // restoreWidgetPosition(floatingPomo, 'floatingPomo');
  // restoreWidgetPosition(floatingTodo, 'floatingTodo');
  // restoreWidgetPosition(floatingEvents, 'floatingEvents');
  // restoreWidgetPosition(floatingCalculator, 'floatingCalculator');
  // restoreWidgetPosition(floatingCalendar, 'floatingCalendar');
  // restoreWidgetPosition(floatingNotes, 'floatingNotes');

  // Setup draggable and resizable functionality
  makeDraggable(clock, null, 'analogClock');
  makeDraggable(floatingPomo, null, 'floatingPomo');
  makeDraggable(floatingTodo, '.todo-header', 'floatingTodo');
  makeDraggable(floatingEvents, '.events-header', 'floatingEvents');
  makeDraggable(floatingCalculator, '.calc-header', 'floatingCalculator');
  makeDraggable(floatingCalendar, '.calendar-header', 'floatingCalendar');
  makeDraggable(floatingNotes, '.notes-header', 'floatingNotes');
  makeDraggable(floatingWebBrowser, '.browser-header', 'floatingWebBrowser');
  makeDraggable(canvasManager, '.canvas-manager-header', 'canvasManager');

  // Make widgets resizable
  makeResizable(floatingTodo, 'floatingTodo');
  makeResizable(floatingEvents, 'floatingEvents');
  makeResizable(floatingCalculator, 'floatingCalculator');
  makeResizable(floatingCalendar, 'floatingCalendar');
  makeResizable(floatingNotes, 'floatingNotes');
  makeResizable(floatingWebBrowser, 'floatingWebBrowser');
  makeResizable(canvasManager, 'canvasManager');

  // Add click handlers to bring widgets to front
  const allWidgets = [clock, floatingPomo, floatingTodo, floatingEvents, floatingCalculator, floatingCalendar, floatingNotes, floatingWebBrowser, canvasManager];
  
  // Touch handling for close button visibility
  const touchTimers = new Map();
  
  allWidgets.forEach(widget => {
    if (widget) {
      widget.addEventListener('mousedown', () => bringToFront(widget));
      
      // Touch handling - keep close button visible longer
      widget.addEventListener('touchstart', (e) => {
        bringToFront(widget);
        
        // Add touched class to show close button
        widget.classList.add('widget-touched');
        
        // Clear any existing timer for this widget
        if (touchTimers.has(widget)) {
          clearTimeout(touchTimers.get(widget));
        }
        
        // Keep close button visible for 3 seconds after touch
        const timer = setTimeout(() => {
          widget.classList.remove('widget-touched');
          touchTimers.delete(widget);
        }, 3000);
        
        touchTimers.set(widget, timer);
      });
      
      // Also remove on touchend if user taps elsewhere quickly
      widget.addEventListener('touchend', (e) => {
        // Don't remove immediately - let the timer handle it
        // This gives users time to tap the close button
      });
    }
  });

  // Handle viewport resize and orientation change
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(adjustAllWidgetsToViewport, 200);
  });
  
  window.addEventListener('orientationchange', () => {
    setTimeout(adjustAllWidgetsToViewport, 300);
  });

  // =========================
  // CANVAS PANNING (Space + Drag)
  // =========================
  const canvasWorkspace = document.getElementById('canvasWorkspace');
  const canvasHint = document.getElementById('canvasHint');
  let isPanning = false;
  let panStartX = 0;
  let panStartY = 0;
  let scrollStartX = 0;
  let scrollStartY = 0;
  let spacePressed = false;

  // Auto-hide hint after 5 seconds
  if (canvasHint) {
    setTimeout(() => {
      canvasHint.classList.add('hidden');
    }, 5000);
  }

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && !e.repeat && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && !e.target.isContentEditable) {
      e.preventDefault();
      spacePressed = true;
      canvasWorkspace.style.cursor = 'grab';
    }
  });

  window.addEventListener('keyup', (e) => {
    if (e.code === 'Space') {
      spacePressed = false;
      canvasWorkspace.style.cursor = '';
      if (isPanning) {
        isPanning = false;
        canvasWorkspace.classList.remove('panning');
      }
    }
  });

  canvasWorkspace.addEventListener('mousedown', (e) => {
    // Pan with Space+LMB or Middle Mouse Button
    if ((spacePressed && e.button === 0) || e.button === 1) {
      e.preventDefault();
      isPanning = true;
      canvasWorkspace.classList.add('panning');
      panStartX = e.clientX;
      panStartY = e.clientY;
      scrollStartX = canvasWorkspace.scrollLeft;
      scrollStartY = canvasWorkspace.scrollTop;
    }
  });

  window.addEventListener('mousemove', (e) => {
    if (isPanning) {
      const deltaX = panStartX - e.clientX;
      const deltaY = panStartY - e.clientY;
      canvasWorkspace.scrollLeft = scrollStartX + deltaX;
      canvasWorkspace.scrollTop = scrollStartY + deltaY;
    }
  });

  window.addEventListener('mouseup', () => {
    if (isPanning) {
      isPanning = false;
      canvasWorkspace.classList.remove('panning');
    }
  });

  // =========================
  // ANALOG CLOCK TICK LOGIC
  // =========================
  const hourHand = document.getElementById('hourHand');
  const minuteHand = document.getElementById('minuteHand');
  const secondHand = document.getElementById('secondHand');
  const clockDay = document.getElementById('clockDay');
  const clockNum = document.getElementById('clockNum');

  function updateAnalogClock() {
    const now = new Date();
    const sec = now.getSeconds();
    const min = now.getMinutes();
    const hr = now.getHours() % 12;

    if (hourHand) hourHand.style.transform = `translateX(-50%) rotate(${hr * 30 + min * 0.5}deg)`;
    if (minuteHand) minuteHand.style.transform = `translateX(-50%) rotate(${min * 6}deg)`;
    if (secondHand) secondHand.style.transform = `translateX(-50%) rotate(${sec * 6}deg)`;

    if (clockDay) clockDay.textContent = now.toLocaleDateString(undefined, { weekday: 'short' });
    if (clockNum) clockNum.textContent = now.getDate();
  }

  // Align ticks to the next second boundary for accuracy
  (function startClockTicks() {
    updateAnalogClock();
    const now = new Date();
    const msToNextSecond = 1000 - now.getMilliseconds();
    setTimeout(() => {
      updateAnalogClock();
      setInterval(updateAnalogClock, 1000);
    }, msToNextSecond);
  })();

  // =========================
  // TODO LIST LOGIC - REBUILT FROM SCRATCH
  // =========================
  
  // Initialize todo state
  let todos = [];
  let todosLoaded = false;
  
  // Get DOM elements
  const todoInput = document.getElementById('todoInput');
  const todoAddBtn = document.getElementById('todoAddBtn');
  const todoList = document.getElementById('todoList');

  // Render todos to DOM
  function renderTodos() {
    if (!todoList) {
      console.error('[TODO] todoList element not found');
      return;
    }
    
    console.log('[TODO] Rendering', todos.length, 'todos');
    todoList.innerHTML = '';
    
    // Show loading state if waiting for Firebase
    if (!todosLoaded && window.auth && window.auth.currentUser) {
      todoList.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--muted);font-size:0.9rem;">â³ Loading from cloud...</div>';
      return;
    }
    
    // Show empty state if no todos
    if (todos.length === 0) {
      todoList.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--muted);font-size:0.85rem;">No tasks yet. Add one above!</div>';
      return;
    }
    
    // Render each todo
    todos.forEach((todo, index) => {
      const item = document.createElement('div');
      item.className = 'todo-item';
      item.dataset.index = index;
      
      // Checkbox
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'todo-checkbox';
      checkbox.checked = todo.completed || false;
      checkbox.addEventListener('change', () => toggleTodo(index));
      
      // Text
      const text = document.createElement('span');
      text.className = 'todo-text' + (todo.completed ? ' completed' : '');
      text.textContent = todo.text;
      
      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'todo-delete';
      deleteBtn.textContent = 'âœ•';
      deleteBtn.addEventListener('click', () => deleteTodo(index));
      
      item.appendChild(checkbox);
      item.appendChild(text);
      item.appendChild(deleteBtn);
      todoList.appendChild(item);
    });
  }

  // Add new todo
  function addTodo() {
    if (!todoInput) return;
    
    const text = todoInput.value.trim();
    if (!text) {
      console.log('[TODO] Empty input, ignoring');
      return;
    }
    
    // Check if user is authenticated
    if (!window.auth || !window.auth.currentUser) {
      alert('Please log in to save todos');
      return;
    }
    
    console.log('[TODO] Adding new todo:', text);
    
    const newTodo = {
      text: text,
      completed: false,
      id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      createdAt: Date.now()
    };
    
    todos.push(newTodo);
    todoInput.value = '';
    
    console.log('[TODO] Total todos:', todos.length);
    renderTodos();
    saveTodosToFirebase();
  }

  // Toggle todo completion
  function toggleTodo(index) {
    if (index < 0 || index >= todos.length) return;
    
    console.log('[TODO] Toggling todo at index', index);
    todos[index].completed = !todos[index].completed;
    
    renderTodos();
    saveTodosToFirebase();
  }

  // Delete todo
  function deleteTodo(index) {
    if (index < 0 || index >= todos.length) return;
    
    console.log('[TODO] Deleting todo at index', index);
    todos.splice(index, 1);
    
    renderTodos();
    saveTodosToFirebase();
  }

  // Save todos to Firebase
  async function saveTodosToFirebase() {
    try {
      // Verify authentication
      if (!window.auth || !window.auth.currentUser) {
        console.warn('[TODO] Not authenticated, cannot save');
        return;
      }
      
      if (!window.db || !window.doc || !window.setDoc || !window.serverTimestamp) {
        console.error('[TODO] Firebase not initialized');
        return;
      }
      
      const userId = window.auth.currentUser.uid;
      const deviceId = window.deviceId || 'unknown';
      
      console.log('[TODO] Saving', todos.length, 'todos to Firebase for user:', userId);
      
      const todoRef = window.doc(window.db, 'user_todos', userId);
      await window.setDoc(todoRef, {
        items: todos,
        by: deviceId,
        updatedAt: window.serverTimestamp()
      });
      
      console.log('[TODO] âœ… Successfully saved to Firebase');
    } catch (error) {
      console.error('[TODO] âŒ Failed to save to Firebase:', error);
      console.error('[TODO] Error code:', error.code);
      console.error('[TODO] Error message:', error.message);
    }
  }

  // Load todos from Firebase (called by Firebase listener)
  function loadTodosFromFirebase(data) {
    try {
      console.log('[TODO] Loading data from Firebase:', data);
      
      if (!data) {
        console.log('[TODO] No data received from Firebase, using empty array');
        todos = [];
        todosLoaded = true;
        renderTodos();
        return;
      }
      
      if (Array.isArray(data.items)) {
        todos = data.items;
        console.log('[TODO] âœ… Loaded', todos.length, 'todos from Firebase');
      } else {
        console.warn('[TODO] data.items is not an array, using empty array');
        todos = [];
      }
      
      todosLoaded = true;
      renderTodos();
    } catch (error) {
      console.error('[TODO] âŒ Error loading from Firebase:', error);
      todos = [];
      todosLoaded = true;
      renderTodos();
    }
  }

  // Expose function for Firebase listener
  window.applyRemoteTodos = loadTodosFromFirebase;

  // Expose function for clearing completed todos (used by settings)
  window.clearCompletedTodos = function() {
    const remaining = todos.filter(t => !t.completed);
    todos = remaining;
    renderTodos();
    saveTodosToFirebase();
  };

  // Set up event listeners
  if (todoAddBtn) {
    todoAddBtn.addEventListener('click', addTodo);
    console.log('[TODO] Add button listener attached');
  }

  if (todoInput) {
    todoInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addTodo();
      }
    });
    console.log('[TODO] Input keypress listener attached');
  }

  // Initial render
  console.log('[TODO] Initial render');
  renderTodos();

  // =========================
  // EVENTS LOGIC
  // =========================
  const eventDateInput = document.getElementById('eventDateInput');
  const eventTextInput = document.getElementById('eventTextInput');
  const eventAddBtn = document.getElementById('eventAddBtn');
  const eventsList = document.getElementById('eventsList');
  const selectedDateBadge = document.getElementById('selectedDateBadge');
  const showAllEventsBtn = document.getElementById('showAllEventsBtn');

  // Set today as default date
  if (eventDateInput) {
    const today = new Date();
    eventDateInput.value = today.toISOString().split('T')[0];
  }

  // Click date badge or button to show all events
  if (selectedDateBadge) {
    selectedDateBadge.onclick = () => {
      selectedCalendarDate = null;
      renderEvents(null);
    };
  }
  if (showAllEventsBtn) {
    showAllEventsBtn.onclick = () => {
      selectedCalendarDate = null;
      renderEvents(null);
    };
  }

  function renderEvents(filterDate = null) {
    if (!eventsList) return;
    eventsList.innerHTML = '';
    
    // Show loading state if not loaded yet and user is authenticated
    if (!eventsLoaded && window.auth && auth.currentUser) {
      eventsList.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--muted);">Loading events from cloud...</div>';
      return;
    }
    
    // Filter events by date if specified
    const filteredEvents = filterDate 
      ? events.filter(e => e.date === filterDate)
      : events;

    // Sort events by date (newest first)
    filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));

    filteredEvents.forEach((event) => {
      const actualIndex = events.findIndex(e => e.id === event.id);
      const item = document.createElement('div');
      item.className = 'event-item';
      const dateObj = new Date(event.date + 'T00:00:00');
      const dateStr = dateObj.toLocaleDateString(undefined, { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
      item.innerHTML = `
        <div class="event-date-badge">${dateStr}</div>
        <div class="event-text">${event.text}</div>
        <button class="event-delete" data-index="${actualIndex}">âœ•</button>
      `;
      eventsList.appendChild(item);
    });

    // Event listeners
    eventsList.querySelectorAll('.event-delete').forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        const idx = Number(e.currentTarget.dataset.index);
        events.splice(idx, 1);
        renderEvents(selectedCalendarDate);
        renderCalendar(shownYear);
        syncEventsToCloud();
      };
    });

    // Update selected date badge and show all button
    if (selectedDateBadge) {
      if (filterDate) {
        const dateObj = new Date(filterDate + 'T00:00:00');
        selectedDateBadge.textContent = 'ğŸ“† ' + dateObj.toLocaleDateString(undefined, { 
          month: 'short', 
          day: 'numeric' 
        });
        selectedDateBadge.style.display = 'inline-block';
        if (showAllEventsBtn) showAllEventsBtn.style.display = 'inline-block';
      } else {
        selectedDateBadge.textContent = '';
        selectedDateBadge.style.display = 'none';
        if (showAllEventsBtn) showAllEventsBtn.style.display = 'none';
      }
    }
  }
  window.renderEvents = renderEvents;

  function addEvent() {
    if (!eventDateInput || !eventTextInput) return;
    const date = eventDateInput.value;
    const text = eventTextInput.value.trim();
    if (!date || !text) return;
    
    events.push({ 
      date, 
      text, 
      id: Date.now() + Math.random() 
    });
    
    eventTextInput.value = '';
    // Keep current filter (if any) after adding
    renderEvents(selectedCalendarDate);
    renderCalendar(shownYear);
    syncEventsToCloud();
  }

  async function syncEventsToCloud() {
    try {
      console.log('[EVENTS] syncEventsToCloud called, events count:', events.length);
      
      // Require authentication for data operations
      if (!window.auth || !auth.currentUser || !window.db || !window.doc || !window.setDoc || !window.serverTimestamp) {
        console.warn('[EVENTS] Not authenticated - data not saved');
        return;
      }
      
      // Get deviceId from global scope or localStorage
      const deviceId = window.deviceId || localStorage.getItem('device_id') || 'unknown';
      console.log('[EVENTS] Syncing', events.length, 'events to Firebase...');
      
      const ref = doc(db, 'user_events', auth.currentUser.uid);
      await setDoc(ref, {
        items: events,
        by: deviceId,
        updatedAt: serverTimestamp()
      }, { merge: true });
      
      console.log('[EVENTS] âœ“ Successfully synced to Firebase');
    } catch (err) {
      console.error('[EVENTS] Cloud sync failed:', err);
      console.error('[EVENTS] Error details:', err.message, err.code);
    }
  }

  window.applyRemoteEvents = (data) => {
    try {
      if (!data) {
        console.log('[EVENTS] No data received');
        eventsLoaded = true;
        renderEvents(selectedCalendarDate);
        renderCalendar(shownYear);
        return;
      }
      console.log('[EVENTS] Received data:', data);
      // Don't skip if from same device - we need to load on page refresh
      // if (data.by && data.by === deviceId) return;
      if (Array.isArray(data.items)) {
        events = data.items;
        eventsLoaded = true;
        console.log('[EVENTS] Loaded', events.length, 'events from Firebase');
        // Preserve current filter when receiving remote updates
        renderEvents(selectedCalendarDate);
        renderCalendar(shownYear);
      } else {
        console.warn('[EVENTS] data.items is not an array:', data.items);
        eventsLoaded = true;
        renderEvents(selectedCalendarDate);
        renderCalendar(shownYear);
      }
    } catch (e) {
      console.error('[EVENTS] applyRemoteEvents error:', e);
      eventsLoaded = true;
      renderEvents(selectedCalendarDate);
      renderCalendar(shownYear);
    }
  };

  if (eventAddBtn) eventAddBtn.onclick = addEvent;
  if (eventTextInput) {
    eventTextInput.onkeypress = (e) => {
      if (e.key === 'Enter') addEvent();
    };
  }

  // Show all events initially (no filter)
  renderEvents(null);
</script>

<!-- Firebase Module -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
  import {
    getAuth, setPersistence, browserLocalPersistence, signOut, onAuthStateChanged,
    signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail,
    signInWithCustomToken
  } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

  // Firebase config
  const firebaseConfig = {
    apiKey: 'AIzaSyA05Vxw3kSZ8xAHUBppMh5p7VwBZ-47kmM',
    authDomain: 'calendar-599ac.firebaseapp.com',
    projectId: 'calendar-599ac',
    storageBucket: 'calendar-599ac.firebasestorage.app',
    messagingSenderId: '89812638572',
    appId: '1:89812638572:web:f02d7309367576a619b149'
  };

  // Initialize
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Expose for non-module script usage
  window.auth = auth;
  window.db = db;
  window.doc = doc;
  window.setDoc = setDoc;
  window.serverTimestamp = serverTimestamp;

  // UI elements
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const resetPasswordBtn = document.getElementById('resetPasswordBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const loggedOutUI = document.getElementById('loggedOutUI');
  const loggedInUI = document.getElementById('loggedInUI');
  const userEmailDisplay = document.getElementById('userEmailDisplay');
  const syncStatus = document.getElementById('syncStatus');
  const notesEditor = document.getElementById('notesEditor');

  const NOTES_KEY_CLOUD = 'calendar_notes_rich';

  const setSyncStatus = (text) => { if (syncStatus) syncStatus.textContent = text; };

  // Auth actions
  const handleAuthError = (err) => {
    console.error(err);
    let msg = 'Authentication failed';
    if (err.code === 'auth/wrong-password') msg = 'Wrong password';
    if (err.code === 'auth/user-not-found') msg = 'User not found';
    if (err.code === 'auth/email-already-in-use') msg = 'Email already registered';
    if (err.code === 'auth/invalid-email') msg = 'Invalid email address';
    if (err.code === 'auth/weak-password') msg = 'Password is too weak';
    setSyncStatus('Error: ' + msg);
  };

  if (loginBtn) loginBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) return setSyncStatus('Enter email & password');
    try {
      setSyncStatus('Logging in...');
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) { handleAuthError(err); }
  };

  if (signupBtn) signupBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) return setSyncStatus('Enter email & password');
    try {
      setSyncStatus('Creating account...');
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) { handleAuthError(err); }
  };

  if (resetPasswordBtn) resetPasswordBtn.onclick = async () => {
    const email = emailInput.value.trim();
    if (!email) return setSyncStatus('Enter your email first');
    try {
      setSyncStatus('Sending reset link...');
      await sendPasswordResetEmail(auth, email);
      setSyncStatus('Check your inbox for reset link');
    } catch (err) { handleAuthError(err); }
  };

  if (logoutBtn) logoutBtn.onclick = async () => {
    // Clear all app data from memory
    todos = [];
    events = [];
    todosLoaded = false;
    eventsLoaded = false;
    
    // Clear all cached data from localStorage
    console.log('[LOGOUT] Clearing all cached data...');
    localStorage.removeItem('todos_local_cache');
    localStorage.removeItem('events_local_cache');
    localStorage.removeItem('calendar_notes_rich');
    
    // Clear UI
    if (todoList) todoList.innerHTML = '';
    if (eventsList) eventsList.innerHTML = '';
    if (notesEditor) notesEditor.innerHTML = '';
    
    console.log('[LOGOUT] All data cleared, signing out...');
    await signOut(auth);
  };

  // Persist auth
  (async function initAuth() {
    try {
      await setPersistence(auth, browserLocalPersistence);
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      }
    } catch (err) {
      console.error('Init Auth error', err);
    }
  })();

  // Realtime sync
  let unsubscribeNote = null;
  let unsubscribePomo = null;
  let unsubscribeEvents = null;
  let unsubscribeTodo = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      if (loggedOutUI) loggedOutUI.style.display = 'none';
      if (loggedInUI) loggedInUI.style.display = 'block';
      if (userEmailDisplay) userEmailDisplay.textContent = `Logged in as: ${user.email}`;
      setSyncStatus('Signed in â€” syncing');

      // Notes listener
      const noteRef = doc(db, 'user_notes', user.uid);
      if (unsubscribeNote) unsubscribeNote();
      unsubscribeNote = onSnapshot(noteRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (document.activeElement !== notesEditor && notesEditor) {
            notesEditor.innerHTML = data.content || '';
          }
          setSyncStatus('Cloud Synced');
        } else {
          // No existing notes - start with empty
          setDoc(noteRef, { content: '', updatedAt: serverTimestamp() })
            .then(() => setSyncStatus('Synced (Started Cloud)'))
            .catch(() => setSyncStatus('Sync Error'));
        }
      }, (err) => {
        console.error('Firestore Error:', err);
        setSyncStatus('Sync Error: Permission Denied');
      });

      // Pomodoro listener
      const pomoRef = doc(db, 'user_pomodoro', user.uid);
      if (unsubscribePomo) unsubscribePomo();
      unsubscribePomo = onSnapshot(pomoRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (window.applyRemoteState) {
            window.applyRemoteState(data);
          }
        } else {
          // No cloud data yet, initialize with default values
          setDoc(pomoRef, {
            remaining: 60 * 60,
            duration: 60,
            running: false,
            startedAt: null,
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial pomo set error:', err));
        }
      }, (err) => {
        console.error('Pomodoro listener error:', err);
      });

      // Todo listener
      const todoRef = doc(db, 'user_todos', user.uid);
      if (unsubscribeTodo) unsubscribeTodo();
      console.log('[TODO] Setting up Firebase listener for user:', user.uid);
      unsubscribeTodo = onSnapshot(todoRef, (snap) => {
        console.log('[TODO] Snapshot received, exists:', snap.exists());
        if (snap.exists()) {
          const data = snap.data();
          console.log('[TODO] Snapshot data:', data);
          if (window.applyRemoteTodos) {
            window.applyRemoteTodos(data);
          }
        } else {
          console.log('[TODO] No todos document found, creating empty one');
          setDoc(todoRef, {
            items: [],
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial todo set error:', err));
        }
      }, (err) => {
        console.error('[TODO] Listener error:', err);
        console.error('[TODO] Error code:', err.code);
        console.error('[TODO] Error message:', err.message);
      });

      // Events listener
      const eventsRef = doc(db, 'user_events', user.uid);
      if (unsubscribeEvents) unsubscribeEvents();
      console.log('[EVENTS] Setting up Firebase listener for user:', user.uid);
      unsubscribeEvents = onSnapshot(eventsRef, (snap) => {
        console.log('[EVENTS] Snapshot received, exists:', snap.exists());
        if (snap.exists()) {
          const data = snap.data();
          console.log('[EVENTS] Snapshot data:', data);
          if (window.applyRemoteEvents) {
            window.applyRemoteEvents(data);
          }
        } else {
          console.log('[EVENTS] No events document found, creating empty one');
          setDoc(eventsRef, {
            items: [],
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial events set error:', err));
        }
      }, (err) => {
        console.error('[EVENTS] Listener error:', err);
        console.error('[EVENTS] Error code:', err.code);
        console.error('[EVENTS] Error message:', err.message);
      });

    } else {
      if (loggedOutUI) loggedOutUI.style.display = 'block';
      if (loggedInUI) loggedInUI.style.display = 'none';
      setSyncStatus('Not signed in - Login to access your data');
      
      // Unsubscribe from all listeners
      if (unsubscribeNote) { unsubscribeNote(); unsubscribeNote = null; }
      if (unsubscribePomo) { unsubscribePomo(); unsubscribePomo = null; }
      if (unsubscribeTodo) { unsubscribeTodo(); unsubscribeTodo = null; }
      if (unsubscribeEvents) { unsubscribeEvents(); unsubscribeEvents = null; }
      
      // Clear all data when logged out (cloud-first approach)
      todos = [];
      events = [];
      todosLoaded = false;
      eventsLoaded = false;
      if (notesEditor) notesEditor.innerHTML = '';
      if (todoList) todoList.innerHTML = '';
      if (eventsList) eventsList.innerHTML = '';
    }
  });

  // Debounced cloud save for notes
  let saveTimer = null;
  if (notesEditor) {
    notesEditor.addEventListener('input', () => {
      const html = notesEditor.innerHTML;
      // Only save to cloud if authenticated - no local storage
      if (auth.currentUser) {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(async () => {
          try {
            const noteRef = doc(db, 'user_notes', auth.currentUser.uid);
            await setDoc(noteRef, { content: html, updatedAt: serverTimestamp() }, { merge: true });
            setSyncStatus('All changes saved');
          } catch (err) {
            setSyncStatus('Cloud save failed');
          }
        }, 800);
      }
    });
  }

  window.addEventListener('offline', () => setSyncStatus('Offline â€” saved locally'));
  window.addEventListener('online', () => setSyncStatus('Online'));
</script>

<!-- Widget/App Scripts -->
<script src="apps/clock.js"></script>
<script src="apps/pomodoro.js"></script>
<script src="apps/todo.js"></script>
<script src="apps/calculator.js"></script>
<script src="apps/notes.js"></script>
<script src="apps/web-browser.js"></script>
<script src="apps/canvas-manager.js"></script>
<script src="apps/settings.js"></script>

<script>
  // Initialize canvas manager after all scripts are loaded
  if (window.initializeCanvasManager) {
    window.initializeCanvasManager();
  }
</script>

</body>
</html>
