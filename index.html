<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Year Calendar with Notes</title>

  <!-- =========================
        STYLES (CSS)
        ========================= -->
  <link rel="stylesheet" href="css/themes.css?v=2">
  <link rel="stylesheet" href="css/base.css?v=2">
  <link rel="stylesheet" href="css/header.css?v=2">
  <link rel="stylesheet" href="css/calendar.css?v=2">
  <link rel="stylesheet" href="css/notes.css?v=2">
  <link rel="stylesheet" href="css/clock.css?v=2">
  <link rel="stylesheet" href="css/pomodoro.css?v=2">
  <link rel="stylesheet" href="css/todo.css?v=2">
  <link rel="stylesheet" href="css/calculator.css?v=2">
  <link rel="stylesheet" href="css/events.css?v=2">
  <link rel="stylesheet" href="css/app-launcher.css?v=2">
  <link rel="stylesheet" href="css/canvas-tabs.css?v=2">
  <link rel="stylesheet" href="css/widgets.css?v=2">
  <link rel="stylesheet" href="css/mobile.css?v=2">
</head>
<body>

<header>
  <button id="appLauncherBtn" class="app-launcher-btn" title="Apps">‚ñ¶</button>
  
  <div style="display:inline-flex;align-items:center;gap:0.4rem;">
    <div class="dynamic-island canvas-switcher" id="canvasSwitcher">
      üìë <span id="canvasNameDisplay">Canvas 1</span> <span class="dropdown-arrow">‚ñæ</span>
      <div class="canvas-dropdown" id="canvasDropdown"></div>
    </div>
    <div class="dynamic-island"><span id="dtText"></span></div>
    <div class="dynamic-island">üçÖ <span id="pomoTime">60:00</span>
      <button id="pomoStart" class="pomo-btn">‚ñ∂</button>
      <button id="pomoReset" class="pomo-btn">‚ü≥</button>
    </div>
  </div>

  <button id="themeBtn" class="theme-btn">üçé macOS</button>
  <button id="settingsBtn" class="theme-btn" style="right:5.5rem;">‚öôÔ∏è Settings</button>
</header>

<!-- Canvas Workspace -->
<div id="canvasWorkspace">

<!-- Canvas Helper Hint -->
<div class="canvas-hint" id="canvasHint">
  üí° <strong>Quick Tips:</strong> Hold <kbd>Space</kbd> + drag to pan ‚Ä¢ Drag widgets anywhere ‚Ä¢ Use Canvas Manager to switch workspaces ‚Ä¢ Click <strong>‚ñ¶</strong> for apps
</div>

<!-- Floating Analog Clock -->
<div id="analogClock" class="analog-clock">
  <button id="closeClockBtn" class="close-widget-btn" title="Close Clock">‚úï</button>
  <div class="clock-face">
    <div class="hour-marks">
      <span></span><span></span><span></span><span></span><span></span><span></span>
      <span></span><span></span><span></span><span></span><span></span><span></span>
    </div>
    <div class="hand hour" id="hourHand"></div>
    <div class="hand minute" id="minuteHand"></div>
    <div class="hand second" id="secondHand"></div>
    <div class="clock-center"></div>
    <div class="clock-date"><div id="clockDay"></div><div id="clockNum"></div></div>
  </div>
</div>

<!-- Floating Pomodoro -->
<div id="floatingPomo" class="floating-pomo">
  <button id="closePomoBtn" class="close-widget-btn" title="Close Pomodoro">‚úï</button>
  <div class="pomo-content">
    <span class="pomo-emoji">üçÖ</span>
    <span id="floatingPomoTime">60:00</span>
    <div class="pomo-controls">
      <button id="floatingPomoStart" class="pomo-btn">‚ñ∂</button>
      <button id="floatingPomoReset" class="pomo-btn">‚ü≥</button>
    </div>
  </div>
</div>

<!-- Floating Todo List -->
<div id="floatingTodo" class="floating-todo">
  <button id="closeTodoBtn" class="close-widget-btn" title="Close Todo">‚úï</button>
  <div class="resize-handle"></div>
  <div class="todo-header">üìù To-Do List</div>
  <div class="todo-input-container">
    <input type="text" id="todoInput" class="todo-input" placeholder="Add a task..." />
    <button id="todoAddBtn" class="todo-add-btn">+</button>
  </div>
  <div id="todoList" class="todo-list"></div>
</div>

<!-- Floating Calculator Widget -->
<div id="floatingCalculator" class="floating-calculator">
  <button id="closeCalculatorBtn" class="close-widget-btn" title="Close Calculator">‚úï</button>
  <div class="resize-handle"></div>
  <div class="calc-header">üî¢ Calculator</div>
  <div id="calcDisplay" class="calc-display">0</div>
  <div class="calc-buttons">
    <button class="calc-btn clear" data-calc="C">C</button>
    <button class="calc-btn" data-calc="(">(</button>
    <button class="calc-btn" data-calc=")">)</button>
    <button class="calc-btn operator" data-calc="/">√∑</button>
    
    <button class="calc-btn" data-calc="7">7</button>
    <button class="calc-btn" data-calc="8">8</button>
    <button class="calc-btn" data-calc="9">9</button>
    <button class="calc-btn operator" data-calc="*">√ó</button>
    
    <button class="calc-btn" data-calc="4">4</button>
    <button class="calc-btn" data-calc="5">5</button>
    <button class="calc-btn" data-calc="6">6</button>
    <button class="calc-btn operator" data-calc="-">‚àí</button>
    
    <button class="calc-btn" data-calc="1">1</button>
    <button class="calc-btn" data-calc="2">2</button>
    <button class="calc-btn" data-calc="3">3</button>
    <button class="calc-btn operator" data-calc="+">+</button>
    
    <button class="calc-btn" data-calc="0">0</button>
    <button class="calc-btn" data-calc=".">.</button>
    <button class="calc-btn equals" data-calc="=">=</button>
  </div>
</div>

<!-- Floating Events Widget -->
<div id="floatingEvents" class="floating-events">
  <button id="closeEventsBtn" class="close-widget-btn" title="Close Events">‚úï</button>
  <div class="resize-handle"></div>
  <div class="events-header">
    <span>üìÖ Events</span>
    <span id="selectedDateBadge" class="selected-date-badge" style="cursor:pointer" title="Click to show all events"></span>
    <button id="showAllEventsBtn" class="show-all-btn">Show All</button>
  </div>
  <div class="events-input-container">
    <div class="events-input-row">
      <input type="date" id="eventDateInput" class="event-date-input" />
      <input type="text" id="eventTextInput" class="event-text-input" placeholder="Event description..." />
    </div>
    <button id="eventAddBtn" class="event-add-btn">+ Add Event</button>
  </div>
  <div id="eventsList" class="events-list"></div>
</div>

<!-- Floating Calendar Widget -->
<div id="floatingCalendar" class="floating-calendar">
  <button id="closeCalendarBtn" class="close-widget-btn" title="Close Calendar">‚úï</button>
  <div class="resize-handle"></div>
  <div class="calendar-header">
    <h1 class="calendar-title" id="year">Calendar 2025</h1>
    <div class="calendar-controls">
      <button id="todayBtn" class="calendar-today-btn">üìç Today</button>
      <button id="monthToggleBtn" class="calendar-month-btn">üìÖ Year View</button>
      <button id="prev" class="calendar-nav-btn">‚óÄ</button>
      <button id="next" class="calendar-nav-btn">‚ñ∂</button>
    </div>
  </div>
  <div id="calendar" class="calendar"></div>
</div>

<!-- Floating Notes Widget -->
<div id="floatingNotes" class="floating-notes">
  <button id="closeNotesBtn" class="close-widget-btn" title="Close Notes">‚úï</button>
  <div class="resize-handle"></div>
  <div class="notes-header">
    <div style="display:flex;align-items:center;gap:0.6rem;">
      <h2 style="margin:0">Notes</h2>
      <div id="syncStatus" style="font-size:0.75rem;color:var(--muted)">Not signed in</div>
    </div>
    <div class="notes-tools">
      <button data-cmd="bold"><b>B</b></button>
      <button data-cmd="italic"><i>I</i></button>
      <button data-cmd="underline"><u>U</u></button>
      <button data-cmd="insertUnorderedList">‚Ä¢ List</button>
    </div>
  </div>
  <div id="notesEditor" class="notes-editor" contenteditable="true"></div>
</div>

<!-- Canvas Manager Widget -->
<div id="canvasManager" class="canvas-manager">
  <button id="closeCanvasManagerBtn" class="close-widget-btn" title="Close">‚úï</button>
  <div class="resize-handle"></div>
  <div class="canvas-manager-header">üìë Canvas Manager</div>
  <div id="canvasTabsContainer" class="canvas-tabs-container">
    <!-- Tabs will be rendered here by JavaScript -->
  </div>
</div>

</div><!-- End Canvas Workspace -->

<!-- App Drawer Overlay -->
<div id="appDrawer" class="app-drawer">
  <div class="app-drawer-content">
    <div class="app-drawer-header">üöÄ Apps</div>
    <div class="app-list">
      <div class="app-item" data-app="calendar">
        <div class="app-icon">üìÜ</div>
        <div class="app-info">
          <div class="app-name">Calendar</div>
          <div class="app-desc">Full year view</div>
        </div>
        <div class="app-toggle" id="toggleCalendarApp"></div>
      </div>
      <div class="app-item" data-app="clock">
        <div class="app-icon">üïê</div>
        <div class="app-info">
          <div class="app-name">Analog Clock</div>
          <div class="app-desc">Live time display</div>
        </div>
        <div class="app-toggle" id="toggleClockApp"></div>
      </div>
      <div class="app-item" data-app="pomodoro">
        <div class="app-icon">üçÖ</div>
        <div class="app-info">
          <div class="app-name">Pomodoro Timer</div>
          <div class="app-desc">Focus timer</div>
        </div>
        <div class="app-toggle" id="togglePomoApp"></div>
      </div>
      <div class="app-item" data-app="todo">
        <div class="app-icon">‚úÖ</div>
        <div class="app-info">
          <div class="app-name">To-Do List</div>
          <div class="app-desc">Task management</div>
        </div>
        <div class="app-toggle" id="toggleTodoApp"></div>
      </div>
      <div class="app-item" data-app="events">
        <div class="app-icon">üìÖ</div>
        <div class="app-info">
          <div class="app-name">Events</div>
          <div class="app-desc">Track events</div>
        </div>
        <div class="app-toggle" id="toggleEventsApp"></div>
      </div>
      <div class="app-item" data-app="calculator">
        <div class="app-icon">üî¢</div>
        <div class="app-info">
          <div class="app-name">Calculator</div>
          <div class="app-desc">Quick calculations</div>
        </div>
        <div class="app-toggle" id="toggleCalculatorApp"></div>
      </div>
      <div class="app-item" data-app="notes">
        <div class="app-icon">üìù</div>
        <div class="app-info">
          <div class="app-name">Notes</div>
          <div class="app-desc">Quick notes</div>
        </div>
        <div class="app-toggle" id="toggleNotesApp"></div>
      </div>
      <div class="app-item" data-app="canvasManager">
        <div class="app-icon">üìë</div>
        <div class="app-info">
          <div class="app-name">Canvas Manager</div>
          <div class="app-desc">Manage canvases</div>
        </div>
        <div class="app-toggle" id="toggleCanvasManagerApp"></div>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     SETTINGS PAGE (OVERLAY)
     ========================= -->
<div id="settingsPage" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.25);backdrop-filter:blur(4px);">
    <div style="max-width:420px;margin:4rem auto;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-float); max-height: 90vh; overflow-y: auto;">
    <h2 style="margin-top:0">Settings</h2>

    <!-- Appearance -->
    <div class="month" style="margin-bottom:1rem;">
      <h3>Appearance</h3>
      <p style="font-size:0.8rem;color:var(--muted)">Theme</p>
      <div id="settingsThemes" style="display:flex;gap:0.4rem;flex-wrap:wrap;"></div>

      <p style="font-size:0.8rem;color:var(--muted);margin-top:0.6rem">Font Size</p>
      <button class="font-btn" data-size="90">A‚àí</button>
      <button class="font-btn" data-size="100">A</button>
      <button class="font-btn" data-size="110">A+</button>
    </div>

    <!-- Pomodoro -->
    <div class="month" style="margin-bottom:1rem;">
      <h3>Pomodoro</h3>
      <p style="font-size:0.75rem;color:var(--muted)">Session length (minutes)</p>
      <input id="pomoDurationInput" type="number" min="1" style="width:80px;padding:4px 6px;border-radius:8px;border:1px solid var(--border);font-size:0.8rem;" />
    </div>

    <!-- Account -->
    <div class="month" style="margin-bottom:1rem;">
      <h3>Account</h3>
      
      <!-- Logged Out View -->
      <div id="loggedOutUI">
        <input type="email" id="emailInput" class="auth-input" placeholder="Email address">
        <input type="password" id="passwordInput" class="auth-input" placeholder="Password">
        
        <div style="display:flex; gap: 8px; margin-bottom: 12px;">
          <button id="loginBtn" class="today-btn" style="position:static; flex:1; justify-content:center;">Login</button>
          <button id="signupBtn" class="theme-btn" style="position:static; flex:1; justify-content:center;">Sign Up</button>
        </div>
        
        <button id="resetPasswordBtn" style="font-size: 0.7rem; color: var(--primary); text-decoration: underline; background: none; border: none; padding: 0; cursor: pointer;">Forgot Password?</button>
      </div>

      <!-- Logged In View -->
      <div id="loggedInUI" style="display:none;">
        <p id="userEmailDisplay" style="font-size: 0.8rem; margin-bottom: 12px;"></p>
        <button id="logoutBtn" class="today-btn" style="position:static; background: linear-gradient(180deg, #ff3b30, #d70015); width: 100%; justify-content: center;">Sign Out</button>
      </div>

      <p style="font-size:0.75rem;color:var(--muted); margin-top: 12px;">Sync notes across devices</p>
    </div>

    <!-- About -->
    <div class="month">
      <h3>About</h3>
      <p style="font-size:0.75rem;color:var(--muted)">Year Calendar with Notes</p>
    </div>

    <button id="closeSettings" class="theme-btn" style="position:absolute;top:0.8rem;right:0.8rem;">‚úï</button>
  </div>
</div>

<!-- Floating Notes Widget -->
<div id="floatingNotes" class="floating-notes">
  <button id="closeNotesBtn" class="close-widget-btn" title="Close Notes">‚úï</button>
  <div class="resize-handle"></div>
  <div class="notes-header">
    <div style="display:flex;align-items:center;gap:0.6rem;">
      <h2 style="margin:0">Notes</h2>
      <div id="syncStatus" style="font-size:0.75rem;color:var(--muted)">Not signed in</div>
    </div>
    <div class="notes-tools">
      <button data-cmd="bold"><b>B</b></button>
      <button data-cmd="italic"><i>I</i></button>
      <button data-cmd="underline"><u>U</u></button>
      <button data-cmd="insertUnorderedList">‚Ä¢ List</button>
    </div>
  </div>
  <div id="notesEditor" class="notes-editor" contenteditable="true"></div>
</div>

</div><!-- End Canvas Workspace -->

<script>
  const calEl = document.getElementById('calendar');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPage = document.getElementById('settingsPage');
  const closeSettings = document.getElementById('closeSettings');
  const yearEl = document.getElementById('year');
  const notesEditor = document.getElementById('notesEditor');
  const toolButtons = document.querySelectorAll('.notes-tools button');

  const now = new Date();
  const CURRENT_YEAR = now.getFullYear();
  const TODAY_DATE = now.getDate();
  const TODAY_MONTH = now.getMonth();
  let shownYear = CURRENT_YEAR;

  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  let monthViewIndex = null;
  const monthToggleBtn = document.getElementById('monthToggleBtn');
  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  // Events data (initialized early for calendar rendering)
  let events = [];
  let selectedCalendarDate = null;

  function renderCalendar(year) {
    calEl.innerHTML = '';
    yearEl.textContent = `Calendar ${year}`;

    MONTHS.forEach((m, i) => {
      if (monthViewIndex !== null && monthViewIndex !== i) return;
      const box = document.createElement('div');
      box.className = 'month';
      box.innerHTML = `<h2 data-month="${i}" style="cursor:pointer">${m}</h2>`;

      const w = document.createElement('div');
      w.className = 'weekdays';
      DAYS.forEach(d => w.innerHTML += `<div>${d}</div>`);

      const g = document.createElement('div');
      g.className = 'days';
      const first = new Date(year, i, 1).getDay();
      const total = new Date(year, i + 1, 0).getDate();

      for (let j = 0; j < first; j++) g.innerHTML += '<div></div>';
      for (let d = 1; d <= total; d++) {
        const t = d === TODAY_DATE && i === TODAY_MONTH && year === CURRENT_YEAR;
        const dateStr = `${year}-${String(i + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const hasEvent = events.some(e => e.date === dateStr);
        const dotHtml = hasEvent ? '<span class="event-dot"></span>' : '';
        g.innerHTML += `<div class="${t ? 'today' : ''}" data-date="${dateStr}" style="cursor:pointer">${d}${dotHtml}</div>`;
      }

      box.append(w, g);
      calEl.appendChild(box);
    });

    // Add click handlers to dates for event viewing
    calEl.querySelectorAll('.days div[data-date]').forEach(dayEl => {
      dayEl.onclick = (e) => {
        const dateStr = e.currentTarget.dataset.date;
        if (!dateStr) return;
        selectedCalendarDate = dateStr;
        const eventDateInput = document.getElementById('eventDateInput');
        if (eventDateInput) eventDateInput.value = dateStr;
        if (window.renderEvents) window.renderEvents(dateStr);
        
        // Show events widget if hidden
        const eventsWidget = document.getElementById('floatingEvents');
        if (eventsWidget && eventsWidget.style.display === 'none') {
          if (window.updateEventsVisibility) window.updateEventsVisibility(true);
        }
      };
    });
  }

  function updateTime() {
    const d = new Date();
    const dtText = document.getElementById('dtText');
    if(dtText) {
      dtText.textContent = d.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' }) + ' ‚Ä¢ ' + d.toLocaleTimeString();
    }
  }

  toolButtons.forEach(b => b.onclick = () => {
    document.execCommand(b.dataset.cmd);
    updateToolStates();
  });

  function updateToolStates() {
    toolButtons.forEach(btn => {
      const cmd = btn.dataset.cmd;
      try {
        const isActive = document.queryCommandState(cmd);
        btn.classList.toggle('active', isActive);
      } catch (e) {}
    });
  }

  document.addEventListener('selectionchange', () => {
    if (document.activeElement === notesEditor) {
      updateToolStates();
    }
  });

  const NOTES_KEY = 'calendar_notes_rich';
  notesEditor.innerHTML = localStorage.getItem(NOTES_KEY) || '';
  notesEditor.oninput = () => localStorage.setItem(NOTES_KEY, notesEditor.innerHTML);

  renderCalendar(shownYear);

  // Font size controls
  const fontButtons = document.querySelectorAll('.font-btn');
  fontButtons.forEach(btn => {
    btn.onclick = () => {
      const size = btn.dataset.size;
      document.documentElement.style.fontSize = size + '%';
      localStorage.setItem('fontSize', size);
    };
  });

  const savedFontSize = localStorage.getItem('fontSize');
  if (savedFontSize) {
    document.documentElement.style.fontSize = savedFontSize + '%';
  }

  settingsBtn.onclick = () => { settingsPage.style.display = 'block'; };
  closeSettings.onclick = (e) => { e.stopPropagation(); settingsPage.style.display = 'none'; };

  settingsPage.addEventListener('click', (e) => {
    if (e.target === settingsPage) {
      settingsPage.style.display = 'none';
    }
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && settingsPage.style.display === 'block') {
      settingsPage.style.display = 'none';
    }
  });

  monthToggleBtn.onclick = () => {
    if (monthViewIndex === null) {
      monthViewIndex = TODAY_MONTH;
      monthToggleBtn.textContent = 'ÔøΩ Year View';
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
    } else {
      monthViewIndex = null;
      monthToggleBtn.textContent = 'üìÖ Month View';
      yearEl.textContent = `Calendar ${shownYear}`;
    }
    renderCalendar(shownYear);
  };

  calEl.addEventListener('click', (e) => {
    const h = e.target.closest('h2[data-month]');
    if (!h) return;
    monthViewIndex = Number(h.dataset.month);
    monthToggleBtn.textContent = 'üìÖ Year View';
    yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
    renderCalendar(shownYear);
  });
  updateTime();
  setInterval(updateTime, 1000);

  const POMO_KEY = 'pomo_duration_minutes';
  const POMO_SECS_LOCAL_KEY = 'pomo_secs_local';
  const DEVICE_ID_KEY = 'device_id';
  let defaultPomoMinutes = Number(localStorage.getItem(POMO_KEY)) || 60;
  let secsStored = Number(localStorage.getItem(POMO_SECS_LOCAL_KEY));
  let secs = (!isNaN(secsStored) && secsStored > 0) ? secsStored : (defaultPomoMinutes * 60);
  let timer = null; // local display tick interval
  let anchorStartMs = null; // when (ms) the session started (server/local)
  let anchorRemaining = null; // secs remaining at start
  let isApplyingRemote = false;
  let deviceId = localStorage.getItem(DEVICE_ID_KEY);
  if (!deviceId) {
    deviceId = Math.random().toString(36).slice(2) + Date.now().toString(36);
    localStorage.setItem(DEVICE_ID_KEY, deviceId);
  }

  const pomoDurationInput = document.getElementById('pomoDurationInput');
  pomoDurationInput.value = defaultPomoMinutes;

  function updatePomoDisplay() {
    const minStr = String(Math.floor(secs/60)).padStart(2,'0');
    const secStr = String(secs%60).padStart(2,'0');
    const timeText = `${minStr}:${secStr}`;
    const pt = document.getElementById('pomoTime');
    const fpt = document.getElementById('floatingPomoTime');
    if(pt) pt.textContent = timeText;
    if(fpt) fpt.textContent = timeText;
  }

  function saveLocalSecs() {
    localStorage.setItem(POMO_SECS_LOCAL_KEY, String(secs));
  }

  function setStartButtons(running) {
    const ps = document.getElementById('pomoStart');
    const fps = document.getElementById('floatingPomoStart');
    if (ps) ps.textContent = running ? '‚è∏' : '‚ñ∂';
    if (fps) fps.textContent = running ? '‚è∏' : '‚ñ∂';
  }

  async function syncToCloud(runningFlag, extra = {}) {
    try {
      if (!window.auth || !auth.currentUser || !window.db || !window.doc || !window.setDoc || !window.serverTimestamp) return;
      const ref = doc(db, 'user_pomodoro', auth.currentUser.uid);
      await setDoc(ref, Object.assign({
        duration: defaultPomoMinutes,
        running: !!runningFlag,
        by: deviceId,
        updatedAt: serverTimestamp()
      }, extra), { merge: true });
    } catch (err) {
      console.error('[POMO] Cloud sync failed:', err);
    }
  }

  function clearLocalTimer() {
    if (timer) { clearInterval(timer); timer = null; }
  }

  function startLocalDisplayFromAnchor(remainAtStart, startedAtMs) {
    clearLocalTimer();
    anchorRemaining = remainAtStart;
    anchorStartMs = startedAtMs;
    setStartButtons(true);
    const tick = () => {
      const elapsed = Math.floor((Date.now() - anchorStartMs) / 1000);
      const left = Math.max(0, Math.round(anchorRemaining - elapsed));
      secs = left;
      updatePomoDisplay();
      saveLocalSecs();
      if (left <= 0) {
        clearLocalTimer();
        setStartButtons(false);
      }
    };
    tick();
    timer = setInterval(tick, 1000);
  }

  function togglePomo() {
    // Pause if currently running
    if (timer) {
      clearLocalTimer();
      setStartButtons(false);
      saveLocalSecs();
      // Persist pause with remaining seconds
      syncToCloud(false, { remaining: secs, startedAt: null });
      return;
    }
    // Start a new session from current remaining seconds
    const remainAtStart = secs;
    const startedNow = Date.now();
    startLocalDisplayFromAnchor(remainAtStart, startedNow);
    // Persist start (no per-second writes)
    syncToCloud(true, { remaining: remainAtStart, startedAt: serverTimestamp() });
  }

  function resetPomo() {
    clearLocalTimer();
    secs = defaultPomoMinutes * 60;
    updatePomoDisplay();
    setStartButtons(false);
    saveLocalSecs();
    syncToCloud(false, { remaining: secs, startedAt: null });
  }

  pomoDurationInput.onchange = () => {
    const val = Math.max(1, Number(pomoDurationInput.value) || 60);
    defaultPomoMinutes = val;
    localStorage.setItem(POMO_KEY, val);
    secs = val * 60;
    updatePomoDisplay();
    clearLocalTimer();
    setStartButtons(false);
    saveLocalSecs();
    syncToCloud(false, { remaining: secs, startedAt: null });
  };
  
  const pomoStartBtn = document.getElementById('pomoStart');
  const floatingPomoStartBtn = document.getElementById('floatingPomoStart');
  const pomoResetBtn = document.getElementById('pomoReset');
  const floatingPomoResetBtn = document.getElementById('floatingPomoReset');
  
  console.log('Pomodoro buttons:', { pomoStartBtn, floatingPomoStartBtn, pomoResetBtn, floatingPomoResetBtn });
  
  if (pomoStartBtn) {
    pomoStartBtn.onclick = togglePomo;
    pomoStartBtn.style.pointerEvents = 'auto';
  }
  if (floatingPomoStartBtn) {
    floatingPomoStartBtn.onclick = togglePomo;
    floatingPomoStartBtn.style.pointerEvents = 'auto';
  }
  if (pomoResetBtn) {
    pomoResetBtn.onclick = resetPomo;
    pomoResetBtn.style.pointerEvents = 'auto';
  }
  if (floatingPomoResetBtn) {
    floatingPomoResetBtn.onclick = resetPomo;
    floatingPomoResetBtn.style.pointerEvents = 'auto';
  }

  // Initialize pomodoro display
  updatePomoDisplay();

  // Expose handler for Firebase snapshot updates
  window.applyRemoteState = (data) => {
    try {
      if (!data) return;
      if (data.by && data.by === deviceId) return; // ignore self-originating updates

      // Update duration if changed remotely
      if (typeof data.duration === 'number' && data.duration > 0 && data.duration !== defaultPomoMinutes) {
        defaultPomoMinutes = data.duration;
        localStorage.setItem(POMO_KEY, String(defaultPomoMinutes));
        if (pomoDurationInput) pomoDurationInput.value = defaultPomoMinutes;
      }

      const running = !!data.running;
      const remaining = (typeof data.remaining === 'number' && data.remaining >= 0)
        ? data.remaining
        : (typeof data.secs === 'number' ? data.secs : defaultPomoMinutes * 60);

      if (running && data.startedAt && typeof data.startedAt.toMillis === 'function') {
        const startedAtMs = data.startedAt.toMillis();
        startLocalDisplayFromAnchor(remaining, startedAtMs);
      } else if (running) {
        // Fallback if startedAt missing: just start from remaining now
        startLocalDisplayFromAnchor(remaining, Date.now());
      } else {
        clearLocalTimer();
        secs = remaining;
        updatePomoDisplay();
        setStartButtons(false);
      }
    } catch (e) {
      console.error('[POMO] applyRemoteState error:', e);
    }
  };

  document.getElementById('prev').onclick = () => {
    if (monthViewIndex !== null) {
      monthViewIndex = (monthViewIndex + 11) % 12;
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
      renderCalendar(shownYear);
    } else {
      renderCalendar(--shownYear);
    }
  };
  document.getElementById('next').onclick = () => {
    if (monthViewIndex !== null) {
      monthViewIndex = (monthViewIndex + 1) % 12;
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
      renderCalendar(shownYear);
    } else {
      renderCalendar(++shownYear);
    }
  };
  todayBtn.onclick = () => {
    if (monthViewIndex === null) {
      shownYear = CURRENT_YEAR;
      renderCalendar(shownYear);
      return;
    }
    shownYear = CURRENT_YEAR;
    monthViewIndex = TODAY_MONTH;
    monthToggleBtn.textContent = 'üóì Year';
    yearEl.textContent = `${MONTHS[TODAY_MONTH]} ${shownYear}`;
    renderCalendar(shownYear);
  };

  const themes = [
    { name: 'üçé macOS', class: '' },
    { name: 'üåô Dark', class: 'dark' },
    { name: 'üåä Ocean', class: 'theme-ocean' },
    { name: 'üå≤ Forest', class: 'theme-forest' },
    { name: 'üåÖ Solar', class: 'theme-solar' },
    { name: 'üíé Glass', class: 'theme-glass' }
  ];
  let themeIndex = 0;
  themeBtn.onclick = () => {
    document.body.classList.remove('dark','theme-ocean','theme-forest','theme-solar','theme-glass');
    themeIndex = (themeIndex + 1) % themes.length;
    const t = themes[themeIndex];
    if (t.class) document.body.classList.add(t.class);
    themeBtn.textContent = t.name;
  };

  // =========================
  // APP LAUNCHER & DRAWER
  // =========================
  const appLauncherBtn = document.getElementById('appLauncherBtn');
  const appDrawer = document.getElementById('appDrawer');
  const toggleCalendarApp = document.getElementById('toggleCalendarApp');
  const toggleClockApp = document.getElementById('toggleClockApp');
  const togglePomoApp = document.getElementById('togglePomoApp');
  const toggleTodoApp = document.getElementById('toggleTodoApp');
  const toggleEventsApp = document.getElementById('toggleEventsApp');
  const toggleNotesApp = document.getElementById('toggleNotesApp');
  const toggleCanvasManagerApp = document.getElementById('toggleCanvasManagerApp');

  // Open/close app drawer
  if (appLauncherBtn) {
    appLauncherBtn.onclick = () => {
      if (appDrawer.style.display === 'block') {
        appDrawer.style.display = 'none';
      } else {
        appDrawer.style.display = 'block';
      }
    };
  }

  if (appDrawer) {
    appDrawer.onclick = (e) => {
      if (e.target === appDrawer) {
        appDrawer.style.display = 'none';
      }
    };
  }

  // Close drawer on Escape
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && appDrawer.style.display === 'block') {
      appDrawer.style.display = 'none';
    }
  });

  // =========================
  // WIDGET VISIBILITY + DRAG
  // =========================
  const clock = document.getElementById('analogClock');
  const closeClockBtn = document.getElementById('closeClockBtn');
  const floatingPomo = document.getElementById('floatingPomo');
  const closePomoBtn = document.getElementById('closePomoBtn');
  const floatingTodo = document.getElementById('floatingTodo');
  const closeTodoBtn = document.getElementById('closeTodoBtn');
  const floatingEvents = document.getElementById('floatingEvents');
  const closeEventsBtn = document.getElementById('closeEventsBtn');
  const floatingCalendar = document.getElementById('floatingCalendar');
  const closeCalendarBtn = document.getElementById('closeCalendarBtn');
  const floatingNotes = document.getElementById('floatingNotes');
  const closeNotesBtn = document.getElementById('closeNotesBtn');
  const canvasManager = document.getElementById('canvasManager');
  const closeCanvasManagerBtn = document.getElementById('closeCanvasManagerBtn');

  const CLOCK_VIS_KEY = 'show_analog_clock';
  const POMO_VIS_KEY = 'show_floating_pomo';
  const TODO_VIS_KEY = 'show_floating_todo';
  const EVENTS_VIS_KEY = 'show_floating_events';
  const CALENDAR_VIS_KEY = 'show_floating_calendar';
  const NOTES_VIS_KEY = 'show_floating_notes';
  const CANVAS_TABS_VIS_KEY = 'show_canvas_tabs';

  function updateCalendarVisibility(visible) {
    if (!floatingCalendar) return;
    floatingCalendar.style.display = visible ? 'flex' : 'none';
    if (toggleCalendarApp) toggleCalendarApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateCalendarVisibility = updateCalendarVisibility;

  function updateClockVisibility(visible) {
    if (!clock) return;
    clock.style.display = visible ? 'block' : 'none';
    if (toggleClockApp) toggleClockApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }

  function updatePomoVisibility(visible) {
    if (!floatingPomo) return;
    floatingPomo.style.display = visible ? 'block' : 'none';
    if (togglePomoApp) togglePomoApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }

  function updateTodoVisibility(visible) {
    if (!floatingTodo) return;
    floatingTodo.style.display = visible ? 'flex' : 'none';
    if (toggleTodoApp) toggleTodoApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }

  function updateEventsVisibility(visible) {
    if (!floatingEvents) return;
    floatingEvents.style.display = visible ? 'flex' : 'none';
    if (toggleEventsApp) toggleEventsApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateEventsVisibility = updateEventsVisibility;

  function updateNotesVisibility(visible) {
    if (!floatingNotes) return;
    floatingNotes.style.display = visible ? 'flex' : 'none';
    if (toggleNotesApp) toggleNotesApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateNotesVisibility = updateNotesVisibility;

  function updateCanvasManagerVisibility(visible) {
    if (!canvasManager) return;
    canvasManager.style.display = visible ? 'flex' : 'none';
    if (toggleCanvasManagerApp) toggleCanvasManagerApp.classList.toggle('active', !!visible);
    if (window.saveCurrentCanvas) window.saveCurrentCanvas();
  }
  window.updateCanvasManagerVisibility = updateCanvasManagerVisibility;

  // Widget visibility initialization is now handled by canvas manager

  // App toggle click handlers
  if (toggleCalendarApp) {
    toggleCalendarApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingCalendar && floatingCalendar.style.display !== 'none';
      updateCalendarVisibility(!isVisible);
    };
  }

  if (toggleClockApp) {
    toggleClockApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = clock && clock.style.display !== 'none';
      updateClockVisibility(!isVisible);
    };
  }
  if (togglePomoApp) {
    togglePomoApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingPomo && floatingPomo.style.display !== 'none';
      updatePomoVisibility(!isVisible);
    };
  }
  if (toggleTodoApp) {
    toggleTodoApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingTodo && floatingTodo.style.display !== 'none';
      updateTodoVisibility(!isVisible);
    };
  }
  if (toggleEventsApp) {
    toggleEventsApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingEvents && floatingEvents.style.display !== 'none';
      updateEventsVisibility(!isVisible);
    };
  }
  if (toggleNotesApp) {
    toggleNotesApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingNotes && floatingNotes.style.display !== 'none';
      updateNotesVisibility(!isVisible);
    };
  }
  if (toggleCanvasManagerApp) {
    toggleCanvasManagerApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = canvasManager && canvasManager.style.display !== 'none';
      updateCanvasManagerVisibility(!isVisible);
    };
  }

  // Close button handlers
  if (closeCalendarBtn) closeCalendarBtn.onclick = (e) => { e.stopPropagation(); updateCalendarVisibility(false); };
  if (closeClockBtn) closeClockBtn.onclick = (e) => { e.stopPropagation(); updateClockVisibility(false); };
  if (closePomoBtn) closePomoBtn.onclick = (e) => { e.stopPropagation(); updatePomoVisibility(false); };
  if (closeTodoBtn) closeTodoBtn.onclick = (e) => { e.stopPropagation(); updateTodoVisibility(false); };
  if (closeEventsBtn) closeEventsBtn.onclick = (e) => { e.stopPropagation(); updateEventsVisibility(false); };
  if (closeNotesBtn) closeNotesBtn.onclick = (e) => { e.stopPropagation(); updateNotesVisibility(false); };
  if (closeCanvasManagerBtn) closeCanvasManagerBtn.onclick = (e) => { e.stopPropagation(); updateCanvasManagerVisibility(false); };

  // =========================
  // CALCULATOR WIDGET
  // =========================
  const floatingCalculator = document.getElementById('floatingCalculator');
  const calcDisplay = document.getElementById('calcDisplay');
  const calcButtons = document.querySelectorAll('.calc-btn');
  const closeCalculatorBtn = document.getElementById('closeCalculatorBtn');
  const toggleCalculatorApp = document.getElementById('toggleCalculatorApp');
  const CALCULATOR_VIS_KEY = 'show_calculator';

  let calcExpression = '';
  let calcResult = '0';

  function updateCalculatorVisibility(visible) {
    if (!floatingCalculator) return;
    floatingCalculator.style.display = visible ? 'flex' : 'none';
    localStorage.setItem(CALCULATOR_VIS_KEY, String(visible));
    if (toggleCalculatorApp) toggleCalculatorApp.classList.toggle('active', !!visible);
  }

  function updateCalcDisplay(value) {
    if (calcDisplay) calcDisplay.textContent = value;
  }

  function handleCalculatorInput(input) {
    if (input === 'C') {
      calcExpression = '';
      calcResult = '0';
      updateCalcDisplay('0');
    } else if (input === '=') {
      try {
        // Replace display symbols with JS operators
        const expr = calcExpression.replace(/√ó/g, '*').replace(/√∑/g, '/').replace(/‚àí/g, '-');
        const result = eval(expr);
        calcResult = result.toString();
        updateCalcDisplay(calcResult);
        calcExpression = calcResult;
      } catch (e) {
        updateCalcDisplay('Error');
        calcExpression = '';
        calcResult = '0';
      }
    } else {
      if (calcExpression === '0' || calcExpression === calcResult) {
        calcExpression = input;
      } else {
        calcExpression += input;
      }
      updateCalcDisplay(calcExpression);
    }
  }

  calcButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const value = btn.dataset.calc;
      if (value) handleCalculatorInput(value);
    });
  });

  // Keyboard support
  document.addEventListener('keydown', (e) => {
    // Don't intercept keys if user is typing in an input field or contenteditable
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
      return;
    }
    
    if (floatingCalculator.style.display !== 'flex') return;
    const key = e.key;
    if (/[0-9\+\-\*\/\.\(\)]/.test(key)) {
      e.preventDefault();
      handleCalculatorInput(key);
    } else if (key === 'Enter') {
      e.preventDefault();
      handleCalculatorInput('=');
    } else if (key === 'Escape' || key === 'Backspace') {
      e.preventDefault();
      handleCalculatorInput('C');
    }
  });

  if (toggleCalculatorApp) {
    toggleCalculatorApp.onclick = (e) => {
      e.stopPropagation();
      const isVisible = floatingCalculator && floatingCalculator.style.display !== 'none';
      updateCalculatorVisibility(!isVisible);
    };
  }

  if (closeCalculatorBtn) {
    closeCalculatorBtn.onclick = (e) => {
      e.stopPropagation();
      updateCalculatorVisibility(false);
    };
  }

  // Init calculator visibility
  (function initCalculatorVisibility() {
    if (toggleCalculatorApp) {
      const savedCalc = localStorage.getItem(CALCULATOR_VIS_KEY);
      const showCalc = savedCalc === null ? false : savedCalc !== 'false';
      toggleCalculatorApp.classList.toggle('active', showCalc);
      if (showCalc) floatingCalculator.style.display = 'flex';
    }
  })();

  // =========================
  // CANVAS WIDGET POSITIONING
  // =========================
  let highestZIndex = 1000;
  
  // Bring widget to front when clicked
  function bringToFront(el) {
    if (!el) return;
    highestZIndex++;
    el.style.zIndex = highestZIndex;
  }
  
  function constrainWidgetToViewport(el) {
    if (!el) return;
    // In canvas mode, widgets can be placed anywhere
    // Only ensure they don't go negative
    let left = parseFloat(el.style.left) || 0;
    let top = parseFloat(el.style.top) || 0;
    
    if (left < 0) left = 0;
    if (top < 0) top = 0;
    
    el.style.left = left + 'px';
    el.style.top = top + 'px';
  }
  
  function saveWidgetPosition(el, id) {
    // Save to current canvas
    saveCurrentCanvasPositions();
  }
  
  function restoreWidgetPosition(el, id) {
    // Positions are loaded via loadCanvasPositions
    // This function is kept for compatibility
  }
  
  function adjustAllWidgetsToViewport() {
    const widgets = [
      { el: clock, id: 'analogClock' },
      { el: floatingPomo, id: 'floatingPomo' },
      { el: floatingTodo, id: 'floatingTodo' },
      { el: floatingEvents, id: 'floatingEvents' },
      { el: floatingCalculator, id: 'floatingCalculator' },
      { el: floatingCalendar, id: 'floatingCalendar' },
      { el: floatingNotes, id: 'floatingNotes' }
    ];
    
    widgets.forEach(({ el, id }) => {
      if (el && el.style.left && el.style.top) {
        constrainWidgetToViewport(el);
        saveWidgetPosition(el, id);
      }
    });
  }

  // Draggable (mouse + touch) - only from header
  function makeDraggable(el, handleSelector = null, widgetId = null) {
    if (!el) return;
    let isDragging = false;
    let startX, startY, startLeft, startTop;

    const getPoint = (evt) => {
      if (evt.touches && evt.touches.length) return { x: evt.touches[0].clientX, y: evt.touches[0].clientY };
      return { x: evt.clientX, y: evt.clientY };
    };

    const startDrag = (e) => {
      // If handleSelector is provided, only allow drag from that element
      if (handleSelector) {
        const handle = el.querySelector(handleSelector);
        if (!handle || !handle.contains(e.target)) return;
      }
      
      // prevent dragging when pressing inner buttons or input fields
      if (e.target && (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
      
      // Bring to front when starting to drag
      bringToFront(el);
      
      isDragging = true;
      const p = getPoint(e);
      startX = p.x; startY = p.y;
      startLeft = el.offsetLeft; startTop = el.offsetTop;
      el.style.right = 'auto';
      el.style.bottom = 'auto';
      // Prevent scrolling on touch devices only when actually dragging from valid area
      if (e.type === 'touchstart') {
        e.preventDefault();
      }
    };

    const moveDrag = (e) => {
      if (!isDragging) return;
      // Prevent scrolling while dragging on touch devices
      if (e.type === 'touchmove') {
        e.preventDefault();
      }
      const p = getPoint(e);
      el.style.left = startLeft + (p.x - startX) + 'px';
      el.style.top = startTop + (p.y - startY) + 'px';
    };

    const endDrag = () => {
      if (!isDragging) return;
      isDragging = false;
      constrainWidgetToViewport(el);
      if (widgetId) saveWidgetPosition(el, widgetId);
    };

    el.addEventListener('mousedown', startDrag);
    el.addEventListener('touchstart', startDrag, { passive: false });
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('touchmove', moveDrag, { passive: false });
    window.addEventListener('mouseup', endDrag);
    window.addEventListener('touchend', endDrag);
  }

  // Make widgets resizable
  function makeResizable(el, widgetId = null) {
    if (!el) return;
    const handle = el.querySelector('.resize-handle');
    if (!handle) return;

    let isResizing = false;
    let startX, startY, startWidth, startHeight;

    const getPoint = (evt) => {
      if (evt.touches && evt.touches.length) return { x: evt.touches[0].clientX, y: evt.touches[0].clientY };
      return { x: evt.clientX, y: evt.clientY };
    };

    const startResize = (e) => {
      e.stopPropagation();
      e.preventDefault();
      isResizing = true;
      const p = getPoint(e);
      startX = p.x;
      startY = p.y;
      startWidth = el.offsetWidth;
      startHeight = el.offsetHeight;
      document.body.style.cursor = 'nwse-resize';
      document.body.style.userSelect = 'none';
    };

    const moveResize = (e) => {
      if (!isResizing) return;
      e.preventDefault();
      const p = getPoint(e);
      const newWidth = Math.max(250, startWidth + (p.x - startX));
      const newHeight = Math.max(200, startHeight + (p.y - startY));
      el.style.width = newWidth + 'px';
      el.style.height = newHeight + 'px';
    };

    const endResize = () => {
      if (!isResizing) return;
      isResizing = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
      if (widgetId) saveWidgetPosition(el, widgetId);
    };

    handle.addEventListener('mousedown', startResize);
    handle.addEventListener('touchstart', startResize, { passive: false });
    window.addEventListener('mousemove', moveResize);
    window.addEventListener('touchmove', moveResize, { passive: false });
    window.addEventListener('mouseup', endResize);
    window.addEventListener('touchend', endResize);
  }

  // Restore saved positions - commented out, canvas manager handles this
  // restoreWidgetPosition(clock, 'analogClock');
  // restoreWidgetPosition(floatingPomo, 'floatingPomo');
  // restoreWidgetPosition(floatingTodo, 'floatingTodo');
  // restoreWidgetPosition(floatingEvents, 'floatingEvents');
  // restoreWidgetPosition(floatingCalculator, 'floatingCalculator');
  // restoreWidgetPosition(floatingCalendar, 'floatingCalendar');
  // restoreWidgetPosition(floatingNotes, 'floatingNotes');

  // Setup draggable and resizable functionality
  makeDraggable(clock, null, 'analogClock');
  makeDraggable(floatingPomo, null, 'floatingPomo');
  makeDraggable(floatingTodo, '.todo-header', 'floatingTodo');
  makeDraggable(floatingEvents, '.events-header', 'floatingEvents');
  makeDraggable(floatingCalculator, '.calc-header', 'floatingCalculator');
  makeDraggable(floatingCalendar, '.calendar-header', 'floatingCalendar');
  makeDraggable(floatingNotes, '.notes-header', 'floatingNotes');
  makeDraggable(canvasManager, '.canvas-manager-header', 'canvasManager');

  // Make widgets resizable
  makeResizable(floatingTodo, 'floatingTodo');
  makeResizable(floatingEvents, 'floatingEvents');
  makeResizable(floatingCalculator, 'floatingCalculator');
  makeResizable(floatingCalendar, 'floatingCalendar');
  makeResizable(floatingNotes, 'floatingNotes');
  makeResizable(canvasManager, 'canvasManager');

  // Add click handlers to bring widgets to front
  const allWidgets = [clock, floatingPomo, floatingTodo, floatingEvents, floatingCalculator, floatingCalendar, floatingNotes, canvasManager];
  allWidgets.forEach(widget => {
    if (widget) {
      widget.addEventListener('mousedown', () => bringToFront(widget));
      widget.addEventListener('touchstart', () => bringToFront(widget));
    }
  });

  // Handle viewport resize and orientation change
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(adjustAllWidgetsToViewport, 200);
  });
  
  window.addEventListener('orientationchange', () => {
    setTimeout(adjustAllWidgetsToViewport, 300);
  });

  // =========================
  // CANVAS PANNING (Space + Drag)
  // =========================
  const canvasWorkspace = document.getElementById('canvasWorkspace');
  const canvasHint = document.getElementById('canvasHint');
  let isPanning = false;
  let panStartX = 0;
  let panStartY = 0;
  let scrollStartX = 0;
  let scrollStartY = 0;
  let spacePressed = false;

  // Auto-hide hint after 5 seconds
  if (canvasHint) {
    setTimeout(() => {
      canvasHint.classList.add('hidden');
    }, 5000);
  }

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && !e.repeat && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA' && !e.target.isContentEditable) {
      e.preventDefault();
      spacePressed = true;
      canvasWorkspace.style.cursor = 'grab';
    }
  });

  window.addEventListener('keyup', (e) => {
    if (e.code === 'Space') {
      spacePressed = false;
      canvasWorkspace.style.cursor = '';
      if (isPanning) {
        isPanning = false;
        canvasWorkspace.classList.remove('panning');
      }
    }
  });

  canvasWorkspace.addEventListener('mousedown', (e) => {
    // Pan with Space+LMB or Middle Mouse Button
    if ((spacePressed && e.button === 0) || e.button === 1) {
      e.preventDefault();
      isPanning = true;
      canvasWorkspace.classList.add('panning');
      panStartX = e.clientX;
      panStartY = e.clientY;
      scrollStartX = canvasWorkspace.scrollLeft;
      scrollStartY = canvasWorkspace.scrollTop;
    }
  });

  window.addEventListener('mousemove', (e) => {
    if (isPanning) {
      const deltaX = panStartX - e.clientX;
      const deltaY = panStartY - e.clientY;
      canvasWorkspace.scrollLeft = scrollStartX + deltaX;
      canvasWorkspace.scrollTop = scrollStartY + deltaY;
    }
  });

  window.addEventListener('mouseup', () => {
    if (isPanning) {
      isPanning = false;
      canvasWorkspace.classList.remove('panning');
    }
  });

  // =========================
  // ANALOG CLOCK TICK LOGIC
  // =========================
  const hourHand = document.getElementById('hourHand');
  const minuteHand = document.getElementById('minuteHand');
  const secondHand = document.getElementById('secondHand');
  const clockDay = document.getElementById('clockDay');
  const clockNum = document.getElementById('clockNum');

  function updateAnalogClock() {
    const now = new Date();
    const sec = now.getSeconds();
    const min = now.getMinutes();
    const hr = now.getHours() % 12;

    if (hourHand) hourHand.style.transform = `translateX(-50%) rotate(${hr * 30 + min * 0.5}deg)`;
    if (minuteHand) minuteHand.style.transform = `translateX(-50%) rotate(${min * 6}deg)`;
    if (secondHand) secondHand.style.transform = `translateX(-50%) rotate(${sec * 6}deg)`;

    if (clockDay) clockDay.textContent = now.toLocaleDateString(undefined, { weekday: 'short' });
    if (clockNum) clockNum.textContent = now.getDate();
  }

  // Align ticks to the next second boundary for accuracy
  (function startClockTicks() {
    updateAnalogClock();
    const now = new Date();
    const msToNextSecond = 1000 - now.getMilliseconds();
    setTimeout(() => {
      updateAnalogClock();
      setInterval(updateAnalogClock, 1000);
    }, msToNextSecond);
  })();

  // =========================
  // TODO LIST LOGIC
  // =========================
  let todos = [];
  const todoInput = document.getElementById('todoInput');
  const todoAddBtn = document.getElementById('todoAddBtn');
  const todoList = document.getElementById('todoList');

  function renderTodos() {
    if (!todoList) return;
    todoList.innerHTML = '';
    todos.forEach((todo, index) => {
      const item = document.createElement('div');
      item.className = 'todo-item';
      item.innerHTML = `
        <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} data-index="${index}" />
        <span class="todo-text ${todo.completed ? 'completed' : ''}">${todo.text}</span>
        <button class="todo-delete" data-index="${index}">‚úï</button>
      `;
      todoList.appendChild(item);
    });

    // Event listeners
    todoList.querySelectorAll('.todo-checkbox').forEach(cb => {
      cb.onchange = (e) => {
        const idx = Number(e.target.dataset.index);
        todos[idx].completed = e.target.checked;
        renderTodos();
        syncTodosToCloud();
      };
    });
    todoList.querySelectorAll('.todo-delete').forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        const idx = Number(e.currentTarget.dataset.index);
        todos.splice(idx, 1);
        renderTodos();
        syncTodosToCloud();
      };
    });
  }

  function addTodo() {
    if (!todoInput) return;
    const text = todoInput.value.trim();
    if (!text) return;
    todos.push({ text, completed: false, id: Date.now() + Math.random() });
    todoInput.value = '';
    renderTodos();
    syncTodosToCloud();
  }

  async function syncTodosToCloud() {
    try {
      if (!window.auth || !auth.currentUser || !window.db || !window.doc || !window.setDoc || !window.serverTimestamp) return;
      const ref = doc(db, 'user_todos', auth.currentUser.uid);
      await setDoc(ref, {
        items: todos,
        by: deviceId,
        updatedAt: serverTimestamp()
      }, { merge: true });
    } catch (err) {
      console.error('[TODO] Cloud sync failed:', err);
    }
  }

  window.applyRemoteTodos = (data) => {
    try {
      if (!data) {
        console.log('[TODO] No data received');
        return;
      }
      console.log('[TODO] Received data:', data);
      // Don't skip if from same device - we need to load on page refresh
      // if (data.by && data.by === deviceId) return;
      if (Array.isArray(data.items)) {
        todos = data.items;
        console.log('[TODO] Loaded', todos.length, 'todos from Firebase');
        renderTodos();
      } else {
        console.warn('[TODO] data.items is not an array:', data.items);
      }
    } catch (e) {
      console.error('[TODO] applyRemoteTodos error:', e);
    }
  };

  if (todoAddBtn) todoAddBtn.onclick = addTodo;
  if (todoInput) {
    todoInput.onkeypress = (e) => {
      if (e.key === 'Enter') addTodo();
    };
  }

  renderTodos();

  // =========================
  // EVENTS LOGIC
  // =========================
  const eventDateInput = document.getElementById('eventDateInput');
  const eventTextInput = document.getElementById('eventTextInput');
  const eventAddBtn = document.getElementById('eventAddBtn');
  const eventsList = document.getElementById('eventsList');
  const selectedDateBadge = document.getElementById('selectedDateBadge');
  const showAllEventsBtn = document.getElementById('showAllEventsBtn');

  // Set today as default date
  if (eventDateInput) {
    const today = new Date();
    eventDateInput.value = today.toISOString().split('T')[0];
  }

  // Click date badge or button to show all events
  if (selectedDateBadge) {
    selectedDateBadge.onclick = () => {
      selectedCalendarDate = null;
      renderEvents(null);
    };
  }
  if (showAllEventsBtn) {
    showAllEventsBtn.onclick = () => {
      selectedCalendarDate = null;
      renderEvents(null);
    };
  }

  function renderEvents(filterDate = null) {
    if (!eventsList) return;
    eventsList.innerHTML = '';
    
    // Filter events by date if specified
    const filteredEvents = filterDate 
      ? events.filter(e => e.date === filterDate)
      : events;

    // Sort events by date (newest first)
    filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));

    filteredEvents.forEach((event) => {
      const actualIndex = events.findIndex(e => e.id === event.id);
      const item = document.createElement('div');
      item.className = 'event-item';
      const dateObj = new Date(event.date + 'T00:00:00');
      const dateStr = dateObj.toLocaleDateString(undefined, { 
        weekday: 'short', 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
      item.innerHTML = `
        <div class="event-date-badge">${dateStr}</div>
        <div class="event-text">${event.text}</div>
        <button class="event-delete" data-index="${actualIndex}">‚úï</button>
      `;
      eventsList.appendChild(item);
    });

    // Event listeners
    eventsList.querySelectorAll('.event-delete').forEach(btn => {
      btn.onclick = (e) => {
        e.stopPropagation();
        const idx = Number(e.currentTarget.dataset.index);
        events.splice(idx, 1);
        renderEvents(selectedCalendarDate);
        renderCalendar(shownYear);
        syncEventsToCloud();
      };
    });

    // Update selected date badge and show all button
    if (selectedDateBadge) {
      if (filterDate) {
        const dateObj = new Date(filterDate + 'T00:00:00');
        selectedDateBadge.textContent = 'üìÜ ' + dateObj.toLocaleDateString(undefined, { 
          month: 'short', 
          day: 'numeric' 
        });
        selectedDateBadge.style.display = 'inline-block';
        if (showAllEventsBtn) showAllEventsBtn.style.display = 'inline-block';
      } else {
        selectedDateBadge.textContent = '';
        selectedDateBadge.style.display = 'none';
        if (showAllEventsBtn) showAllEventsBtn.style.display = 'none';
      }
    }
  }
  window.renderEvents = renderEvents;

  function addEvent() {
    if (!eventDateInput || !eventTextInput) return;
    const date = eventDateInput.value;
    const text = eventTextInput.value.trim();
    if (!date || !text) return;
    
    events.push({ 
      date, 
      text, 
      id: Date.now() + Math.random() 
    });
    
    eventTextInput.value = '';
    // Keep current filter (if any) after adding
    renderEvents(selectedCalendarDate);
    renderCalendar(shownYear);
    syncEventsToCloud();
  }

  async function syncEventsToCloud() {
    try {
      if (!window.auth || !auth.currentUser || !window.db || !window.doc || !window.setDoc || !window.serverTimestamp) return;
      const ref = doc(db, 'user_events', auth.currentUser.uid);
      await setDoc(ref, {
        items: events,
        by: deviceId,
        updatedAt: serverTimestamp()
      }, { merge: true });
    } catch (err) {
      console.error('[EVENTS] Cloud sync failed:', err);
    }
  }

  window.applyRemoteEvents = (data) => {
    try {
      if (!data) {
        console.log('[EVENTS] No data received');
        return;
      }
      console.log('[EVENTS] Received data:', data);
      // Don't skip if from same device - we need to load on page refresh
      // if (data.by && data.by === deviceId) return;
      if (Array.isArray(data.items)) {
        events = data.items;
        console.log('[EVENTS] Loaded', events.length, 'events from Firebase');
        // Preserve current filter when receiving remote updates
        renderEvents(selectedCalendarDate);
        renderCalendar(shownYear);
      } else {
        console.warn('[EVENTS] data.items is not an array:', data.items);
      }
    } catch (e) {
      console.error('[EVENTS] applyRemoteEvents error:', e);
    }
  };

  if (eventAddBtn) eventAddBtn.onclick = addEvent;
  if (eventTextInput) {
    eventTextInput.onkeypress = (e) => {
      if (e.key === 'Enter') addEvent();
    };
  }

  // Show all events initially (no filter)
  renderEvents(null);
</script>

<!-- Firebase Module -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
  import {
    getAuth, setPersistence, browserLocalPersistence, signOut, onAuthStateChanged,
    signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail,
    signInWithCustomToken
  } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js';
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

  // Firebase config
  const firebaseConfig = {
    apiKey: 'AIzaSyA05Vxw3kSZ8xAHUBppMh5p7VwBZ-47kmM',
    authDomain: 'calendar-599ac.firebaseapp.com',
    projectId: 'calendar-599ac',
    storageBucket: 'calendar-599ac.firebasestorage.app',
    messagingSenderId: '89812638572',
    appId: '1:89812638572:web:f02d7309367576a619b149'
  };

  // Initialize
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Expose for non-module script usage
  window.auth = auth;
  window.db = db;
  window.doc = doc;
  window.setDoc = setDoc;
  window.serverTimestamp = serverTimestamp;

  // UI elements
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const resetPasswordBtn = document.getElementById('resetPasswordBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const loggedOutUI = document.getElementById('loggedOutUI');
  const loggedInUI = document.getElementById('loggedInUI');
  const userEmailDisplay = document.getElementById('userEmailDisplay');
  const syncStatus = document.getElementById('syncStatus');
  const notesEditor = document.getElementById('notesEditor');

  const NOTES_KEY_CLOUD = 'calendar_notes_rich';

  const setSyncStatus = (text) => { if (syncStatus) syncStatus.textContent = text; };

  // Auth actions
  const handleAuthError = (err) => {
    console.error(err);
    let msg = 'Authentication failed';
    if (err.code === 'auth/wrong-password') msg = 'Wrong password';
    if (err.code === 'auth/user-not-found') msg = 'User not found';
    if (err.code === 'auth/email-already-in-use') msg = 'Email already registered';
    if (err.code === 'auth/invalid-email') msg = 'Invalid email address';
    if (err.code === 'auth/weak-password') msg = 'Password is too weak';
    setSyncStatus('Error: ' + msg);
  };

  if (loginBtn) loginBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) return setSyncStatus('Enter email & password');
    try {
      setSyncStatus('Logging in...');
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) { handleAuthError(err); }
  };

  if (signupBtn) signupBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) return setSyncStatus('Enter email & password');
    try {
      setSyncStatus('Creating account...');
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) { handleAuthError(err); }
  };

  if (resetPasswordBtn) resetPasswordBtn.onclick = async () => {
    const email = emailInput.value.trim();
    if (!email) return setSyncStatus('Enter your email first');
    try {
      setSyncStatus('Sending reset link...');
      await sendPasswordResetEmail(auth, email);
      setSyncStatus('Check your inbox for reset link');
    } catch (err) { handleAuthError(err); }
  };

  if (logoutBtn) logoutBtn.onclick = () => signOut(auth);

  // Persist auth
  (async function initAuth() {
    try {
      await setPersistence(auth, browserLocalPersistence);
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      }
    } catch (err) {
      console.error('Init Auth error', err);
    }
  })();

  // Realtime sync
  let unsubscribeNote = null;
  let unsubscribePomo = null;
  let unsubscribeEvents = null;
  let unsubscribeTodo = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      if (loggedOutUI) loggedOutUI.style.display = 'none';
      if (loggedInUI) loggedInUI.style.display = 'block';
      if (userEmailDisplay) userEmailDisplay.textContent = `Logged in as: ${user.email}`;
      setSyncStatus('Signed in ‚Äî syncing');

      // Notes listener
      const noteRef = doc(db, 'user_notes', user.uid);
      if (unsubscribeNote) unsubscribeNote();
      unsubscribeNote = onSnapshot(noteRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (document.activeElement !== notesEditor && notesEditor) {
            notesEditor.innerHTML = data.content || '';
          }
          setSyncStatus('Cloud Synced');
        } else {
          const local = localStorage.getItem(NOTES_KEY_CLOUD) || '';
          setDoc(noteRef, { content: local, updatedAt: serverTimestamp() })
            .then(() => setSyncStatus('Synced (Started Cloud)'))
            .catch(() => setSyncStatus('Sync Error'));
        }
      }, (err) => {
        console.error('Firestore Error:', err);
        setSyncStatus('Sync Error: Permission Denied');
      });

      // Pomodoro listener
      const pomoRef = doc(db, 'user_pomodoro', user.uid);
      if (unsubscribePomo) unsubscribePomo();
      unsubscribePomo = onSnapshot(pomoRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          if (window.applyRemoteState) {
            window.applyRemoteState(data);
          }
        } else {
          const localDuration = Number(localStorage.getItem('pomo_duration_minutes')) || 60;
          const localSecs = Number(localStorage.getItem('pomo_secs_local')) || (localDuration * 60);
          setDoc(pomoRef, {
            remaining: localSecs,
            duration: localDuration,
            running: false,
            startedAt: null,
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial pomo set error:', err));
        }
      }, (err) => {
        console.error('Pomodoro listener error:', err);
      });

      // Todo listener
      const todoRef = doc(db, 'user_todos', user.uid);
      if (unsubscribeTodo) unsubscribeTodo();
      console.log('[TODO] Setting up Firebase listener for user:', user.uid);
      unsubscribeTodo = onSnapshot(todoRef, (snap) => {
        console.log('[TODO] Snapshot received, exists:', snap.exists());
        if (snap.exists()) {
          const data = snap.data();
          console.log('[TODO] Snapshot data:', data);
          if (window.applyRemoteTodos) {
            window.applyRemoteTodos(data);
          }
        } else {
          console.log('[TODO] No todos document found, creating empty one');
          setDoc(todoRef, {
            items: [],
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial todo set error:', err));
        }
      }, (err) => {
        console.error('[TODO] Listener error:', err);
        console.error('[TODO] Error code:', err.code);
        console.error('[TODO] Error message:', err.message);
      });

      // Events listener
      const eventsRef = doc(db, 'user_events', user.uid);
      if (unsubscribeEvents) unsubscribeEvents();
      console.log('[EVENTS] Setting up Firebase listener for user:', user.uid);
      unsubscribeEvents = onSnapshot(eventsRef, (snap) => {
        console.log('[EVENTS] Snapshot received, exists:', snap.exists());
        if (snap.exists()) {
          const data = snap.data();
          console.log('[EVENTS] Snapshot data:', data);
          if (window.applyRemoteEvents) {
            window.applyRemoteEvents(data);
          }
        } else {
          console.log('[EVENTS] No events document found, creating empty one');
          setDoc(eventsRef, {
            items: [],
            updatedAt: serverTimestamp()
          }).catch(err => console.error('[FIREBASE] Initial events set error:', err));
        }
      }, (err) => {
        console.error('[EVENTS] Listener error:', err);
        console.error('[EVENTS] Error code:', err.code);
        console.error('[EVENTS] Error message:', err.message);
      });

    } else {
      if (loggedOutUI) loggedOutUI.style.display = 'block';
      if (loggedInUI) loggedInUI.style.display = 'none';
      setSyncStatus('Not signed in (Local mode)');
      if (unsubscribeNote) { unsubscribeNote(); unsubscribeNote = null; }
      if (unsubscribePomo) { unsubscribePomo(); unsubscribePomo = null; }
      if (unsubscribeTodo) { unsubscribeTodo(); unsubscribeTodo = null; }
      if (unsubscribeEvents) { unsubscribeEvents(); unsubscribeEvents = null; }
      if (notesEditor) notesEditor.innerHTML = localStorage.getItem(NOTES_KEY_CLOUD) || '';
    }
  });

  // Debounced cloud save for notes
  let saveTimer = null;
  if (notesEditor) {
    notesEditor.addEventListener('input', () => {
      const html = notesEditor.innerHTML;
      localStorage.setItem(NOTES_KEY_CLOUD, html);
      if (auth.currentUser) {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(async () => {
          try {
            const noteRef = doc(db, 'user_notes', auth.currentUser.uid);
            await setDoc(noteRef, { content: html, updatedAt: serverTimestamp() }, { merge: true });
            setSyncStatus('All changes saved');
          } catch (err) {
            setSyncStatus('Cloud save failed');
          }
        }, 800);
      }
    });
  }

  window.addEventListener('offline', () => setSyncStatus('Offline ‚Äî saved locally'));
  window.addEventListener('online', () => setSyncStatus('Online'));
</script>

<!-- Widget/App Scripts -->
<script src="apps/clock.js"></script>
<script src="apps/pomodoro.js"></script>
<script src="apps/todo.js"></script>
<script src="apps/calculator.js"></script>
<script src="apps/notes.js"></script>
<script src="apps/canvas-manager.js"></script>

<script>
  // Initialize canvas manager after all scripts are loaded
  if (window.initializeCanvasManager) {
    window.initializeCanvasManager();
  }
</script>

</body>
</html>