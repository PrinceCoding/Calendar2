<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Year Calendar with Notes</title>

  <!-- =========================
        STYLES (CSS)
        ========================= -->
  <style>
    /* =========================
        macOS SYSTEM THEME
        ========================= */
    :root {
      --bg: #f5f5f7;
      --card: rgba(255,255,255,0.75);
      --text: #1d1d1f;
      --muted: #6e6e73;
      --primary: #007aff;
      --today: #34c759;
      --border: rgba(0,0,0,0.08);
      --shadow-soft: 0 1px 2px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 24px rgba(0,0,0,0.12);
    }

    body.dark {
      --bg: #0f1115;
      --card: rgba(28,28,30,0.75);
      --text: #f5f5f7;
      --muted: #9a9aa0;
      --primary: #0a84ff;
      --today: #30d158;
      --border: rgba(255,255,255,0.12);
    }

    /* Ocean theme */
    body.theme-ocean {
      --bg: #ecfeff;
      --card: rgba(255,255,255,0.8);
      --text: #164e63;
      --muted: #155e75;
      --primary: #06b6d4;
      --today: #22d3ee;
      --border: rgba(22,78,99,0.15);
    }

    /* Forest theme */
    body.theme-forest {
      --bg: #f0fdf4;
      --card: rgba(255,255,255,0.8);
      --text: #14532d;
      --muted: #166534;
      --primary: #16a34a;
      --today: #22c55e;
      --border: rgba(20,83,45,0.15);
    }

    /* Solar theme */
    body.theme-solar {
      --bg: #fff7ed;
      --card: rgba(255,255,255,0.85);
      --text: #7c2d12;
      --muted: #a16207;
      --primary: #f97316;
      --today: #fb923c;
      --border: rgba(124,45,18,0.15);
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    button {
      border: none;
      background: none;
      font-family: inherit;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      pointer-events: none;
    }

    /* =========================
        HEADER
        ========================= */
    header {
      position: relative;
      padding: 0.9rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .date-time {
      height: 32px;
      padding: 0 0.9rem;
      border-radius: 10px;
      font-size: 0.78rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: var(--card);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft), var(--shadow-float);
      white-space: nowrap;
    }

    .pomo-btn {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: rgba(0,0,0,0.08);
      color: var(--text);
      font-size: 0.65rem;
      display: grid;
      place-items: center;
    }

    .today-btn,
    .theme-btn {
      height: 32px;
      padding: 0 0.9rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .today-btn {
      position: absolute;
      top: 0.9rem;
      left: 1rem;
      background: linear-gradient(180deg, #34c759, #28b84e);
      color: #fff;
    }

    .theme-btn {
      position: absolute;
      top: 0.9rem;
      right: 1rem;
      background: var(--card);
      color: var(--text);
    }

    h1 {
      margin: 0.6rem 0 0.2rem;
      font-size: 1.7rem;
      font-weight: 600;
    }

    .nav {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
    }

    .nav-btn {
      height: 28px;
      width: 28px;
      border-radius: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      color: var(--text);
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    body.dark .nav-btn {
      background: rgba(44,44,46,0.85);
      color: #f5f5f7;
      border: 1px solid rgba(255,255,255,0.18);
    }

    /* =========================
        CALENDAR
        ========================= */
    .calendar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.8rem;
      padding: 0.8rem 1rem 1rem;
    }

    .month {
      background: var(--card);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.75rem;
      box-shadow: var(--shadow-soft), var(--shadow-float);
    }

    .month h2 {
      margin: 0.2rem 0 0.6rem;
      text-align: center;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
    }

    .weekdays,
    .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      gap: 0.25rem;
    }

    .weekdays div {
      font-size: 0.6rem;
      color: var(--muted);
    }

    .days div {
      font-size: 0.75rem;
      padding: 0.35rem 0;
      border-radius: 8px;
      transition: background 0.15s ease;
    }

    .days div:hover {
      background: rgba(0,0,0,0.06);
    }

    .today {
      background: var(--today);
      color: #fff;
      font-weight: 600;
    }

    /* =========================
        NOTES
        ========================= */
    .notes {
      margin: 0.6rem 1rem 1rem;
      background: var(--card);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.75rem;
      box-shadow: var(--shadow-soft), var(--shadow-float);
    }

    .notes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .notes h2 {
      margin: 0;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .notes-tools button {
      height: 26px;
      padding: 0 0.5rem;
      border-radius: 7px;
      background: var(--card);
      border: 1px solid var(--border);
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text);
      box-shadow: var(--shadow-soft);
    }

    .notes-tools button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    body.dark .notes-tools button {
      background: rgba(44,44,46,0.85);
      color: #f5f5f7;
      border: 1px solid rgba(255,255,255,0.18);
    }

    .notes-editor {
      width: 100%;
      min-height: 120px;
      padding: 0.6rem;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      background: rgba(255,255,255,0.5);
      color: var(--text);
      outline: none;
    }

    body.dark .notes-editor {
      background: rgba(0,0,0,0.25);
    }

    footer {
      text-align: center;
      font-size: 0.65rem;
      color: var(--muted);
      padding-bottom: 0.6rem;
    }

    /* Auth Input Styles */
    .auth-input {
      width: 100%;
      height: 34px;
      padding: 0 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.4);
      color: var(--text);
      outline: none;
      transition: border-color 0.2s;
    }
    .auth-input:focus {
      border-color: var(--primary);
    }
    body.dark .auth-input {
      background: rgba(0,0,0,0.2);
    }

  /* =========================
   iPHONE / MOBILE ADJUSTMENTS
   ========================= */
@media (max-width: 480px) {
  header {
    padding: 0.7rem 0.6rem 0.8rem;
  }

  .date-time {
    font-size: 0.7rem;
    padding: 0 0.6rem;
    height: 30px;
  }

  .today-btn,
  .theme-btn {
    position: static;
    height: 28px;
    font-size: 0.7rem;
    padding: 0 0.6rem;
  }

  header > div:first-child {
    flex-wrap: wrap;
    justify-content: center;
  }

  .nav {
    margin-top: 0.4rem;
  }

  h1 {
    font-size: 1.3rem;
  }

  .calendar {
    grid-template-columns: 1fr;
    padding: 0.6rem;
  }

  .month {
    padding: 0.6rem;
  }

  .month h2 {
    font-size: 0.9rem;
  }

  .weekdays div {
    font-size: 0.55rem;
  }

  .days div {
    font-size: 0.7rem;
    padding: 0.3rem 0;
  }

  .notes {
    margin: 0.6rem;
  }

  .notes-editor {
    min-height: 140px;
    font-size: 0.8rem;
  }
}

    /* =========================
        LAYOUT 2 (CALENDAR + NOTES SIDE BY SIDE)
        ========================= */
    body.layout-2 main {
      display: grid;
      grid-template-columns: 2.2fr 8px 1fr;
      gap: 0;
      padding: 0 1rem 1rem;
      align-items: stretch;
    }

    body.layout-2 .calendar {
      padding: 0;
    }

    body.layout-2 .notes {
      margin: 0;
      height: fit-content;
      position: sticky;
      top: 1rem;
    }

    /* Resize handle */
    .resize-handle {
      cursor: col-resize;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.12), transparent);
    }

    body.dark .resize-handle {
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.25), transparent);
    }

    /* =========================
        LAYOUT 2 ‚Äì MOBILE FIX (PHONE)
        ========================= */
    @media (max-width: 768px) {
      body.layout-2 main {
        display: block; /* stop grid */
        padding: 0.6rem;
      }

      body.layout-2 .calendar {
        padding: 0;
      }

      body.layout-2 .notes {
        position: relative;
        margin: 0.8rem 0 0;
        max-height: none;
      }

      .resize-handle {
        display: none;
      }
    }

/* =========================
        FLOATING ANALOG CLOCK
        ========================= */
    .analog-clock {
      position: fixed;
      bottom: 1.2rem;
      right: 1.2rem;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft), var(--shadow-float);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      cursor: grab;
      z-index: 999;
    }
    .analog-clock:active { cursor: grabbing; }
    .clock-face { position: relative; width: 100%; height: 100%; }
    .hour-marks {
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      pointer-events: none;
    }
    .hour-marks span {
      position: absolute;
      top: 0;
      left: 50%;
      width: 2px;
      height: 6px;
      background: var(--muted);
      transform-origin: center calc(60px - 6px);
    }
    .hour-marks span:nth-child(1) { transform: rotate(0deg); }
    .hour-marks span:nth-child(2) { transform: rotate(30deg); }
    .hour-marks span:nth-child(3) { transform: rotate(60deg); }
    .hour-marks span:nth-child(4) { transform: rotate(90deg); }
    .hour-marks span:nth-child(5) { transform: rotate(120deg); }
    .hour-marks span:nth-child(6) { transform: rotate(150deg); }
    .hour-marks span:nth-child(7) { transform: rotate(180deg); }
    .hour-marks span:nth-child(8) { transform: rotate(210deg); }
    .hour-marks span:nth-child(9) { transform: rotate(240deg); }
    .hour-marks span:nth-child(10){ transform: rotate(270deg); }
    .hour-marks span:nth-child(11){ transform: rotate(300deg); }
    .hour-marks span:nth-child(12){ transform: rotate(330deg); }
    .hand {
      position: absolute;
      left: 50%;
      bottom: 50%;
      transform-origin: bottom center;
      background: var(--text);
      border-radius: 2px;
    }
    .hand.hour { width: 4px; height: 32px; }
    .hand.minute { width: 3px; height: 44px; }
    .hand.second { width: 2px; height: 50px; background: var(--primary); }
    .clock-center {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--text);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .clock-date {
      position: absolute;
      top: 6px;
      left: 50%;
      transform: translateX(-50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.55rem;
      font-weight: 600;
      color: var(--text);
      background: rgba(0,0,0,0.04);
      border: 1px solid var(--border);
      letter-spacing: 0.3px;
      pointer-events: none;
      line-height: 1.05;
    }
    body.dark .clock-date {
      background: rgba(255,255,255,0.08);
    }
    .clock-date div {
      display: block;
    }

    /* =========================
        FLOATING POMODORO
        ========================= */
    .floating-pomo {
      position: fixed;
      bottom: 10rem;
      right: 1.2rem;
      padding: 0.6rem 1rem;
      border-radius: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft), var(--shadow-float);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      cursor: grab;
      z-index: 998;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
    }
    .floating-pomo:active { cursor: grabbing; }
    .pomo-content { display: flex; align-items: center; gap: 0.6rem; font-weight: 600; font-size: 0.9rem; }
    .pomo-controls { display: flex; gap: 0.3rem; }

    /* =========================
        CLOSE BUTTON FOR WIDGETS
        ========================= */
    .close-widget-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ff3b30;
      color: white;
      font-size: 10px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .analog-clock:hover .close-widget-btn,
    .floating-pomo:hover .close-widget-btn {
      opacity: 1;
    }
    .close-widget-btn:hover {
      background: #d70015;
      transform: scale(1.1);
    }
</style>
</head>
<body>

<header>
  <div style="display:inline-flex;align-items:center;gap:0.4rem;">
    <div class="date-time"><span id="dtText"></span></div>
    <div class="date-time">üçÖ <span id="pomoTime">60:00</span>
      <button id="pomoStart" class="pomo-btn">‚ñ∂</button>
      <button id="pomoReset" class="pomo-btn">‚ü≥</button>
    </div>
  </div>

  <button id="todayBtn" class="today-btn">üìç Today</button>
  <button id="themeBtn" class="theme-btn">üçé macOS</button>
  <button id="layoutBtn" class="theme-btn" style="right:5.5rem;">üóÇ Layout 1</button>
  <button id="settingsBtn" class="theme-btn" style="right:15.5rem;">‚öôÔ∏è Settings</button>
  <button id="monthToggleBtn" class="theme-btn" style="right:10.5rem;">üìÖ Month</button>

  <div class="nav">
    <button id="prev" class="nav-btn">‚óÄ</button>
    <h1 id="year"></h1>
    <button id="next" class="nav-btn">‚ñ∂</button>
  </div>
</header>

<!-- Floating Analog Clock -->
<div id="analogClock" class="analog-clock">
  <button id="closeClockBtn" class="close-widget-btn" title="Close Clock">‚úï</button>
  <div class="clock-face">
    <div class="hour-marks">
      <span></span><span></span><span></span><span></span><span></span><span></span>
      <span></span><span></span><span></span><span></span><span></span><span></span>
    </div>
    <div class="hand hour" id="hourHand"></div>
    <div class="hand minute" id="minuteHand"></div>
    <div class="hand second" id="secondHand"></div>
    <div class="clock-center"></div>
    <div class="clock-date"><div id="clockDay"></div><div id="clockNum"></div></div>
  </div>
</div>

<!-- Floating Pomodoro -->
<div id="floatingPomo" class="floating-pomo">
  <button id="closePomoBtn" class="close-widget-btn" title="Close Pomodoro">‚úï</button>
  <div class="pomo-content">
    <span class="pomo-emoji">üçÖ</span>
    <span id="floatingPomoTime">60:00</span>
    <div class="pomo-controls">
      <button id="floatingPomoStart" class="pomo-btn">‚ñ∂</button>
      <button id="floatingPomoReset" class="pomo-btn">‚ü≥</button>
    </div>
  </div>
</div>

<!-- =========================
     SETTINGS PAGE (OVERLAY)
     ========================= -->
<div id="settingsPage" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.25);backdrop-filter:blur(4px);">
    <div style="max-width:420px;margin:4rem auto;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-float); max-height: 90vh; overflow-y: auto;">
    <h2 style="margin-top:0">Settings</h2>

    <!-- Appearance -->
    <div class="month" style="margin-bottom:1rem;">
      <h3>Appearance</h3>
      <p style="font-size:0.8rem;color:var(--muted)">Theme</p>
      <div id="settingsThemes" style="display:flex;gap:0.4rem;flex-wrap:wrap;"></div>

      <p style="font-size:0.8rem;color:var(--muted);margin-top:0.6rem">Font Size</p>
      <button class="font-btn" data-size="90">A‚àí</button>
      <button class="font-btn" data-size="100">A</button>
      <button class="font-btn" data-size="110">A+</button>
    </div>

    <!-- Widgets -->
    <div class="month" style="margin-bottom:1rem;">
      <h3>Widgets</h3>
      <label style="font-size:0.8rem;display:flex;align-items:center;gap:0.4rem;margin-bottom:0.6rem;">
        <input type="checkbox" id="toggleClock" /> Show analog clock
      </label>
      <label style="font-size:0.8rem;display:flex;align-items:center;gap:0.4rem;">
        <input type="checkbox" id="toggleFloatingPomo" /> Show floating Pomodoro
      </label>
    </div>

    <!-- Pomodoro -->
    <div class="month" style="margin-bottom:1rem;">
      <h3>Pomodoro</h3>
      <p style="font-size:0.75rem;color:var(--muted)">Session length (minutes)</p>
      <input id="pomoDurationInput" type="number" min="1" style="width:80px;padding:4px 6px;border-radius:8px;border:1px solid var(--border);font-size:0.8rem;" />
    </div>

    <!-- Account -->
    <div class="month" style="margin-bottom:1rem;">
      <h3>Account</h3>
      
      <!-- Logged Out View -->
      <div id="loggedOutUI">
        <input type="email" id="emailInput" class="auth-input" placeholder="Email address">
        <input type="password" id="passwordInput" class="auth-input" placeholder="Password">
        
        <div style="display:flex; gap: 8px; margin-bottom: 12px;">
          <button id="loginBtn" class="today-btn" style="position:static; flex:1; justify-content:center;">Login</button>
          <button id="signupBtn" class="theme-btn" style="position:static; flex:1; justify-content:center;">Sign Up</button>
        </div>
        
        <button id="resetPasswordBtn" style="font-size: 0.7rem; color: var(--primary); text-decoration: underline; background: none; border: none; padding: 0; cursor: pointer;">Forgot Password?</button>
      </div>

      <!-- Logged In View -->
      <div id="loggedInUI" style="display:none;">
        <p id="userEmailDisplay" style="font-size: 0.8rem; margin-bottom: 12px;"></p>
        <button id="logoutBtn" class="today-btn" style="position:static; background: linear-gradient(180deg, #ff3b30, #d70015); width: 100%; justify-content: center;">Sign Out</button>
      </div>

      <p style="font-size:0.75rem;color:var(--muted); margin-top: 12px;">Sync notes across devices</p>
    </div>

    <!-- About -->
    <div class="month">
      <h3>About</h3>
      <p style="font-size:0.75rem;color:var(--muted)">Year Calendar with Notes</p>
    </div>

    <button id="closeSettings" class="theme-btn" style="position:absolute;top:0.8rem;right:0.8rem;">‚úï</button>
  </div>
</div>

<main id="mainLayout">

<div id="calendar" class="calendar"></div>

  <div id="resizeHandle" class="resize-handle"></div>

<section class="notes">
  <div class="notes-header">
    <div style="display:flex;align-items:center;gap:0.6rem;">
      <h2 style="margin:0">Notes</h2>
      <div id="syncStatus" style="font-size:0.75rem;color:var(--muted)">Not signed in</div>
    </div>
    <div class="notes-tools">
      <button data-cmd="bold"><b>B</b></button>
      <button data-cmd="italic"><i>I</i></button>
      <button data-cmd="underline"><u>U</u></button>
      <button data-cmd="insertUnorderedList">‚Ä¢ List</button>
    </div>
  </div>
  <div id="notesEditor" class="notes-editor" contenteditable="true"></div>
</section>

<footer>Highlighted date = Today</footer>

</main>

<script>
  /* =========================
      UI & CALENDAR LOGIC
      ========================= */
  const calEl = document.getElementById('calendar');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPage = document.getElementById('settingsPage');
  const closeSettings = document.getElementById('closeSettings');
  const yearEl = document.getElementById('year');
  const notesEditor = document.getElementById('notesEditor');
  const toolButtons = document.querySelectorAll('.notes-tools button');

  const now = new Date();
  const CURRENT_YEAR = now.getFullYear();
  const TODAY_DATE = now.getDate();
  const TODAY_MONTH = now.getMonth();
  let shownYear = CURRENT_YEAR;

  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  let monthViewIndex = null;
  const monthToggleBtn = document.getElementById('monthToggleBtn');
  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  function renderCalendar(year) {
    calEl.innerHTML = '';
    yearEl.textContent = `Calendar ${year}`;

    MONTHS.forEach((m, i) => {
      if (monthViewIndex !== null && monthViewIndex !== i) return;
      const box = document.createElement('div');
      box.className = 'month';
      box.innerHTML = `<h2 data-month="${i}" style="cursor:pointer">${m}</h2>`;

      const w = document.createElement('div');
      w.className = 'weekdays';
      DAYS.forEach(d => w.innerHTML += `<div>${d}</div>`);

      const g = document.createElement('div');
      g.className = 'days';
      const first = new Date(year, i, 1).getDay();
      const total = new Date(year, i + 1, 0).getDate();

      for (let j = 0; j < first; j++) g.innerHTML += '<div></div>';
      for (let d = 1; d <= total; d++) {
        const t = d === TODAY_DATE && i === TODAY_MONTH && year === CURRENT_YEAR;
        g.innerHTML += `<div class="${t ? 'today' : ''}">${d}</div>`;
      }

      box.append(w, g);
      calEl.appendChild(box);
    });
  }

  function updateTime() {
    const d = new Date();
    const dtText = document.getElementById('dtText');
    if(dtText) {
      dtText.textContent = d.toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' }) + ' ‚Ä¢ ' + d.toLocaleTimeString();
    }
  }

  toolButtons.forEach(b => b.onclick = () => {
    document.execCommand(b.dataset.cmd);
    updateToolStates();
  });

  function updateToolStates() {
    toolButtons.forEach(btn => {
      const cmd = btn.dataset.cmd;
      try {
        const isActive = document.queryCommandState(cmd);
        btn.classList.toggle('active', isActive);
      } catch (e) {}
    });
  }

  document.addEventListener('selectionchange', () => {
    if (document.activeElement === notesEditor) {
      updateToolStates();
    }
  });

  renderCalendar(shownYear);

  // Font size controls
  const fontButtons = document.querySelectorAll('.font-btn');
  fontButtons.forEach(btn => {
    btn.onclick = () => {
      const size = btn.dataset.size;
      document.documentElement.style.fontSize = size + '%';
      localStorage.setItem('fontSize', size);
    };
  });

  const savedFontSize = localStorage.getItem('fontSize');
  if (savedFontSize) {
    document.documentElement.style.fontSize = savedFontSize + '%';
  }

  settingsBtn.onclick = () => { settingsPage.style.display = 'block'; };
  closeSettings.onclick = (e) => { e.stopPropagation(); settingsPage.style.display = 'none'; };

  settingsPage.addEventListener('click', (e) => {
    if (e.target === settingsPage) {
      settingsPage.style.display = 'none';
    }
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && settingsPage.style.display === 'block') {
      settingsPage.style.display = 'none';
    }
  });

  monthToggleBtn.onclick = () => {
    if (monthViewIndex === null) {
      monthViewIndex = TODAY_MONTH;
      monthToggleBtn.textContent = 'üóì Year';
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
    } else {
      monthViewIndex = null;
      monthToggleBtn.textContent = 'üìÖ Month';
      yearEl.textContent = `Calendar ${shownYear}`;
    }
    renderCalendar(shownYear);
  };

  calEl.addEventListener('click', (e) => {
    const h = e.target.closest('h2[data-month]');
    if (!h) return;
    monthViewIndex = Number(h.dataset.month);
    monthToggleBtn.textContent = 'üóì Year';
    yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
    renderCalendar(shownYear);
  });
  updateTime();
  setInterval(updateTime, 1000);

  document.getElementById('prev').onclick = () => {
    if (monthViewIndex !== null) {
      monthViewIndex = (monthViewIndex + 11) % 12;
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
      renderCalendar(shownYear);
    } else {
      renderCalendar(--shownYear);
    }
  };
  document.getElementById('next').onclick = () => {
    if (monthViewIndex !== null) {
      monthViewIndex = (monthViewIndex + 1) % 12;
      yearEl.textContent = `${MONTHS[monthViewIndex]} ${shownYear}`;
      renderCalendar(shownYear);
    } else {
      renderCalendar(++shownYear);
    }
  };
  todayBtn.onclick = () => {
    if (monthViewIndex === null) {
      shownYear = CURRENT_YEAR;
      renderCalendar(shownYear);
      return;
    }
    shownYear = CURRENT_YEAR;
    monthViewIndex = TODAY_MONTH;
    monthToggleBtn.textContent = 'üóì Year';
    yearEl.textContent = `${MONTHS[TODAY_MONTH]} ${shownYear}`;
    renderCalendar(shownYear);
  };

  const themes = [
    { name: 'üçé macOS', class: '' },
    { name: 'üåô Dark', class: 'dark' },
    { name: 'üåä Ocean', class: 'theme-ocean' },
    { name: 'üå≤ Forest', class: 'theme-forest' },
    { name: 'üåÖ Solar', class: 'theme-solar' }
  ];
  let themeIndex = 0;
  themeBtn.onclick = () => {
    document.body.classList.remove('dark','theme-ocean','theme-forest','theme-solar');
    themeIndex = (themeIndex + 1) % themes.length;
    const t = themes[themeIndex];
    if (t.class) document.body.classList.add(t.class);
    themeBtn.textContent = t.name;
  };

  const layoutBtn = document.getElementById('layoutBtn');
  let currentLayout = 1;
  layoutBtn.onclick = () => {
    const main = document.getElementById('mainLayout');
    if (currentLayout === 1) {
      currentLayout = 2;
      document.body.classList.add('layout-2');
      layoutBtn.textContent = 'üóÇ Layout 2';
      const saved = localStorage.getItem('layout2_split_sizes');
      if (saved) main.style.gridTemplateColumns = saved;
    } else {
      currentLayout = 1;
      document.body.classList.remove('layout-2');
      layoutBtn.textContent = 'üóÇ Layout 1';
      main.style.gridTemplateColumns = '';
    }
  };

  const handle = document.getElementById('resizeHandle');
  let isResizing = false;
  handle.addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'col-resize'; });
  window.addEventListener('mousemove', (e) => {
    if (!isResizing || !document.body.classList.contains('layout-2')) return;
    const main = document.getElementById('mainLayout');
    const rect = main.getBoundingClientRect();
    const leftWidth = e.clientX - rect.left;
    const total = rect.width;
    const leftFr = Math.max(1, Math.min(4, (leftWidth / total) * 3));
    main.style.gridTemplateColumns = `${leftFr}fr 8px ${4 - leftFr}fr`;
  });
  window.addEventListener('mouseup', () => {
    if (!isResizing) return;
    isResizing = false;
    document.body.style.cursor = '';
    const main = document.getElementById('mainLayout');
    if (document.body.classList.contains('layout-2')) {
      localStorage.setItem('layout2_split_sizes', main.style.gridTemplateColumns);
    }
  });
</script>

<!-- Firebase Module -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
  import { 
    getAuth, setPersistence, browserLocalPersistence, signOut, onAuthStateChanged,
    signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail,
    signInAnonymously, signInWithCustomToken
  } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

  // Firebase environment configuration
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "AIzaSyA05Vxw3kSZ8xAHUBppMh5p7VwBZ-47kmM",
    authDomain: "calendar-599ac.firebaseapp.com",
    projectId: "calendar-599ac",
    storageBucket: "calendar-599ac.firebasestorage.app",
    messagingSenderId: "89812638572",
    appId: "1:89812638572:web:f02d7309367576a619b149"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'calendar-notes-v1';

  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const resetPasswordBtn = document.getElementById('resetPasswordBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const loggedOutUI = document.getElementById('loggedOutUI');
  const loggedInUI = document.getElementById('loggedInUI');
  const userEmailDisplay = document.getElementById('userEmailDisplay');
  const syncStatus = document.getElementById('syncStatus');
  const notesEditor = document.getElementById('notesEditor');
  const NOTES_KEY = 'calendar_notes_rich';

  function setSyncStatus(text){ if (syncStatus) syncStatus.textContent = text; }

  /* =========================
      POMODORO CLOUD LOGIC
      ========================= */
  const POMO_KEY = 'pomo_duration_minutes';
  let defaultPomoMinutes = Number(localStorage.getItem(POMO_KEY)) || 60;
  let secs = defaultPomoMinutes * 60;
  let timer = null;
  let isCloudRunning = false;

  const pomoTime = document.getElementById('pomoTime');
  const floatingPomoTime = document.getElementById('floatingPomoTime');
  const pomoDurationInput = document.getElementById('pomoDurationInput');
  pomoDurationInput.value = defaultPomoMinutes;

  function updatePomoDisplay(secondsToShow) {
    const minStr = String(Math.floor(secondsToShow/60)).padStart(2,'0');
    const secStr = String(secondsToShow%60).padStart(2,'0');
    const timeText = `${minStr}:${secStr}`;
    if(pomoTime) pomoTime.textContent = timeText;
    if(floatingPomoTime) floatingPomoTime.textContent = timeText;
  }

  function startLocalPomoTicker() {
    if (timer) clearInterval(timer);
    timer = setInterval(() => {
      if (secs <= 0) {
        clearInterval(timer);
        timer = null;
        updatePomoDisplay(0);
        return;
      }
      secs--;
      updatePomoDisplay(secs);
    }, 1000);
    document.getElementById('pomoStart').textContent = '‚è∏';
    document.getElementById('floatingPomoStart').textContent = '‚è∏';
  }

  function stopLocalPomoTicker() {
    clearInterval(timer);
    timer = null;
    document.getElementById('pomoStart').textContent = '‚ñ∂';
    document.getElementById('floatingPomoStart').textContent = '‚ñ∂';
  }

  async function pushPomoState(running, overrideSecs = null) {
    if (!auth.currentUser) return;
    const s = overrideSecs !== null ? overrideSecs : secs;
    const pomoRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'pomodoro', 'state');
    try {
      await setDoc(pomoRef, {
        secs: s,
        isRunning: running,
        timestamp: serverTimestamp(),
        defaultPomoMinutes: defaultPomoMinutes
      });
    } catch (err) { console.error("Pomo push error", err); }
  }

  function handlePomoToggle() {
    if (!auth.currentUser) {
      if (timer) { stopLocalPomoTicker(); } else { startLocalPomoTicker(); }
      return;
    }
    pushPomoState(!isCloudRunning);
  }

  function handlePomoReset() {
    const resetSecs = defaultPomoMinutes * 60;
    if (!auth.currentUser) {
      secs = resetSecs;
      updatePomoDisplay(secs);
      stopLocalPomoTicker();
      return;
    }
    pushPomoState(false, resetSecs);
  }

  pomoDurationInput.onchange = () => {
    const val = Math.max(1, Number(pomoDurationInput.value) || 60);
    defaultPomoMinutes = val;
    localStorage.setItem(POMO_KEY, val);
    if (!auth.currentUser) {
      secs = val * 60;
      updatePomoDisplay(secs);
      stopLocalPomoTicker();
    } else {
      pushPomoState(false, val * 60);
    }
  };

  document.getElementById('pomoStart').onclick = handlePomoToggle;
  document.getElementById('floatingPomoStart').onclick = handlePomoToggle;
  document.getElementById('pomoReset').onclick = handlePomoReset;
  document.getElementById('floatingPomoReset').onclick = handlePomoReset;

  /* =========================
      AUTH & DATA SYNC
      ========================= */
  const handleAuthError = (err) => {
    console.error("Auth error detail:", err);
    let msg = 'Authentication failed';
    if(err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') msg = 'Wrong email/password';
    if(err.code === 'auth/user-not-found') msg = 'User not found';
    if(err.code === 'auth/email-already-in-use') msg = 'Email already in use';
    if(err.code === 'auth/invalid-email') msg = 'Invalid email';
    setSyncStatus('Error: ' + msg);
  };

  loginBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if(!email || !password) return setSyncStatus('Enter email & password');
    try { 
      setSyncStatus('Attempting login...');
      await signInWithEmailAndPassword(auth, email, password); 
    } catch (err) { handleAuthError(err); }
  };

  signupBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if(!email || !password) return setSyncStatus('Enter email & password');
    try { 
      setSyncStatus('Creating account...');
      await createUserWithEmailAndPassword(auth, email, password); 
    } catch (err) { handleAuthError(err); }
  };

  resetPasswordBtn.onclick = async () => {
    const email = emailInput.value.trim();
    if(!email) return setSyncStatus('Enter email first');
    try { await sendPasswordResetEmail(auth, email); setSyncStatus('Reset link sent'); } catch (err) { handleAuthError(err); }
  };

  logoutBtn.onclick = () => signOut(auth);

  const initAuth = async () => {
    try {
      await setPersistence(auth, browserLocalPersistence);
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else if (!auth.currentUser) {
        await signInAnonymously(auth);
      }
    } catch (err) { console.error("Init Auth error", err); }
  };
  initAuth();

  let unsubNotes = null;
  let unsubPomo = null;

  onAuthStateChanged(auth, user => {
    if (user) {
      loggedOutUI.style.display = 'none';
      loggedInUI.style.display = 'block';
      userEmailDisplay.textContent = `Logged in as: ${user.email || 'Guest'}`;
      setSyncStatus('Cloud Synced');

      // Notes Basic Sync Logic (Restored)
      const noteRef = doc(db, 'artifacts', appId, 'users', user.uid, 'notes', 'main');
      if (unsubNotes) unsubNotes();
      unsubNotes = onSnapshot(noteRef, snap => {
        if (snap.exists()) {
          const data = snap.data();
          if (document.activeElement !== notesEditor) {
            notesEditor.innerHTML = data.content || '';
          }
          setSyncStatus('Cloud Synced');
        } else {
          const local = localStorage.getItem(NOTES_KEY) || '';
          setDoc(noteRef, { content: local, updatedAt: serverTimestamp() })
            .then(() => setSyncStatus('Cloud Initialized'));
        }
      }, err => {
        console.error("Firestore note sync error:", err);
        setSyncStatus('Sync Error: Access Denied');
      });

      // Pomodoro Sync
      const pomoRef = doc(db, 'artifacts', appId, 'users', user.uid, 'pomodoro', 'state');
      if (unsubPomo) unsubPomo();
      unsubPomo = onSnapshot(pomoRef, snap => {
        if (snap.exists()) {
          const data = snap.data();
          isCloudRunning = data.isRunning;
          defaultPomoMinutes = data.defaultPomoMinutes || 60;
          pomoDurationInput.value = defaultPomoMinutes;
          
          if (isCloudRunning && data.timestamp) {
            const serverTime = data.timestamp.toMillis();
            const elapsedSincePush = Math.floor((Date.now() - serverTime) / 1000);
            secs = Math.max(0, data.secs - elapsedSincePush);
            startLocalPomoTicker();
          } else {
            secs = data.secs;
            updatePomoDisplay(secs);
            stopLocalPomoTicker();
          }
        }
      });
    } else {
      loggedOutUI.style.display = 'block';
      loggedInUI.style.display = 'none';
      setSyncStatus('Local Mode');
      if (unsubNotes) unsubNotes();
      if (unsubPomo) unsubPomo();
      notesEditor.innerHTML = localStorage.getItem(NOTES_KEY) || ''; 
    }
  });

  // Notes Auto-save (Basic Method)
  let saveTimer = null;
  notesEditor.addEventListener('input', () => {
    const html = notesEditor.innerHTML;
    localStorage.setItem(NOTES_KEY, html);
    if (auth.currentUser) {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try {
          const noteRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'notes', 'main');
          await setDoc(noteRef, { content: html, updatedAt: serverTimestamp() }, { merge: true });
          setSyncStatus('All changes saved');
        } catch (e) {
          setSyncStatus('Cloud save error');
        }
      }, 800);
    }
  });

  /* =========================
      WIDGETS LOGIC
      ========================= */
  const clock = document.getElementById('analogClock');
  const toggleClock = document.getElementById('toggleClock');
  const closeClockBtn = document.getElementById('closeClockBtn');
  const CLOCK_VIS_KEY = 'show_analog_clock';

  const savedClock = localStorage.getItem(CLOCK_VIS_KEY);
  const showClock = savedClock !== 'false';
  clock.style.display = showClock ? 'block' : 'none';
  if (toggleClock) toggleClock.checked = showClock;

  function updateClockVisibility(visible) {
    clock.style.display = visible ? 'block' : 'none';
    localStorage.setItem(CLOCK_VIS_KEY, visible);
    if (toggleClock) toggleClock.checked = visible;
  }
  if (toggleClock) toggleClock.onchange = () => updateClockVisibility(toggleClock.checked);
  if (closeClockBtn) closeClockBtn.onclick = (e) => { e.stopPropagation(); updateClockVisibility(false); };

  const hourHand = document.getElementById('hourHand');
  const minuteHand = document.getElementById('minuteHand');
  const secondHand = document.getElementById('secondHand');
  const clockDay = document.getElementById('clockDay');
  const clockNum = document.getElementById('clockNum');

  function updateAnalogClock() {
    const now = new Date();
    const s = now.getSeconds();
    const m = now.getMinutes();
    const h = now.getHours() % 12;
    hourHand.style.transform = `translateX(-50%) rotate(${h * 30 + m * 0.5}deg)`;
    minuteHand.style.transform = `translateX(-50%) rotate(${m * 6}deg)`;
    secondHand.style.transform = `translateX(-50%) rotate(${s * 6}deg)`;
    clockDay.textContent = now.toLocaleDateString(undefined, { weekday: 'short' });
    clockNum.textContent = now.getDate();
  }
  setInterval(updateAnalogClock, 1000);
  updateAnalogClock();

  const floatingPomo = document.getElementById('floatingPomo');
  const toggleFloatingPomo = document.getElementById('toggleFloatingPomo');
  const closePomoBtn = document.getElementById('closePomoBtn');
  const POMO_VIS_KEY = 'show_floating_pomo';

  const savedPomoVis = localStorage.getItem(POMO_VIS_KEY);
  const showPomo = savedPomoVis !== 'false';
  floatingPomo.style.display = showPomo ? 'flex' : 'none';
  if (toggleFloatingPomo) toggleFloatingPomo.checked = showPomo;

  function updatePomoVisibility(visible) {
    floatingPomo.style.display = visible ? 'flex' : 'none';
    localStorage.setItem(POMO_VIS_KEY, visible);
    if (toggleFloatingPomo) toggleFloatingPomo.checked = visible;
  }
  if (toggleFloatingPomo) toggleFloatingPomo.onchange = () => updatePomoVisibility(toggleFloatingPomo.checked);
  if (closePomoBtn) closePomoBtn.onclick = (e) => { e.stopPropagation(); updatePomoVisibility(false); };

  function makeDraggable(el) {
    let isDragging = false;
    let startX, startY, startLeft, startTop;
    el.addEventListener('mousedown', e => {
      if (e.target.tagName === 'BUTTON') return;
      isDragging = true;
      startX = e.clientX; startY = e.clientY;
      startLeft = el.offsetLeft; startTop = el.offsetTop;
      el.style.right = 'auto'; el.style.bottom = 'auto';
    });
    window.addEventListener('mousemove', e => {
      if (!isDragging) return;
      el.style.left = startLeft + (e.clientX - startX) + 'px';
      el.style.top = startTop + (e.clientY - startY) + 'px';
    });
    window.addEventListener('mouseup', () => isDragging = false);
  }
  makeDraggable(clock);
  makeDraggable(floatingPomo);

  window.addEventListener('offline', () => setSyncStatus('Offline ‚Äî saved locally'));
  window.addEventListener('online', () => setSyncStatus('Online'));
</script>
</body>
</html>
