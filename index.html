<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Year Calendar with Notes</title>

  <style>
    :root {
      --bg: #f5f5f7;
      --card: rgba(255,255,255,0.75);
      --text: #1d1d1f;
      --muted: #6e6e73;
      --primary: #007aff;
      --today: #34c759;
      --border: rgba(0,0,0,0.08);
      --shadow-soft: 0 1px 2px rgba(0,0,0,0.08);
      --shadow-float: 0 8px 24px rgba(0,0,0,0.12);
    }

    body.dark {
      --bg: #0f1115;
      --card: rgba(28,28,30,0.75);
      --text: #f5f5f7;
      --muted: #9a9aa0;
      --primary: #0a84ff;
      --today: #30d158;
      --border: rgba(255,255,255,0.12);
    }

    body.theme-ocean {
      --bg: #ecfeff;
      --card: rgba(255,255,255,0.8);
      --text: #164e63;
      --muted: #155e75;
      --primary: #06b6d4;
      --today: #22d3ee;
      --border: rgba(22,78,99,0.15);
    }

    body.theme-forest {
      --bg: #f0fdf4;
      --card: rgba(255,255,255,0.8);
      --text: #14532d;
      --muted: #166534;
      --primary: #16a34a;
      --today: #22c55e;
      --border: rgba(20,83,45,0.15);
    }

    body.theme-solar {
      --bg: #fff7ed;
      --card: rgba(255,255,255,0.85);
      --text: #7c2d12;
      --muted: #a16207;
      --primary: #f97316;
      --today: #fb923c;
      --border: rgba(124,45,18,0.15);
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    button {
      border: none;
      background: none;
      font-family: inherit;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    button:active { opacity: 0.7; }
    button:disabled { opacity: 0.5; cursor: default; }

    header {
      position: relative;
      padding: 0.9rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .date-time {
      height: 32px;
      padding: 0 0.9rem;
      border-radius: 10px;
      font-size: 0.78rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: var(--card);
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft), var(--shadow-float);
      white-space: nowrap;
    }

    .pomo-btn {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: rgba(0,0,0,0.08);
      color: var(--text);
      font-size: 0.65rem;
      display: grid;
      place-items: center;
    }

    .today-btn, .theme-btn {
      height: 32px;
      padding: 0 0.9rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      backdrop-filter: blur(14px) saturate(180%);
      -webkit-backdrop-filter: blur(14px) saturate(180%);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .today-btn {
      position: absolute;
      top: 0.9rem;
      left: 1rem;
      background: linear-gradient(180deg, #34c759, #28b84e);
      color: #fff;
    }

    .theme-btn {
      position: absolute;
      top: 0.9rem;
      right: 1rem;
      background: var(--card);
      color: var(--text);
    }

    h1 {
      margin: 0.6rem 0 0.2rem;
      font-size: 1.7rem;
      font-weight: 600;
    }

    .nav {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
    }

    .nav-btn {
      height: 28px;
      width: 28px;
      border-radius: 8px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      color: var(--text);
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.8rem;
      padding: 0.8rem 1rem 1rem;
    }

    .month {
      background: var(--card);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.75rem;
      box-shadow: var(--shadow-soft), var(--shadow-float);
    }

    .month h2 {
      margin: 0.2rem 0 0.6rem;
      text-align: center;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .weekdays, .days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      gap: 0.25rem;
    }

    .weekdays div { font-size: 0.6rem; color: var(--muted); }
    .days div { font-size: 0.75rem; padding: 0.35rem 0; border-radius: 8px; transition: background 0.15s ease; }
    .days div:hover { background: rgba(0,0,0,0.06); }
    .today { background: var(--today); color: #fff; font-weight: 600; }

    .notes {
      margin: 0.6rem 1rem 1rem;
      background: var(--card);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 0.75rem;
      box-shadow: var(--shadow-soft), var(--shadow-float);
    }

    .notes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .notes h2 { margin: 0; font-size: 0.9rem; font-weight: 600; }

    .notes-tools button {
      height: 26px;
      padding: 0 0.5rem;
      border-radius: 7px;
      background: var(--card);
      border: 1px solid var(--border);
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text);
    }

    .notes-editor {
      width: 100%;
      min-height: 120px;
      padding: 0.6rem;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
      background: rgba(255,255,255,0.5);
      color: var(--text);
      outline: none;
      line-height: 1.5;
    }

    body.dark .notes-editor { background: rgba(0,0,0,0.25); }

    footer {
      text-align: center;
      font-size: 0.65rem;
      color: var(--muted);
      padding-bottom: 1rem;
    }

    /* Layout 2 Split View */
    body.layout-2 main {
      display: grid;
      grid-template-columns: 2.2fr 8px 1fr;
      padding: 0 1rem 1rem;
      height: calc(100vh - 120px);
    }

    body.layout-2 .calendar { padding: 0; overflow-y: auto; }
    body.layout-2 .notes { margin: 0; height: 100%; overflow-y: auto; }

    .resize-handle {
      cursor: col-resize;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.1), transparent);
    }

    @media (max-width: 768px) {
      body.layout-2 main { display: block; height: auto; }
      .resize-handle { display: none; }
      .today-btn, .theme-btn { position: static; margin-bottom: 10px; }
      header { flex-wrap: wrap; }
    }

    /* Auth UI Specifics */
    .input-field {
      width: 100%;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.5);
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      margin-bottom: 8px;
    }
    body.dark .input-field { background: rgba(0,0,0,0.2); }

    /* Fix reCAPTCHA z-index and container styling */
    #recaptcha-container {
      margin: 10px 0;
      transform: scale(0.9);
      transform-origin: left top;
    }

    /* Important: Force Google's verification challenge above our modal */
    .grecaptcha-badge { z-index: 10001 !important; }
    iframe[title*="recaptcha challenge"] { z-index: 10002 !important; }
  </style>
</head>
<body>

<header>
  <div style="display:inline-flex;align-items:center;gap:0.4rem; margin-bottom: 1rem;">
    <div class="date-time"><span id="dtText"></span></div>
    <div class="date-time">üçÖ <span id="pomoTime">60:00</span>
      <button id="pomoStart" class="pomo-btn">‚ñ∂</button>
      <button id="pomoReset" class="pomo-btn">‚ü≥</button>
    </div>
  </div>

  <button id="todayBtn" class="today-btn">üìç Today</button>
  <button id="themeBtn" class="theme-btn">üçé macOS</button>
  
  <div style="display:flex; gap: 0.5rem; margin-bottom: 1rem;">
    <button id="layoutBtn" class="theme-btn" style="position:static;">üóÇ Layout 1</button>
    <button id="monthToggleBtn" class="theme-btn" style="position:static;">üìÖ Month</button>
    <button id="settingsBtn" class="theme-btn" style="position:static;">‚öôÔ∏è Settings</button>
  </div>

  <div class="nav">
    <button id="prev" class="nav-btn">‚óÄ</button>
    <h1 id="year"></h1>
    <button id="next" class="nav-btn">‚ñ∂</button>
  </div>
</header>

<div id="settingsPage" style="display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.25);backdrop-filter:blur(10px); justify-content:center; align-items:center;">
    <div style="width:100%; max-width:420px; padding:1.5rem; background:var(--card); border:1px solid var(--border); border-radius:24px; box-shadow:var(--shadow-float); position:relative; max-height: 90vh; overflow-y: auto;">
      <h2 style="margin-top:0">Settings</h2>

      <div class="month" style="margin-bottom:1rem; background:transparent; box-shadow:none; border:none; padding:0;">
        <h3 style="font-size:0.9rem; margin-bottom:10px;">Appearance</h3>
        <p style="font-size:0.8rem;color:var(--muted); margin-bottom:8px;">Font Size</p>
        <div style="display:flex; gap:0.5rem;">
          <button class="font-btn today-btn" style="position:static; flex:1;" data-size="90">A‚àí</button>
          <button class="font-btn today-btn" style="position:static; flex:1;" data-size="100">A</button>
          <button class="font-btn today-btn" style="position:static; flex:1;" data-size="110">A+</button>
        </div>
      </div>

      <div class="month" style="margin-bottom:1rem; background:transparent; box-shadow:none; border:none; padding:0;">
        <h3 style="font-size:0.9rem; margin-bottom:10px;">Pomodoro</h3>
        <input id="pomoDurationInput" type="number" class="input-field" placeholder="Session minutes">
      </div>

      <div class="month" style="margin-bottom:1rem; background:transparent; box-shadow:none; border:none; padding:0;">
        <h3 style="font-size:0.9rem; margin-bottom:10px;">Account</h3>
        <div id="authContainer">
          <button id="googleLoginBtn" class="today-btn" style="position:static; width:100%; margin-bottom:12px; display:flex; justify-content:center;">üîê Login with Google</button>
          
          <div id="phoneAuthSection" style="border-top: 1px solid var(--border); padding-top:12px;">
            <p style="font-size:0.75rem; color:var(--muted); margin-bottom:8px;">Login with Phone (SMS)</p>
            <div id="phoneInputContainer" style="display:flex; gap:8px;">
              <input id="phoneInput" type="tel" class="input-field" placeholder="+1234567890" style="margin-bottom:0;">
              <button id="sendCodeBtn" class="today-btn" style="position:static; white-space:nowrap;">Send SMS</button>
            </div>
            
            <!-- Visible reCAPTCHA container -->
            <div id="recaptcha-container"></div>
            
            <div id="otpSection" style="display:none; margin-top:10px; flex-direction:column; gap:8px;">
              <input id="otpInput" type="text" class="input-field" placeholder="Verification Code" style="margin-bottom:0;">
              <button id="verifyOtpBtn" class="today-btn" style="position:static; width:100%; background:var(--primary);">Verify & Sign In</button>
            </div>
          </div>

          <button id="signOutBtn" class="theme-btn" style="position:static; width:100%; display:none; justify-content:center; color: #ff3b30;">üö™ Sign Out</button>
        </div>
      </div>

      <button id="closeSettings" class="theme-btn" style="width:100%; position:static; margin-top:1rem; justify-content:center;">Done</button>
    </div>
</div>

<main id="mainLayout">
  <div id="calendar" class="calendar"></div>
  <div id="resizeHandle" class="resize-handle"></div>
  <section class="notes">
    <div class="notes-header">
      <div style="display:flex;flex-direction:column;">
        <h2 id="notesTitle">Notes</h2>
        <div id="syncStatus" style="font-size:0.7rem;color:var(--muted)">Local Mode</div>
      </div>
      <div class="notes-tools">
        <button onclick="document.execCommand('bold')"><b>B</b></button>
        <button onclick="document.execCommand('italic')"><i>I</i></button>
        <button onclick="document.execCommand('underline')"><u>U</u></button>
        <button onclick="document.execCommand('insertUnorderedList')">‚Ä¢ List</button>
      </div>
    </div>
    <div id="notesEditor" class="notes-editor" contenteditable="true"></div>
  </section>
</main>

<footer>Highlighted date = Today</footer>

<script>
  // CALENDAR LOGIC
  const calEl = document.getElementById('calendar');
  const yearEl = document.getElementById('year');
  const dtText = document.getElementById('dtText');
  const notesEditor = document.getElementById('notesEditor');
  
  const now = new Date();
  const CURRENT_YEAR = now.getFullYear();
  const TODAY_DATE = now.getDate();
  const TODAY_MONTH = now.getMonth();
  let shownYear = CURRENT_YEAR;
  let monthViewIndex = null;

  const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  function renderCalendar(year) {
    calEl.innerHTML = '';
    yearEl.textContent = monthViewIndex !== null ? `${MONTHS[monthViewIndex]} ${year}` : `Calendar ${year}`;

    MONTHS.forEach((m, i) => {
      if (monthViewIndex !== null && monthViewIndex !== i) return;
      const box = document.createElement('div');
      box.className = 'month';
      box.innerHTML = `<h2 data-month="${i}" style="cursor:pointer">${m}</h2>`;
      const w = document.createElement('div');
      w.className = 'weekdays';
      DAYS.forEach(d => w.innerHTML += `<div>${d}</div>`);
      const g = document.createElement('div');
      g.className = 'days';
      const first = new Date(year, i, 1).getDay();
      const total = new Date(year, i + 1, 0).getDate();
      for (let j = 0; j < first; j++) g.innerHTML += '<div></div>';
      for (let d = 1; d <= total; d++) {
        const isToday = d === TODAY_DATE && i === TODAY_MONTH && year === CURRENT_YEAR;
        g.innerHTML += `<div class="${isToday ? 'today' : ''}">${d}</div>`;
      }
      box.append(w, g);
      calEl.appendChild(box);
    });
  }

  function updateTime() {
    const d = new Date();
    dtText.textContent = d.toLocaleDateString(undefined, { weekday:'long', month:'long', day:'numeric' }) + ' ‚Ä¢ ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  renderCalendar(shownYear);
  updateTime();
  setInterval(updateTime, 1000);

  document.getElementById('settingsBtn').onclick = () => document.getElementById('settingsPage').style.display = 'flex';
  document.getElementById('closeSettings').onclick = () => document.getElementById('settingsPage').style.display = 'none';
  
  document.getElementById('prev').onclick = () => {
    if (monthViewIndex !== null) { monthViewIndex = (monthViewIndex + 11) % 12; if(monthViewIndex === 11) shownYear--; }
    else shownYear--;
    renderCalendar(shownYear);
  };
  document.getElementById('next').onclick = () => {
    if (monthViewIndex !== null) { monthViewIndex = (monthViewIndex + 1) % 12; if(monthViewIndex === 0) shownYear++; }
    else shownYear++;
    renderCalendar(shownYear);
  };
  document.getElementById('todayBtn').onclick = () => {
    shownYear = CURRENT_YEAR;
    monthViewIndex = null;
    renderCalendar(shownYear);
  };
  document.getElementById('monthToggleBtn').onclick = () => {
    monthViewIndex = monthViewIndex === null ? TODAY_MONTH : null;
    renderCalendar(shownYear);
  };

  calEl.onclick = (e) => {
    const h2 = e.target.closest('h2[data-month]');
    if (h2) {
      monthViewIndex = parseInt(h2.dataset.month);
      renderCalendar(shownYear);
    }
  };

  let themeIdx = 0;
  const themes = ['', 'dark', 'theme-ocean', 'theme-forest', 'theme-solar'];
  const themeNames = ['üçé macOS', 'üåô Dark', 'üåä Ocean', 'üå≤ Forest', 'üåÖ Solar'];
  document.getElementById('themeBtn').onclick = () => {
    document.body.classList.remove(...themes.filter(t => t));
    themeIdx = (themeIdx + 1) % themes.length;
    if (themes[themeIdx]) document.body.classList.add(themes[themeIdx]);
    document.getElementById('themeBtn').textContent = themeNames[themeIdx];
  };

  let isLayout2 = false;
  document.getElementById('layoutBtn').onclick = () => {
    isLayout2 = !isLayout2;
    document.body.classList.toggle('layout-2', isLayout2);
    document.getElementById('layoutBtn').textContent = isLayout2 ? 'üóÇ Layout 2' : 'üóÇ Layout 1';
  };

  let pomoSecs = 3600;
  let pomoInt = null;
  const pomoTime = document.getElementById('pomoTime');
  document.getElementById('pomoStart').onclick = (e) => {
    if (pomoInt) {
      clearInterval(pomoInt); pomoInt = null; e.target.textContent = '‚ñ∂';
    } else {
      pomoInt = setInterval(() => {
        if (pomoSecs <= 0) return clearInterval(pomoInt);
        pomoSecs--;
        const m = Math.floor(pomoSecs/60);
        const s = pomoSecs % 60;
        pomoTime.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      }, 1000);
      e.target.textContent = '‚è∏';
    }
  };
  document.getElementById('pomoReset').onclick = () => {
    clearInterval(pomoInt); pomoInt = null;
    const dur = parseInt(document.getElementById('pomoDurationInput').value) || 60;
    pomoSecs = dur * 60;
    pomoTime.textContent = `${dur}:00`;
    document.getElementById('pomoStart').textContent = '‚ñ∂';
  };

  notesEditor.oninput = () => {
    if (!document.getElementById('syncStatus').textContent.includes('Synced')) {
      localStorage.setItem('calendar_notes_local', notesEditor.innerHTML);
    }
  };
  const localNotes = localStorage.getItem('calendar_notes_local');
  if (localNotes) notesEditor.innerHTML = localNotes;
</script>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
  import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithPhoneNumber, RecaptchaVerifier, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

  const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyA05Vxw3kSZ8xAHUBppMh5p7VwBZ-47kmM","authDomain":"calendar-599ac.firebaseapp.com","projectId":"calendar-599ac","storageBucket":"calendar-599ac.firebasestorage.app","messagingSenderId":"89812638572","appId":"1:89812638572:web:f02d7309367576a619b149"}');
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const appId = 'calendar-notes-v2';

  const googleBtn = document.getElementById('googleLoginBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const phoneAuthSection = document.getElementById('phoneAuthSection');
  const sendCodeBtn = document.getElementById('sendCodeBtn');
  const verifyOtpBtn = document.getElementById('verifyOtpBtn');
  const otpSection = document.getElementById('otpSection');
  const syncStatus = document.getElementById('syncStatus');
  const notesEditor = document.getElementById('notesEditor');

  let confirmationResult = null;
  let unsubscribeNotes = null;

  // Clear existing verifier on load to prevent duplicates
  if (window.recaptchaVerifier) {
    window.recaptchaVerifier.clear();
    window.recaptchaVerifier = null;
  }

  // Setup visible reCAPTCHA
  const setupRecaptcha = () => {
    if (!window.recaptchaVerifier) {
      window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 
        'size': 'normal', // Changed to normal for better feedback
        'callback': (response) => {
          // reCAPTCHA solved
        },
        'expired-callback': () => {
          syncStatus.textContent = 'reCAPTCHA expired. Please solve it again.';
        }
      });
      window.recaptchaVerifier.render();
    }
  };

  sendCodeBtn.onclick = async () => {
    const phone = document.getElementById('phoneInput').value;
    if (!phone.startsWith('+')) return alert('Use international format starting with + (e.g. +1)');
    
    try {
      setupRecaptcha();
      syncStatus.textContent = 'Sending SMS...';
      confirmationResult = await signInWithPhoneNumber(auth, phone, window.recaptchaVerifier);
      otpSection.style.display = 'flex';
      syncStatus.textContent = 'Code Sent';
    } catch (err) {
      console.error(err);
      syncStatus.textContent = 'Error';
      alert('Error: ' + err.message);
      // Reset reCAPTCHA on error so user can try again
      if (window.recaptchaVerifier) {
        window.recaptchaVerifier.render().then(widgetId => {
          grecaptcha.reset(widgetId);
        });
      }
    }
  };

  verifyOtpBtn.onclick = async () => {
    const code = document.getElementById('otpInput').value;
    try {
      syncStatus.textContent = 'Verifying...';
      await confirmationResult.confirm(code);
      document.getElementById('settingsPage').style.display = 'none';
    } catch (err) {
      alert('Invalid Verification Code');
      syncStatus.textContent = 'Verification Failed';
    }
  };

  googleBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
  signOutBtn.onclick = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      googleBtn.style.display = 'none';
      phoneAuthSection.style.display = 'none';
      signOutBtn.style.display = 'flex';
      syncStatus.textContent = '‚òÅÔ∏è Synced: ' + (user.displayName || user.phoneNumber);

      const noteRef = doc(db, 'artifacts', appId, 'users', user.uid, 'notes', 'main');
      
      if (unsubscribeNotes) unsubscribeNotes();
      unsubscribeNotes = onSnapshot(noteRef, (snap) => {
        if (snap.exists() && !notesEditor.matches(':focus')) {
          notesEditor.innerHTML = snap.data().content || '';
        }
      }, (err) => {
        console.error('Firestore error:', err);
      });
    } else {
      googleBtn.style.display = 'flex';
      phoneAuthSection.style.display = 'block';
      signOutBtn.style.display = 'none';
      otpSection.style.display = 'none';
      syncStatus.textContent = 'Local Mode';
      if (unsubscribeNotes) { unsubscribeNotes(); unsubscribeNotes = null; }
    }
  });

  let saveTimer = null;
  notesEditor.addEventListener('input', () => {
    if (!auth.currentUser) return;
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
      const noteRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'notes', 'main');
      try {
        await setDoc(noteRef, {
          content: notesEditor.innerHTML,
          updatedAt: serverTimestamp()
        }, { merge: true });
        syncStatus.textContent = '‚òÅÔ∏è Changes saved';
      } catch (err) {
        syncStatus.textContent = 'Sync Error';
      }
    }, 1000);
  });
</script>
</body>
</html>
